{
  "pageTitle": "7. יומן תפוסה ספא (absolute_calendar)",
  "sections": [
    {
      "title": "הקדמה",
      "content": "בדף absolute_calendar.php מוצג יומן תפוסה עבור ספא, המאפשר להציג משמרות (shifts), מטפלים (therapists) או חדרים (units). העמוד תומך בתצוגות יום/שבוע/חודש/רשימה, כולל חיתוך אירועים מחוץ לטווח התאריכים, מנגנון גלילה וגרירה, והצגה של \"הערות יומיות\". בנוסף, יש תמיכה במטפלים פיקטיביים (fictive) ובנעילת יום (locked), וכן התחשבות בחגים/ימי חופשה (not_holidays, sites_periods) ושעות פעילות יומיות (sites_weekly_hours). קיימים דגלים רבים לקביעת אופן הצגת היומן (remarksShort, roomsShort, therapistShort, hidefaces, groupTreat, timeStart, redline)."
    },
    {
      "title": "הקבצים הרלוונטיים לצורך absolute_calendar",
      "content": "<ul>\n<li><code>absolute_calendar.php</code> – הקובץ הראשי (נסרק במלואו).</li>\n<li><code>page7.json</code> – גרסת הדוקומנטציה המקורית שסופקה (נסרק במלואו).</li>\n<li><code>ajax_daily_remarks.php</code> – משמש לשמירת הערות יומיות (נסרק במלואו).</li>\n</ul>"
    },
    {
      "title": "קבצים נוספים (לפי הקוד)",
      "content": "<ul>\n<li><code>ajax_tfusa_view.php</code> – לא סופק במלואו, נדרש כדי להשלים פעולות AJAX נוספות (set_session וכו').</li>\n<li>קובץ שמממש את <code>udb::...</code> (כגון <code>UserUtilsNew.php</code>) – לא סופק.</li>\n<li>הגדרות נוספות כגון <code>$domain_icon</code> (מקור לא ידוע), לא סופק במלואו.</li>\n</ul>"
    },
    {
      "title": "תרחישים כוללים בעמוד absolute_calendar",
      "subSections": [
        {
          "title": "תרחיש 1: טעינת העמוד עם פרמטרים",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1.1</td>\n<td>משתמש נכנס ל-URL עם פרמטרים (למשל <code>?page=absolute_calendar&type=2&viewtype=0&date=01/05/2024&weekly=1&workers=0</code>).</td>\n<td>1. הפרמטרים נקלטים (<code>type, viewtype, date, weekly, workers</code>).<br>2. הגדרת <code>$caltype</code>, <code>$viewtype</code>, <code>$date</code> וכו'.<br>3. טווח התאריכים מחושב (<code>$firstDay</code>, <code>$lastDay</code>, <code>$showDays</code>), נוצרת טבלת יומן.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 2: מעבר בין מצב יום / שבוע / חודש / רשימה",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2.1</td>\n<td>משתמש בוחר תצוגה יומית / שבועית / חודשית / רשימה.</td>\n<td>1. <code>viewtype</code> מתעדכן (0=רשימה, 1=חודש, 2=יום).<br>2. בשילוב <code>weekly=1</code> יופעל מצב שבועי.</td>\n</tr>\n<tr>\n<td>2.2</td>\n<td>העמוד נטען מחדש.</td>\n<td>1. חישוב מחדש <code>$firstDay</code>, <code>$lastDay</code>, <code>$showDays</code>.<br>2. בניית טבלת יומן מותאמת.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 3: תצוגה לפי משמרות / מטפלים / חדרים (type=0,1,2)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3.1</td>\n<td>משתמש בוחר \"משמרות\"/\"מטפלים\"/\"חדרים\".</td>\n<td>1. <code>$caltype</code> נקבע ל-0 (משמרות) / 1 (מטפלים) / 2 (חדרים).<br>2. טעינת נתוני בסיס כגון <code>therapists</code> או <code>rooms_units</code> ל-<code>$crooms</code>.</td>\n</tr>\n<tr>\n<td>3.2</td>\n<td>רואה בצד ימין את הרשימה.</td>\n<td>מוצגים חדרים/מטפלים/משמרות באופן מרוכז.</td>\n</tr>\n<tr>\n<td>3.3</td>\n<td>סיכומי טיפולים/משמרות.</td>\n<td>חישוב <code>$totals</code>, <code>$totalsTime</code> והצגתם.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 4: מעבר למצב עובדים (workers)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>4.1</td>\n<td>משתמש לוחץ \"עובדים\" (workers=1).</td>\n<td>1. הקוד מזהה <code>workers=1</code> וטוען נתונים מ-<code>workers</code> ולא מ-<code>therapists</code>.<br>2. משמרות נטענות מ-<code>workShifts</code> במקום <code>spaShifts</code>.</td>\n</tr>\n<tr>\n<td>4.2</td>\n<td>רשימת עובדים מוצגת.</td>\n<td>הצגה מקבילה ל\"מטפלים\", רק עם <code>workers</code>.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 5: גלילה/גרירה אופקית ואנכית של היומן",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>5.1</td>\n<td>גורר את הטבלה עם העכבר/אצבע.</td>\n<td>1. <code>mousedown</code>, <code>mousemove</code>, <code>touchmove</code> מנהלים את <code>scrollLeft()</code>/<code>scrollTop()</code>.<br>2. שימוש ב-<code>dragging</code> וערכים <code>dx</code>, <code>dy</code>.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 6: הצגת והוספת הערות יומיות (Daily Remarks)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>6.1</td>\n<td>מנהל רואה אייקון הערות ולוחץ.</td>\n<td>1. <code>$adminAccess=1</code> נדרש לעריכה.<br>2. <code>$remarksShort</code> להגדרת תצוגה מקוצרת.</td>\n</tr>\n<tr>\n<td>6.2</td>\n<td>בפופאפ מקליד הערה ולוחץ \"שמור\".</td>\n<td>1. <code>ajax_daily_remarks.php</code> שומר ב-DB.<br>2. שינוי אייקון ל-<code>class=\"msgs\"</code> אם יש טקסט.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 7: סינון והצגת יחידות (type=2)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>7.1</td>\n<td>לוחץ \"כל היחידות\" או יחידה כלשהי.</td>\n<td>1. <code>showunits()</code> מופעל.<br>2. פופאפ <code>#unitSelect</code> נפתח.</td>\n</tr>\n<tr>\n<td>7.2</td>\n<td>רואה רק מה שנבחר.</td>\n<td><code>$('.row[data-uid='+uid+']').show()</code> וסגירת הפופאפ.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 8: טעינת הזמנות/משמרות והצגתן ביומן",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8.1</td>\n<td>רוצה לראות הזמנות (type=1/2) או משמרות (type=0).</td>\n<td>1. <code>orders</code> או <code>spaShifts/workShifts</code> נטענים ל-<code>$calendarOrders</code>.<br>2. סינון לפי <code>timeFrom/timeUntil</code>.</td>\n</tr>\n<tr>\n<td>8.2</td>\n<td>בלוקים בצבעים מופיעים ביומן.</td>\n<td>1. <code>addOrder()</code> / <code>addShift_inOrders()</code> מייצרים <code>&lt;div&gt;</code> עם סגנון גודל/מיקום.<br>2. משמרת פיקטיבית עלולה לחסום יום שלם.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 9: חיתוך הזמנות לפי יום/שבוע/חודש",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>9.1</td>\n<td>בוחר תצוגת יום/שבוע/חודש.</td>\n<td>1. הגדרת <code>$viewtype=1</code>/<code>2</code> או <code>weekly=1</code>.<br>2. אירועים ארוכים מקוצרים.</td>\n</tr>\n<tr>\n<td>9.2</td>\n<td>האירוע \"נחתך\" בגבולות התצוגה.</td>\n<td>עדכון <code>$calendarOrders[k]['timeFrom']</code> ו-<code>$calendarOrders[k]['timeUntil']</code>.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 10: מצב משתמש רגיל מול מנהל (adminAccess)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>10.1</td>\n<td>מנהל רואה כפתורי עריכה.</td>\n<td>1. <code>$adminAccess=1</code> מציג \"ערוך שבוע\" וכו'.<br>2. משתמש רגיל מוגבל לתצוגת הזמנותיו.</td>\n</tr>\n<tr>\n<td>10.2</td>\n<td>משתמש רגיל אינו רואה כפתורים מסוימים.</td>\n<td>1. אין \"ערוך שבוע\", אין \"הערות יומיות\".<br>2. סינון לפי <code>therapistID</code> (או <code>workerID</code>).</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 11: משמרות פיקטיביות (fictive) ונעילת יום",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>11.1</td>\n<td>רואה \"מטפל פיקטיבי\" שחוסם יום.</td>\n<td>1. <code>workerType='fictive'</code> מגדיר משמרת 00:00-23:59.<br>2. <code>status=0</code> עשוי להסתיר אותה.<br>3. שימוש ב-<code>bshift</code>/<code>ashift</code> לשעות.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 12: עריכת שבוע (weekly_shifts)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>12.1</td>\n<td>לוחץ על \"ערוך שבוע\" ליד מטפל.</td>\n<td>1. נשלח <code>masterID</code> + טווח שבועי.<br>2. עריכת המשמרות של אותו מטפל.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 13: Drag & Drop בהזמנה",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>13.1</td>\n<td>מנסה לגרור הזמנה בין תאים.</td>\n<td>1. אלמנטים עם <code>ondrop=\"drop(event)\"</code> ו-<code>ondragover=\"allowDrop(event)\"</code>.<br>2. יישום מלא לא בהכרח קיים.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 14: שינוי אתר (Site Select)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>14.1</td>\n<td>משתמש בוחר אתר חדש ב-<code>&lt;select&gt;</code>.</td>\n<td>1. פונקציה <code>select_site_id(ele)</code> מחלצת <code>asite=val</code> ומפנה ל-URL חדש.<br>2. <code>$_CURRENT_USER->active_site()</code> מעודכן, הטבלה נבנית לאתר החדש.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 15: סובב תצוגה (toggleFlip)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>15.1</td>\n<td>לוחץ \"סובב תצוגה\".</td>\n<td>1. <code>toggleFlip()</code> מוסיף/מסיר מחלקה <code>flipped</code> ל-<code>.atfusa</code>.<br>2. ההתאמות ב-<code>width/height</code> של האלמנטים נעשות ב-JS.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 16: מצב \"רחב\" (Wide) לעומת \"רגיל\"",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>16.1</td>\n<td>בוחר \"רחב\" או חוזר ל\"רגיל\".</td>\n<td>1. <code>$('.atfusa').addClass('wide')</code> או הסרה.<br>2. שמירת <code>wide=1</code> ב-storage / session.</td>\n</tr>\n</tbody>\n</table>"
        },
        {
          "title": "תרחיש 17: גרירה בעזרת העכבר לגלילה (Drag to scroll)",
          "content": "<table>\n<thead>\n<tr>\n<th>שלב</th>\n<th>צד המשתמש</th>\n<th>צד הקוד</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>17.1</td>\n<td>המשתמש לוחץ וגורר ברחבי הטבלה כדי לגלול.</td>\n<td>1. <code>mousedown</code> שומר מיקום, <code>mousemove</code> מחשב <code>dx</code>/<code>dy</code>.<br>2. <code>scrollLeft</code> ו-<code>scrollTop</code> מתעדכנים.</td>\n</tr>\n<tr>\n<td>17.2</td>\n<td>משחרר העכבר.</td>\n<td>1. <code>mouseup</code> מסיר את <code>mousemove</code>.<br>2. בודק אם היתה גרירה או קליק (ע\"י משתנה <code>dragging</code>).</td>\n</tr>\n</tbody>\n</table>"
        }
      ]
    },
    {
      "title": "קבצים שנבדקו לצורך absolute_calendar",
      "content": "<ul>\n<li><code>absolute_calendar.php</code> – הקובץ הראשי (נסרק במלואו).</li>\n<li><code>page7.json</code> – הדוקומנטציה המקורית שסופקה.</li>\n<li><code>ajax_daily_remarks.php</code> – משמש לטיפול בהערות יומיות (נסרק במלואו).</li>\n</ul>"
    },
    {
      "title": "קבצים חסרים להשלמת חלק מהתרחישים",
      "content": "<ul>\n<li><code>ajax_tfusa_view.php</code> – לא סופק במלואו (מוזכר בקוד).</li>\n<li>קובץ המכיל את המימוש של <code>udb::...</code> (לדוגמה <code>UserUtilsNew.php</code>), לא סופק.</li>\n<li>קבצים/הגדרות עבור <code>$domain_icon</code> ועוד.</li>\n</ul>"
    },
    {
      "title": "סיכום (absolute_calendar)",
      "content": "<ul>\n<li><strong>absolute_calendar.php</strong> אחראי על טעינת יומן משמרות/מטפלים/חדרים (כולל עובדים), תצוגות גמישות (יום/שבוע/חודש/רשימה), חיתוך אירועים, והערות יומיות.</li>\n<li>הקוד מטפל בהרשאות משתמש רגיל/מנהל, כולל אפשרות \"נעילת יום\" ומטפלים פיקטיביים לחסימות.</li>\n<li>יש הגדרות hours/holidays (sites_weekly_hours, sites_periods, not_holidays) להתאמת שעות פעילות וחופשות.</li>\n<li>עריכת שבוע, Drag & Drop וקינפוג נוסף דורשים קבצים חיצוניים נוספים (כגון ajax_tfusa_view.php ו-udb::...).</li>\n</ul>"
    }
  ]
}
