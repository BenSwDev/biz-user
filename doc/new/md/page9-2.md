# 1. הקדמה
מערכת זו מטפלת (באמצעות קבצי PHP) בניהול מטפלים (Therapists) באתרי ספא/טיפול שונים. מהתוכן שבקבצים עולה שהמערכת מאפשרת לבצע פעולות הוספה, עדכון ומחיקה של מטפלים, לצד ניהול הגדרות כלליות לאתר (כמו מגבלות, הגדרות תשלום, ועוד).  
להלן עיקרי הרציונל על בסיס המידע המופיע בקוד:

- **pages/treaters.php** מרכז את עיקר התצוגה והניהול של המטפלים בצד ממשק המשתמש, כולל:
    - טפסים להוספת מטפל חדש (רגיל או "פיקטיבי"), עדכון פרטי מטפל קיים (שם, כתובת, טלפון, מייל, העדפות מגדר, פוליסת ביטוח, חשבון בנק, סוג שכר ועוד), והצגת רשימת כל המטפלים.
    - לוגיקה לבדיקת הרשאות (באמצעות `$_CURRENT_USER`) כדי לוודא שהמשתמש המחובר מוסמך לפעול על האתר המסוים.
    - אפשרות להעלות קובץ פוליסת ביטוח לנתיב ייעודי ולמחוק קובץ ביטוח קיים.
    - מנגנון לטיפול ב"Salary" (שכר) לפי תעריף לדקה או לפי אחוזים, כולל עדכונים עתידיים.
- **ajax_delTreater.php** מטפל במחיקה של מטפלים דרך קריאת AJAX, ובודק אם יש למטפל הזמנות פעילות. אם יש הזמנות פעילות, המחיקה נמנעת; אחרת, המטפל נמחק לוגית (`deleted = 1` ו-`active = 0`).
- **ajax_settings.php** מאפשר עדכון של הגדרות באתר ובמטפלים באמצעות מגוון פעולות (`act` שונה ב-POST), כגון:
    - הגדרות תצוגה ביומן.
    - הגבלות, איסורים והפעלות אוטומטיות (למשל שליחת תזכורות, הסתרת תורים ריקים, דרישת כתובת או חדר, דרישות ביטול ועוד).
    - הגדרות שכר (ברמת האתר או ברמת המטפל), כולל שינוי סוג השכר (דקות או אחוזים) והזנת תעריפים חדשים.
- **ajax_limit_metaplim.php** מטפל בעדכון שדה `limit_metaplim` בטבלת האתרים (`sites`), שמגדיר מגבלה על תצוגת המטפלים.

סיכום כולל: מדובר במערכת לניהול מטפלים והגדרות הקשורות אליהם ואתר הספא/טיפול, המופעלת הן בצד התצוגה (בקובץ `pages/treaters.php`) והן בצד שרת (באמצעות קריאות AJAX לקבצים השונים).


# 2. הקבצים שנבדקו

1. **pages/treaters.php**
    - מציג ומנהל את רשימת המטפלים הקיימים.
    - מאפשר הוספה ועריכה של מטפלים (כולל העלאת פוליסה, הזנת חשבון בנק, הגדרת תאריך עבודה וכו’).
    - מכיל לוגיקה שמבצעת בדיקות הרשאה (באמצעות אובייקט `$_CURRENT_USER`) ופעולות על בסיס טופס שנשלח ב-POST.
    - מכיל רכיבי UI (טבלאות, כפתורים, טפסים) לניהול המטפלים.
    - מתייחס לשדות ולטבלאות כמו `therapists`, `therapists_treats`, `orders`, `sites` ומספק ממשק לניהול שכר מטפלים (בדקה/אחוזים).
    - מבצע קריאות AJAX (כמו `ajax_delTreater.php`, `ajax_settings.php`, `ajax_limit_metaplim.php`) לצורך פעולות מסוימות.

2. **ajax_delTreater.php**
    - קובץ AJAX למחיקת מטפל מהמערכת.
    - בודק הרשאות של המשתמש מול `siteID` של המטפל.
    - מאמת שהמטפל אינו מקושר להזמנות פעילות (`orders`), ואם יש – מונע מחיקה.
    - במידה ומותר למחוק, מעדכן את רשומת המטפל (`deleted = 1` ו-`active = 0`) ומאפס את `therapistID` בהזמנות הקשורות.

3. **ajax_settings.php**
    - קובץ AJAX כללי לעדכון שורה של הגדרות במערכת (גם בהקשר של מטפלים, גם בהקשר של אתרים).
    - פועל עם פרמטר `act` (דרך `$_POST`) ובהתאם לערך שלו מעדכן הגדרות שונות במסד הנתונים (`sites` או `therapists`):
        - הגדרות ביטול/תזכורות.
        - הגדרות שכר בסיס ואת שיטת החישוב (אחוזים/דקות) ברמה גלובלית (לאתר) או פר-מטפל.
        - הגדרת ימים מינימליים להזמנה מראש, דרישה לכתובת/חדר, ועוד.
    - מחזיר תשובה בפורמט JSON, עם מפתח `status` (0=הצלחה, 99=שגיאה) והודעות שונות.

4. **ajax_limit_metaplim.php**
    - קובץ AJAX לעדכון השדה `limit_metaplim` בטבלת `sites`.
    - מקבל `siteID` וערך `limit`, בודק הרשאות, ומעדכן את המסד.
    - מחזיר תשובה JSON בצורת הצלחה/כישלון.


# 3. הקבצים שלא נמצאו
אין קבצים המסומנים כ"לא נמצאו" (לא הופיע בתוכן שום ציון לקובץ שאמור להיות קיים אך בפועל חסר).


# 4. הקבצים שלא נבדקו
על סמך התוכן שבקבצים, אין הפניות לקבצים נוספים החיוניים שאינם ברשימה (פרט לאותם קבצים שההנחיות אומרות להתעלם מהם, כגון `auth.php` או `partial/...` וכו’).  
לפיכך, לא זוהו קבצים אחרים שיש בהם צורך לבדיקה.


# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

להלן תרחישי שימוש אפשריים, כפי שעולים מתוך הקוד שנסרק:

---

## תרחיש 1: הצגת רשימת המטפלים (בתוך `pages/treaters.php`)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
המשתמש (מנהל האתר) נכנס לעמוד `treaters.php` ורואה טבלה/list של כל המטפלים הקיימים. הוא יכול לסנן, לעבור בין מטפלים פעילים ולא-פעילים, ולגשת לאזור עריכת מטפל.

| מספר צעד | פעולה מצד המשתמש                         | תוצאה מצופה                                                                 |
|----------|------------------------------------------|------------------------------------------------------------------------------|
| 1        | נכנס ל־URL/דף של `treaters.php`          | הטבלה נטענת ומציגה רשימת מטפלים (כולל שם, מגדר, סוג העסקה, טלפון, אימייל וכו'). |
| 2        | לוחץ על כפתור "פעילים בלבד" או "לא פעילים" | מוצגים רק המטפלים העונים לתנאי שנבחר (פעילים או לא פעילים).                |
| 3        | מקליק על שם מטפל בטבלה                  | נפתח מסך/מעבר עריכה של אותו מטפל (כמתואר בתרחיש העריכה).                    |

### 2. תיאור המימוש בקוד (Back-End Perspective)

**תיאור כללי:**  
בתוך `pages/treaters.php` מתבצעת שאילתת בסיס נתונים לטבלת `therapists`, מצטרפות אליה טבלאות נוספות (`orders` וכו’) לצורכי ספירת הזמנות. המשתמש יכול להשתמש בכפתורים ובפונקציות JavaScript (למשל `openPop()`) כדי להיכנס לעריכת מטפל או לסינון המציג רק פעילים/לא פעילים.

| מספר צעד | לוגיקה טכנית                                                                                                                  | מיקום בקוד                                             | מבנה ותוכן הקוד                                                                                                                       |
|----------|------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------|
| 1        | `udb::full_list(...)` טוען את רשימת המטפלים מהטבלה `therapists` (מצורפות טבלאות כמו `orders` לחישוב הזמנות פעילות).         | סביב שורות 300–330 בקובץ `pages/treaters.php`          | שאילתת `SELECT ... FROM therapists LEFT JOIN orders ...` ולאחר מכן לולאה לבניית שורות הטבלה.                                          |
| 2        | הכנסת השורות לטבלה `<table id="therapists"> ...`                                      | סביב השורות שבהן מופיעה הטבלה `#therapists`            | משולבים בתוך `<tbody>` עם פקודות `echo` בשפת PHP, תוך התייחסות לשדות כמו `siteName`, `gender_self` ועוד.                              |
| 3        | מתווספות כפתורי "פעילים בלבד" / "לא פעילים" שמפעילים שינוי CSS (`#tblwrap`)             | בקוד ה־HTML + JavaScript (`$('#tblwrap').addClass(...)`) | פעולה זו מסתירה/מציגה את השורות `<tr>` באמצעות מחלקת CSS (לדוגמה `notactivet`).                                                        |
| 4        | לחיצה על שם המטפל (או על שדותיו) מפעילה `openPop(therapistID, siteID)` ב-JS, שמעבירה ל-URL עם `tID=therapistID`             | פונקציה `openPop()` בשורות JavaScript שבתוך הקובץ       | `location.href = "?page=treaters&tID=" + pageID + "&asite=" + siteID;`.                                                                |

---

## תרחיש 2: הוספת מטפל חדש (מתוך `pages/treaters.php`)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
המשתמש רוצה להוסיף מטפל חדש – הוא לוחץ על כפתור "הוסף חדש" וממלא פרטים שונים (שם המטפל, טלפון, תאריכי עבודה, חשבון בנק, ביטוח וכו’). בסיום לוחץ "שמור".

| מספר צעד | פעולה מצד המשתמש                               | תוצאה מצופה                                                         |
|----------|------------------------------------------------|----------------------------------------------------------------------|
| 1        | בעמוד הראשי של `treaters.php`, לוחץ על "הוסף חדש" | נפתח מסך/טופס עריכת מטפל ריק (tID=0) המאפשר למלא פרטי מטפל.         |
| 2        | ממלא את כל השדות הנדרשים (שם, אימייל, מגדר...)   | הטופס מוכן לשליחה; השדות מוצגים באותו עמוד עריכה.                   |
| 3        | מעלה קובץ פוליסת ביטוח (אם יש)                   | הקובץ נטען לטופס ונראה שצורף לפני השמירה הסופית.                    |
| 4        | לוחץ על כפתור "שמור"                             | מופיעה הודעה (או רענון), והמטפל החדש מופיע ברשימת המטפלים.          |

### 2. תיאור המימוש בקוד (Back-End Perspective)

**תיאור כללי:**  
בקובץ `pages/treaters.php` קיים טיפול ב-POST (בדיקת `if ('POST' == $_SERVER['REQUEST_METHOD'])`). בעת שליחת הטופס, מתבצעים בדיקות, שמירת הפרטים בטבלה `therapists`, ושמירה של קובץ הפוליסה בספרייה `../../insurances/` (אם הועלה).

| מספר צעד | לוגיקה טכנית                                                                                         | מיקום בקוד                       | מבנה ותוכן הקוד                                                                                                                          |
|----------|-----------------------------------------------------------------------------------------------------|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בדיקה האם `therapistID`==0 (כלומר, מטפל חדש)                                                        | פונקציית הטיפול ב־POST (סביבות שורה 350+) | אם `therapistID` עדיין לא קיים, מבצעים `INSERT` ל־`therapists` (תוך הקצאת `siteID`, `workerType`, ועוד).                                |
| 2        | `fileUpload(...)` בודקת ומעבירה את הקובץ לספריית `../../insurances/`, אם הועלה                       | פונקציה `moveSingleFile` ו־`fileUpload`   | נבדק גודל הקובץ, יוצרים שם ייחודי (מבוסס מיקרוטיים), מעבירים אותו, ומשנים הרשאות (0777).                                                |
| 3        | עיבוד שדות שונים (לדוגמה `insurance_expiry_date`, `workStart`, `workEnd`) לפורמט date ב־MySQL       | אחרי קליטת הנתונים (`typemap(...)`)       | ההמרה נעשית על ידי פיצול בתבנית `dd.mm.yyyy` והיפוך ל־`yyyy-mm-dd`.                                                                      |
| 4        | עדכון/הכנסה של השדות לבסיס הנתונים (כולל `therapists_treats` עבור טיפולים שהמטפל נותן, אם רלוונטי)  | בלוק ה־try ... catch הראשי        | מתבצע `udb::insert` או `udb::update` לפי המצב, ולאחר מכן שמירה של טיפולים בטבלת `therapists_treats`.                                     |

---

## תרחיש 3: הוספת מטפל "פיקטיבי" (מתוך `pages/treaters.php`)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
בדף המטפלים מופיע גם כפתור "הוסף פיקטיבי". מטפל פיקטיבי הוא ללא שם משתמש/סיסמא, ומשויך לטווח תאריכים מסוים (מתאריך-עד-תאריך) לשיבוץ זמני במערכת.

| מספר צעד | פעולה מצד המשתמש                                      | תוצאה מצופה                                                                      |
|----------|-------------------------------------------------------|-----------------------------------------------------------------------------------|
| 1        | לוחץ על "הוסף פיקטיבי" (או "הוסף פיקטיבי לתאריך")     | נפתח טופס למילוי תאריכים ולכל היותר מילוי שם כלשהו (אוטומטי אם לא הוזן).          |
| 2        | מזין "מתאריך" ו"עד תאריך" (שניהם חובה בממשק)          | בממשק מוצגים תאריכי ההתחלה והסיום לעבודה עבור אותו "מטפל".                         |
| 3        | לוחץ על כפתור "הוסף פיקטיבי"                          | המערכת שומרת את הרשומה כ־`workerType = 'fictive'`, לרוב ללא מייל או פרטים נוספים. |
| 4        | חוזר לרשימה ומזהה שהמטפל הפיקטיבי נוסף לרשימה         | ברשימה הוא מסומן כסוג "fictive", פעמים רבות ללא מגדר או פרטים נוספים.            |

### 2. תיאור המימוש בקוד (Back-End Perspective)

| מספר צעד | לוגיקה טכנית                                                                                            | מיקום בקוד                     | מבנה ותוכן הקוד                                                                          |
|----------|--------------------------------------------------------------------------------------------------------|--------------------------------|-------------------------------------------------------------------------------------------|
| 1        | בטופס שנשלח (POST) מוגדר `fictive=1`, וכן בדיקה פנימית שיוצרת שם מטפל אוטומטי: `'מטפל '.($tc + 1)`     | סביב שורות 70–80 (בדיקת `fictive`) | `udb::single_value("SELECT COUNT(*) ... WHERE workerType='fictive'")` לצורך קביעת המספור. |
| 2        | מזינים `workStart`, `workEnd` כערכי תאריכים בבסיס הנתונים (או NULL אם לא הוזנו)                         | קוד ההכנה של השדות לאחר `typemap` | מתבצע `UPDATE`/`INSERT` לטבלת `therapists`.                                               |
| 3        | ההרשומה נשמרת עם `workerType = 'fictive'` ו`gender_self = 3` (ללא מגדר ספציפי)                          | בתוך ה־try/catch                | כך אפשר להבדיל בין מטפל "רגיל" לבין מטפל "פיקטיבי".                                       |
| 4        | לאחר השמירה, מתבצע `header` או JavaScript redirect חזרה לדף `?page=treaters`                            | בסיום הבלוק, סביב שורה 190+     | קוד מסוג `<script>window.location.href = '?page=treaters';</script>` (או דומה).          |

---

## תרחיש 4: עריכת פרטי מטפל קיים (מתוך `pages/treaters.php`)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
המשתמש לוחץ על שם המטפל בטבלה, רואה טופס מלא בפרטיו, מבצע שינויים (שם, כתובת, טלפון, העדפות טיפול וכו’) ולוחץ "שמור".

| מספר צעד | פעולה מצד המשתמש                               | תוצאה מצופה                                                                                                      |
|----------|-----------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| 1        | לוחץ על שם המטפל בטבלת המטפלים                | עובר למסך עריכה שבו הטופס מאוכלס אוטומטית עם פרטי המטפל הנוכחי.                                                   |
| 2        | מעדכן שדות כרצונו (למשל שדות בנק, שינוי תוקף ביטוח, העלאת קובץ ביטוח חדש) | הטופס מתעדכן במידע החדש; אם מעלה קובץ, מצפה לראות קישור או אינדיקציה להעלאה.                                       |
| 3        | מסמן טיפולים (checkbox) שמטפל זה יכול לתת      | מופיעים בקטגוריית "טיפולים".                                                                                    |
| 4        | לוחץ "שמור"                                    | הפרטים נשמרים במסד הנתונים, והמשתמש שב לרשימת המטפלים.                                                           |

### 2. תיאור המימוש בקוד (Back-End Perspective)

| מספר צעד | לוגיקה טכנית                                                                                        | מיקום בקוד                       | מבנה ותוכן הקוד                                                                                  |
|----------|----------------------------------------------------------------------------------------------------|----------------------------------|---------------------------------------------------------------------------------------------------|
| 1        | קריאת פרטי המטפל מ־`therapists` לפי `tID` ב־GET                                                   | סביב שורה 250+                   | `udb::single_row("SELECT * FROM therapists WHERE therapistID=...")` לצורך הצגת נתוני המטפל.      |
| 2        | הטופס מוצג עם value ברוב השדות, ועם checkbox מסומן לכל טיפול שהוא כבר מציע (`therapists_treats`).   | בחלק HTML (סביב "טיפולים")       | לולאה על `treatments` + השוואה מול `tTreats` (IDs של טיפולים שיש למטפל).                         |
| 3        | בעת שליחת הטופס, אם `therapistID` קיים (>0), מתבצע `UPDATE` במקום `INSERT`.                         | פונקציית הטיפול ב־POST           | `udb::update('therapists', $siteData, 'therapistID=...')`.                                       |
| 4        | עדכון קובץ הביטוח (אם הועלה חדש), מחיקת קובץ קודם אם ביקשו `&del_insurance=1`.                     | שורות `if($_GET['del_insurance'] == 1) ...` ואח"כ `fileUpload('insurance_file',...)` | מוחק את הערך `insurance_file` או מעלה קובץ חדש לנתיב `/insurances/`.                                |

---

## תרחיש 5: מחיקת מטפל (באמצעות `ajax_delTreater.php`)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
ברשימת המטפלים, אם למטפל אין הזמנות פעילות, המשתמש יכול ללחוץ "מחק" (כפתור/אייקון פח). אם מאשרים – המטפל מוסר מהמערכת.

| מספר צעד | פעולה מצד המשתמש                                     | תוצאה מצופה                                          |
|----------|------------------------------------------------------|-------------------------------------------------------|
| 1        | לוחץ על "מחק" ליד המטפל                              | מופיעה הודעת אישור (Confirm) "האם אתה בטוח...?".      |
| 2        | מאשר את המחיקה                                       | קריאת AJAX נשלחת לקובץ `ajax_delTreater.php`.        |
| 3        | אין למטפל הזמנות פעילות → המחיקה מתבצעת בהצלחה       | המטפל נעלם מהרשימה; הודעה קצרה מוצגת (או רענון הדף).  |
| 4        | אם יש לו הזמנות פעילות → המחיקה נמנעת                | מתקבלת הודעת שגיאה עם הסבר שהמטפל מקושר להזמנות פעילות.|

### 2. תיאור המימוש בקוד (Back-End Perspective)

| מספר צעד | לוגיקה טכנית                                                                                                                 | מיקום בקוד                  | מבנה ותוכן הקוד                                                                                                                                    |
|----------|-----------------------------------------------------------------------------------------------------------------------------|-----------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | קליטת `therapistID` ב־POST ב־`ajax_delTreater.php`                                                                          | תחילת הקובץ (`ajax_delTreater.php`) | נבדק: `$therapistID = intval($_POST['therapistID'])`.                                                                                                |
| 2        | בדיקת הרשאות שמשתמש נוכחי מורשה לאותו `siteID` שבו המטפל.                                                                    | `if (!$siteID || !$_CURRENT_USER->has($siteID)) throw new Exception(...)` | מחזיר הודעת שגיאה JSON אם אין הרשאה.                                                                           |
| 3        | בדיקה אם יש למטפל הזמנות פעילות (`status=1`)                                                                               | `SELECT COUNT(*) FROM orders ... WHERE therapistID=... AND status=1`                                          | אם `count>0`, זורק Exception עם הסבר שהמטפל לא יכול להימחק.                                                   |
| 4        | מחיקה לוגית: `udb::update("therapists", ['deleted' => 1, 'active' => 0], ...);` וקביעת `therapistID=0` בטבלת `orders`.     | באותו קובץ, בשורות הסיום    | בסיום, מוחזר JSON עם `success=true`.                                                                                                                 |

---

## תרחיש 6: שינוי מגבלת תצוגת מטפלים (באמצעות `ajax_limit_metaplim.php`)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
בדף ניהול המטפלים (ב־`pages/treaters.php`) קיים select: "תצוגת טיפולים", שהמשתמש יכול לבחור בו "ללא הגבלה / יום נוכחי בלבד / יום אחד קדימה...". שינוי הבחירה שולח בקשת AJAX לשינוי הערך במסד.

| מספר צעד | פעולה מצד המשתמש                                           | תוצאה מצופה                                                         |
|----------|------------------------------------------------------------|----------------------------------------------------------------------|
| 1        | בוחר ערך חדש מה־select (למשל "1 = ליום נוכחי בלבד")        | קריאת AJAX יוצאת ל־`ajax_limit_metaplim.php` עם הפרמטרים המתאימים.   |
| 2        | התשובה מתקבלת מהשרת                                       | במידה וההגדרה הצליחה, עשויה להופיע הודעת "עודכן בהצלחה".             |
| 3        | יתכן שהממשק יעדכן באופן חזותי את הרשימה או רק ישמור הגדרה  | תלוי ב-JS. בדרך כלל, המשתמש יראה אישור שהמידע נשמר לשרת.             |

### 2. תיאור המימוש בקוד (Back-End Perspective)

| מספר צעד | לוגיקה טכנית                                                                                             | מיקום בקוד                               | מבנה ותוכן הקוד                                                         |
|----------|---------------------------------------------------------------------------------------------------------|------------------------------------------|--------------------------------------------------------------------------|
| 1        | `$.post('ajax_limit_metaplim.php', {limit:limit, siteID:siteID})...` נשלחת ב-JS מתוך `change_limit(...)` | בקובץ `pages/treaters.php` פונקציית JS  | פונקציית JavaScript שמופעלת בעת שינוי `<select>`.                        |
| 2        | ב־`ajax_limit_metaplim.php`: בדיקת הרשאה (`$_CURRENT_USER->has($siteID)`)                                | `ajax_limit_metaplim.php` כולו          | אם אין הרשאה, מחזירים `error`; אחרת מעדכנים `limit_metaplim`.           |
| 3        | `udb::query("UPDATE sites SET limit_metaplim = ...")`                                                  | שורות הסיום של `ajax_limit_metaplim.php` | לאחר ההצלחה מחזירים JSON עם `status='success'`.                          |

---

## תרחיש 7: עדכון הגדרות כלליות (באמצעות `ajax_settings.php`)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
במערכת קיימות הגדרות נוספות (למשל הגדרות שכר אתר, הגדרות שליחת תזכורות, הגדרות ביטול). המשתמש עובר למסך/כפתור הגדרות (שאינו מוצג במפורש בקוד ה-HTML שסופק, אך נרמז בקוד), בוחר מה להפעיל/לכבות, לוחץ "שמור" או מפעיל סקריפט JS ששולח AJAX.

| מספר צעד | פעולה מצד המשתמש                          | תוצאה מצופה                                                |
|----------|-------------------------------------------|-------------------------------------------------------------|
| 1        | בוחר הגדרה לשנות (למשל "hideUnfilled")    | נשלחת קריאת AJAX אל `ajax_settings.php?act=hideUnfilled`.  |
| 2        | הגדרה נשמרת בהצלחה                        | המשתמש מקבל חיווי שהשינוי נעשה, ומסך ההגדרות מתעדכן.       |
| 3        | שגיאה בהרשאות או בנתונים                  | מוצגת הודעת שגיאה JSON עם `status=99`.                     |

### 2. תיאור המימוש בקוד (Back-End Perspective)

| מספר צעד | לוגיקה טכנית                                                                                                                                  | מיקום בקוד                     | מבנה ותוכן הקוד                                                                                                              |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| 1        | פונקציית `switch($_POST['act'])` ב־`ajax_settings.php` מבצעת עדכונים שונים למסד (שדה מסוים בטבלה `sites` או `therapists`).                   | בקובץ `ajax_settings.php`      | לדוגמה: `case 'hideUnfilled': ... udb::update('sites', ['hideUnfilled' => $hideUnfilled], ...)`.                              |
| 2        | כל פעולה דורשת בדיקת הרשאות שהמשתמש מסוגל לערוך את ה־`siteID` הנבחר.                                                                          | `if (!$_CURRENT_USER->has($sid)) throw new Exception("Access denied...");` | במקרה של כישלון, מוחזרת שגיאה JSON; אחרת `status = 0` (הצלחה).                                                              |
| 3        | שימוש באובייקטים כמו `SalarySite` או `SalaryMaster` לחישוב עדכוני שכר עתידיים (דקות או אחוזים).                                              | חלקי קוד ב־switch כמו `baseSalaryNew` או `masterSalaryNew` | עדכונים נשמרים ב־טבלאות `salaryLog` ובהתאם לכך נקראים בהמשך, או נשמרים ישירות בעמודת `salaryDefault` / `salary` כ־JSON.    |
| 4        | תגובה מחזירה JSON דרך אובייקט `JsonResult` שמגדיר `status` וייתכן גם `error` או שדות נוספים (כמו `amount`).                                  | סוף הקובץ `ajax_settings.php`  | `$result['status'] = 0; echo json_encode($result);` וכו’.                                                                     |

---

# 6. מסמך שימוש (מדריך למשתמש)

להלן הסבר קצר למשתמש כיצד לעבוד עם דף ניהול המטפלים:

1. **כניסה לדף המטפלים**
    - גש לכתובת (URL) המובילה ל־`pages/treaters.php`.
    - תראה טבלה עם מטפלים. ניתן לבחור להציג פעילים בלבד או לא פעילים.

2. **הוספת מטפל חדש**
    - לחץ על הכפתור "הוסף חדש".
    - מלא את הפרטים (שם המטפל, מגדר, אימייל, טלפון ועוד).
    - תוכל להעלות קובץ פוליסת ביטוח במידת הצורך.
    - לסיום לחץ "שמור" – המטפל יופיע ברשימה.

3. **הוספת מטפל פיקטיבי**
    - לחץ על הכפתור "הוסף פיקטיבי" או "הוסף פיקטיבי לתאריך".
    - מלא את טווח התאריכים המבוקש (החל מ... עד...).
    - לחץ "הוסף פיקטיבי" – המטפל הפיקטיבי יתווסף לרשימה עם סוג Worker "fictive".

4. **עריכת מטפל קיים**
    - לחץ על שם המטפל ברשימה.
    - שנה את הפרטים הרצויים (כולל פרטי חשבון בנק, תוקף ביטוח, סוג התשלום, סיסמה וכדומה).
    - רד לתחתית העמוד ולחץ "שמור" לשמירת העדכונים.

5. **מחיקת מטפל**
    - אם מטפל אינו קשור להזמנה פעילה, תופיע אפשרות "מחק" (אייקון פח).
    - לחץ "מחק" ואשר את הפעולה.
    - אם למטפל יש הזמנות פעילות – ייתכן שתתקבל הודעת שגיאה ולא ניתן יהיה למחוק.

6. **שינוי מגבלת תצוגת מטפלים**
    - בעמוד הראשי, ליד "תצוגת טיפולים", בחר אחת מהאפשרויות (ללא הגבלה, יום נוכחי בלבד, יום קדימה וכו’).
    - ההגדרה נשמרת אוטומטית מול המסד ותזכה להודעת "עודכן בהצלחה".

7. **עדכון הגדרות מתקדמות**
    - אם קיימת לשונית הגדרות/כפתור כלשהו (לא מוצג במפורש בקוד שניתן), ניתן ללחוץ ולבחור להדליק או לכבות תכונות (כגון `hideUnfilled`).
    - כל בחירה או כיבוי נעשית באמצעות AJAX (`ajax_settings.php`), ולאחריה אמורה להופיע הודעה על הצלחה או כישלון.

# 7. סיכום
בקבצים שסופקו נבנתה מערכת לניהול מקיף של מטפלים ואתרי טיפול, כולל הוספה, עריכה, מחיקה, העלאת קובצי ביטוח והגדרת טווחי תאריכים לעבודת המטפל. כמו כן, קיימים מנגנוני הגדרות (בין אם זה הגדרות תצוגה, חישוב שכר, ועוד) המתעדכנים ב-AJAX, ומערך הרשאות המבטיח שרק משתמשים מורשים יוכלו לבצע פעולות על אתר או מטפל מסוים. מערכת זו מאפשרת ניהול יעיל ומרוכז של צוות המטפלים והתנאים הקשורים אליהם.


