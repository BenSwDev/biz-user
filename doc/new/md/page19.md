# 1. הקדמה
המסמך שלפניכם מרכז את המידע שנאסף מתוך הקובץ היחיד שנמצא ונסרק במלואו: `pages/vilasavail.php`. מטרת המסמך היא להציג ניתוח מלא של הקוד והתוכן, בהתאם להנחיות, ולספק תרחישי שימוש ותרחישי זרימה (Use Flows) המשלבים הן את נקודת המבט של המשתמש (Front-End) והן את נקודת המבט של המפתח (Back-End).

כל המידע והניתוחים המופיעים כאן מבוססים **אך ורק** על מה שניתן להסיק באופן וודאי מתוך התוכן של הקובץ `pages/vilasavail.php`. לא נוספו פרטים או השערות שאינן מבוססות על התוכן בפועל.

---

# 2. הקבצים שנבדקו
1. **pages/vilasavail.php**
    - **תוכן עיקרי בקובץ**:
        - כולל שתי פונקציות עיקריות:
            1. `apiCallGET($act, $siteID)` – מבצעת קריאת GET לכתובת `https://www.vila.co.il/api/data-for-biz.php?key=avg142f2g!00a&act=...&siteid=...`.
            2. `apiCallPOST($act, $siteID)` – מבצעת קריאת POST לאותה כתובת, ומעבירה את כל משתני `$_POST`.
        - מבצע שאילתת SQL (`select portalsID from sites where siteID=...`) כדי לשלוף את `portalsID`.
        - אם הבקשה היא בשיטת `POST`, מתבצע עדכון זמינות באמצעות `apiCallPOST("updateAvail", $portalsID)`.
        - נטען HTML כלשהו (מתוך `$periodHtml['html']`), שמגיע כתוצאה מקריאת `apiCallGET('getperiods', $portalsID)`.
        - בקוד מופיעה כותרת בעברית: "הגדרות זמינות לאתרי וילה פור יו ווילה", וכן מנגנון הצגת הודעה במקרה שלא מחוברים לאתרי וילה.
        - עיצוב CSS בסיסי מוצג בתגיות `<style>` לצורך הצגת טבלה, שורות, וסגנון לכפתור שליחת הטופס.

---

# 3. הקבצים שלא נמצאו
אין כל קובץ נוסף שהוגדר ברשימה המקורית כ"קיים" אך בפועל סומן כ"לא נמצא". לפיכך, רשימה זו ריקה.

---

# 4. הקבצים שלא נבדקו
להלן רשימת הקבצים או המשאבים המזוהים מתוך תוכן הקובץ `pages/vilasavail.php`, אך אינם מופיעים כלל ברשימה של קבצים שנבדקו או כקבצים שלא נמצאו:

1. **`data-for-biz.php`**
    - מוזכר בכתובת `https://www.vila.co.il/api/data-for-biz.php?key=...` כמשאב חיצוני; אינו מופיע ברשימות הקבצים המקומיות, ולכן לא נסרק בפועל.

*שים לב*: אין בקובץ אזכורים לקבצים כמו `index.php`, `partial/menu.php` או `functions.php`, ולכן אין צורך להתייחס אליהם.

---

# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

להלן הניתוח המקיף של תרחישי השימוש הקיימים בקובץ `pages/vilasavail.php`.  
ניתן לזהות שני תרחישים עיקריים:

## תרחיש שימוש 1: טעינת העמוד ובדיקת חיבור לאתרי וילה

### 1.1 תיאור משתמש הקצה (Front-End Perspective)
- **תיאור כללי:**  
  המשתמש נכנס לעמוד "הגדרות זמינות לאתרי וילה פור יו ווילה" (`pages/vilasavail.php`). הוא מצפה לראות את אפשרויות ההגדרה או לגלות שהוא אינו מחובר לאתרי וילה.

- **טבלת צעדי התרחיש מצד המשתמש:**

| **מספר צעד** | **פעולה מצד המשתמש**               | **תוצאה מצופה**                                         |
|--------------|-------------------------------------|---------------------------------------------------------|
| 1            | ניגש לכתובת `pages/vilasavail.php`  | העמוד נטען, נבדק האם המשתמש מקושר לאתרי וילה           |
| 2            | המתנה לטעינת התוכן                  | אם לא מחובר – מוצגת הודעה "לא מחובר לאתרי וילה..."     |
| 3            | -                                   | אם מחובר – מוצגת כותרת והטבלה/טופס הגדרות הזמינות      |

### 1.2 תיאור המימוש בקוד (Back-End Perspective)
- **תיאור כללי:**  
  בעת טעינת העמוד, מתבצעת שאילתת SQL לשם קבלת `portalsID`. אם לא מתקבל ערך, מחזירים הודעה מתאימה ומפסיקים את תהליך הטעינה. אחרת, ממשיכים בקריאה לפונקציית `apiCallGET('getperiods', $portalsID)` ומדפיסים את ה-HTML המוחזר בתוך `$periodHtml['html']`.

- **טבלת צעדי התרחיש מצד המתכנת:**

| **מספר צעד** | **לוגיקה טכנית**                                                                                          | **מיקום בקוד**                                  | **מבנה ותוכן הקוד**                                                                                                                                                                                                     |
|--------------|-----------------------------------------------------------------------------------------------------------|-------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1            | שליפת `portalsID` מהטבלה `sites` לפי `siteID` (מהמשתמש הנוכחי)                                          | סביב השורה: `\$sql = "select portalsID..."`    | `udb::single_value($sql)` מחזיר ערך יחיד מתוך בסיס הנתונים.                                                                                                                                                              |
| 2            | בדיקה אם הערך `portalsID` קיים                                                                           | בסמוך ל-`if(!$portalsID)`                      | אם אין ערך, מוצג "לא מחובר לאתרי וילה..." ו־`return;`.                                                                                                                                                                  |
| 3            | קריאה לפונקציה `apiCallGET('getperiods', $portalsID)`                                                   | בסמוך לשורה: `\$periodHtml = apiCallGET(...)`  | `apiCallGET` מבצעת `curl_init`, `curl_setopt` ומחזירה JSON מפוענח. הערך `$periodHtml` מחזיק מפתח `'html'`.                                                                                                              |
| 4            | הדפסה של `$periodHtml['html']`                                                                           | `echo $periodHtml['html']`                     | מכיל כנראה טופס או מקטע HTML המייצג את הגדרות הזמינות בעמוד.                                                                                                                                                            |

---

## תרחיש שימוש 2: שליחת טופס עדכון זמינות

### 2.1 תיאור משתמש הקצה (Front-End Perspective)
- **תיאור כללי:**  
  המשתמש ממלא טופס (שהוצג בעמוד) ומעדכן זמינות לתאריכים או לתקופות מסוימות, ולאחר מכן לוחץ על כפתור "שלח" (submit).

- **טבלת צעדי התרחיש מצד המשתמש:**

| **מספר צעד** | **פעולה מצד המשתמש**                           | **תוצאה מצופה**                                                                                  |
|--------------|-----------------------------------------------|--------------------------------------------------------------------------------------------------|
| 1            | ממלא נתונים בטופס (סימון צ'קבוקסים, תאריכים וכו') | עדכון השדות לפי ההעדפות (לדוגמה בחירת תאריכים פנויים/תפוסים)                                   |
| 2            | לוחץ על כפתור ה-Submit                         | נשלחת בקשת POST לעמוד `pages/vilasavail.php`                                                     |
| 3            | ממתין לטעינה מחדש של העמוד                     | המשתמש רואה עדכון ויזואלי בהתאם למה שהוחזר מאותו `apiCallPOST` (אם יש הודעת הצלחה/כישלון וכדומה) |

### 2.2 תיאור המימוש בקוד (Back-End Perspective)
- **תיאור כללי:**  
  עם שליחת הטופס ב-POST, העמוד מזהה את שיטת הבקשה `$_SERVER['REQUEST_METHOD'] === 'POST'`, וקורא לפונקציית `apiCallPOST("updateAvail", $portalsID)` שמעבירה את כל תוכן `$_POST` אל ה-API החיצוני. לאחר מכן מתקבלת תשובה שמאוחסנת במשתנה `$updateResponse`.

- **טבלת צעדי התרחיש מצד המתכנת:**

| **מספר צעד** | **לוגיקה טכנית**                                                                                   | **מיקום בקוד**                           | **מבנה ותוכן הקוד**                                                                                                                                                                                                                     |
|--------------|----------------------------------------------------------------------------------------------------|------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1            | זיהוי שיטת הבקשה כ-POST                                                                           | `if ($_SERVER['REQUEST_METHOD'] ... )`   | `if ($_SERVER['REQUEST_METHOD'] === 'POST') {...}`                                                                                                                                                                                      |
| 2            | שליפת משתנה `period` (וייתכן גם שדות נוספים) מתוך `$_POST`                                        | מיד לאחר בדיקת שיטת הבקשה               | `$period = $_POST['period'];` (ייתכנו שדות נוספים בהתאם למה שנשלח מהטופס).                                                                                                                                                               |
| 3            | קריאה ל-`apiCallPOST("updateAvail", $portalsID)`, המעבירה את כל תוכן `$_POST` כ-POST ל-API החיצוני | `\$updateResponse  = apiCallPOST(...)`   | `curl_init`, `curl_setopt` עם `CURLOPT_POSTFIELDS = http_build_query($_POST, '', '&')`, ולאחר מכן פענוח JSON של התשובה המוחזרת.                                                                                                        |
| 4            | עיבוד תשובת ה-API                                                                                | `print_r($updateResponse);`             | מדפיס את התוכן שקיבל מה-API לאחר העדכון; באפשרות המתכנת להוסיף טיפול משלים (למשל הצגת "נשמר בהצלחה" וכו').                                                                                                                               |

---

# 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך קצר בשפה ידידותית, צעד אחר צעד, לשימוש בדף `pages/vilasavail.php`:

1. **כניסה לדף "הגדרות זמינות"**  
   פתחו את הקישור לכתובת `pages/vilasavail.php`.
    - אם אינכם מחוברים לאתרי וילה, תופיע הודעת שגיאה ולא תוכלו להגדיר זמינות.
    - אם אתם מחוברים, תראו כותרת בשם "הגדרות זמינות לאתרי וילה פור יו ווילה" ומתחתיה טבלה או טופס להזנת פרטי זמינות.

2. **בחירת התקופות והאפשרויות**  
   בטבלה המוצגת, סמנו או בחרו את הפרטים הרלוונטיים (לדוגמה: תאריכים פנויים או תפוסים).

3. **שליחת הטופס**  
   לחצו על כפתור ה-Submit (ייתכן שיהיה מסומן כ"הוספה" או "עדכון", בהתאם ל-HTML שהגיע מה-API).
    - הדף ייטען מחדש ויבצע עדכון זמינות מאחורי הקלעים באמצעות קריאה ל-API.

4. **קבלת חיווי**  
   לאחר השליחה, תוכלו לראות הודעת מצב או בדיקות שונות (כמו הצלחה/כישלון) בהתאם לערכים המודפסים על ידי `$updateResponse`.

---

# 7. סיכום
במסמך זה הצגנו את הניתוח המלא של הקובץ `pages/vilasavail.php`, הכולל את פונקציות ה-API (GET/POST), הלוגיקה לבדיקת חיבור לאתרי וילה, ואת הטעינה והעיבוד של טופס זמינות.  
ראינו שני תרחישי שימוש עיקריים: צפייה/טעינת דף הגדרות הזמינות, ופעולת עדכון הזמינות עצמה. תרחישי השימוש שילבו את נקודת המבט של המשתמש (Front-End) ואת נקודת המבט של המפתח (Back-End).  
לבסוף, צורף מדריך ידידותי למשתמש, המפרט את הצעדים לצורך ביצוע העדכונים השוטפים בעמוד זה.


