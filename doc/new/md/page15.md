# 1. הקדמה
להלן מסמך המסכם את שלושת הקבצים שנמצאו וסרקנו במלואם: **pages/prices.php**, **prices.php**, וכן **ajax_global.php**. המסמך מבוסס אך ורק על התוכן הקיים בפועל בקבצים אלו, ללא השלמות או פרשנויות מעבר למה שקיים במפורש.

בקבצים אלה קיים ממשק לניהול מחירים ותקופות באתר מסוים, הכולל מעבר בין אתרים (sites), הגדרת חדרים (rooms), חגים ותקופות (periods), הגדרת “מינימום לילות” (minNights) ועוד. כמו כן, קיימת לוגיקת Ajax (ב-`ajax_global.php`) לטיפול בפעולות כגון הוספת תקופות חדשות, עריכתן, מחיקתן, סנכרון (sync) ועוד. כל זאת במטרה לתת למשתמש ממשק ניהול גמיש בעריכת המחירים וההגדרות הקשורות בחדרי האתר.


# 2. הקבצים שנבדקו
1. **pages/prices.php**
    - אחראי להצגת רשימת אתרים (sites) באמצעות לולאה על בסיס נתונים, וכל אחד מהאתרים מופיע כ"טאב" (div עם class="tab").
    - בלחיצה על הטאב, פונקציית `changeTab(siteid)` מחליפה את הכתובת של iframe ל-`prices.php?asite=siteid`.
    - כולל קוד CSS בסיסי שמסדר את מראה הטאבים וה-iframe.
    - מכיל JavaScript הפועל בשילוב jQuery (שבו מוסר ה-class "active" מכל הטאבים ומוסף לטאב הנבחר).

2. **prices.php**
    - נכלל בו `include_once "auth.php"` (אינו מצריך רשומת "לא נבדק" לפי ההנחיות).
    - הקובץ מאחזר מידע מה-DB לגבי חדרים (rooms), תקופות (periods) וחגים (holidays), מפעיל לוגיקה למניעת כפילויות, ומציג את התוצאות לפי סדר זמנים (תאריכים).
    - יוצרת מבנה HTML עם אלמנטים הבאים:
        - רשימת תקופות (divים עם `class="item callable"`) כגון "מחיר רגיל", "תקופה חמה" וחגים/תאריכים מיוחדים.
        - אזור עריכה של מינימום לילות (minNights) וימי סופ"ש (weekend).
        - כפתורי JavaScript ו-Ajax (באמצעות `$.post(...)`) לטיפול ב:
            - `getMin`, `sync`, `roomPrices`, `roomPricesDay`, `savePrices`, `savePricesDay`, `saveMinNights`, `saveWeekend`, `newPeriod`, `editPeriod`, `removePeriod` ועוד.
    - הקוד מפעיל אובייקט בשם `PriceCaller` אשר שולח בקשות Ajax ל-`ajax_global.php` ומעדכן חלקים שונים בתצוגה (UI).
    - מאפשר גם הוספת תקופות חדשות (פופאפ עם טופס "הוספת תקופה חדשה") ועריכת תקופה קיימת (פופאפ הכולל עריכת שם, תאריכי התחלה/סיום, ומחיקת תקופה).

3. **ajax_global.php**
    - מכיל לוגיקת צד שרת (Back-End) עבור הקריאות ה-אסינכרוניות (Ajax).
    - בתוכו קיימת `switch` גדולה על `$_POST['act']`, ובה מימוש של פעולות שונות, כגון:
        - **getMin**, **saveMinNights**, **saveWeekend**, **sync** (סנכרון עם תקופה חמה), **newPeriod**, **editPeriod**, **removePeriod** (מחיקת תקופה), **roomPrices**, **roomPricesDay**, **savePricesDay**, **savePrices** וכו'.
        - חלק מהפעולות מתייחסות גם לעדכוני DB בטבלאות `rooms_prices`, `rooms_min_nights`, `sites_periods` וכד'.
    - מטפל גם בפעולות נוספות כמו `ownComment`, `treatmentStartTimes`, `sameDayOrderHoursBefore`, ופעולות נוספות, אך לפי הקוד שסופק לא נצפה בהן שימוש ישיר בדפי ה-Front-End הנוכחיים (pages/prices.php או prices.php).
    - בסיום מפיק תשובות ב-JSON (מפתח `status`, `error`, ועוד).


# 3. הקבצים שלא נמצאו
לא נמצאו קבצים שהוגדרו כ"לא נמצאו" ברשימה ששיתפת – כלומר אין ברשימה קבצים שמופיעים כ"חסרים".


# 4. הקבצים שלא נבדקו
להלן קבצים/תכולות שמוזכרים בקוד אך אינם מופיעים ברשימת הקבצים שנבדקו או ברשימת הקבצים שלא נמצאו, ועל כן לא נסרקו בפועל:

- **assets/css/jquery.ui.all.css**
- **assets/css/styleprices.css**
- **assets/css/sweetalert2.min.css**
- **assets/addons/datetimepicker/jquery.datetimepicker.full.min.css**
- **assets/js/jquery-2.2.4.min.js**
- **assets/js/jquery.ui.min.js**
- **assets/js/jquery.ui.datepicker-he.js**
- **assets/addons/datetimepicker/jquery.datetimepicker.full.min.js**
- **assets/js/sweetalert2.min.js**
- **assets/js/website.js**
- **assets/js/local_loader.js**
- **assets/js/owl.carousel.min.js** (מופיע בהערה מקומנט)
- **SearchCache** ו-**reviewcomment** (מחלקות או ספריות חיצוניות שמופעלות בקוד)

> **הערה**: לפי ההנחיות אין צורך להזכיר קבצים כמו `auth.php`, `index.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php`, `functions.php` – גם אם הם לא קיימים ברשימה. לפיכך הם לא מופיעים כאן.


# 5. תרחישים כוללים בעמוד
להלן כלל התרחישים (Use Flow Scenarios) שניתן לזהות במערכת, בהתבסס על שלושת הקבצים שנסרקו. כל תרחיש מפוצל להיבט משתמש הקצה (Front-End) ולהיבט המפתח (Back-End).

---

## תרחיש 1: מעבר בין אתרים (Site) בדף הראשי (pages/prices.php)
### (1) תיאור משתמש הקצה
- **תיאור כללי**: המשתמש נכנס לדף `pages/prices.php` ורואה טאבים המייצגים אתרים שונים. כשלוחצים על טאב מסוים, העמוד מעדכן את התוכן ב-iframe.
- **טבלת צעדים (Front-End)**

| מספר צעד | פעולה מצד המשתמש                       | תוצאה מצופה                                                                                 |
|----------|----------------------------------------|---------------------------------------------------------------------------------------------|
| 1        | רואה את רשימת האתרים כטאבים            | הטאב של האתר הפעיל מוצג עם class="active"                                                   |
| 2        | לוחץ על טאב של אתר אחר                 | ה-tab מקבל class="active" והאחרים מאבדים את ה-"active".                                     |
| 3        |                                        | כתובת ה-iframe מתעדכנת ל-`prices.php?asite=<siteID>`.                                       |


### (2) תיאור המימוש בקוד
- **תיאור כללי**:  
  בקובץ `pages/prices.php`, מתבצעת שאילתת SELECT לקבלת רשימת האתרים מ-DB, ולאחר מכן לכל אתר נוצר רכיב `<div class="tab ...">` ב-PHP.   
  הקוד מגדיר פונקציית JavaScript `changeTab(siteid)` שמשנה את ה-src של ה-iframe לכתובת המתאימה.

| מספר צעד | לוגיקה טכנית                                                                                 | מיקום בקוד            | מבנה ותוכן הקוד                                                                                           |
|----------|----------------------------------------------------------------------------------------------|-----------------------|-------------------------------------------------------------------------------------------------------------|
| 1        | שאילתת SELECT לשליפת האתרים (`$que = "SELECT sites.siteID, sites.siteName ... "`)           | `pages/prices.php`    | `$sites = udb::full_list($que);`                                                                             |
| 2        | יצירת `<div>` עבור כל אתר עם `onclick="changeTab(...)"`                                      | `pages/prices.php`    | `<div id="tab<?=$site["siteID"]?>"...><?=$site["siteName"]?></div>`                                          |
| 3        | JS: פונקציה `changeTab(siteid)` מסירה class 'active' מכל הטאבים ומוסיפה לאחד הנוכחי         | `<script>...</script>`| `$('#prices').attr('src','prices.php?asite='+siteid);`                                                      |

---

## תרחיש 2: הצגת נתוני תקופות ומחירים (prices.php)
### (1) תיאור משתמש הקצה
- **תיאור כללי**: לאחר הבחירה בטאב (מתרחיש 1), ה-iframe טוען את `prices.php?asite=<siteID>`. שם המשתמש רואה רשימת תקופות (רגיל, חמה, תאריכים מיוחדים), וכן רכיבים לעריכת פרמטרים (למשל מינימום לילות).
- **טבלת צעדים (Front-End)**

| מספר צעד | פעולה מצד המשתמש                                    | תוצאה מצופה                                                         |
|----------|-----------------------------------------------------|---------------------------------------------------------------------|
| 1        | נכנס/מגיע לדף `prices.php` באייפריים               | מוצגות תקופות בסיסיות (מחיר רגיל/חם) + חגים/תאריכים (אם קיימים).    |
| 2        | לוחץ על תקופה מסוימת                               | הפריט הנבחר מקבל class="active", נטענים/מוצגים הגדרות לפי אותה תקופה.|

### (2) תיאור המימוש בקוד
- **תיאור כללי**:  
  בקובץ `prices.php`, מתבצעות שאילתות לקבלת rooms, periods (רגיל, חמה, וחגים). התוצאות מוצגות כ-div עם data-attributes כמו `data-period="..."` ו-`data-value="<periodID>"`. JavaScript שבלחיצה קורא בפוסט ל-`ajax_global.php` (act = "getMin"/"roomPrices" וכו') בהתאם להקשר.

| מספר צעד | לוגיקה טכנית                                                                                       | מיקום בקוד  | מבנה ותוכן הקוד                                                                               |
|----------|----------------------------------------------------------------------------------------------------|-------------|-----------------------------------------------------------------------------------------------|
| 1        | שליפת חדרים `SELECT roomID, roomName FROM rooms ...`                                             | `prices.php`| `$room = udb::full_list($que);`                                                               |
| 2        | שליפת תקופות `SELECT * FROM sites_periods WHERE siteID=...` (רגילות וחמות)                      | `prices.php`| `$periods = udb::key_list($que, 'periodType');`                                               |
| 3        | שליפת חגים (holidays) שלא הוצמדו כבר ל-periods                                                   | `prices.php`| `$holidays = udb::key_row($que, 'holidayID');`                                                |
| 4        | מיזוג תקופות/חגים למערך `$periods` ומיון לפי תאריכי התחלה                                        | `prices.php`| `usort($periods, function($a, $b){ ... });`                                                   |
| 5        | יצירת `<div class="item callable" data-param="periodID" data-value="...">` לכל תקופה             | `prices.php`| `<div class="item callable" data-period="<?=...?>" data-value="<?=$periodID?>">...</div>`      |
| 6        | JS: בלחיצה מפעילים `caller.set(data.param, data.value, data.refresh)` => שולח Ajax ל-`ajax_global.php` | `<script>` | `$.post('ajax_global.php', {act:'getMin', periodID:...}).then(...)` ועוד קריאות דומות         |

---

## תרחיש 3: עריכת מחירים יומיים ומינימום לילות
### (1) תיאור משתמש הקצה
- **תיאור כללי**: המשתמש בוחר תקופה וחדר, מקבל טבלה/ממשק לעריכת הגדרות "מינימום לילות" (עבור כל יום בשבוע), וכן הגדרות מחירים לפי יום.
- **טבלת צעדים (Front-End)**

| מספר צעד | פעולה מצד המשתמש                                      | תוצאה מצופה                                                                                 |
|----------|-------------------------------------------------------|---------------------------------------------------------------------------------------------|
| 1        | בוחר תקופה וחדר                                      | נטען ממשק שבו ניתן לשנות ערכי minNights, minVoid, הגדרת אמצ"ש/סופ"ש (checkbox), מחירי לילה וכו'. |
| 2        | משנה ערך אחד (למשל ב-select של מינימום לילות)         | מתבצעת קריאת Ajax ל-`ajax_global.php` עם `act='saveMinNights'` או `act='saveWeekend'` וכו'.  |
| 3        | לוחץ "שמירה" או משנה מחירים בטופס מחירים             | הערכים נשמרים ב-DB (דרך Ajax), והמסך מתעדכן/מרענן.                                         |

### (2) תיאור המימוש בקוד (Back-End)
- **תיאור כללי**:  
  ב-`prices.php` קיימות פונקציות JavaScript הקוראות ל-`PriceCaller` (ובעצם ל-`ajax_global.php`). בצד השרת, `ajax_global.php` מממש שלל פעולות ב-switch (למשל `saveMinNights`, `saveWeekend`, `savePrices` ועוד), שמבצעות שאילתות עדכון מול DB.

| מספר צעד | לוגיקה טכנית                                                                                           | מיקום בקוד          | מבנה ותוכן הקוד                                                                                                                                                    |
|----------|--------------------------------------------------------------------------------------------------------|---------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בלחיצה על select (onchange), JS שולח `act='saveMinNights'` / `saveWeekend' וכו' ל-ajax_global.php      | `prices.php`        | `$.post('ajax_global.php', {act:'saveMinNights',...})`                                                                                                            |
| 2        | ב-`ajax_global.php`: case 'saveMinNights' => עדכון טבלת `rooms_min_nights` לפי `$periodID` ו-$day.    | `ajax_global.php`   | `udb::insert('rooms_min_nights', [...], true, false);`                                                                                                             |
| 3        | באופן דומה, עריכת "סופ"ש" (weekend) => case 'saveWeekend' => עדכון שדה `weekend` ב-`sites_periods`.   | `ajax_global.php`   | `udb::update('sites_periods', [...], "...");`                                                                                                                      |
| 4        | כאשר לוחצים "שמירה" על טופס מחירים (כמו `buttonPriceForm`), JS קורא `save_prices(...)` => act='savePrices' | `prices.php`        | `$.post('ajax_global.php', {act:'savePrices', ...})`                                                                                                              |
| 5        | ב-case 'savePrices': מכניס או מעדכן טבלת `rooms_prices` עבור כל יום (`day=-1` עד `day=6`).             | `ajax_global.php`   | `for($i = -1; $i < 7; ++$i){ udb::insert('rooms_prices', [...], true, false); }`                                                                                   |

---

## תרחיש 4: הוספה, עריכה ומחיקה של תקופות
### (1) תיאור משתמש הקצה
- **תיאור כללי**: המשתמש יכול להוסיף תקופה חדשה (פופאפ "הוספת תקופה"), לערוך תקופה קיימת (פופאפ "עריכת תקופה"), ואף למחוק תקופה (Remove).
- **טבלת צעדים (Front-End)**

| מספר צעד | פעולה מצד המשתמש                                | תוצאה מצופה                                                                             |
|----------|-----------------------------------------------|-----------------------------------------------------------------------------------------|
| 1        | לוחץ על "הוספת תקופה חדשה" (`#addPeriodBtn`)   | נפתח פופאפ ובו טופס עם "שם תקופה", "תאריך התחלה", "תאריך סיום".                         |
| 2        | ממלא נתונים ולוחץ "יצירת תקופה חדשה"           | מתבצע Ajax (`act='newPeriod'`). במידה והצליח – הדף מתרענן ומוצגת התקופה החדשה.           |
| 3        | לוחץ על כפתור עריכה (אם קיים) או על תקופה בהתאמה | נפתח פופאפ "editPeriodPopup". ניתן לשנות שם, תאריכים וכד'.                               |
| 4        | לוחץ "שמירה"                                   | Ajax עם `act='editPeriod'` – התצוגה מתעדכנת / הדף נטען מחדש.                             |
| 5        | לוחץ כפתור מחיקה (Remove) בתוך פופאפ העריכה     | Ajax עם `act='removePeriod'` – התקופה מוסרת מה-DB, ובסיום ריענון המסך מציג שהיא נעלמה.    |

### (2) תיאור המימוש בקוד (Back-End)
- **תיאור כללי**:  
  ב-`prices.php` יש כפתורי הוספה/עריכה. האירועים מפעילים קריאות Ajax ל-`ajax_global.php`:
    - `act='newPeriod'`: הוספת רשומה ל-`sites_periods` (periodType=0).
    - `act='editPeriod'`: עדכון תאריכים ו/או שם.
    - `act='removePeriod'`: מחיקת הרשומות הרלוונטיות בכל הטבלאות (sites_periods, rooms_min_nights, rooms_prices).

| מספר צעד | לוגיקה טכנית                                                                           | מיקום בקוד         | מבנה ותוכן הקוד                                                                                          |
|----------|----------------------------------------------------------------------------------------|--------------------|----------------------------------------------------------------------------------------------------------|
| 1        | פופאפ "newPeriod": שולח `&act=newPeriod&asite=...`                                    | `prices.php`       | `$.post('ajax_global.php', $(this.form).serialize() + '&act=newPeriod&asite=...')`                       |
| 2        | ב-`ajax_global.php`, case 'newPeriod': בודק התנגשות עם תקופות קיימות או חגים => מוסיף. | `ajax_global.php`  | `udb::insert('sites_periods', [...])`                                                                    |
| 3        | פופאפ "editPeriod": שולח `&act=editPeriod` עם periodID                                 | `prices.php`       | `$.post('ajax_global.php', {...}).then(...)`                                                             |
| 4        | case 'editPeriod': בודק שוב אם תאריכים חופפים, ואז `udb::update('sites_periods', [...])` | `ajax_global.php`  |                                                                                                          |
| 5        | מחיקה (Remove): case 'removePeriod' => מוחק מה-DB ב-rooms_min_nights, rooms_prices וכו' | `ajax_global.php`  | `udb::query("DELETE FROM ...");`                                                                          |

---

# 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך קצר להפעלת דף ניהול המחירים והתקופות (Front-End) בצעדים ברורים:

1. **פתיחת דף הניהול**
    - גשו ל-`pages/prices.php`. תראו טאבים המייצגים אתרים שונים. לחצו על הטאב הרצוי (הוא ישנה סטטוס ל"active").

2. **צפייה ועריכה ב-iframe**
    - בחלק התחתון (iframe) ייטען `prices.php`. שם תוכלו לראות רשימת "מחיר רגיל", "תקופה חמה" וחגים/תאריכים אחרים.
    - לחצו על כל תקופה בכדי להעלות את הגדרותיה (מינימום לילות, מחירים וכו').

3. **שינוי מינימום לילות/סופ"ש**
    - בוחרים תקופה, רואים טבלת ימים (ראשון-שבת).
    - משנים (select) את הערך הרצוי (למשל "מינימום לילות") או מסמנים/מסירים "סופ"ש".
    - השינוי נשמר מידית דרך Ajax או בלחיצה על כפתור "שמירה" (תלוי במיקומי הקוד).

4. **הוספת תקופה**
    - לחצו "הוספת תקופה חדשה".
    - ייפתח פופאפ למילוי שם התקופה ותאריכי התחלה/סיום.
    - בלחיצה על "יצירת תקופה חדשה", אם אין התנגשויות – התקופה תתוסף.

5. **עריכת תקופה קיימת**
    - לחצו על תקופה ובפופאפ "עריכת תקופה" תוכלו לשנות שם ותאריכים.
    - לשמירה לחצו על "שמירה". הדף יתעדכן.

6. **מחיקת תקופה**
    - ב"עריכת תקופה" (פופאפ) מופיע כפתור "מחיקת תקופה". בלחיצה עליו, התקופה נמחקת מיידית מהמערכת (כולל מחיקת כל ההגדרות הקשורות).

7. **סיום**
    - כשתסיימו לעדכן, ניתן לסגור את החלון או לעבור לטאב אתר אחר.

---

# 7. סיכום
שלושת הקבצים – **pages/prices.php**, **prices.php** ו-**ajax_global.php** – יוצרים יחד מנגנון ניהול מתקדם למחירים ותקופות באתר.
- דרך *pages/prices.php* המשתמש עובר בין אתרים שונים בלחיצה על טאב.
- העמוד *prices.php* מציג ויזואלית את התקופות וההגדרות.
- הקובץ *ajax_global.php* מטפל בצד השרת בכל הקריאות האסינכרוניות, החל משינוי ערכי מינימום לילות ועד הוספת/מחיקת תקופות.

כך מתקבלת מערכת ניהול פרודוקטיבית ונוחה, המאפשרת עריכת מחירים, הגדרת סופ"ש, מינימום לילות ואף ניהול תקופות וחגים מורכבים – והכול באופן דינמי ואינטראקטיבי.


