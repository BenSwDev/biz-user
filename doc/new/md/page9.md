# 1. הקדמה
בקובץ `pages/treatments.php` מופיעה תצוגת עמוד המאפשרת למשתמש לצפות ולהגדיר מחירים עבור טיפולים שונים במתחם ספא (כולל אפשרות של זמן ניקיון בין טיפולים). הקוד עושה שימוש באובייקט משתמש (`$_CURRENT_USER`), אשר ממנו נגזר המתחם (site) הפעיל, וכן בודק האם למשתמש יש הרשאות מתאימות לביצוע שמירה (כלומר, עריכת הגדרות המחירים).  
כאשר מתבצעת בקשת POST (טופס), מתבצע עדכון במחירי הטיפולים במסד הנתונים, ושליחה של המחירים המעודכנים למערכת חיצונית בשם `SpaPlusRelay`.

בנוסף, הקובץ מציג טופס הכולל טבלת טיפולים, משכי זמן אפשריים (בדקות), ושלושה סוגי מחירים: יחיד, זוג וקבוצה. המשתמש יכול להזין את המחירים המתאימים ולשמור אותם במסד הנתונים — בתנאי שיש לו הרשאות גובהות (משתמש-על או משתמש מסוג 0).

---

# 2. הקבצים שנבדקו
1. **`pages/treatments.php`**
    - קובץ זה מציג ומנהל את עמוד הטיפולים.
    - בתוכו מתבצעות הפעולות הבאות (עיקרי הדברים):
        - בדיקה/קביעת מתחם (site) פעיל עבור המשתמש.
        - שליפת ערכי מחירים קיימים מתוך הטבלאות הרלוונטיות (כגון `treatmentsPricesSites`) והצגתם בטבלה.
        - מתן אפשרות לעדכון מחירים (כולל זמן ניקיון) בעת שליחת טופס (POST).
        - קריאה למחלקה `SpaPlusRelay` לצורך עדכון חיצוני של המחירים, אם השמירה הצליחה.
        - שימוש בהגדרות הרשאה שונות (כגון `$_CURRENT_USER->access()` וכדומה) כדי לקבוע האם לאפשר עריכה/שמירה.

---

# 3. הקבצים שלא נמצאו
לא זוהו קבצים ברשימה ששיתפתי לגביהם שנאמר בפירוש "הקובץ לא נמצא", ולכן הרשימה כאן ריקה.

---

# 4. הקבצים שלא נבדקו
להלן רשימת ישויות/אזכורים מתוך הקובץ `pages/treatments.php` שעשויים לייצג קבצים נוספים, אך לא הופיעו ברשימת הקבצים שנבדקו או ברשימת הקבצים שלא נמצאו:

1. **SpaPlusRelay** (לדוגמה `SpaPlusRelay.php`)
2. **udb** (ייתכן `udb.php`)
3. **TfusaBaseUser**, **TfusaUser** (מחלקות משתמש, ייתכן שהן נמצאות בקבצים נפרדים)
4. **assets/css/style_ctrl.php**

> **שים לב:** אין צורך ליצור רשומות "לא נבדקו" עבור `index.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php`, `auth.php`, `functions.php`.

---

# 5. תרחישים כוללים בעמוד

## הוראות לניתוח קוד ובניית תרחישי שימוש (Use Flow Scenarios) באופן אופטימלי
**מטרה:** להפיק ניתוח מקצועי ומדויק של הקוד הקיים בעמוד `treatments.php`, תוך זיהוי כל תרחישי השימוש האפשריים. הניתוח יתאר הן את חוויית המשתמש (Front-End) והן את המימוש הטכני (Back-End).

### 1. זיהוי כל תרחישי השימוש
בקובץ `pages/treatments.php` קיים תרחיש שימוש עיקרי:

**תרחיש 1: ניהול (צפייה/עריכה) של מחירי טיפולים וזמן ניקיון**

---

### 2. מבנה הניתוח של כל תרחיש שימוש
1. **תיאור משתמש הקצה (Front-End / User Perspective)**
2. **תיאור המימוש בקוד (Back-End / Developer Perspective)**

---

### 3. ניתוח משתמש הקצה (Front-End Perspective)

#### תרחיש 1: ניהול (צפייה/עריכה) של מחירי טיפולים וזמן ניקיון

**תיאור כללי:**  
המשתמש (מנהל/אדמין) מגיע לעמוד "טיפולי ספא" ורואה טבלה עם רשימת טיפולים, משכי זמן אפשריים ומחירים (ליחיד, זוג וקבוצה). בנוסף, ניתן להגדיר "זמן ניקיון" בין טיפולים. המשתמש רשאי לשנות את השדות אם יש לו הרשאות מתאימות, ולשמור את השינויים.

| מספר צעד | פעולה מצד המשתמש                                | תוצאה מצופה                                                                                              |
|----------|-------------------------------------------------|-----------------------------------------------------------------------------------------------------------|
| 1        | כניסה לעמוד `?page=treatments`                  | הטבלה נטענת ומציגה את הטיפולים הקיימים ומשך הזמן האפשרי לכל טיפול, כולל המחירים הנוכחיים.                  |
| 2        | בחירת זמן ניקיון (אם משתמש מורשה)               | סימון זמני הניקיון האפשריים (0,5,10,15,20,25,30 דקות), כאשר הנוכחי מסומן כברירת מחדל.                     |
| 3        | עדכון מחירים בתאים הרלוונטיים בטבלה (רשות)     | המשתמש יכול להקליד מחירים (ליחיד, זוג, קבוצה) בכל משבצת זמן. אם אין הרשאה, השדות יופיעו כערכי קריאה בלבד. |
| 4        | לחיצה על כפתור "שמור"                           | המערכת שולחת את נתוני הטופס לשרת לביצוע עדכון במסד הנתונים.                                              |
| 5        | לאחר השמירה: טעינה מחודשת של הדף                | הדף נטען מחדש, והמחירים המעודכנים מוצגים. מתבצע עדכון אוטומטי לשירות חיצוני (SpaPlusRelay) במידת הצורך.  |

---

### 4. ניתוח המימוש בקוד (Back-End Perspective)

#### תרחיש 1: ניהול (צפייה/עריכה) של מחירי טיפולים וזמן ניקיון

**תיאור כללי (Flow):**  
בקובץ `pages/treatments.php` מתבצעת בתחילה בדיקה של מתחם (site) פעיל, וכן בדיקה האם למשתמש יש הרשאות לערוך ולשמור נתונים. אם כן, ובהינתן שמדובר בבקשת `POST`, המערכת מעדכנת את ערכי המחירים בטבלת `treatmentsPricesSites`, וכן את זמן הניקיון (`waitingTime` בטבלת `sites`). לסיום, מתבצעת קריאה ל־`SpaPlusRelay->sendPrices()` כדי לעדכן מערכת חיצונית.

| מספר צעד | לוגיקה טכנית                                                                                                                      | מיקום בקוד                       | מבנה ותוכן הקוד                                                                                               |
|----------|-----------------------------------------------------------------------------------------------------------------------------------|----------------------------------|---------------------------------------------------------------------------------------------------------------|
| 1        | בדיקת המתחם (site) הפעיל עבור המשתמש. אם לא קיים, מופעל `$_CURRENT_USER->select_site()`.                                         | בראש הקובץ (`if (!$_CURRENT_USER->select_site()) { ... }`)  | ```php
if (!$_CURRENT_USER->select_site()) {
$_CURRENT_USER->select_site($_CURRENT_USER->active_site());
...
}
$sid = $_CURRENT_USER->active_site() ?: 0;
``` |
| 2        | בדיקת הרשאת שמירה `$canSave`: האם המשתמש הוא סופר-אדמין (`TfusaUser::ACCESS_SUPER`) או שה-`userType` שלו שווה 0.                | לקראת שורה ~18–20                | ```php
$canSave = ($_CURRENT_USER->access() == TfusaUser::ACCESS_SUPER) || ($_CURRENT_USER->userType == 0);
``` |
| 3        | אם `REQUEST_METHOD == POST` ו-`$canSave`, מעדכן זמן ניקיון (`waitingTime`) בטבלת `sites`.                                        | החל משורה ~22                    | ```php
if ('POST' == $_SERVER['REQUEST_METHOD'] && $canSave) {
    udb::update('sites', ['waitingTime' => max(0, intval($_POST['timeout']))], '`siteID` = ' . $sid);
    ...
}
``` |
| 4        | לאחר מכן, מוחק את הרשומות הנוכחיות של מחירים עבור האתר (`treatmentsPricesSites`), ומכניס את המחירים החדשים.                     | בהמשך בלוק ה-POST                | ```php
udb::query("delete from `treatmentsPricesSites` where `siteID` = ".$sid);
...
udb::insert('treatmentsPricesSites', $que, true);
``` |
| 5        | יוצר אובייקט `SpaPlusRelay` ומזמין את `sendPrices()` לסנכרן מחירים עם המערכת החיצונית. במקרה של כשל, נשלח מייל התראה.          | שורות ~47–53                     | ```php
try {
    $relay = new SpaPlusRelay($sid);
    $relay->sendPrices();
} catch (Exception $e) {
    mail('alchemist.tech@gmail.com', ...
}
``` |
| 6        | בסוף, מפנה את הדפדפן חזרה אל `?page=treatments`.                                                                                 | לאחר מכן (~שורה 54)             | ```php
echo '<script> window.location.href = "?page=treatments"; </script>';
return;
``` |

---

# 6. מסמך שימוש (מדריך למשתמש)
**כיצד להשתמש בעמוד `treatments`:**
1. היכנס לעמוד `?page=treatments`.
2. אם אתה עובד עם מספר מתחמים (Multi-Site), בדוק שבחרת את המתחם הרצוי.
3. צפייה ושינוי מחירים: תוכל לראות בטבלה את הטיפולים הקיימים, משך זמן (בדקות) עבור כל טיפול, ו-3 סוגי מחירים (יחיד, זוג וקבוצה).
4. בחר את זמן הניקיון הרצוי (בדקות), אם ברצונך לעדכן אותו.
5. אם יש לך הרשאות מתאימות, ערוך את המחירים בשדות של כל טיפול (ליחיד, זוג, קבוצה).
6. לחץ על "שמור". העמוד ייטען מחדש, והמערכת תעדכן את מחירי הטיפולים במסד הנתונים ובמערכת החיצונית (SpaPlusRelay).

---

# 7. סיכום
הקובץ `pages/treatments.php` משמש להגדרת מחירי טיפולים וזמני ניקיון במערכת, עם אפשרות עדכון והאצתו למערכת חיצונית. הקוד מבצע בדיקות הרשאה, שולף מידע על טיפולים וזמני ניקיון קיימים, ומאפשר לשנותם באמצעות טופס פשוט. הפונקציונליות נשענת על מחלקות חיצוניות `SpaPlusRelay` ו-`udb` לצורך עדכוני DB וסנכרון מול גורם חיצוני.

