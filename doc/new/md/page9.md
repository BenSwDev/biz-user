# 1. הקדמה

קובץ `pages/treatments.php` מכיל לוגיקה המאפשרת, למשתמשים מורשים, לצפות ולהגדיר מחירים וזמני המתנה (Waiting Time) עבור טיפולי ספא. הקוד מוודא את זהות המשתמש, את ההרשאות שלו לשמור שינויים, ובהתאם לכך מציג או מסתיר אלמנטים בממשק (כגון שדות עריכה והכפתור "שמור"). בעת שליחת הטופס (באמצעות בקשת POST), הקוד מעדכן את המידע במסד הנתונים ושולח, באמצעות אובייקט `SpaPlusRelay`, מידע על המחירים לאינטגרציה חיצונית (אם קיימת).

פעולת הקובץ מבוססת בין היתר על מידע הנשלף מטבלאות שונות במסד הנתונים (דוגמת `sitesTratments`, `treatmentsPricesSites`, `treatments`, `sites`) וכן על אובייקטים חיצוניים (כגון `udb` לביצוע פעולות במסד הנתונים, והאובייקט `SpaPlusRelay` לשליחת עדכונים).

---

# 2. הקבצים שנבדקו

1. **pages/treatments.php**  
   - **תוכן עיקרי ומאפיינים בקובץ**:
     - בדיקת האובייקט `$_CURRENT_USER` כדי לקבוע לאיזה אתר (Site) הוא משויך ולאשר שיש לו הרשאות גישה.
     - הגדרת משתנה `$sid` (Site ID) המשמש לזיהוי המתחם שבשבילו נטענים הטיפולים.
     - בדיקת הרשאה (`$canSave`) על סמך סוג המשתמש (משתמש-על או משתמש מסוג מסוים).
     - שליפת זמני טיפול קיימים (עבור טיפולים שונים) ממסד הנתונים.
     - הצגת טופס המאפשר למשתמש להזין/לערוך מחירים שונים (ליחיד, זוג, קבוצה) ולבחור זמן המתנה (Cleaning Time).
     - בעת שליחת הטופס (`POST`), מתבצעת עדכון לערכי המחירים במסד הנתונים וכן קריאה ל- `SpaPlusRelay->sendPrices()`.
     - טעינת עיצוב (CSS) דינמית דרך `assets/css/style_ctrl.php` (עם פרמטרים המועברים ב-URL).

---

# 3. הקבצים שלא נמצאו

לא נמצאו קבצים נוספים ברשימה שסופקה (אין קבצים שצוינו כ"לא נמצאו").

---

# 4. הקבצים שלא נבדקו

מן הקוד שבקובץ `pages/treatments.php` עולה שימוש/אזכור במספר מחלקות וקבצים אפשריים, אשר **אינם** מופיעים ברשימה שהועברה (ולכן לא נבדקו בפועל):

1. שימוש באובייקט `SpaPlusRelay` (ככל הנראה ממומש בקובץ נפרד, כגון `SpaPlusRelay.php` או שם אחר).
2. שימוש במחלקה `udb` (לפעולות על מסד הנתונים), אשר ככל הנראה נמצאת בקובץ נפרד, לדוגמה `udb.php`.
3. קריאה לקובץ עיצוב `assets/css/style_ctrl.php?dir=...&fileName=treatments...` – גם הוא לא הופיע ברשימה כקובץ נפרד.

> **הערה**: אין צורך ליצור רשומת "לא נבדקו" עבור `index.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php`, `auth.php`, `functions.php` גם אם היו מופיעים בקוד – אך בפועל, הם אינם מופיעים כאן ולכן אינם רלוונטיים.

---

# 5. תרחישים כוללים בעמוד

## 5.1 זיהוי תרחישי השימוש (Use Flows)

בקובץ `pages/treatments.php` זוהו שני תרחישים עיקריים:

1. **תרחיש "צפייה והגדרת המחירים"**  
   המשתמש נכנס לעמוד, בוחר זמן המתנה (אם מותר לו) ומגדיר מחירי טיפולים לפי משך הטיפול ולפי סוג (יחיד, זוג, קבוצה), ואז לוחץ על "שמור".

2. **תרחיש "גישה ללא הרשאות עריכה"**  
   המשתמש נכנס לעמוד אך **אינו** מורשה לבצע שינויים (למשל, `$canSave` = `false`). במקרה זה, הטופס יוצג במצב קריאה בלבד (שדות מחירים חסומים וללא כפתור שמירה).

---

## 5.2 מבנה הניתוח לכל תרחיש

בהתאם להנחיות, ננתח כל תרחיש בשני חלקים:  
1. **תיאור משתמש הקצה (Front-End / User Perspective)**  
2. **תיאור המימוש בקוד (Back-End / Developer Perspective)**

---

### תרחיש 1: "צפייה והגדרת המחירים"

#### א. ניתוח משתמש הקצה (Front-End Perspective)

**תיאור כללי**  
המשתמש (בעל הרשאות עריכה) נכנס לעמוד "טיפולי ספא". הוא מצפה לראות רשימה של טיפולים, עבור כל משך טיפול אפשרי, עם אפשרות להזין/לשנות מחירים לשלושה סוגים (יחיד/זוג/קבוצה). בנוסף, הוא יכול להגדיר זמן המתנה (Cleaning Time). לבסוף, לוחץ "שמור" כדי לעדכן במסד הנתונים.

| **#** | **פעולה מצד המשתמש**                           | **תוצאה מצופה**                                                |
|-------|------------------------------------------------|----------------------------------------------------------------|
| 1     | נכנס לעמוד `...?page=treatments`               | רואה טופס המכיל טבלה: טיפולים, משך טיפול, מחירים, זמן המתנה.  |
| 2     | מסמן זמן המתנה (רדיו-באטון) מתוך רשימה אפשרית   | בחירתו מסומנת, ערך זה יישמר עבור הטופס.                        |
| 3     | מזין או משנה מחירים בשדות הטופס (יחיד/זוג/קבוצה) | שדות הטופס מתעדכנים מקומית.                                   |
| 4     | לוחץ על כפתור "שמור"                           | הדף נשלח לשרת (POST).                                         |
| 5     | לאחר שליחה: מקבל ריענון הדף                    | רואה שוב את הטבלה כשהנתונים המעודכנים מוצגים בה.               |

---

#### ב. ניתוח המימוש בקוד (Back-End Perspective)

**תיאור כללי**  
בטעינת העמוד, הקוד בודק את `$_CURRENT_USER`, ואת ההרשאות שלו (דרך `$canSave`). נטענים זמני הטיפול מתוך הטבלה `treatmentsPricesSites`. כמו כן, הקוד שואב את ערכי המחירים ומייצר את הטבלה הדינמית בהתאם לכל טיפול ולכל משך זמין. עם שליחת הטופס (`POST`), מתבצע עדכון מול מסד הנתונים בטבלאות `sites` (עבור זמן המתנה) ו- `treatmentsPricesSites` (עבור המחירים). לבסוף, הקריאה ל- `SpaPlusRelay->sendPrices()` מעדכנת מערכת חיצונית.

| **#** | **לוגיקה טכנית**                                                                                                                                                                                        | **מיקום בקוד**                        | **מבנה ותוכן הקוד**                                                                                                                                                                                   |
|-------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1     | בדיקה אם המשתמש בחר אתר (`select_site`), ואם לא – מפעיל `select_site($_CURRENT_USER->active_site())`.                                                                                                   | תחילת הקובץ (לאחר `<?php`...)         | `if (!$_CURRENT_USER->select_site()) { ... }`                                                                                                                                                         |
| 2     | הגדרת `$sid` (Site ID) לפי האתר הפעיל.                                                                                                                                                                 | תחילת הקובץ                            | `$sid = $_CURRENT_USER->active_site() ?: 0;`                                                                                                                                                           |
| 3     | בדיקה אם למשתמש יש הרשאות עריכה (`$canSave`). התנאי בודק אם הוא Super או UserType=0.                                                                                                                  | בקוד ה-PHP הראשוני                     | `$canSave = ($_CURRENT_USER->access() == TfusaUser::ACCESS_SUPER) ...`                                                                                                                                |
| 4     | שליפת זמני טיפולים מתוך `treatmentsPricesSites` וגזירת משכי טיפולים (`duratuion`).                                                                                                                     | סביב `$realTimes = udb::single_column` | `SELECT DISTINCT 'duratuion' FROM 'treatmentsPricesSites'... ORDER BY 'duratuion'`                                                                                                                     |
| 5     | שליפת שם הטיפולים מטבלת `treatments` והכנתם להצגה בטבלה.                                                                                                                                               | `SELECT * FROM 'treatments'`           | ה-loop על התוצאה מייצר שורות טבלה עבור כל טיפול רלוונטי.                                                                                                                                               |
| 6     | הצגת הטבלה (HTML) עם אינפוטים המתאימים ליחיד/זוג/קבוצה, וכן אינפוטים עבור בחירת זמן המתנה.                                                                                                               | בקובץ ה-HTML (בתוך `<?php ... ?>`)    | קוד HTML עם `<form>` ו-`<input type="text"...>` ו-`<input type="radio"...>`                                                                                                                            |
| 7     | במקרה של POST (בדיקת `if ('POST' == $_SERVER['REQUEST_METHOD'] && $canSave) {...}`): <br/>א. עדכון `waitingTime` בטבלת `sites`.<br/>ב. מחיקת רשומות קיימות ב-`treatmentsPricesSites` לאותו אתר.<br/>ג. הוספת רשומות חדשות עם המחירים. | בגוש התנאי `if('POST' == $_SERVER...`  | שימוש בפונקציות `udb::update(...)`, `udb::query(...)`, `udb::insert(...)` בהתאם לערכי הפוסט.                                                                                                        |
| 8     | קריאה ל- `SpaPlusRelay` לשליחת המחירים החדשים. במקרה של כשל, נשלחת הודעת שגיאה בדוא"ל.                                                                                                                  | בתוך הבלוק `try { $relay->sendPrices(); }` | `SpaPlusRelay($sid)` ואח"כ `$relay->sendPrices()`. אם יש Exception, נשלח `mail(...)`.                                                                                                                  |
| 9     | הפניה (Redirect) באמצעות `echo '<script> window.location.href = "?page=treatments"; </script>';` בסיום השמירה.                                                                                          | סוף בלוק ה-POST                        | `<script> window.location.href = ... </script>`                                                                                                                                                        |

---

### תרחיש 2: "גישה ללא הרשאות עריכה"

#### א. ניתוח משתמש הקצה (Front-End Perspective)

**תיאור כללי**  
משתמש בעל הרשאות מוגבלות או חסרות לחלוטין נכנס לעמוד. הוא רואה את הטבלה המפרטת את מחירי הטיפולים, אך אין ביכולתו לשנות את השדות או ללחוץ על כפתור "שמור" (שכן הכפתור לא יוצג או שיהיה במצב בלתי פעיל).

| **#** | **פעולה מצד המשתמש**             | **תוצאה מצופה**                                                    |
|-------|----------------------------------|--------------------------------------------------------------------|
| 1     | נכנס לעמוד `...?page=treatments` | רואה טבלה שמציגה את המחירים, אך השדות בקריאה בלבד (או חסומים).     |
| 2     | מנסה לבצע שינויים בשדות הטופס    | לא יכול לשנות את הערכים (readonly), ואין כפתור "שמור" פעיל.        |
| 3     | מנסה ללחוץ על "שמור"            | הכפתור כלל אינו מופיע, או שאינו פעיל, ולכן לא מתבצע שום עדכון.     |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)

| **#** | **לוגיקה טכנית**                                                                                                                                                                   | **מיקום בקוד**            | **מבנה ותוכן הקוד**                                                                                                                  |
|-------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|---------------------------------------------------------------------------------------------------------------------------------------|
| 1     | `$canSave` מוגדר ל-`false` בגלל המשתמש אינו Super או בעל `userType=0`.                                                                                                             | בחלק הראשוני של הקובץ      | `$canSave = (...) ? true : false;`                                                                                                    |
| 2     | טופס המחירים נטען כרגיל, אך השדות מוצגים עם `readonly` והכפתור "שמור" מוסתר (בדיקה `if($canSave){...}`).                                                                            | בחלק יצירת ה-HTML          | `<? if($canSave){ ?> <input type="submit" ...> <? } ?>`<br>ובנוסף הוספת `readonly` לתיבות הטקסט במידה `$canSave` הוא false.         |
| 3     | במקרה של `POST`, המערכת כלל לא מבצעת עדכון כי התנאי כולל `&& $canSave`; אם אין הרשאה, הקוד לא נכנס לבלוק.                                                                           | `if('POST' == $_SERVER...` | `if ('POST' == $_SERVER['REQUEST_METHOD'] && $canSave) { ... }`                                                                      |
| 4     | התוצאה – אין שום שינוי במסד הנתונים ואין שליחה ל- `SpaPlusRelay`.                                                                                                                  | סוף בלוק ה-POST            | בהיעדר `$canSave`, הלוגיקה לא מתבצעת.                                                                                                 |

---

# 6. מסמך שימוש (מדריך למשתמש)

להלן מדריך קצר לעבודה עם עמוד `טיפולי ספא`:

1. **כניסה לעמוד**  
   - גש לכתובת המתאימה (לרוב `...?page=treatments`).
   - אם אתה משתמש בעל הרשאות עריכה, הטופס יוצג במצב פעיל עם אפשרות לשנות את הזמן הנדרש לניקיון (Cleaning Time) ואת מחירי הטיפולים.

2. **בחירת זמן ניקיון (Cleaning Time)**  
   - בחלק העליון של הטופס, מציגה המערכת מספר אפשרויות (ברדיו-באטונים).  
   - בחר את מספר הדקות המתאים.

3. **שינוי מחירי הטיפולים**  
   - עבור כל טיפול וכל משך טיפול שקיים, הזן או עדכן מחיר לשלושה סוגים (יחיד / זוג / קבוצה).
   - השדות ניתנים לעריכה רק אם יש לך הרשאות עריכה.

4. **שמירת השינויים**  
   - לאחר הכנסת כל הנתונים הרצויים, לחץ על כפתור "שמור" בתחתית הטופס.  
   - אם השמירה מצליחה, העמוד ייטען מחדש עם הנתונים העדכניים.

5. **בעלי הרשאה מוגבלת**  
   - אם אין לך הרשאות עריכה, תראה את העמוד במצב תצוגה בלבד (readonly). כפתור "שמור" לא יופיע, או יוצג אך לא יהיה פעיל.

---

# 7. סיכום

מסמך זה מרכז את מבנה העמוד `pages/treatments.php` ואת תרחישי השימוש העיקריים בו. הקוד מאפשר למשתמשים מורשים להגדיר את זמני הניקיון והמחירים לטיפולים שונים במספר מתכונות (יחיד, זוג, קבוצה). באמצעות בדיקות הרשאה, נמנעת גישה של משתמשים לא מורשים לעדכון הנתונים. עם עדכון הערכים, מתבצעת קריאה למערכת חיצונית (`SpaPlusRelay`), לצורך עדכוני מחירים בזמן אמת. כך מתקבלת גישה נוחה וסדר בארגון המחירים והזמנים, תוך שליטה מלאה ברמת האתר (Site) הרלוונטי.
