# 1. הקדמה
בקבצים שנבדקו (`pages/reviews.php` ו-`ajax_global.php`) ניתן לראות מערכת לניהול והצגת חוות דעת (Reviews) ותגובה (Comment) של בעל האתר, לצד מנגנוני AJAX מגוונים.  
הקובץ `reviews.php` (בתיקיית `pages/`) מציג את חוות הדעת בפועל, מאפשר סינון/חיפוש, ציון ממוצע, הצגת הזמנה מקושרת (אם קיימת), וצירוף מסמך אסמכתא. הוא גם כולל אפשרות למשתמש בעל הרשאות מנהל (admin) לשלוח קישורים למילוי חוות דעת. כמו כן, משולבת בו חלונית קופצת (Popup) לעריכת/הוספת תגובה (ownComment) מטעם בעל האתר.  
הקובץ `ajax_global.php` מטפל בצד השרת בקריאות AJAX שונות. בהקשר של חוות דעת, הוא אחראי, בין היתר, לפעולה `"ownComment"`, כלומר: שליפת ו/או שמירת התגובה של בעל האתר לחוות הדעת, ושליחת עדכון ללקוח בדוא"ל/SMS לאחר הוספת תגובה.

---

# 2. הקבצים שנבדקו

1. **pages/reviews.php**
    - קובץ להצגת חוות דעת והוספת תגובות מטעם בעל האתר.
    - מאפשר חיפוש וסינון לפי תאריך, טקסט חופשי ומזהה מתחם (siteID).
    - בודק הרשאות משתמש (מנהל/מטפל) ומציע אפשרות לשלוח קישור למילוי חוות דעת.
    - מציג רשימת חוות דעת כולל כפתורים לצפייה בהזמנה המקושרת או במסמך אסמכתא.
    - כולל קוד JavaScript המזין/שולף תגובת בעל האתר דרך קריאות AJAX (בפרט act=ownComment אל `ajax_global.php`).

2. **ajax_global.php**
    - קובץ צד שרת המטפל בבקשות AJAX מגוונות לפי הערך של `$_POST['act']`.
    - עבור חוות דעת, המקרה הרלוונטי הוא `case "ownComment"`:
        - שליפה/שמירה של שדה `ownComment` בטבלת `reviews`.
        - שליחת הודעה ללקוח (בדוא"ל/SMS) על תגובה חדשה לביקורת.
    - מכיל פעולות נוספות (כגון `getcoords`, `menuc`, `sync`, `roomPrices`, וכו'), אך לא נמצאו אזכורים לשימוש בהן בקובץ `reviews.php`.

---

# 3. הקבצים שלא נמצאו
לא דווח על שום קובץ שנאמר לגביו במפורש כי "לא נמצא". לפיכך, הרשימה ריקה.

---

# 4. הקבצים שלא נבדקו
להלן קבצים שהקוד מתייחס אליהם, אך אינם מופיעים ברשימת הקבצים הנסרקים או אלה ש"לא נמצאו":
1. **review.php** – מוזכר בקישור למילוי חוות דעת (`href="/review.php?siteID=..."`).
2. **user/mails/rate.php** – מוזכר בפרמטר `data-mail-file="/user/mails/rate.php?siteID=..."`.

(קבצים כגון `auth.php` הוזכרו אך ההנחיות מורות להתעלם מהם לצורך "קבצים שלא נבדקו".)

---

# 5. תרחישים כוללים בעמוד

להלן תרחישי השימוש (Use Flow Scenarios) העיקריים העולים מניתוח שני הקבצים:

## תרחיש 1: חיפוש וסינון חוות דעת
### 1. תיאור משתמש הקצה (Front-End Perspective)
- **תיאור כללי**: המשתמש נכנס לעמוד "חוות דעת" ורוצה למצוא ביקורות לפי מתחם (siteID), תאריכים וטקסט חופשי.
- **טבלת צעדי התרחיש**:

| מספר צעד | פעולה מצד המשתמש                                    | תוצאה מצופה                                                    |
|----------|-----------------------------------------------------|----------------------------------------------------------------|
| 1        | פתיחת הדף `reviews.php`                             | העמוד נטען; מציג חוות דעת לפי הגדרות ברירת מחדל                |
| 2        | מילוי שדות "מתאריך" / "עד תאריך"                   | התאריכים נכנסים לשדות המתאימים (פורמט dd/mm/yyyy)             |
| 3        | הזנת מילת חיפוש חופשית בשדה "חיפוש חופשי" (אופציונלי) | המשתמש רואה את הטקסט מוזן בשדה                                  |
| 4        | בחירת מזהה מתחם (siteID) מרשימה נפתחת (אופציונלי)   | אם יש מספר מתחמים, מופיעים באפשרות הבחירה                       |
| 5        | לחיצה על כפתור "חפש"                                | הדף נטען מחדש, מציג את חוות הדעת העונות על תנאי הסינון         |

### 2. תיאור המימוש בקוד (Back-End Perspective)
- **תיאור כללי**: בקריאה לדף, או לאחר שליחת טופס GET, `reviews.php` בונה שאילתת SQL לפי הפרמטרים (`sid`, תאריכי `from` / `to`, ומילת חיפוש חופשית) ומציג תוצאות.
- **טבלת צעדי התרחיש**:

| מספר צעד | לוגיקה טכנית                                                                                                                                   | מיקום בקוד                | מבנה ותוכן הקוד                                                                                                                 |
|----------|-----------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| 1        | קריאת פרמטרים מ-`$_GET` (sid, from, to, free) והמרת תאריכים ע"י `typemap`                                                                     | תחילת `pages/reviews.php` | שימוש ב-`explode('/', $_GET['from'])` ואז `array_reverse()`, וכן `trim()` כדי לייצר `YYYY-mm-dd`                                 |
| 2        | בדיקת הרשאות המשתמש לצפות במתחם (אם לא מורשה – מציג 'Access denied')                                                                           | מיד אחרי הגדרת `$sid`     | `if($sid && !$_CURRENT_USER->has($sid)) { echo 'Access denied'; return; }`                                                       |
| 3        | בניית מערך `$where` עם תנאים דינמיים (תאריכים, חיפוש חופשי, מזהה המטפל, וכו')                                                                 | אמצע `pages/reviews.php`  | `$where[] = "...";`                                                                                                              |
| 4        | אם המשתמש אינו מנהל, מוסיפים תנאי "orders.therapistID = userID"                                                                                | אחרי בדיקת גישת Admin     | `if (!$_CURRENT_USER->access(...)) { $where[] = "orders.therapistID = ..."; }`                                                   |
| 5        | הרצת השאילתה עם `udb::key_row(...)`, ושמירת מספר התוצאות הכולל עם `udb::single_value("SELECT FOUND_ROWS()")`                                   | מעט אחרי `$que`           | `$pager->setTotal(...)`                                                                                                          |
| 6        | הצגת התוצאות ב־`foreach($pays as $pay) { ... }` (כולל שם, תאריך, ציון, וכו')                                                                   | בחלק ה-HTML תחת `<div class="review">` | הצגת נתוני `$pay['title']`, `$pay['text']`, `$pay['avgScore']`, וכו'                                                              |

---

## תרחיש 2: שליחת קישור למילוי חוות דעת (למנהלים)
### 1. תיאור משתמש הקצה (Front-End Perspective)
- **תיאור כללי**: מנהל (Admin) בעמוד חוות הדעת יכול לשלוח (או להעתיק) קישור למילוי ביקורת חדשה, בהתאם למתחם הנבחר.
- **טבלת צעדי התרחיש**:

| מספר צעד | פעולה מצד המשתמש                                   | תוצאה מצופה                                                        |
|----------|----------------------------------------------------|--------------------------------------------------------------------|
| 1        | זיהוי אזור "שליחת חו"ד" המופיע רק למשתמש בעל הרשאות מנהל | המשתמש מזהה בחלק העליון ממשק לשליחת קישור לחוות דעת                 |
| 2        | בחירת מתחם מסוים אם יש יותר מאחד                   | מוצג כפתור "שליחת חו"ד" וקישור "קישור למילוי חו"ד"                  |
| 3        | לחיצה על "שליחת חו"ד"                              | המערכת מכינה קישור או שולחת באמצעות מנגנון פנימי (מייל/SMS וכדומה) |

### 2. תיאור המימוש בקוד (Back-End Perspective)
- **תיאור כללי**: אם `$_CURRENT_USER->access(TfusaUser::ACCESS_BIT_ADMIN)`, מוצג בלוק HTML המכיל כפתורי "שליחת חו"ד". הקישור עצמו מפנה ל-`review.php?siteID=...`.
- **טבלת צעדי התרחיש**:

| מספר צעד | לוגיקה טכנית                                                               | מיקום בקוד                                   | מבנה ותוכן הקוד                                                              |
|----------|---------------------------------------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------|
| 1        | בדיקת הרשאת מנהל `if($_CURRENT_USER->access(TfusaUser::ACCESS_BIT_ADMIN))`| מעט לפני `<div class="health_send">`         | `<div class="health_send"> ... </div>` מציג אזור "שליחת חו"ד"                |
| 2        | מעבר על המערך `$sname` (רשימת המתחמים) ויצירת אפשרות בחירה (select)       | בקטע `<div class="site-select">`            | `foreach($sname as $id => $name) { ... }`                                    |
| 3        | כפתור `<div class="plusSend" ...>` עם data-title, data-msg, data-subject  | בתוך `<div class="site-line" ...>` או `<div class="send_btn ...>` | הקישור מניע קריאה חיצונית לשליחה/פתיחת לינק למילוי חוות דעת                  |
| 4        | `<a class="send_btn" href="/review.php?siteID=...">` ליצירת גישה ישירה    | סמוך לכפתור "שליחת חו"ד"                    | מפנה אל `review.php?siteID=...`                                              |

---

## תרחיש 3: הוספה או עריכת תגובת בעל האתר (Owner’s Comment)
### 1. תיאור משתמש הקצה (Front-End Perspective)
- **תיאור כללי**: בעמוד החוות דעת, לכל ביקורת יש אפשרות "הוסף תגובה" או "ערוך תגובה". לחיצה פותחת חלונית קופצת שמאפשרת למנהל/בעל האתר לערוך את התגובה שלו.
- **טבלת צעדי התרחיש**:

| מספר צעד | פעולה מצד המשתמש                                                                      | תוצאה מצופה                                                            |
|----------|---------------------------------------------------------------------------------------|------------------------------------------------------------------------|
| 1        | לחיצה על הקישור/כפתור "הוסף" או "ערוך תגובה" ליד חוות הדעת                            | נפתחת חלונית (Popup) עם שדה טקסט (ownComment)                          |
| 2        | הזנת תוכן התגובה בחלונית                                                              | המשתמש רואה את הטקסט מוזן בשדה                                         |
| 3        | לחיצה על כפתור "שמירה"                                                                | שליחת קריאת AJAX ל-`ajax_global.php` (act=ownComment) לצורך שמירת הנתון|
| 4        | סגירת החלונית                                                                          | במסך החוות דעת תתעדכן התגובה (או תוצג לאחר רענון)                      |

### 2. תיאור המימוש בקוד (Back-End Perspective)
כאן בא לידי ביטוי הקוד בשני מקומות: `reviews.php` (עבור הקריאה AJAX) ו-`ajax_global.php` (עבור הטיפול בשרת).
- **תיאור כללי**:
    - בצד ה-Front-End: JavaScript מגדיר איוונט על כפתור: `$.post("ajax_global.php", { act: 'ownComment', id: ... })`.
    - בצד ה-Back-End (`ajax_global.php`): בנתיב `case "ownComment"` שומר/מחזיר את הטקסט בטבלת `reviews`, ושולח ללקוח עדכון.

- **טבלת צעדי התרחיש**:

| מספר צעד | לוגיקה טכנית                                                                                         | מיקום בקוד                                              | מבנה ותוכן הקוד                                                                                                                      |
|----------|-----------------------------------------------------------------------------------------------------|---------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בעת לחיצה על "הוסף/ערוך תגובה", נשלחת בקשת POST עם `act=ownComment` ל־`ajax_global.php`             | ב-JavaScript שבסוף `reviews.php` (`$(".add-com a").on...`) | `$.post("ajax_global.php",{ act:'ownComment', id:reviewID },function(response){ ... })`                                               |
| 2        | אם לא נמסר תוכן חדש (ownComment), מחזיר את ערך קיים מה-DB (ומכניס אותו לשדה `#ownComment`)          | פונקציית ה-`else` בתוך `case "ownComment"`             | `$result['text'] = udb::single_value("select ownComment ...")`                                                                       |
| 3        | אם נמסר תוכן חדש, מתבצעת עדכון DB בטבלת `reviews` (שדה `ownComment` ו-`ownCommentDate`)            | `case "ownComment"` ב־`ajax_global.php`                | `udb::update("reviews",$que, " reviewID=".$rID);`                                                                                    |
| 4        | לאחר השמירה, מופעלת `reviewcomment::sendEmailSmsforClientsNotifyAboutReviewComment($data);`         | באותו case, אחרי העדכון                                | השולח התראה ללקוח (אם קיימים פרטי קשר)                                                                                                |
| 5        | מחזירים תשובת JSON (למשל `result['update'] = 1`), ואז ב-JavaScript סוגרים את החלונית ומנקים את השדה | סוף הפונקציה `ownComment` + callback ב־JS              | `$("#addcomm").hide(); $("#ownComment").val("");`                                                                                    |

---

## תרחיש 4: צפייה בפרטי הזמנה מחוות דעת
### 1. תיאור משתמש הקצה (Front-End Perspective)
- **תיאור כללי**: אם לחוות הדעת משויך מספר הזמנה (`orderID`), המשתמש רואה כפתור "הצג הזמנה" ולחיצה עליו פותחת מידע נוסף.
- **טבלת צעדי התרחיש**:

| מספר צעד | פעולה מצד המשתמש              | תוצאה מצופה                                                 |
|----------|-------------------------------|-------------------------------------------------------------|
| 1        | זיהוי כפתור "הצג הזמנה"      | מופיע רק אם `orderID` קיים בביקורת הנוכחית                 |
| 2        | לחיצה על הכפתור              | כנראה נפתח חלון/פופ-אפ או עמוד חדש המציג את פרטי ההזמנה      |

### 2. תיאור המימוש בקוד (Back-End Perspective)
- **תיאור כללי**: בוצעת בדיקה `if($pay["orderID"]) { ... }`. אם קיים `orderID`, מייצרים `<div class="showOrder" onclick="window.openFoo.call(window, {'orderID':...})">`.
- **טבלת צעדי התרחיש**:

| מספר צעד | לוגיקה טכנית                                                                                 | מיקום בקוד                                   | מבנה ותוכן הקוד                                          |
|----------|---------------------------------------------------------------------------------------------|----------------------------------------------|----------------------------------------------------------|
| 1        | בלולאה על כל חוות דעת `foreach($pays as $pay)`, בודקים `if($pay["orderID"])`                | `reviews.php` > `<div class="review">`       | `<div class="showOrder" onclick="window.openFoo.call(window, {'orderID':...})">הצג הזמנה</div>` |
| 2        | פונקציה `window.openFoo.call(window, {'orderID':...})` אינה מוצגת בקובץ, ייתכן והיא גלובלית | ה-JavaScript בקובץ `reviews.php` לא מגדיר אותה | מנגנון פתיחת פרטי ההזמנה, אינו מופיע בהרחבה בשני הקבצים   |

---

## תרחיש 5: צפייה במסמך אסמכתא (Document Attachment)
### 1. תיאור משתמש הקצה (Front-End Perspective)
- **תיאור כללי**: אם לחוות הדעת משויך קובץ (document), מופיע כפתור "הצג אסמכתא". לחיצה פותחת כנראה את המסמך לצפייה או להורדה.
- **טבלת צעדי התרחיש**:

| מספר צעד | פעולה מצד המשתמש              | תוצאה מצופה                                                     |
|----------|-------------------------------|-----------------------------------------------------------------|
| 1        | זיהוי כפתור "הצג אסמכתא"     | מופיע רק אם `$pay["document"]` קיים                            |
| 2        | לחיצה על הכפתור              | פתיחת המסמך בחלון חדש או מודאל (בהתאם למימוש בפועל)             |

### 2. תיאור המימוש בקוד (Back-End Perspective)
- **תיאור כללי**: בתוך הלולאה על חוות הדעת, בודקים `if($pay["document"])`, אם כן – מכניסים `onclick="openDoc('...')"`.
- **טבלת צעדי התרחיש**:

| מספר צעד | לוגיקה טכנית                                                    | מיקום בקוד                        | מבנה ותוכן הקוד                                                |
|----------|----------------------------------------------------------------|-----------------------------------|----------------------------------------------------------------|
| 1        | בדיקת `$pay["document"]`                                       | `foreach($pays as $pay)`          | `if($pay["document"]) { <div onclick="openDoc('...')"> ... }` |
| 2        | קריאה לפונקציה JavaScript `openDoc(...)` שאינה מוגדרת בקובץ זה | `<div class="showOrder" ...>`     | ייתכן שהיא פונקציה גלובלית במערכת, אינה מוצגת בשני הקבצים       |

---

### הערה בנוגע ל-`ajax_global.php`:
מעבר לנתיב `"ownComment"`, יש בקובץ `ajax_global.php` מקרים רבים (`case`...) המיועדים לבקשות אחרות במערכת (כגון `getcoords`, `treatmentStartTimes`, ועוד). בקובץ `reviews.php` לא נמצאו קריאות AJAX עבורם, ולכן אין לנו די נתונים לשרטט תרחישי שימוש נוספים מנקודת מבט המשתמש. ברור שהקוד שם מנהל היגיון עסקי נוסף (כמו עריכת מחירים, תקופות, ימי סופ"ש וכו'), אך בעמוד `reviews.php` הם לא מופעלים.

---

# 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך מקוצר לשימוש בעמוד חוות הדעת (reviews.php):

1. **פתיחת הדף**
    - גש לכתובת המפנה אל `reviews.php`.
    - אם אתה בעל הרשאת מנהל, יופיע למעלה אזור "שליחת חו"ד".

2. **חיפוש וסינון חוות דעת**
    - בחלק העליון של העמוד, לחץ על כותרת "חפש חוות דעת" כדי לפתוח את טופס החיפוש.
    - בחר מתחם (אם יש לך גישה למספר מתחמים), הגדר תאריכים, והכנס מילת חיפוש חופשית.
    - לחץ על "חפש" – התוצאות יתעדכנו בהתאם.

3. **שליחת קישור למילוי חוות דעת (מנהלים בלבד)**
    - אם אתה מנהל, תראה בלוק "שליחת חו"ד".
    - בחר את המתחם הרצוי ולחץ על הכפתור "שליחת חו"ד" או על הקישור "קישור למילוי חו"ד" כדי לשלוח/להעתיק קישור ללקוח.

4. **הוספה או עריכת תגובת בעל האתר**
    - ליד כל חוות דעת מופיע קישור "הוסף תגובה" או "ערוך תגובה".
    - לחץ עליו כדי לפתוח חלונית קופצת, הזן את התגובה ולחץ על "שמירה".
    - התגובה תישמר במסד הנתונים ותוצג בעתיד לצד הביקורת.

5. **צפייה בהזמנה (אם קיימת)**
    - אם לחוות הדעת משויך orderID, יופיע כפתור "הצג הזמנה".
    - לחיצה עליו תוביל לפתיחת פרטי ההזמנה (למשל בחלון חדש).

6. **צפייה במסמך אסמכתא (אם קיים)**
    - אם הועלה מסמך לחוות הדעת, תופיע אפשרות "הצג אסמכתא".
    - לחיצה פותחת את המסמך (PDF או אחר) לצפייה/הורדה.

---

# 7. סיכום
שני הקבצים יוצרים מערכת מלאה לניהול חוות דעת:
- `reviews.php` מטפל בצד התצוגה והפעולות של המשתמש בעמוד הביקורות (חיפוש, סינון, הוספת תגובה, שליחת קישורים ועוד).
- `ajax_global.php` אחראי לעיבוד AJAX בצד השרת, ובפרט לטיפול בבקשה `ownComment`, שמאפשרת להכניס או לערוך תגובה לביקורת ולהודיע ללקוח על כך.  
  בקוד הקיים קיימים מנגנוני בדיקת הרשאות, בקרת מתחמים וסינון חוות דעת, וכן פעולות נוספות שאינן מופעלות מ-`reviews.php`. באופן כללי, המערכת מציגה יכולת גמישה לשינוי והרחבה של תהליכי עבודה סביב ביקורות, תגובות, והיבטים נוספים (לדוגמה עריכת מחירים והגדרת זמינות) – אך אלה לא מתבטאים ישירות בעמוד "reviews.php".


