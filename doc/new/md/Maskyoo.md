# 1. הקדמה
בקבצים שנבדקו מופיעים קטעי קוד הקשורים למערכת ניהול והצגת מידע על שיחות נכנסות (דרך שירות חיצוני בשם Maskyoo), וכן שליחת הודעות SMS דרך שירות `sms.deals`. הקוד מציג כיצד משתמשים בפרטי גישה (משתמש וסיסמה) על מנת לשלוח SMS, לרשום שם שולח חדש, ולאסוף מידע על שיחות ממערכות חיצוניות של Maskyoo. בנוסף, ישנם קבצים המיועדים להצגת הדוחות ופרטי השיחות (כגון זמן השיחה, סטטוס וכדומה) עבור משתמשים שונים (ממשק `member` ו-`user`).

הרציונל העיקרי בקוד:
- שימוש במחלקה `Maskyoo` לצורך שליחת הודעות SMS ורישום "שם שולח" חדש.
- משיכת רשומות של שיחות ממערכת Maskyoo ושמירתן לטבלת `maskyooCalls` במסד הנתונים.
- הצגת דוחות שיחה למשתמשים (כולל זמני התחלה, סיום, סטטוס השיחה ועוד).

המסמך להלן מרכז את כל המידע שנמצא הלכה למעשה בקבצים, ללא הוספת פרטים חיצוניים.

---

# 2. הקבצים שנבדקו

1. **api/classes/class.Maskyoo.php**  
   - מכיל מחלקה בשם `Maskyoo` עם שדות סטטיים `$user`, `$pass` ופעולה סטטית `sms($msg, $destination, $sender = 'V4Vacation')`.  
   - הפעולה מבצעת שליחת SMS דרך כתובת `https://sms.deals/ws.php`, באמצעות קריאת `curl` לביצוע הבקשה.  
   - בעת הצלחה מוחזר פלט השרת, ובכישלון מוחזר `"ERROR"` או `"error_no_sender"`.

2. **cms/classes/class.Maskyoo.php**  
   - מכיל מחלקה בשם `Maskyoo` עם שדות סטטיים `$user`, `$pass` (ערכי סיסמה שונים מהקובץ הקודם) ושתי פעולות סטטיות עיקריות:
     1. `sms($msg, $destination, $sender)` – לשליחת SMS (לוגיקה דומה לקובץ הקודם).  
     2. `register_name($name)` – לשליחת בקשה לכתובת `https://www.sms.deals/api/ws.php?service=add_sender_text` לצורך רישום שם שולח חדש (Sender Name).  
   - בכל מקרה, השיטה משתמשת ב-`curl` וחוזרת עם התשובה (או `ERROR CODE X` במקרה של שגיאה).

3. **cms/moduls/minisites/stats/maskyoo.php**  
   - קובץ שמייבא (`include_once`) את `"../../../bin/system.php"`.  
   - כולל פונקציות `post_data($url, $data, $tkn)` ו-`getCalls($url, $tkn, $from, $to)` לביצוע קריאות API אל שרת Maskyoo והחזרת תוצאות של שיחות.  
   - מנגנון הבאת השיחות:  
     - משתמש ברשימת טוקנים (token) שונים (`$tokens`) עבור מספר ערוצים (`mamash`, `vila4u`, `peaks_251`),  
     - מבצע לולאה על כל טוקן ושולף את השיחות בעזרת `getCalls()`,  
     - משלב (`array_merge`) את כל השיחות למערך `$result['result']`.  
   - בסיום, רץ על השיחות שהוחזרו וכאשר נמצא התאמה לטלפון (בעזרת `$sitesPhones` מתוך DB), הוא מוסיף רשומה לטבלת `maskyooCalls`.  
   - כישלונות או שגיאות נרשמים בקובץ `maskyooerror.txt`.

4. **member/partials/stats/maskyoocall.php**  
   - מציג כותרת "שיחות מסקיו".  
   - מכין מערך `$disposition` לתרגום סטטוס שיחה (ANSWER=נענה, NOANSWER=לא נענה, וכו').  
   - מציג טבלה עם מידע על השיחות מהטבלה `maskyooCalls` (שאילתה: `SELECT * FROM maskyooCalls ... order by start_call DESC`).  
   - בטבלה מופיעים עמודות: מספר רץ, מספר טלפון של המתקשר, מספר היעד, שעת התחלה, שעת סיום, משך השיחה, סטטוס.  
   - חישוב משך השיחה נעשה בעזרת `DateTime` ו-`diff`.

5. **user/partials/stats/maskyoocall.php**  
   - תוכן כמעט זהה לקובץ הנמצא בנתיב `member/partials/stats/maskyoocall.php`.  
   - גם כאן מוצגת טבלת השיחות עם אותם פרמטרים ועמודות, וחישוב משך השיחה.

---

# 3. הקבצים שלא נמצאו
לא צוינו ברשימה קבצים עם סימון מפורש של "הקובץ לא נמצא". לפיכך, רשימה זו ריקה.

---

# 4. הקבצים שלא נבדקו
להלן קבצים שנרמז על קיומם או על שימוש בהם דרך הקוד, אך אינם מופיעים ברשימת הקבצים שנסרקו ואינם סווגו כ"קובץ לא נמצא":

1. **system.php**  
   - מופיע בפקודת `include_once "../../../bin/system.php"`.  
   - לא נכלל ברשימת הקבצים שנסרקו.

2. **udb (שם לא ידוע במדויק)**  
   - הקוד מפעיל קריאות סטטיות `udb::insert()`, `udb::full_list()`, `udb::key_row()`.  
   - לא ידוע שם הקובץ המדויק (למשל `udb.class.php`, `udb.php` וכד’), אך ברור שישנה תלות חיצונית בקובץ המכיל את המחלקה/הפונקציונליות `udb::`.

> (**הערה:** הקבצים `index.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php`, `auth.php`, `functions.php` לא נכללים כאן בהתאם להנחיה מפורשת להתעלם מאזכורים שלהם.)

---

# 5. תרחישים כוללים בעמוד

## הוראות לניתוח קוד ובניית תרחישי שימוש באופן אופטימלי

### **5.1 זיהוי כל תרחישי השימוש**
מתוך הקבצים שנבדקו, ניתן לזהות את התרחישים הבאים:

1. **תרחיש שליחת הודעת SMS**  
   (מתבסס על הקבצים `api/classes/class.Maskyoo.php` ו-`cms/classes/class.Maskyoo.php` – המתודה `sms`)

2. **תרחיש רישום שם שולח חדש**  
   (מתבסס על המתודה `register_name` ב-`cms/classes/class.Maskyoo.php`)

3. **תרחיש איסוף שיחות ממערכת Maskyoo ושמירתן**  
   (מתבסס על `cms/moduls/minisites/stats/maskyoo.php`)

4. **תרחיש צפייה ברשימת השיחות (בממשק Member)**  
   (מתבסס על `member/partials/stats/maskyoocall.php`)

5. **תרחיש צפייה ברשימת השיחות (בממשק User)**  
   (מתבסס על `user/partials/stats/maskyoocall.php`)

---

### **5.2 מבנה הניתוח של כל תרחיש שימוש**
הניתוח של כל תרחיש שימוש יחולק לשני חלקים:
1. **תיאור משתמש הקצה (Front-End / User Perspective)**  
2. **תיאור המימוש בקוד (Back-End / Developer Perspective)**  

להלן פירוט עבור כל תרחיש שימוש.

---

### **5.3 ניתוח משתמש הקצה (Front-End Perspective)**

#### **תרחיש 1: שליחת הודעת SMS**
- **תיאור כללי:** המשתמש (אדמין/מערכת) מעוניין לשלוח הודעת SMS למספר יעד מסוים עם תוכן הודעה וסוג שולח (Sender).
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש         | תוצאה מצופה                                                  |
|----------|--------------------------|--------------------------------------------------------------|
| 1        | מזין תוכן הודעה ומספר יעד + שם שולח | מצפה שהמערכת תשדר את ה-SMS לשירות החיצוני (`sms.deals`).   |
| 2        | לוחץ "שליחה" או מפעיל פונקציה לשליחת SMS | קבלת אישור על הצלחה או כישלון בשליחת ההודעה.                |

---

#### **תרחיש 2: רישום שם שולח חדש**
- **תיאור כללי:** המשתמש רוצה להוסיף שם חדש שיוכר כשולח חוקי למערכת ה-SMS.
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                     | תוצאה מצופה                                                         |
|----------|--------------------------------------|---------------------------------------------------------------------|
| 1        | מזין שם שולח חדש (טקסט)             | המערכת שולחת בקשה לרישום השם לשרתי `sms.deals`.                     |
| 2        | לוחץ "רישום שולח" או מפעיל פונקציה מתאימה | מתקבל אישור הצלחה או כישלון, בהתאם לתגובה מהשירות החיצוני.         |

---

#### **תרחיש 3: איסוף שיחות ממערכת Maskyoo ושמירתן**
- **תיאור כללי:** המערכת (אוטומטית או מי שמפעיל את הקובץ) מבצעת משיכה של נתוני שיחות חדשות ממספר כתובות/טוקנים של Maskyoo, ושומרת את הרשומות במסד הנתונים.
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                         | תוצאה מצופה                                                               |
|----------|------------------------------------------|---------------------------------------------------------------------------|
| 1        | מפעיל סקריפט/עמוד שמריץ את `maskyoo.php` | מתבצעת שאילתת API לכל URL והטוקן המתאימים, ונאספים נתוני השיחות האחרונים. |
| 2        | תהליך סיום                                | נוצרת/מתעדכנת טבלת `maskyooCalls` עם שיחות חדשות שזוהו.                  |

*(בתרחיש זה לרוב אין פעולה ידנית אלא הגדרת קרון/הרצה יזומה — אולם מנקודת מבט המשתמש, מספיק להפעיל את הסקריפט.)*

---

#### **תרחיש 4: צפייה ברשימת השיחות (ממשק Member)**
- **תיאור כללי:** משתמש מסוג Member נכנס למסך צפייה בשיחות Maskyoo, ורואה את כל השיחות האחרונות.
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                            | תוצאה מצופה                                                                 |
|----------|---------------------------------------------|----------------------------------------------------------------------------|
| 1        | פותח את הדף `member/partials/stats/maskyoocall.php` | טבלת שיחות נטענת, מציגה את הפרטים: שעת התחלה, שעת סיום, משך, סטטוס וכו'.   |
| 2        | מסתכל בנתונים                               | רואה את הסטטוסים בתרגום לעברית (נענה/לא נענה/בוטל וכו').                    |

---

#### **תרחיש 5: צפייה ברשימת השיחות (ממשק User)**
- **תיאור כללי:** משתמש קצה (User) נכנס לעמוד ייעודי ומקבל מידע דומה על שיחות Maskyoo, בהתאמה להרשאותיו.
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                         | תוצאה מצופה                                                                                |
|----------|------------------------------------------|--------------------------------------------------------------------------------------------|
| 1        | פותח את הדף `user/partials/stats/maskyoocall.php` | טבלת עם שיחות Maskyoo, מציגה נתוני שעת התחלה, סיום, סטטוס ושאר נתונים רלוונטיים.          |
| 2        | קורא את המידע המוצג                       | רואה פירוט השיחה ומספרים מקוצרים (מומר `972` ל-`0`), זמנים וסטטוס.                        |

---

### **5.4 ניתוח המימוש בקוד (Back-End Perspective)**

#### **תרחיש 1: שליחת הודעת SMS**

- **תיאור כללי:**  
  המחלקה `Maskyoo` (בקובצי `class.Maskyoo.php` השונים) משתמשת בפרטי גישה סטטיים `$user`, `$pass` לשירות `sms.deals`. נעשית קריאת `curl` לכתובת URL ייעודית הכוללת את משתני ההודעה, היעד והשולח.

- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                                                                                       | מיקום בקוד                            | מבנה ותוכן הקוד                                                                                               |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|----------------------------------------------------------------------------------------------------------------|
| 1        | מקבל משתני `$msg`, `$destination`, `$sender` ומוודא שיש ערך ב-`$sender`.                                                                           | `sms()` בתוך `class.Maskyoo.php`       | ```php<br>if($sender){<br>   $sms_user = self::$user;<br>   $sms_password = self::$pass;<br>   ...<br>}<br>``` |
| 2        | מקודד את ההודעה (`urlencode`) ובונה URL פנייה לשירות `sms.deals/ws.php?service=send_sms&message=...&dest=...&sender=...&username=...&password=...` | אותו מיקום                            | ```php<br>$request = "https://sms.deals/ws.php?service=send_sms&message=".$msg."&dest=".$destination."&sender=".$sender..."``` |
| 3        | יוצר קריאת `curl`, שולח את הבקשה, בודק את `CURLINFO_HTTP_CODE` ומחזיר תוצאה (`"ERROR"`) או את תשובת השרת.                                          | אותו מיקום                            | `curl_init()`, `curl_setopt()`, `curl_exec()`, בדיקת `$curlStatus == 200`.                                     |

---

#### **תרחיש 2: רישום שם שולח חדש**

- **תיאור כללי:**  
  מתודה `register_name($name)` שולחת בקשה לכתובת `https://www.sms.deals/api/ws.php?service=add_sender_text` כדי להוסיף את השם החדש לרשימת השולחים המורשים.

- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                                                                          | מיקום בקוד                             | מבנה ותוכן הקוד                                                                                                     |
|----------|---------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| 1        | מקבל `$name` ומחבר את פרטי המשתמש והסיסמה מהמחלקה `Maskyoo`.                                                                          | `register_name()` בתוך `class.Maskyoo.php` | ```php<br>$request = 'https://www.sms.deals/api/ws.php?service=add_sender_text&username=' . urlencode(self::$user) ...``` |
| 2        | מבצע `curl_exec` על `$request`, בודק קוד החזרה (`$curlStatus`), ומחזיר את הטקסט המלא או הודעת שגיאה.                                  | אותו מיקום                             | `curl_setopt($curlSend, CURLOPT_RETURNTRANSFER, 1);` ואז `curl_exec($curlSend)`.                                     |

---

#### **תרחיש 3: איסוף שיחות ממערכת Maskyoo ושמירתן**

- **תיאור כללי:**  
  הקובץ `maskyoo.php` (תיקיית `cms/moduls/minisites/stats`) מבצע קריאות API למספר כתובות. תוצאת ה-JSON מפוענחת, ואם `status.code == 200`, הוא ממזג את מערך השיחות הגולמיות לתוך `$result['result']`. כל שיחה נשמרת למסד רק אם נמצא טלפון מתאים ב-`$sitesPhones`.

- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                                                                       | מיקום בקוד                                  | מבנה ותוכן הקוד                                                                    |
|----------|------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------|-------------------------------------------------------------------------------------|
| 1        | `include_once "../../../bin/system.php";` (תלות חיצונית)                                                                          | תחילת `maskyoo.php`                        | `include_once "../../../bin/system.php";`                                           |
| 2        | הגדרת פונקציות `post_data()` ו-`getCalls()` ומשתנה `$tokens` עם כתובות `url` ו-`token`.                                           | בתוך `maskyoo.php`                         | ```php<br>$tokens['mamash']['url'] = "...";<br>$tokens['mamash']['token'] = "...";``` |
| 3        | לולאה על כל ערך ב-`$tokens`, קריאה ל-`getCalls()`, איחוד התוצאות ב-`$result['result']`.                                            | בתוך `foreach ($tokens as $k=>$tkn) {...}` | `if($tmp['result']) { $result['result'] = array_merge($result['result'],$tmp['result']); }`                              |
| 4        | עיבוד תוצאת `$result['result']`, בדיקה האם מספר טלפון נמצא ב-`$sitesPhones`; אם כן, הוספת רשומה לטבלת `maskyooCalls`.             | `foreach ($result['result'] as $call) {...}`| `udb::insert("maskyooCalls",$cp,true);`                                             |

---

#### **תרחיש 4: צפייה ברשימת השיחות (ממשק Member)**

- **תיאור כללי:**  
  הקובץ `member/partials/stats/maskyoocall.php` מציג טבלה עם תוצאות השאילתה מטבלת `maskyooCalls`, כולל חישוב של משך השיחה ותרגום הסטטוס.

- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                           | מיקום בקוד                                        | מבנה ותוכן הקוד                                               |
|----------|----------------------------------------------------------------------------------------|---------------------------------------------------|---------------------------------------------------------------|
| 1        | מוגדר מערך `$disposition` לתרגום ערכי הסטטוס (ANSWER, NOANSWER, BUSY...) לערכים בעברית | בראש הקובץ `maskyoocall.php`                      | ```php<br>$disposition = Array(...);```                      |
| 2        | מוגדר `SELECT * FROM maskyooCalls ... order by start_call DESC` לקבלת כל השיחות       | `$maskyooSql = "SELECT * FROM maskyooCalls ...";` | `udb::full_list($maskyooSql);`                                |
| 3        | ריצה בלולאה על כל שיחה שנמצאה, חישוב `DateTime` והפרש דקה/שנייה להצגת משך השיחה        | `foreach ($maskyoo as $call) {...}`               | ```php<br>$diff = $start_datetime->diff(new DateTime($datetime_2));``` |

---

#### **תרחיש 5: צפייה ברשימת השיחות (ממשק User)**

- **תיאור כללי:**  
  הקובץ `user/partials/stats/maskyoocall.php` פועל באופן דומה מאוד ל-`member/partials/stats/maskyoocall.php`, אך מותאם לממשק ה-User.

- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                           | מיקום בקוד                                     | מבנה ותוכן הקוד                                               |
|----------|----------------------------------------------------------------------------------------|------------------------------------------------|---------------------------------------------------------------|
| 1        | מערך `$disposition` זהה, עם השאילתה `SELECT * FROM maskyooCalls ...`                  | בראש הקובץ `maskyoocall.php`                  | ```php<br>$disposition = Array(...);```                      |
| 2        | לולאה על כל שיחה, כולל חישוב משך השיחה והצגה בטבלה                                     | `foreach ($maskyoo as $call) {...}`           | שימוש ב-`DateTime` ו-`diff` לקבלת דקות/שניות                 |

---

# 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך מקוצר כיצד להשתמש בפונקציונליות/דפים שהוזכרו:

1. **שליחת SMS**:  
   - גש לממשק המתאים או לקריאה הפנימית המפעילה את הפונקציה `Maskyoo::sms($msg, $destination, $sender)`.  
   - הזן את תוכן ההודעה `$msg`, את מספר הטלפון `$destination`, ואת שם/מספר השולח `$sender`.  
   - הפעל את הפונקציה. אם הכל תקין, תתקבל תשובת הצלחה מהשרת; אחרת הודעת שגיאה.

2. **רישום שם שולח חדש**:  
   - מתוך ממשק ניהול, הזן את השם המבוקש כרכיב שולח חדש.  
   - הפעל את הפעולה `Maskyoo::register_name($name)`.  
   - במידה ויש הרשאה מתאימה, המערכת תחזיר הודעת הצלחה, או תציין שגיאה במידה ושם זה כבר תפוס או לא מאושר.

3. **איסוף שיחות**:  
   - הפעל (ידנית או ע"י Cron) את הסקריפט `cms/moduls/minisites/stats/maskyoo.php`.  
   - הסקריפט יקרא ל-API של Maskyoo, יאסוף שיחות חדשות, וישמור אותן לטבלת `maskyooCalls`.  
   - במקרה של שגיאה, היא תירשם בקובץ `maskyooerror.txt`.

4. **צפייה ברשימת שיחות (ממשק Member/User)**:  
   - היכנס לנתיב `member/partials/stats/maskyoocall.php` או `user/partials/stats/maskyoocall.php`.  
   - יוצג בפניך דוח השיחות הכולל זמן התחלה, סיום, מספרים (ANI/DDI), ומשך השיחה.  
   - במידה והשיחה נענתה או בוטלה, הסטטוס יופיע בעברית (נענה/לא נענה/תפוס וכו').

---

# 7. סיכום
הקבצים שסופקו מציגים לוגיקה טכנית ושלבי מימוש עבור מערכת משלוח SMS (דרך `Maskyoo`) ואיסוף נתוני שיחות. במקביל, יש ממשקים להצגת היסטוריית השיחות וסיכום נתוני השיחה למשתמשים מסוגים שונים.  
שלבי העבודה כוללים:
- שימוש במחלקת `Maskyoo` לשליחת SMS ורישום שם שולח.
- איסוף שיחות בעזרת סקריפט ייעודי ושמירתן במסד נתונים.
- הצגה ברורה של הנתונים בטבלאות לפי הרשאות משתמש.

מערכת זו נשענת על קבצי עזר חיצוניים (`system.php` ופתרון `udb::`) המוסיפים פונקציונליות בסיסית (כגון גישה ל-DB והגדרות מערכת), אך אינם נכללים בקבצים שנסרקו.

