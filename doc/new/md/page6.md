# 1. הקדמה
המערכת המתוארת בקבצים אלו עוסקת בניהול מנויים (subscriptions) וגיפט-קארדים (giftcards).  
ניתן, למשל, ליצור/לערוך מנוי, להוסיף טיפולים (treatments), להגדיר הנחות ותשלומים, לבצע חיפוש מנויים, לנהל שליחת SMS, לנהל כרטיסי גיפט-קארד (קביעת תוקף, הצגה, מימוש, זיכוי), ועוד.  
התוכן מבוסס **אך ורק** על המידע שהופיע בקבצים הספציפיים שסופקו ונסרקו במלואם.

---

# 2. הקבצים שנבדקו
להלן רשימת הקבצים שנסרקו בפועל ושיש בהם תוכן:

1. **pages/subscriptions.php**
    - מציג עמוד לניהול מנויים, כולל חיפוש (לפי תאריכים וחיפוש חופשי) והצגת טבלה עם מספר מנוי, שם לקוח, סטטוס, כמות טיפולים ועוד.
    - מכיל כפתור “הוסף חדש” לפתיחת ממשק הוספה/עריכה.
    - משתמש בקובץ `assets/js/giftcards.js` ב-JavaScript, ומבצע פעולות AJAX מול `ajax_subscription.php`.
    - אפשרות “איתור מנוי מהיר” ע"י הקלדת מספר מנוי.

2. **assets/js/giftcards.js**
    - אוסף פונקציות JavaScript לניהול ממשק גיפט-קארדים: טעינה/עריכה/מחיקה, העלאת תמונות, reset לסדר תצוגה ועוד.
    - מבצע קריאות AJAX לקבצים שונים, כגון `ajax_giftcards_setting.php`, `ajax_load_giftcard.php` ועוד.

3. **ajax_subscription.php**
    - קובץ PHP לטיפול בצד שרת עבור מנויים: טעינת פרטי מנוי (loadSub), שמירת מנוי חדש/קיים (saveSubs), חיפוש מנוי לפי מספר ועוד.
    - מבצע עדכונים בטבלאות `subscriptions`, `subscriptionTreatments` ועוד, בתיאום עם הרשאות המשתמש.

4. **ajax_client.php**
    - סקריפט PHP המטפל בפעולות הקשורות ללקוחות (Client), בעיקר חיפוש AutoComplete של לקוחות לפי שם/טלפון/ת"ז/אימייל.
    - מחזיר JSON עם רשימת לקוחות מתאימים.

5. **ajax_spaSMS.php**
    - סקריפט PHP לשליחת SMS ללקוח (באמצעות ספק חיצוני - `Maskyoo::sms`).
    - מאחסן תיעוד השליחה בטבלאות מתאימות (כגון `orders_sms` או `sms_manual`).

6. **ajax_giftcards_setting.php**
    - משמש לקריאה/עדכון של הגדרות כלליות עבור גיפט-קארדים (title, לוגו, תמונת רקע, תיאור ועוד).
    - תומך בהעלאת תמונות (באמצעות `pictureUpload`).

7. **ajax_load_giftcard.php**
    - מטפל בפעולות CRUD (יצירה, טעינה, מחיקה לוגית, שינוי סדר) של גיפט-קארדים.
    - `act=0` לקריאה, `act=1` ליצירה או עדכון, `act=2` הפעלה/השבתה, `act=3` מחיקה, `act=4` עדכון סדר תצוגה.

8. **ajax_pop_gift.php**
    - מציג פופ-אפ עם פרטי הגיפט-קארד (משתמש בטבלת `gifts_purchases`), כולל יתרה, תוקף, שם המזמין, אפשרויות מימוש חלקי/מלא/זיכוי.
    - מחלץ מידע על שימושים (giftCardsUsage) ומציגם בטבלה.


---

# 3. הקבצים שלא נמצאו
לא נמצאו קבצים שהוגדרו ברשימה אך אינם קיימים בפועל.  
(לא קיימת אינדיקציה לכך שיש “הקובץ לא נמצא”.)

---

# 4. הקבצים שלא נבדקו
קיימים מספר קבצים המוזכרים בקוד (או לוגית נדרשים), אך **אינם מופיעים** ברשימה שנסרקה בפועל:

1. **ajax_giftcards.php**
2. **download_invoice_gc.php**
3. **../picUpload.php**

*(בקבצים הנסרקים יש קריאות או הפניות לקבצים אלו, אך הם אינם מופיעים ברשימת הקבצים שנבדקו או בהגדרת קבצים שלא נמצאו.)*

---

# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

להלן תרחישי שימוש אפשריים, בהתבסס על הקוד שבקבצים שנסרקו.

## 5.1 זיהוי כל תרחישי השימוש
1. **תרחיש חיפוש מנויים**
2. **תרחיש הוספת/עריכת מנוי**
3. **תרחיש הוספת טיפולים למנוי**
4. **תרחיש איתור מנוי מהיר (fast-find)**
5. **תרחיש שליחת הודעת SMS ללקוח**
6. **תרחיש ניהול הגדרות גיפט-קארדים** (title, רקע, לוגו, וכו’)
7. **תרחיש ניהול והצגת גיפט-קארדים** (יצירה, עריכה, מחיקה, סדר)
8. **תרחיש צפייה בגיפט-קארד (פופ-אפ) ומימוש**

---

## 5.2 מבנה הניתוח של כל תרחיש
לכל תרחיש נציג שני חלקים:

1. **Front-End** – תיאור משתמש הקצה
2. **Back-End** – תיאור המימוש בקוד

---

## 5.3 ניתוח משתמש הקצה (Front-End Perspective)

### תרחיש 1: חיפוש מנויים
**תיאור כללי (Front-End):**  
המשתמש פותח את עמוד `subscriptions.php`, ממלא פרטי חיפוש (תאריכים או טקסט חופשי) ולוחץ “חפש”.

**טבלת צעדים**  
| מס׳ צעד | פעולה מצד המשתמש                             | תוצאה מצופה                                                                 |
|---------|---------------------------------------------|-----------------------------------------------------------------------------|
| 1       | פתיחת העמוד `subscriptions.php`              | מוצג טופס חיפוש + טבלת מנויים מלאה.                                        |
| 2       | מילוי שדות חיפוש (תאריכי הפקה, “חיפוש חופשי”) | המשתמש מזין קריטריונים לצמצום התוצאות.                                      |
| 3       | לחיצה על “חפש”                                | ביצוע AJAX/בקשת GET, והצגת טבלת מנויים מסוננת לפי הקריטריונים שהוזנו.       |

---

### תרחיש 2: הוספת/עריכת מנוי
**תיאור כללי (Front-End):**  
לחיצה על כפתור “הוסף חדש” או לחיצה על שורה בטבלת המנויים תפתח חלון עריכה. המשתמש ממלא או משנה פרטים, ואז שומר.

**טבלת צעדים**  
| מס׳ צעד | פעולה מצד המשתמש                     | תוצאה מצופה                                                            |
|---------|--------------------------------------|-------------------------------------------------------------------------|
| 1       | לחיצה על “הוסף חדש” או על מנוי קיים  | מופיע פופ-אפ (או דף פנימי) לעריכת פרטי המנוי (שם, טלפון, דוא”ל וכו’).   |
| 2       | מילוי/עדכון הפרטים (שם, כתובת, ועוד) | הטופס מתמלא, ניתן לשנות ערכים.                                         |
| 3       | לחיצה על “שמור מנוי”                 | מתבצע שמירה (AJAX), החלון נסגר וטבלת המנויים מתעדכנת עם הנתונים החדשים. |

---

### תרחיש 3: הוספת טיפולים למנוי
**תיאור כללי (Front-End):**  
בתוך חלון עריכת מנוי, המשתמש יכול להוסיף טיפולים חדשים למנוי (מספר טיפולים, סוג טיפול, וכדומה).

**טבלת צעדים**  
| מס׳ צעד | פעולה מצד המשתמש        | תוצאה מצופה                                                            |
|---------|-------------------------|-------------------------------------------------------------------------|
| 1       | לחיצה על “הוסף טיפולים” | מופיע חלון נוסף להזנת סוג טיפול, משך, כמות טיפולים וכו’.               |
| 2       | מילוי פרטי הטיפול       | המשתמש רואה סכום/מחיר ומשך מותאמים אוטומטית (לפי הנתונים בשרת).        |
| 3       | לחיצה על “הוסף”         | הרשומה נוספת לרשימת הטיפולים בתצוגה, העלות הכוללת מתעדכנת, ממתין לשמירה. |

---

### תרחיש 4: איתור מנוי מהיר
**תיאור כללי (Front-End):**  
באותו עמוד `subscriptions.php`, יש תיבה להקלדת מספר מנוי ולחיצה לאיתור מהיר.

**טבלת צעדים**  
| מס׳ צעד | פעולה מצד המשתמש           | תוצאה מצופה                                                          |
|---------|---------------------------|-----------------------------------------------------------------------|
| 1       | הקלדת מספר מנוי בתיבת חיפוש מהיר | המשתמש מקליד מספר מפורמט ועובר ללחיצה.                               |
| 2       | לחיצה על אייקון ה”חיפוש”       | ביצוע AJAX ל־`ajax_subscription.php` (act=findSubs) בהתאם לקלט.       |
| 3       | הצגת תוצאות (אם נמצאו)       | אם נמצא מנוי מתאים, נפתח חלון עריכה / מעבר לעריכת אותו מנוי.         |

---

### תרחיש 5: שליחת הודעת SMS ללקוח
**תיאור כללי (Front-End):**  
לאחר שנוצר מנוי, או בתוך הממשק, ניתן לשלוח SMS ללקוח (למשל אישור הזמנה). המשתמש לוחץ על כפתור “שליחת SMS”, עורך את ההודעה ושולח.

**טבלת צעדים**  
| מס׳ צעד | פעולה מצד המשתמש            | תוצאה מצופה                                                                |
|---------|----------------------------|-----------------------------------------------------------------------------|
| 1       | לחיצה על כפתור “שליחת SMS” | נפתח חלון/פופ-אפ לעריכת תוכן ההודעה.                                       |
| 2       | עריכת הטקסט                | המשתמש מקליד/מתקן את תוכן ההודעה (מוגבל במספר תווים).                        |
| 3       | לחיצה על “שליחה”           | מתבצע קריאה לשרת (AJAX), ההודעה נשלחת, מופיעה הודעה על הצלחה/כישלון.        |

---

### תרחיש 6: ניהול הגדרות גיפט-קארדים
**תיאור כללי (Front-End):**  
במערכת קיימת אפשרות להגדיר כרטיסי מתנה בצורה מותאמת (טקסט, רקע, לוגו וכו’). המשתמש פותח את טופס ההגדרות, מעלה לוגו/תמונת רקע ומעדכן שדות טקסט.

**טבלת צעדים**  
| מס׳ צעד | פעולה מצד המשתמש                           | תוצאה מצופה                                                                 |
|---------|-------------------------------------------|------------------------------------------------------------------------------|
| 1       | כניסה למסך/כפתור “ערוך הגדרות גיפט-קארדים” | מופיע פופ-אפ או דיאלוג להגדרת “title”, “desc”, “logo” וכו’.                  |
| 2       | מילוי ערכים / העלאת קבצים (תמונה/לוגו)     | המשתמש רואה תצוגה מקדימה (פונקציה `readURL`) ויכול לשנות טקסטים.            |
| 3       | לחיצה על “שמור”                            | המערכת שולחת את הנתונים (AJAX) ל־`ajax_giftcards_setting.php`, מעדכנת את ההגדרות. |

---

### תרחיש 7: ניהול והצגת גיפט-קארדים
**תיאור כללי (Front-End):**  
ברשימת הגיפט-קארדים ניתן לטעון מידע על כרטיס מסוים, לערוך את פרטיו (כותרת, סכום, תוקף), למחוק אותו (מחיקה לוגית), לשנות סדר וכדומה.

**טבלת צעדים**  
| מס׳ צעד | פעולה מצד המשתמש                              | תוצאה מצופה                                                                         |
|---------|----------------------------------------------|--------------------------------------------------------------------------------------|
| 1       | בחירת גיפט-קארד מרשימה או לחיצה על “הוסף גיפט” | נפתח טופס (פופ-אפ) עם השדות: כותרת, תיאור, סכום, תוקף, תמונה וכו’.                   |
| 2       | עריכת השדות                                  | המשתמש רואה עדכוני תצוגה בהתאם (כולל העלאת תמונה, הסתרת שדות לפי giftType).          |
| 3       | לחיצה על “שמור” או “מחק”                     | מתבצע AJAX ל־`ajax_load_giftcard.php` (act=1 ליצירה/עריכה, act=3 למחיקה), והעמוד מתעדכן. |

---

### תרחיש 8: צפייה בגיפט-קארד (פופ-אפ) ומימוש
**תיאור כללי (Front-End):**  
משתמש יכול לצפות בפרטי גיפט-קארד (בפופ-אפ), לראות יתרה ותוקף, ולממש באופן חלקי/מלא או לבצע זיכוי (Refund).

**טבלת צעדים**  
| מס׳ צעד | פעולה מצד המשתמש                                           | תוצאה מצופה                                                                        |
|---------|-----------------------------------------------------------|-------------------------------------------------------------------------------------|
| 1       | לחיצה על כפתור “צפייה” (או קוד גיפט-קארד)                  | נפתח פופ-אפ (ע"י AJAX מול `ajax_pop_gift.php`), מציג פרטי הרכישה/היתרה.             |
| 2       | לחיצה על “מימוש חלקי” או “מימוש מלא”                       | מופיע חלון/טופס למילוי סכום, ואישור סופי.                                           |
| 3       | לחיצה על “אשר”                                            | ביצוע עדכון בבסיס נתונים (giftCardsUsage), סגירה והטעינה מחדש, או הצגה מעודכנת של היתרה. |
| 4       | (אופציונלי) לחיצה על “זיכוי” (Refund) אם זמין (direct)    | תתבצע פעולת זיכוי (AJAX) אם לא מומש (או מימוש=0). מופיע אישור/שגיאה בהתאם לתנאים.   |

---

## 5.4 ניתוח המימוש בקוד (Back-End Perspective)

**דוגמה כוללת**: נפרט כאן דוגמא מפורטת לשני תרחישים כמודל, כאשר בשאר התרחישים העיקרון דומה (בקבצים נצפו פעולות AJAX דומות).

---

### דוגמה: תרחיש 1 (חיפוש מנויים) – Back-End

**תיאור כללי:**  
עם שליחת טופס החיפוש או לחיצה על כפתור “חפש”, עמוד `subscriptions.php` קורא מצד השרת ומריץ שאילתות על בסיס הנתונים (`subscriptions`), בהתבסס על תאריכים ומחרוזת חיפוש חופשית.

**טבלת צעדים (Back-End)**  
| מס׳ צעד | לוגיקה טכנית                                                                                  | מיקום בקוד                       | מבנה ותוכן הקוד                                                                                                 |
|---------|----------------------------------------------------------------------------------------------|----------------------------------|-------------------------------------------------------------------------------------------------------------------|
| 1       | קליטת פרמטרים GET (`createDate`, `createDateTo`, `free`)                                     | `subscriptions.php`, שורות החיפוש | נבדק `$tmp = UtilsDate::date2db($_GET['createDate'])` וכדומה, ונבנה מערך `$where`.                               |
| 2       | בניית שאילתא SQL לצירוף התניות (רשימת `$where`)                                             | `subscriptions.php`               | `$que = "SELECT ... FROM subscriptions ... LEFT JOIN subscriptionTreatments ... WHERE ".implode(' AND ', $where)` |
| 3       | שליפת התוצאות לתוך `$list = udb::key_row($que, 'subID')`                                     | `subscriptions.php`               | בסיום מוצגים הנתונים בטבלה (מספר מנוי, שם, עלות, כמות טיפולים, סטטוס).                                           |

---

### דוגמה: תרחיש 2 (הוספת/עריכת מנוי) – Back-End

**תיאור כללי:**  
בלחיצה על “שמור מנוי” (בפופ-אפ העריכה), מתרחש קריאת AJAX ל-`ajax_subscription.php` עם `act='saveSubs'`. הנתונים נשמרים או נוצר מנוי חדש.

**טבלת צעדים (Back-End)**  
| מס׳ צעד | לוגיקה טכנית                                                                                                                         | מיקום בקוד              | מבנה ותוכן הקוד                                                                                                    |
|---------|-------------------------------------------------------------------------------------------------------------------------------------|-------------------------|----------------------------------------------------------------------------------------------------------------------|
| 1       | קליטת פרמטר `$_POST['act']` == 'saveSubs'                                                                                           | `ajax_subscription.php` | `switch($_POST['act']) { case 'saveSubs': ... }`                                                                    |
| 2       | קריאת ערכים כגון `name`, `phone`, `email`, `price_discount` וכו’, אימות (לדוגמה: אם !$input['phone'] זורקים שגיאה).                  | `ajax_subscription.php` | `if (!$input['name']) throw new Exception("Please enter correct name");` ועוד בדיקות.                                |
| 3       | במידה ומתקבל `subID`, בודקים אם קיים במערכת, אחרת נוצרת רשומה חדשה ב־`subscriptions`.                                               | `ajax_subscription.php` | `if ($subID) udb::update('subscriptions', $save, 'subID = '.$subID); else udb::insert('subscriptions',$save);`       |
| 4       | אם הוזנו טיפולים חדשים (`trin`), מבצעים insert לטבלת `subscriptionTreatments`                                                       | `ajax_subscription.php` | לולאה על `$tins` ומבצעים `udb::insert("subscriptionTreatments",$ins)`.                                              |
| 5       | מחזירים תשובת JSON על הצלחה/כישלון.                                                                                                 | `ajax_subscription.php` | `$result['status'] = 0; echo json_encode($result, ...)`.                                                             |

*(באופן דומה, יתר התרחישים מתנהלים על בסיס מנגנוני AJAX בקבצים הרלוונטיים.)*

---

## 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך קצר (בגוף שני) לשימוש במערכת, צעד אחר צעד, בהתאם לתרחישים:

1. **כניסה למסך מנויים**:
    - לאחר שתיכנסו לעמוד “ניהול מנויים” (`subscriptions.php`), תופיע רשימה של כל המנויים הקיימים.

2. **חיפוש מנוי**:
    - כדי לאתר מנוי לפי תאריכים, מלאו את טווח התאריכים ולחצו “חפש”.
    - ניתן גם למלא טקסט חופשי (שם הלקוח, טלפון, אימייל או מספר מנוי).

3. **הוספת מנוי חדש**:
    - לחצו על כפתור “הוסף חדש” (בצד ימין).
    - ייפתח פופ-אפ בו תמלאו שם, טלפון, אימייל, כתובת ופרטי הנחה/תשלום.
    - במידה ותרצו להוסיף טיפולים למנוי זה, לחצו על “הוסף טיפולים”.

4. **עריכת מנוי קיים**:
    - הקליקו על שורת המנוי בטבלה.
    - בפופ-אפ תוכלו לעדכן פרטים או להוסיף/למחוק טיפולים, ואז ללחוץ “שמור מנוי”.

5. **שליחת SMS ללקוח**:
    - במסך העריכה או באזור אחר, לחצו “שליחת SMS”.
    - במידת הצורך, ערכו את תוכן ההודעה ואשרו. תקבלו הודעת הצלחה/שגיאה בהתאם.

6. **ניהול גיפט-קארדים**:
    - בממשק הגיפט-קארדים תוכלו ליצור גיפט-קארד חדש, להגדיר סכום ותוקף, להעלות תמונה (רקע/לוגו) וכד’.
    - מחיקה מתבצעת בלחיצה על “מחק” (מחיקה לוגית).

7. **מימוש גיפט-קארד**:
    - בעת צפייה בגיפט-קארד (פופ-אפ), לחצו “מימוש חלקי” או “מימוש מלא” ומלאו את הסכום המבוקש (בחלקי).
    - אם מאושר, הסכום ינוכה מיתרת הגיפט-קארד ויוצג מעודכן.

---

# 7. סיכום
הקבצים שתוארו לעיל מציגים מערכת לניהול מנויים וגיפט-קארדים:
- ניתן להוסיף מנויים, להחיל עליהם טיפולים, לנהל תשלומים/הנחות, לחפש, ולשלוח ללקוח SMS.
- במקביל ישנו ממשק לניהול גיפט-קארדים, הכולל יצירה, עריכה, מימוש ואף זיכוי (כאשר מתקיימים תנאי ה-Refund).
- שיטת העבודה מבוססת על קריאות AJAX לקבצים השונים בצד השרת, וכל פעולה מתועדת בטבלאות בבסיס הנתונים.

מסמך זה סוקר את המערכת אך ורק בהתאם לקבצים שנבדקו בפועל ולמה שאפשר לדלות מהם.  

