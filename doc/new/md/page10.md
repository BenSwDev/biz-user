# 1. הקדמה
קבצים אלו קשורים לעמוד המרכזי של ניהול והצגת דוחות (report_manage.php) ולשני קבצים משלימים (setReportRange.php ו־orders_menu.php), העוסקים בהגדרת טווחי תאריכים (טווח ברירת מחדל, טווח חודש/שבוע/יום) ותפריטי משנה להזמנות. מעיון בתוכן, עולה כי המערכת מיועדת להפקת דוחות לפי תאריכים וסינונים שונים (תאריך רכישה, תאריך הגעה, תאריך חיוב), ולהצגת סיכומים כספיים והזמנות בממשק מפורט. הקוד כולל אפשרויות חיפוש מתקדמות, מיון עמודות, יצוא לאקסל, הדפסה, פילוח לפי אמצעי תשלום, מקורות הגעה וסוכנים.

## 2. הקבצים שנבדקו
1. **pages/report_manage.php**
    - מטפל בהצגת דוחות תקציב (תאריכים, חיפוש, סינונים).
    - מפעיל שאילתות לבסיס הנתונים (טבלאות orders, orderPayments) ומחשב סכומים וסיכומים.
    - מטפל במקרים של `timeType` שונים (1=תאריך הגעה, 2=תאריך רכישה, 3=תאריך חיוב).
    - כולל פונקציות עזר (כמו `hdate`, `db2dateD`) וקריאות לפונקציות חיצוניות (כגון `selectReportRange()`).
    - מאפשר פילוח דוח לפי סוכנים, מקורות הגעה, אמצעי תשלום (וכן "הצג הכל").
    - משתמש ב־JavaScript ו־jQuery למיון עמודות טבלה, ייצוא לאקסל, הדפסה, ועוד.

2. **partials/setReportRange.php**
    - מגדיר טווחי תאריך ברירת מחדל (החודש, השבוע, היום).
    - אם לא נקבע "מתאריך/עד תאריך" ב־`$_GET`, הוא משתמש בהגדרות אלו.
    - מכיל פונקציה `selectReportRange()` שמייצרת אלמנט ויזואלי לבחירת טווחי תאריכים מוגדרים מראש, ומעדכנת את הטופס בהתאם.

3. **partials/orders_menu.php**
    - מציג תפריט משנה (subMenu2) הקשור לעמוד הזמנות (`orders`).
    - כולל קישורים למצב פעילות, שיריונים, חתימה, הזמנות אחרונות, אירועים קרובים/שהיו, והמתנה לביטול.
    - כל קישור מופיע בתוך `<a>` עם הפרמטרים המתאימים ב־query string.

## 3. הקבצים שלא נמצאו
_(אין ברשימה קבצים שסומנו כ"לא נמצאו")_

## 4. הקבצים שלא נבדקו
- **ajax_excel_reports_manage.php**
  > מופיע בהערת JS לצורך ייצוא לאקסל (but commented out: `// window.location.href = 'ajax_excel_reports_manage.php'...`). אין תוכן ממשי בקובץ זה ברשימה שניתנה, ולכן לא נבדק.

> *(לגבי קבצים כמו `index.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php`, `auth.php`, `functions.php`– יש להתעלם מאזכורים להם על פי ההנחיות.)*

## 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

להלן תרחישים המופיעים (או משתמעים) מהקוד בקבצים שנבדקו:

---

### תרחיש שימוש 1: בחירת טווח תאריכים בעזרת תפריט "setReportRange"
#### 1. תיאור משתמש הקצה (Front-End)
- **תיאור כללי**  
  המשתמש רואה מודול בשם "setReportRange" ובתוכו מספר אפשרויות לטווחי זמן (למשל: החודש, השבוע, היום). בבחירה באחד מהם, השדות `from` ו־`to` בעמוד מתעדכנים אוטומטית, והטופס "נשלח" לצורך הצגת הדוח.

- **טבלת צעדי התרחיש**

| מספר צעד | פעולה מצד המשתמש                                 | תוצאה מצופה                                                           |
|----------|--------------------------------------------------|-----------------------------------------------------------------------|
| 1        | צפייה בכפתורים: "החודש", "השבוע", "היום"        | כפתורי טווח התאריכים מופיעים על המסך                                  |
| 2        | לחיצה על כפתור (למשל "השבוע")                   | התאריכים בטופס מתעדכנים (מתאריך/עד תאריך), הכפתור הופך `active`      |
| 3        | המתנה קצרה (מוגדרת בקוד) והגשת הטופס             | הדף נטען מחדש, מציג דוח בהתאם לטווח התאריכים שנבחר                    |

#### 2. תיאור המימוש בקוד (Back-End)
- **תיאור כללי**  
  הקובץ `partials/setReportRange.php` יוצר מערך טווחים (החודש/השבוע/היום), ובפונקציה `selectReportRange()` מוצג HTML עם כפתורים. כל כפתור מפעיל JS לשינוי השדות `from` ו־`to`, ושומר את הבחירה ב־session/LocalStorage. לאחר מכן מתבצעת שליחה אוטומטית של הטופס.

- **טבלת צעדי התרחיש (מתכנת)**

| מס׳ צעד | לוגיקה טכנית                                                                                          | מיקום בקוד                      | מבנה ותוכן הקוד                                                                                                                         |
|---------|-------------------------------------------------------------------------------------------------------|---------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| 1       | הגדרת המערך `$setnew` ובו ערכי `from`, `to` ו־`name` עבור החודש, השבוע, היום                          | `setReportRange.php` (ראש הקובץ)| `$setnew[0]['from'] = date("01/m/Y"); ... $setnew[0]['name'] = 'החודש';` וכו'.                                                          |
| 2       | בדיקת `$_SESSION[$_GET['page']]` כדי לראות אם יש כבר ערך שמור לטווח                                   | `setReportRange.php`            | `if(isset($_SESSION[$_GET['page']])) { ... } else { $repRange = 0; }`                                                                   |
| 3       | פונקציית `selectReportRange()` כותבת HTML עם `<div id="setReportRange"> ... </div>`                  | `setReportRange.php`            | ה־HTML מייצר `<div id='setRange0' onclick="setReportRange(...)" ...>` וכך עבור כל key                                                   |
| 4       | בפעולת OnClick (JS) – קריאה ל־`setReportRange(elm, type, tvalue)` שמעדכן session ולבסוף מגיש טופס    | קוד JS בתוך `selectReportRange()`| `$('#searchForm input[name="from"]').val(elm.data('from')); ... $('#searchForm').submit();`                                             |
| 5       | בשלב רענון הדף: `report_manage.php` משתמש בערכים `$_GET['from']` / `$_GET['to']` שמוגדרים ע"י הכפתור | `report_manage.php`             | `if($_GET['from']) { $timeFrom = typemap(...); } else { ... }` וכדומה                                                                  |

---

### תרחיש שימוש 2: חיפוש דוחות לפי תאריכים וסוג זמן
#### 1. תיאור משתמש הקצה (Front-End)
- **תיאור כללי**  
  המשתמש מזין (או משאיר) ערכי "מתאריך" ו"עד לתאריך" בטופס החיפוש, ובוחר "לפי תאריך הגעה", "תאריך רכישה" או "תאריך חיוב". לאחר לחיצה על "חפש", מוצג דוח בהתאם.

- **טבלת צעדי התרחיש**

| מס׳ צעד | פעולה מצד המשתמש                               | תוצאה מצופה                                                          |
|---------|------------------------------------------------|----------------------------------------------------------------------|
| 1       | הזנת ערך בשדה "מתאריך" ו"עד לתאריך"           | השדות מתעדכנים בפורמט (dd/mm/yyyy)                                  |
| 2       | בחירת ערך ב־Select בשם `timeType` (1/2/3)      | ממשק המשתמש מציג/מעדכן את הבחירה (הגעה/רכישה/חיוב)                   |
| 3       | לחיצה על הכפתור "חפש"                          | הדף נטען מחדש, תוצאות הדוח מוצגות בטבלה בהתאם לסינון שבוצע           |

#### 2. תיאור המימוש בקוד (Back-End)
- **תיאור כללי**  
  בקובץ `report_manage.php`, מיד עם טעינת הדף נבדקים הפרמטרים `$_GET['from']`, `$_GET['to']` ו־`$_GET['timeType']`. בהתאם לערכים, נבנות שאילתות SQL שונות ומבוצעות קריאות לבסיס הנתונים כדי לקבל את הנתונים הדרושים, ואז מחושבים הסיכומים השונים לפני הצגתם בטבלה.

- **טבלת צעדי התרחיש (מתכנת)**

| מס׳ צעד | לוגיקה טכנית                                                                                                                      | מיקום בקוד               | מבנה ותוכן הקוד                                                                                           |
|---------|-----------------------------------------------------------------------------------------------------------------------------------|--------------------------|-------------------------------------------------------------------------------------------------------------|
| 1       | בדיקת `$_GET['from']`/`$_GET['to']`; אם אינם קיימים, נקבעים ערכי ברירת מחדל (תחילת חודש נוכחי/סוף חודש נוכחי)                     | `report_manage.php`      | `if($_GET['from']) { $timeFrom = typemap(...); } else { $timeFrom = date("Y-m-01"); ... }`                 |
| 2       | בדיקת `$_GET['timeType']` כדי לקבוע איזו עמודת זמן לפילטר (למשל `orders.timeFrom`, `orders.create_date` או תאריך חיוב ב־orderPayments) | `report_manage.php`      | `if($_GET['timeType']==3){ ... } else if($_GET['timeType']==2){ ... } else { ... }`                         |
| 3       | הרכבת מחרוזת השאילתה `$que` עם פילטר התאריכים, סינון לפי `siteID` אם נדרש, וסינון נוסף כמו `orderType = 'order'`                 | `report_manage.php`      | `$que = "SELECT ... FROM `orders` ... WHERE ... AND $timeType >= '$timeFrom 00:00:00' AND ... "$...        |
| 4       | שליפת הנתונים באמצעות `udb::key_row(...)` והצבת התוצאות במערך `$orders`                                                           | `report_manage.php`      | `$orders = udb::key_row($que, 'orderID');`                                                                  |
| 5       | מעבר על התוצאות (foreach) וחישוב שדות נוספים כמו `$order['paid']`, `$order['treatCost']`, `$order['discount']` וכד'               | `report_manage.php`      | הוספת נתונים למערך `$orders` לפני ההדפסה הסופית בטבלה                                                      |
| 6       | הצגת התוצאות ב־HTML, כולל חישובים מצטברים (total) ושורות סיכום: סה"כ הזמנות, סה"כ תשלום, וכד'                                      | `report_manage.php`      | בלולאה `foreach($orders as $order){ ... }` ובסוף שורת `<tr>` לתצוגה של "סה"כ"                                                                    |

---

### תרחיש שימוש 3: מיון עמודות בטבלת הדוח
#### 1. תיאור משתמש הקצה (Front-End)
- **תיאור כללי**  
  לאחר טעינת הדוח, מוצגת טבלה עם נתונים. המשתמש יכול ללחוץ על הכותרות המסומנות (למשל `class="orders_num"`) כדי למיין את הטבלה בסדר עולה או יורד.

- **טבלת צעדי התרחיש**

| מס׳ צעד | פעולה מצד המשתמש            | תוצאה מצופה                                                 |
|---------|-----------------------------|-------------------------------------------------------------|
| 1       | לחיצה על כותרת עמודה       | הטבלה מסתדרת לפי ערכי העמודה, תחילה בסדר עולה (לדוגמה)      |
| 2       | לחיצה חוזרת על אותה עמודה  | מיון מתהפך (יורד)                                           |

#### 2. תיאור המימוש בקוד (Back-End)
- **תיאור כללי**  
  המיון מבוצע ב־JavaScript (צד לקוח) ללא קריאה חוזרת לשרת. בקוד `report_manage.php` משולב סקריפט שמאזין לאירוע `click` על איברים בעלי מחלקה `orders_num`, ומשנה את סדר השורות בטבלה.

- **טבלת צעדי התרחיש (מתכנת)**

| מס׳ צעד | לוגיקה טכנית                                                                                 | מיקום בקוד                 | מבנה ותוכן הקוד                                                       |
|---------|----------------------------------------------------------------------------------------------|----------------------------|------------------------------------------------------------------------|
| 1       | `$('.orders_num').click(function(){ ... })` – מאזין לאירוע לחיצה                            | JavaScript בתוך `report_manage.php` | שימוש בפונקציות `.sort()` על מערך השורות (DOM)                         |
| 2       | אחסון האם המיון כעת הוא בסדר עולה (`this.asc = !this.asc`)                                   | JS inline                 | `if (!this.asc){ rows = rows.reverse(); } ...`                         |
| 3       | הוספת מחלקות `o-up / o-down / o-ctrl` לצורך הדגשה חזותית של מצב המיון                       | JS inline                 | `$(this).addClass('o-up')... $(this).removeClass('o-down')...` וכד'    |
| 4       | הוספת השורות המסודרות בחזרה לתוך הטבלה                                                      | JS inline                 | `for (var i = 0; i < rows.length; i++){ table.append(rows[i])}`         |

---

### תרחיש שימוש 4: מעבר בין "סוכנים", "מקורות הגעה", "אמצעי תשלום" ו"הצג הכל"
#### 1. תיאור משתמש הקצה (Front-End)
- **תיאור כללי**  
  מעל לטבלה קיימים כפתורים: "מקורות הגעה", "אמצעי תשלום", "סוכנים", "מקיף". לחיצה על אחד מהם גורמת להצגת סוגים מסוימים של שורות סיכום (או כל השורות). כך המשתמש יכול לראות פילוח לפי הסוכן שהזמנה קשורה אליו, לפי מקור הגעה, או לפי אמצעי תשלום.

- **טבלת צעדי התרחיש**

| מס׳ צעד | פעולה מצד המשתמש                      | תוצאה מצופה                                                                    |
|---------|---------------------------------------|--------------------------------------------------------------------------------|
| 1       | לחיצה על הכפתור "סוכנים"             | מוסתרות כל השורות הרגילות, ומוצגות השורות בעלות class="agents".                |
| 2       | לחיצה על "מקורות הגעה"               | מוסתרות כל השורות מלבד אלו שב־class="makor".                                   |
| 3       | לחיצה על "אמצעי תשלום"               | מוצגות השורות בעלות class="payTypes".                                         |
| 4       | לחיצה על "מקיף" (או "הצג הכל")       | כל השורות חוזרות להופיע (ללא סינון).                                           |

#### 2. תיאור המימוש בקוד (Back-End)
- **תיאור כללי**  
  אלה פונקציות JS (`show_agents()`, `show_makor()`, `show_paytypes()`, `show_all()`) אשר קובעות מי יוצג ומי יוסתר ב־DOM ע"י שינוי `display` ל־`none` או `table-row`. עמודת הסיכום (id="totalall") נשארת גלויה תמיד.

- **טבלת צעדי התרחיש (מתכנת)**

| מס׳ צעד | לוגיקה טכנית                                                                                   | מיקום בקוד          | מבנה ותוכן הקוד                                                            |
|---------|----------------------------------------------------------------------------------------------|---------------------|----------------------------------------------------------------------------|
| 1       | `function show_agents(){ ... }` – מסתיר את כל השורות מלבד אלו שה־class שלהן "agents"         | JavaScript inline   | `$('.reports tbody tr').css('display','none'); $(".reports .agents").css('display','table-row'); ...` |
| 2       | `function show_makor(){ ... }` – מציג class="makor"                                          | JavaScript inline   |                                                                            |
| 3       | `function show_paytypes(){ ... }` – מציג class="payTypes"                                    | JavaScript inline   |                                                                            |
| 4       | `function show_all(){ ... }` – מסיר את ה־style=display:none מכל השורות ומחזיר להגדרות רגילות | JavaScript inline   |                                                                            |
| 5       | הפעלת `sticky2(1)` או `sticky2(0)` משנה את אופן העבודה עם טבלה מקובעת לעומת טבלה "רגילה"    | JavaScript inline   | `$('.reports').addClass('sticky2');` או `removeClass('sticky2');` בהתאם למצב |

---

### תרחיש שימוש 5: ייצוא לאקסל והדפסת הדוח
#### 1. תיאור משתמש הקצה (Front-End)
- **תיאור כללי**  
  המשתמש רואה שני כפתורים: "ייצוא לאקסל" ו"הדפסה".
    - "ייצוא לאקסל" יוצר קובץ XLS המקומי להורדה.
    - "הדפסה" פותח חלון חדש עם הטבלה, ולאחר מכן מופיע דיאלוג ההדפסה.

- **טבלת צעדי התרחיש**

| מס׳ צעד | פעולה מצד המשתמש                | תוצאה מצופה                                                        |
|---------|---------------------------------|--------------------------------------------------------------------|
| 1       | לחיצה על "ייצוא לאקסל"         | קובץ אקסל נוצר ומורד למחשב המשתמש                                  |
| 2       | לחיצה על "הדפסה"              | חלון חדש נפתח, מוצג תוכן הטבלה, ותיבת הדפסה מופיעה                 |

#### 2. תיאור המימוש בקוד (Back-End)
- **תיאור כללי**
    - ב"ייצוא לאקסל" משתמשים בפלאגין `table2excel` (ב־JS). הקוד אוסף את השורות הנראות, מסמן את הבלתי נראות כ־`noExl`, ומייצר להורדה קובץ `.xls`.
    - ב"הדפסה" קוראים לפונקציה `printData()`, שפותחת חלון חדש, כותבת לתוכו את ה־HTML וה־CSS, ומפעילה `newWin.print()`.

- **טבלת צעדי התרחיש (מתכנת)**

| מס׳ צעד | לוגיקה טכנית                                                                                 | מיקום בקוד               | מבנה ותוכן הקוד                                                     |
|---------|----------------------------------------------------------------------------------------------|--------------------------|---------------------------------------------------------------------|
| 1       | `$('#expExcel').on('click', function(e){ ... })` – מאזין לאירוע                              | JavaScript inline        | משתמש ב־`table2excel` ליצירת קובץ אקסל                                                                   |
| 2       | הסתרת שורות לא רלוונטיות עם `.addClass('noExl')` כך שלא יכללו ביצוא                          | JavaScript inline        | `$('table#reports tr').each(...) { ... addClass('noExl') }`         |
| 3       | קריאה ל־`.table2excel({exclude: ".noExl", ...})`                                             | JavaScript inline        | מגדיר שם הקובץ, סיומת, אפשרויות שונות, ומוריד (download) את הקובץ    |
| 4       | פונקציית `printData()` פותחת חלון חדש `window.open("")`, כותבת לתוכו את תוכן הטבלה וה־style   | JavaScript inline        | `newWin.document.write(...); newWin.print(); newWin.close();`        |

---

## 6. מסמך שימוש (מדריך למשתמש)
1. **פתיחת העמוד**
    - היכנס/י לעמוד הדוחות (report_manage.php) מתוך המערכת. ייתכן שיופיע תפריט נוסף (orders_menu.php) או כפתור "דוחות תקציב" בהתאם להגדרות האתר.

2. **בחירת טווח תאריכים**
    - באפשרותך להשתמש בכפתורים בראש הדף (למשל "החודש", "השבוע", "היום") כדי לקבוע טווח זמן במהירות.
    - ניתן גם להקליד ידנית תאריכים בשדות "מתאריך" ו"עד לתאריך".

3. **בחירת סוג התאריך (arrival/purchase/payment)**
    - בחר/י אם הדוח יוצג לפי "תאריך הגעה", "תאריך רכישה" או "תאריך חיוב".

4. **חיפוש והצגת הדוח**
    - לאחר הגדרת התאריכים וסוג התאריך, לחצ/י על "חפש". התוצאות יוצגו בטבלה בפורמט מפורט, כולל תשלום, מקורות הגעה, וסיכומים.

5. **מיון הנתונים**
    - ניתן ללחוץ על כותרות עמודות מסוימות כדי למיין את הנתונים בסדר עולה/יורד.

6. **הצגת סוכנים/מקורות הגעה/אמצעי תשלום/הכול**
    - מעל הטבלה יש כפתורים לתצוגה ממוקדת לפי "סוכנים", "מקורות הגעה" או "אמצעי תשלום" — או ללחוץ על "מקיף" כדי לראות את כל הנתונים.

7. **ייצוא לאקסל והדפסה**
    - כפתור "ייצוא לאקסל" יאפשר להוריד את הדוח בפורמט XLS.
    - כפתור "הדפסה" יפתח חלון חדש להדפסה.

## 7. סיכום
מערכת הדוחות מורכבת מעמוד ראשי (report_manage.php) המציג טופס סינון תאריכים, מחליט על סוג התאריך הרלוונטי (הגעה/רכישה/חיוב), ויוצר שאילתות לבסיס הנתונים כדי להציג טבלת תוצאות וסיכומים כספיים. קבצים משלימים (setReportRange.php ו־orders_menu.php) מסייעים בהגדרת טווחי תאריכים קבועים מראש, ובהצגת תפריט להזמנות. הפונקציות JavaScript מוסיפות יכולת למיין תוצאות, לייצא לאקסל ולהדפיס את הדוח.

באופן זה, המשתמש יכול לנתח את מצב ההזמנות, התשלומים, הסוכנים ומקורות ההגעה, ולשלוט בקלות בתצוגת הדוח.

