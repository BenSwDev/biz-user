# 1. הקדמה
המסמך שלפניך מתייחס למימוש הקוד הקיים בקובץ המיועד לניהול והתקשרות מול מערכת WuBook, באמצעות ספריית צד-שלישי (WuBookWrapper). הקוד מספק פונקציונליות לעבודה עם זמינות חדרים, ניהול מפתחות (keys) לקישור בין חדרים במערכת המקומית לבין מזהים במערכת WuBook, וכן פעולות כלליות מול ממשקי ה-API של WuBook. 

הרציונל העיקרי שעולה מתוך הקוד הוא לאפשר אינטגרציה בין המערכת המקומית (DB, הזנות) לבין WuBook, תוך שמירה על תיעוד של הקשרים בין חדרים מקומיים לחדרים ב-WuBook, וכן שימוש בשיטות המובנות ב-WuBookManager לביצוע פעולות כמו קבלת מידע על זמינות ועדכוני זמינות.

---

# 2. הקבצים שנבדקו
1. **cms/classes/class.BizWubook.php**  
   - מחלקה בשם `BizWubook` המטפלת באינטראקציה מול מערכת WuBook.
   - משתמשת במחלקה `WuBookManager` (ממרחב השמות `WubookWrapper`) לצורך חיבור לאינטגרציה.
   - מגדירה קבוע `WUBOOK_DIR` עבור נתיבים (לוגים, Cache).
   - מאחסנת טוקן `token` לאחר ביצוע Authentication.
   - קוראת לפונקציות שונות לצורך עדכון זמינות חדרים (`update_rooms`), מחיקת ושמירת מפתחות (`delete_keys`, `save_key`, `save_room_keys`, `save_site_keys`), שליפת מפתחות (`get_keys`, `get_room_keys`, `get_site_keys`) ועוד.
   - מכילה פונקציית קסם `__call` המפנה קריאות לא מזוהות ישירות אל אובייקט `manager` (שהוא אובייקט של `WuBookManager`).

---

# 3. הקבצים שלא נמצאו
*אין ברשימה קבצים שסומנו כ"לא נמצאו".*

---

# 4. הקבצים שלא נבדקו
להלן קבצים וספריות המוזכרים בקוד אך אינם מופיעים ברשימת הקבצים שסיפקת לנו בפועל:
1. **wubook/vendor/autoload.php** – קיימת קריאה ל-`require_once __DIR__ . "/../../wubook/vendor/autoload.php"`.
2. **WuBookManager** – במרחב השמות `WubookWrapper\WuBookManager`; עשויה להיות ממומשת בקובץ נפרד שטרם סופק.
3. **udb** – נראית כספרייה או מחלקה מטפלת ב-DB (קריאות כמו `udb::query`, `udb::insert` וכו'), אך אינה מופיעה בקבצים שנבדקו.

---

# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

## מטרה
לספק ניתוח מקצועי של הקוד הקיים במחלקה `BizWubook`, תוך פירוט תרחישי השימוש (Use Flow) הן ברמה החיצונית (מה רואה ומשתמש המשתמש הסופי, ככל שניתן להסיק) והן ברמה הטכנית של מימוש הקוד.

### 5.1 זיהוי תרחישי השימוש
להלן תרחישי השימוש העיקריים שניתן לאתר בקוד:

1. **רכישת טוקן (Acquire Token) והצגת/עדכון זמינות**  
2. **עדכון זמינות חדרים למערכת WuBook**  
3. **מחיקה, שמירה ושליפה של מפתחות (Keys)**  
4. **הפעלה דינמית של פעולות WuBookManager** (באמצעות `__call`)

---

### 5.2 מבנה הניתוח של כל תרחיש
1. **תיאור משתמש הקצה** (Front-End / User Perspective)  
2. **תיאור המימוש בקוד** (Back-End / Developer Perspective)

---

### 5.3 ניתוח משתמש הקצה (Front-End Perspective)

#### תרחיש 1: רכישת טוקן (Acquire Token) והצגת/עדכון זמינות
**תיאור כללי**  
המשתמש (או רכיב במערכת) מבצע בקשה להצגת זמינות חדרים (או עדכון זמינות). לפני הביצוע, המערכת דואגת להתחבר ל-WuBook ולהוציא טוקן (אם עדיין לא קיים). מנקודת המבט של המשתמש, הוא מצפה לראות את התוצר הסופי (לדוגמה: רשימת זמינות מעודכנת) או לקבל חיווי שהעדכון הצליח.

| מספר צעד | פעולה מצד המשתמש                                                     | תוצאה מצופה                                                              |
|----------|---------------------------------------------------------------------|--------------------------------------------------------------------------|
| 1        | לוחץ על כפתור/שולח בקשה "הצג זמינות" או "עדכן זמינות" בממשק כלשהו    | המערכת מחברת את המשתמש ל-WuBook, מפיקה טוקן במידת הצורך ומחזירה נתונים. |
| 2        | מוודא שהזמינות המעודכנת מופיעה במערכת                               | המשתמש רואה את נתוני הזמינות העדכניים עבור החדרים הרלוונטיים            |

#### תרחיש 2: עדכון זמינות חדרים למערכת WuBook
**תיאור כללי**  
המשתמש בוחר חדרים או שולח מידע על החדרים ומצפה שהזמינות תתעדכן גם ב-WuBook. אם אחד או יותר מהחדרים אינם מקושרים ל-WuBook (אין מפתח מתאים), הוא מקבל חיווי על כך.

| מספר צעד | פעולה מצד המשתמש                                                     | תוצאה מצופה                                                   |
|----------|---------------------------------------------------------------------|---------------------------------------------------------------|
| 1        | מזין/שולח נתוני זמינות/תפוסה של מספר חדרים בממשק המקומי             | מצפה לעדכון מוצלח במערכת WuBook (או הודעת שגיאה אם חסר מפתח)  |
| 2        | מאשר את העדכון (למשל, בלחיצת כפתור "אישור")                          | המשתמש רואה התראה שהעדכון הושלם בהצלחה (או שגיאה מתאימה)     |

#### תרחיש 3: מחיקה, שמירה ושליפה של מפתחות
**תיאור כללי**  
המשתמש (או מנהל מערכת) עורך פעולות על מפתחות (keys) המקשרים בין חדר/אתר מקומי לבין מזהה ב-WuBook. לדוגמה, מוחק מפתח ישן, שומר מפתח חדש או טוען את רשימת המפתחות הקיימים.

| מספר צעד | פעולה מצד המשתמש                                                                 | תוצאה מצופה                                         |
|----------|---------------------------------------------------------------------------------|-----------------------------------------------------|
| 1        | מבקש למחוק/לשמור/לערוך מפתח עבור חדר/אתר                                        | המערכת מוחקת/שומרת/מעדכנת את המפתח במסד הנתונים.    |
| 2        | מבקש להציג את רשימת המפתחות הקיימים עבור חדר/אתר                                 | המשתמש רואה רשימה עדכנית של מפתחות מקושרים         |

#### תרחיש 4: הפעלה דינמית של פעולות WuBookManager
**תיאור כללי**  
המשתמש מפעיל פונקציות מתקדמות שאינן מוגדרות במפורש במחלקה, אך קיים צורך להריץ אותן מול WuBook (לדוגמה, פעולות API נוספות). המחלקה `BizWubook` מעבירה את הקריאה אוטומטית ל-`$this->manager`, ומחזירה את התשובה.

| מספר צעד | פעולה מצד המשתמש                                                        | תוצאה מצופה                                         |
|----------|------------------------------------------------------------------------|-----------------------------------------------------|
| 1        | מפעיל בקשה ייחודית (API לא סטנדרטי) דרך הממשק (לדוגמה, פונקציית `xinfo`) | המערכת קוראת ל-`__call` שמעביר את הבקשה ל-WuBookManager |
| 2        | ממתין לתוצאה או משוב                                                    | המשתמש רואה את התגובה המתקבלת (נתונים או שגיאה)     |

---

### 5.4 ניתוח המימוש בקוד (Back-End Perspective)

להלן פירוט התרחישים מצד המתכנת, עם דגש על זרימת הקוד:

#### תרחיש 1: רכישת טוקן (Acquire Token) והצגת/עדכון זמינות
**תיאור כללי**  
בעת קריאת `availability()`, המחלקה בודקת אם כבר קיים טוקן. אם לא – יוצרת אחד ע"י קריאה ל-`$this->manager->auth()->acquire_token()`. לאחר מכן, קוראת לפונקציה `availability($token)` של האובייקט `manager`.

| מספר צעד | לוגיקה טכנית                                                                                   | מיקום בקוד                                                 | מבנה ותוכן הקוד                                                                                                     |
|----------|-----------------------------------------------------------------------------------------------|-----------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| 1        | בדיקה האם `$this->token` קיים                                                                 | פונקציה `availability()`, שורות 18–19 בערך               | ```php
if (!$this->token)
    $this->token = $this->manager->auth()->acquire_token();
``` |
| 2        | קריאה ל-`$this->manager->availability($this->token)`                                          | בהמשך הפונקציה `availability()`, שורה 21 בערך            | ```php
return $this->manager->availability($this->token);
``` |

#### תרחיש 2: עדכון זמינות חדרים למערכת WuBook
**תיאור כללי**  
פונקציית `update_rooms($rooms)` מזהה את החדרים שיש לעדכן, בודקת אם קיים מפתח (WuBook Key) לכל חדר, ומשתמשת בפונקציית `update_avail_formatted` כדי לעדכן את הזמינות בפועל.

| מספר צעד | לוגיקה טכנית                                                                                                                                            | מיקום בקוד                                                         | מבנה ותוכן הקוד                                                                                                                                            |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בדיקת מערך `$rooms`; במקרה שהוא ריק – נזרקת חריגה (Exception)                                                                                           | פונקציה `update_rooms($rooms)`, שורות 24–26 בערך                   | ```php
if (!$rids)
    throw new Exception('Empty rooms array');
``` |
| 2        | שליפת המפתחות מתוך הטבלה `wubook_keys` בהתבסס על מזהי החדרים                                                                                           | שורות 28–31 לערך                                                   | ```php
$keys = udb::single_list("SELECT `keyID`, `keyStr` ...
``` |
| 3        | בניית מערך `$prep` המתאים למבנה המצופה ע"י WuBook ( keyStr => $rooms[keyID] )                                                                           | שורות 34–36 בערך                                                   | ```php
foreach($keys as $key)
    $prep[$key['keyStr']] = $rooms[$key['keyID']];
``` |
| 4        | קריאה לפונקציה `availability()` (לרכישת טוקן אם אין) ואז `->update_avail_formatted($prep)` על האובייקט המוחזר                                          | שורות 38–39 בערך                                                   | ```php
return $this->availability()->update_avail_formatted($prep);
``` |

#### תרחיש 3: מחיקה, שמירה ושליפה של מפתחות
**תיאור כללי**  
המחלקה מנהלת טבלאות מפתחות (keys) עבור סוגים שונים (room/site). המשתמש יכול למחוק, לשמור או לשלוף מפתחות, בהתאם לצורך (לדוגמה, קישור חדר ב-WuBook לחדר ID מקומי).

| מספר צעד | לוגיקה טכנית                                                                                                                       | מיקום בקוד                                          | מבנה ותוכן הקוד                                                                                 |
|----------|-----------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|--------------------------------------------------------------------------------------------------|
| 1        | **מחיקה** (`delete_keys`) – מוחקת רשומות מהטבלה `wubook_keys` ע"פ סוג ומזהה                                                       | פונקציה `delete_keys(...)`, שורות 53–55 לערך         | ```php
return udb::query("DELETE FROM `".$this->key_table."` ...
``` |
| 2        | **שמירה** (`save_key`) – מוסיפה/מעדכנת רשומה בטבלה `wubook_keys`, עם הערכים `keyType`, `keySource`, `keyStr`, `keyID`             | פונקציה `save_key(...)`, שורות 58–63 לערך           | ```php
return udb::insert($this->key_table, [...], $update);
``` |
| 3        | **שמירה מרובה** (לדוגמה `save_room_keys`) – מוחקת קודם כל את המפתחות הקיימים (שימוש ב-`delete_keys`) ואז שומרת מפתחות חדשים      | פונקציה `save_room_keys(...)`, שורות 65–69 בערך      | ```php
$this->delete_keys('room', $id);
foreach($keys as $source => $key)
    $this->save_key('room', $id, $source, $key);
``` |
| 4        | **שליפה** (`get_keys`) – שולף מפתחות מתוך הטבלה בהתאם לסוג ומזהה                                                                   | פונקציה `get_keys(...)`, שורות 80–82 לערך           | ```php
return udb::key_value("SELECT `keySource`, `keyStr` FROM ...
``` |

#### תרחיש 4: הפעלה דינמית של פעולות WuBookManager
**תיאור כללי**  
המתכנת יכול לקרוא לכל פונקציה שקיימת ב-`WuBookManager` ישירות מתוך אובייקט `BizWubook`. אם הפונקציה לא מוגדרת במחלקה, היא תעבור ל-`__call` ותופעל שם.

| מספר צעד | לוגיקה טכנית                                                 | מיקום בקוד                                 | מבנה ותוכן הקוד                                                           |
|----------|-------------------------------------------------------------|---------------------------------------------|----------------------------------------------------------------------------|
| 1        | קריאה לפונקציה שלא קיימת ב-`BizWubook` (למשל `$biz->xinfo()`) | פונקציית קסם `__call($name, $args)`, שורה 42 לערך | ```php
public function __call($name, $args) {
    return $this->manager->$name(...$args);
}
``` |
| 2        | `$this->manager` מפעיל את המתודה בשם `$name`                 | קוד פנימי של `WuBookManager`               | לא מוצג בקובץ הנוכחי.                                                     |

---

# 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך קצר כיצד להשתמש ב-BizWubook לצורך עדכון וזיהוי זמינות בחדרים, כמו גם לניהול מפתחות:

1. **הוספת והגדרת הקובץ**  
   - ודא שקיים קובץ `class.BizWubook.php` בו מוגדרת המחלקה `BizWubook`.
   - יש לכלול (או לטעון באוטולוד) את הספריות הנדרשות, כגון `wubook/vendor/autoload.php` ו‑`WubookWrapper\WuBookManager`.

2. **יצירת אובייקט**  
   ```php
   $biz = new BizWubook();
   ```
   פעולה זו תאתחל את אובייקט `WuBookManager` עם ההגדרות הקיימות (username, password, provider_key, וכד').

3. **רכישת טוקן (אוטומטי)**  
   - ברגע שתקראו ל-`$biz->availability()`, המערכת תבדוק האם קיים טוקן. אם אין – יבוצע תהליך Acquire Token אוטומטי.

4. **עדכון זמינות חדרים**  
   - בנו מערך של חדרים מקומיים:  
     ```php
     $rooms = [
       101 => 5,  // למשל חדר מקומי ID=101, 5 חדרים פנויים
       102 => 0   // חדר 102 בתפוסה מלאה
     ];
     ```
   - קריאה ל:  
     ```php
     $result = $biz->update_rooms($rooms);
     ```
     אם במערכת `wubook_keys` חסר מפתח עבור חדר מסוים, תחזור הודעה מתאימה או שגיאה.

5. **ניהול מפתחות (Keys)**  
   - **שמירת מפתח** לדוגמה:  
     ```php
     $biz->save_key('room', 101, 'MySource', 'WuBookRoomA');
     ```
     - פעולה זו תשמור (או תעדכן) מפתח עבור החדר עם ID = 101.
   - **מחיקת מפתח**:  
     ```php
     $biz->delete_keys('room', 101);
     ```
   - **שליפת מפתח**:  
     ```php
     $keys = $biz->get_room_keys(101);
     ```
     - תחזיר מערך אסוציאטיבי של `[ 'MySource' => 'WuBookRoomA', ... ]` עבור ה‑ID המבוקש.

6. **הפעלה דינמית של פונקציות WuBookManager**  
   - ניתן לקרוא לכל מתודה הנתמכת ע"י `WuBookManager` ישירות מתוך `$biz`. לדוגמה:  
     ```php
     $response = $biz->fetchBookings($this->token, ['someParam'=>'someValue']);
     ```
     אם המתודה `fetchBookings` אינה מוגדרת ב‑`BizWubook`, היא תופנה אוטומטית ל‑`$this->manager`.

---

# 7. סיכום
בקובץ `cms/classes/class.BizWubook.php` מיושמת מחלקה המאפשרת ניהול זמין של קריאות למערכת WuBook (קבלת טוקן, עדכוני זמינות, קריאות דינמיות). כמו כן, המחלקה מרכזת את הטיפול במפתחות (keys) לקישור בין החדרים/אתרים המקומיים לבין מזהים במערכת WuBook. באופן זה, מקל הקובץ על אינטגרציה ושמירה על עקביות בין ה-DB המקומי למערכת WuBook. בניתוח זה סקרנו את התרחישים המרכזיים (כגון רכישת טוקן, עדכון זמינות, ניהול מפתחות), יחד עם הדרכה קצרה לשימוש.

```
(סיום המסמך)
```

---

## 2. רשימה להעתקה של הקבצים

להלן שלוש הרשימות הנדרשות, כאשר בכל רשימה מופיעים רק שמות הקבצים (שורה אחר שורה).

### 2.1 קבצים שנבדקו
```
cms/classes/class.BizWubook.php
```

### 2.2 קבצים שלא נמצאו
```
```
*(אין קבצים ברשימה זו)*

### 2.3 קבצים שלא נבדקו
```
wubook/vendor/autoload.php
WuBookManager
udb
```
