# 1. הקדמה
המערכת בנויה באופן מודולרי כך שכל עמוד מופעל בהתאם לסוג המשתמש, הרשאותיו והפעולות שנבחרו. התהליך מתחיל בכניסה ל-index.php, שמשמש כנקודת הכניסה הראשית ומנהל את ניתוב העמודים בעזרת פרמטרים שמועברים ב-URL. הקובץ auth.php מטפל בבדיקת ההרשאות והמשתמשים המורשים, ומגדיר את סביבת העבודה של המשתמש הנוכחי.

לאחר מכן, על פי הגדרות ותנאים ייחודיים, המערכת טוענת תפריטים ראשיים ותפריטי משנה (menu.php ו-submenu.php), כמו גם תפריטים מותאמים למשתמשים מסוגים מסוימים (menu_member.php).

כדי לספק פונקציונליות גלובלית ולנהל פעולות נפוצות, נעשה שימוש בקובץ functions.php. השילוב של רכיבים אלו מבטיח חוויית משתמש זורמת ומדויקת, המותאמת לצרכים שונים כמו יומן תפוסה, דוחות, או תהליכי עבודה ייעודיים.

הקבצים שעליהם מבוססת ההקדמה:
index.php
auth.php
functions.php
partial/menu.php
partial/submenu.php
partial/menu_member.php

המסמך שלפניך מרכז ניתוח וסקירה של הקבצים שנמצאו ושנסרקו באופן מלא, כולם קשורים למערכת תשלומים/הצגת תשלומים/ניהול תשלומים ודוחות. החלקים העיקריים כוללים קובצי PHP המציגים ממשקים לדוחות, טיפול בגיפט-קארדים, הורדות חשבוניות, ועוד מספר קבצים בספריות שונות המממשים לוגיקת סליקה וסיוע בטיפול בתשלומים.  
הקבצים כוללים בין היתר שאילתות למסד הנתונים (DB), הגדרת פונקציות עזר, ניהול תהליכי תשלום, הפקת חשבוניות, והצגת דו"חות (בפורמט HTML ו/או PDF). להלן פירוט מלא של הקבצים הסרוקים.  
יש לשים לב כי בקוד מופיעים אזכורים לקבצים חיצוניים נוספים, אשר אינם נכללים ברשימת הקבצים שנסרקו בפועל – ולכן אינם נבדקו. הדבר מפורט בפרקים הבאים.

---

# 2. הקבצים שנבדקו

להלן רשימת הקבצים (עם תוכן בפועל) שנמצאו ונסרקו:

1. **`pages/yaadTrans.php`**
   - קובץ עיקרי המציג עמוד “yaadTrans” שמאפשר חיפוש וסקירה של פעולות תשלום (Orders, Subscriptions, Gift Purchases).
   - כולל טופס סינון לפי תאריכים, אמצעי תשלום, סטטוס הזמנה, טקסט חופשי, ועוד.
   - מציג סיכומי סכומים לפי סוגי תשלום (כרטיס אשראי, מזומן, קופון וכו'), ומאפשר פעולות כמו ביטול/זיכוי תשלום, הורדת חשבוניות, הצגת פופ-אפ להזמנה, הצגת פופ-אפ לשובר/גיפט קארד, וכן הלאה.
   - עושה שימוש במחלקות עזר (למשל `UserUtilsNew`, `UserPager`) ומשתמש בין היתר בקבצים נוספים כגון `partials/setReportRange.php`.

2. **`partials/setReportRange.php`**
   - מכיל פונקציה (`selectReportRange()`) להצגת כפתורי בחירה מהירה של טווחי תאריכים נפוצים (היום, השבוע, החודש).
   - מנוהל באמצעות JavaScript המעדכן את הטופס בהתאם לבחירה, ושולח את הנתונים לחיפוש מחדש.

3. **`ajax_pop_gift.php`**
   - קובץ הנקרא ב-AJAX ומחזיר תוכן HTML עבור פופ-אפ המציג פרטי גיפט-קארד (Gift Card).
   - מאתר נתוני רכישת השובר (`gifts_purchases`), כולל הגבלות, יתרה, היסטוריית מימוש (אם קיימת), ומאפשר פעולת מימוש חלקי/מלא או זיכוי.
   - מתבסס על טבלאות במסד הנתונים ומציג בלוק HTML מפורט עם נתוני השובר, תאריך רכישה, תאריך תפוגה, סכומי מימוש וכן הלאה.

4. **`download_invoice_gc.php`**
   - קובץ להורדת/צפייה בחשבונית עבור Gift Card (רכישת שובר).
   - טוען את פרטי הרכישה (`gifts_purchases`) ומוודא שהמשתמש הנוכחי מורשה לגשת למתחם (siteID תואם).
   - בודק אם הונפקה כבר חשבונית (invoice) ומהו סוג הטרמינל (למשל `CardComGeneral` או `YaadPay`), ואז מפנה להורדת קובץ PDF או לקישור חיצוני.

5. **`download_invoice_sub.php`**
   - משמש להורדה/צפייה בחשבונית של תשלום במנוי (subscriptionPayments).
   - טוען פרטי מנוי (subID) ומוודא שהמשתמש מורשה למתחם.
   - בודק מידע על עסקת החיוב/הזיכוי (cancelData/resultData), ובסוף שולף את החשבונית המתאימה משרת הסליקה החיצוני או דרך `CardComGeneral`.

6. **`download_invoice.php`**
   - זהה כמעט במבנהו ל-`download_invoice_sub.php`, אך מיועד להורדת חשבונית של הזמנת Order רגילה (מופיעה בטבלה `orderPayments`).
   - בודק הרשאות, מאחזר נתונים, מבצע קריאה לממשק הסליקה כדי להחזיר קובץ חשבונית PDF או הפנייה לקישור.

7. **`print_deal_report.php`**
   - מפיק דוח עסקאות (ריכוז עסקאות) לתקופה, מאפשר הצגה בפורמט HTML והדפסה.
   - כולל שאילתות על סוגי תשלומים (כרטיס אשראי, קופונים וכו'), חישוב סך עסקאות, וכן קטעי קוד המתייחסים למחלקת `UserUtilsNew` לצורך פרשנות סוגי תשלום.
   - בסיום מבצע יצירה של PDF (באמצעות `TCPDF`) ושומר אותו בשרת, או מציג את התוכן להדפסה.

8. **`print_deal_report_special.php`**
   - קובץ דומה ל-`print_deal_report.php` המפיק “דוח ריכוז הכנסות” (מיועד למקרים או סוגי כרטיסים מסוימים).
   - מתייחס לאותם מנגנוני PDF ולטבלאות DB דומות, אך מכיל לוגיקה מעט שונה לסינון/איגוד הנתונים (למשל בדיקת כרטיסים שחייבים להסתמך על תאריך הטיפול ולא רק על תאריך התשלום).

9. **`UserUtilsNew.php`** (הממוקם ב-`public_html\cms\classes\UserUtilsNew.php`)
   - מכיל מחלקה סטטית `UserUtilsNew` שתפקידה לספק כלים נרחבים לזיהוי סוגי תשלום, סוגי קופונים, והתאמות שונות לאתרים (sites).
   - טוען מטבלאות `payTypes`, `sitePayTypes` וכולי, כדי לבנות מערכים של שמות קצרים/מלאים, סוגי קופונים (`$typeCoupon`), ועוד.
   - גם מגדיר את `$orderTypes` האפשריים (למשל `'order' => 'asdasda'`).
   - משמש בהרבה מקומות בקוד לצורך פירוש (פונקציית עזר `method()` שמחזירה תיאור של אמצעי תשלום או ספק קופונים).

10. **`UserPager.php`** (נמצא ב-`public_html\cms\classes\UserPager.php`)
- מגדיר מחלקה `UserPager` היורשת מ־`uniPager2` (המוגדר בקובץ `class.unipager2.php`, שלא נמצא ברשימה).
- משמשת לביצוע פאג’ינציה (חלוקה לדפים) בעמודים המציגים רשימות ארוכות של נתונים (למשל ברשימת התשלומים ב־`yaadTrans.php`).
- מגדירה פונקציית עיצוב ברירת מחדל לפס מספרי העמודים, וכן קובעת כמות פריטים (items_per_page = 50) ודפדוף.

11. **`Terminal.php`** (ב-`public_html\cms\classes\Terminal.php`)
- מכיל מחלקה `Terminal` המרכזת לוגיקה כללית לטיפול ב"מסוף" (טרמינל) של סליקה.
- יכול לזהות באיזה סוג מסוף מדובר (לדוגמה `CARDCOM`, `YAAD`, `MAX`), ולטעון אובייקט סליקה מתאים (`YaadPay::getTerminal()`, או `new CardComBiz`, וכו’).
- מוודא האם יש תמיכה בהקפאת תשלום (`has_freeze`), האם יש תמיכה בהפקת חשבוניות (`has_invoice`), תשלומים ללא CVV ועוד.

12. **`CardComGeneral.php`** (ב-`public_html\cms\classes\CardComGeneral.php`)
- יורש מ־`class.CardCom.php` (קובץ חיצוני שלא נכלל ברשימה) ומגדיר מחלקה `CardComGeneral`.
- מותאם ספציפית לחיבור מול CardCom, מגדיר URL-ים ופרמטרים לאימות, באיזה סוג מסמך הפקת חשבונית להשתמש, וכדומה.

13. **`Transaction.php`** (ב-`public_html\cms\classes\Transaction.php`)
- מנהל טבלת `pm_transactions` במסד הנתונים.
- מחלקה זו מאפשרת יצירה, עדכון ושמירה של 'טרנזקציה' – כולל שלבים פנימיים, סטטוס (הצלחה/כישלון), תיעוד לוגים (log record) וכו’.
- מחזיקה מידע על קלט (`input`) ופלט (`result`) בפורמט JSON.

14. **`YaadPay.php`** (ב-`public_html\api\classes\YaadPay.php`)
- מטפל בתקשורת מול חברת YaadPay (כולל קריאות curl ל־API של Yaad).
- מגדיר פונקציות לביצוע תשלום ישיר, בדיקת כרטיס (frame_card_check), הנפקת חשבוניות, החזר כספי (refund) ועוד.
- כולל מערך `YaadError::$list` עם פירוט קודי שגיאה האפשריים בסליקה.
- קובץ חיוני לסליקה דרך Yaad, ומיישם לוגיקה משלימה למחלקת `Terminal`.

---

# 3. הקבצים שלא נמצאו

לפי הרשימה שסופקה, **לא זוהו קבצים חסרים** שהוגדר לגביהם "הקובץ לא נמצא".  
אין קבצים ברשימה שסומנו כ"לא קיימים".

---

# 4. הקבצים שלא נבדקו

במהלך הסריקה נמצאו אזכורים לקבצים או לספריות שאינם מופיעים ברשימה ששיתפת. לכן לא בוצעה אליהם סריקה:
1. **`class.unipager2.php`** (מוזכר בתוך `UserPager.php`)
2. **`Transactions/class.LogRecord.php`** (מוזכר ב-`Transaction.php`)
3. **`TCPDF/tcpdf_config.php`** ו-**`TCPDF/tcpdf.php`** (מוזכרים בקבצי `print_deal_report.php` ו-`print_deal_report_special.php`)
4. **`class.CardCom.php`** (מוזכר ב-`CardComGeneral.php`)

מדובר בקבצים חיצוניים למערכת או בקבצים שלא סופקו ברשימה, ולכן לא נכללו בסריקה.

---

# 5. תרחישים כוללים בעמוד

להלן הוראות לניתוח הקוד ובניית תרחישי שימוש (Use Flow Scenarios).  
המטרה היא להמחיש כיצד המשתמש עובד עם המערכת (Front-End) לצד הפעולות שמתרחשות מאחורי הקלעים (Back-End).

### 5.1 זיהוי כל תרחישי השימוש (Use Flows)

בהתבסס על תוכן הקבצים שנבדקו, זוהו התרחישים העיקריים הבאים:

1. **חיפוש וצפייה ברשימת עסקאות בעמוד `yaadTrans.php`**
2. **מימוש או צפייה בגיפט קארד (Gift Card) באמצעות `ajax_pop_gift.php`**
3. **הורדת חשבונית עבור Order / Subscription / GiftCard** (`download_invoice.php`, `download_invoice_sub.php`, `download_invoice_gc.php`)
4. **הפקת דו"ח עסקאות כללי** (`print_deal_report.php`)
5. **הפקת דו"ח הכנסות מיוחד** (`print_deal_report_special.php`)

### 5.2 מבנה הניתוח של כל תרחיש שימוש

כל תרחיש מחולק לשני חלקים:
1. **תיאור ממשק משתמש (Front-End Perspective)** – צעדי המשתמש ומה הוא רואה.
2. **תיאור המימוש בקוד (Back-End Perspective)** – מה מתרחש בצד השרת, אילו פונקציות/טבלאות מעורבות.

---

## תרחיש 1: חיפוש וצפייה בעסקאות בעמוד `yaadTrans.php`

### (א) ניתוח משתמש הקצה (Front-End)
**תיאור כללי:**  
המשתמש מגיע לעמוד שבו ניתן לסנן ולהציג רשימת תשלומים/עסקאות לפי תאריך, סוג תשלום, טקסט חופשי ועוד.

**טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                                       | תוצאה מצופה                                                  |
|----------|--------------------------------------------------------|--------------------------------------------------------------|
| 1        | המשתמש נכנס לכתובת הדף `yaadTrans.php`                 | נטענת טבלת החיפוש, תצוגת הדוח והפילטרים (תאריכים, סטטוס וכו') |
| 2        | המשתמש בוחר טווח תאריכים (באמצעות הרכיב "מתאריך / עד") | המסך מתעדכן בערכים שנבחרו, מוכן לשליחה                      |
| 3        | המשתמש בוחר אמצעי תשלום אחד או יותר                    | השדות מסומנים ומסננים את הרשימה לפי אמצעי התשלום הללו       |
| 4        | המשתמש ממלא טקסט חופשי / שם לקוח (אופציונלי)           | ערך החיפוש נשמר בטופס, ומסנן בהתאם בהגשת הטופס               |
| 5        | המשתמש לוחץ על "חפש"                                   | הדף נטען מחדש ומציג טבלת תוצאות (רשימת תשלומים)             |
| 6        | המשתמש רואה בכל שורה את פרטי העסקה, אפשרות לבטל/לזכות   | רשימת תשלומים נטענת בחלק המרכזי של העמוד                     |
| 7        | המשתמש יכול ללחוץ על כפתור "ביטול" או "זיכוי" בעסקה     | פעולה בצד השרת לביצוע ביטול או זיכוי, ולאחר מכן עדכון התצוגה |

### (ב) ניתוח המימוש בקוד (Back-End)

**תיאור כללי:**  
בקובץ `yaadTrans.php` נטענים פרמטרים מ-`$_GET` (כגון `sid`, `from`, `to`, `payType2`, `orderSign`) ובאמצעותם נבנה סט תנאים (WHERE) לשליפת העסקאות ממסד הנתונים דרך טבלאות `orderPayments`, `subscriptionPayments`, ו־`gift_purchase_payments`. בפועל משתמשים גם במחלקות עזר כמו `UserPager` לפאג’ינציה, ו־`UserUtilsNew` לאבחון סוגי תשלום.

**טבלת צעדים טכניים (Back-End):**

| מס' צעד | לוגיקה טכנית                                                                                                            | מיקום בקוד / קובץ                  | מבנה ותוכן קוד רלוונטי                                             |
|---------|------------------------------------------------------------------------------------------------------------------------|------------------------------------|----------------------------------------------------------------------|
| 1       | קריאת הפרמטרים (`sid`, `from`, `to`, `payType2`, וכו') ומיפוי לערכים מותאמים (תאריכים וכו')                           | `yaadTrans.php` (שורות ראשונות)   | שימוש ב-\_GET, פונקציית `typemap()` לערכי תאריך/מחרוזת, ועוד.       |
| 2       | בניית מערך ה־`$where` עם תנאים (למשל `p.complete = 1`, טווח תאריכים, סינון אמצעי תשלום, וכו')                        | `yaadTrans.php`                    | השרשור `if ($_GET['payType']...) $where[] = ...` וכד'.              |
| 3       | הרצת השאילתות המאוחדות (UNION) שמחזירות את כל העסקאות מכל סוגי הטבלאות                                                  | `yaadTrans.php`                    | `$que = "SELECT SQL_CALC_FOUND_ROWS ... UNION ALL ..."` ועוד.        |
| 4       | טעינת רשימת העסקאות לתוך מערך `$pays` וקבלת סכומי סך (totals) לפי סוג התשלום                                          | `yaadTrans.php`                    | ביצוע `udb::key_row(...)` ותהליכי חישוב לצורך הצגה                  |
| 5       | הצגת התוצאות למשתמש + כפתורי פעולה (ביטול, זיכוי, הדפסת חשבונית)                                                       | `yaadTrans.php` (אזורים שונים)     | HTML + תנאים לוגיים (אם `$pay['cancelled'] ... וכו')               |
| 6       | בלחיצת ביטול/זיכוי מפעילים קריאה לפונקציה (JavaScript + בקשה לשרת) שמפעילה לוגיקת ביטול, עדכון DB והצגת התוצאה המעודכנת | שילוב front/back דרך AJAX או GET   | תלוי בטרמינל: `YaadPay::payCancel(...)`, `payRefund(...)` או אחר.   |

---

## תרחיש 2: צפייה/מימוש גיפט קארד ב-`ajax_pop_gift.php`

### (א) ניתוח משתמש הקצה (Front-End)
**תיאור כללי:**  
המשתמש לוחץ על כפתור/קישור לצפייה בשובר (גיפט-קארד) – מופיע פופ-אפ ובו פרטי השובר, היתרה, היסטוריית מימושים, וכפתור למימוש חלקי/מלא.

**טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                         | תוצאה מצופה                                                        |
|----------|------------------------------------------|--------------------------------------------------------------------|
| 1        | בעמוד הראשי (`yaadTrans.php` למשל) לוחץ על פריט/כפתור "צפה בשובר" | מופיע פופ-אפ (AJAX) עם פרטי השובר                                   |
| 2        | בפופ-אפ רואה את הסכום המקורי, היתרה, תאריכים | מוצגת טבלה או רשימה של מימושים קודמים                              |
| 3        | לוחץ "מימוש חלקי" או "מימוש מלא" (אם קיים כפתור כזה) | נשלחת קריאת AJAX נוספת כדי לעדכן במסד הנתונים את הפעולה             |
| 4        | לאחר פעולה מוצלחת, הפופ-אפ נסגר / מתעדכן    | יתרת הגיפט-קארד קטנה בהתאם, ונרשם "ניצל" בספר הפעולות (Log usage). |

### (ב) ניתוח המימוש בקוד (Back-End)

| מס' צעד | לוגיקה טכנית                                                                                                   | מיקום בקוד               | מבנה ותוכן קוד רלוונטי                                                                      |
|---------|---------------------------------------------------------------------------------------------------------------|---------------------------|---------------------------------------------------------------------------------------------|
| 1       | `ajax_pop_gift.php` מקבל פרמטרים `gID` או `oid` (מספר השובר)                                                 | `ajax_pop_gift.php`       | `$gID = intval($_GET['gID']); ... $item = udb::single_row("SELECT ... FROM gifts_purchases"` |
| 2       | בודק האם המשתמש מורשה לאתר (בהתאם ל-`$_CURRENT_USER->sites(true)`)                                           | `ajax_pop_gift.php`       | `if(!$_CURRENT_USER->has($item['siteID'])) { ... }`                                         |
| 3       | טוען מידע על הסכום, יתרה, מימושים (`giftCardsUsage`), ושולח HTML מוכן (פופ-אפ)                                | `ajax_pop_gift.php`       | מנגנון איחזור ושילוב ב-HTML: `<div class="gift_container"> ...`                             |
| 4       | לחיצה על "מימוש" תתבצע מול פונקציה (למשל JavaScript) המעבירה קריאה צד שרת (לאחריות המפתח) לעדכון `giftCardsUsage` | לא מוצג במלואו בקובץ      | נרשמת שורה חדשה של שימוש או מבוצע שינוי ביתרה, בהתאם לסכום המימוש                           |
| 5       | מחזיר למשתמש פופ-אפ מעודכן/סגירה                                                                        | באחריות פונקציית JS       | העדכון בוודאי מבוצע והפופ-אפ נסגר, או מוצגת השפעת הפעולה.                                    |

---

## תרחיש 3: הורדת חשבונית (Order / Subscription / GiftCard)

### (א) ניתוח משתמש הקצה (Front-End)
**תיאור כללי:**  
לאחר ביצוע עסקה, המשתמש מעוניין להוריד/לצפות בחשבונית (PDF). בעמוד התשלומים מופיעה אפשרות "חשבונית" שלחיצה עליה תבצע הורדה (או פתיחה בחלון חדש).

**טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                                       | תוצאה מצופה                                            |
|----------|--------------------------------------------------------|--------------------------------------------------------|
| 1        | המשתמש לוחץ על כפתור "חשבונית" בשורת תשלום מסוימת       | מנגנון בדפדפן (link) קורא לקובץ `download_invoice*.php` |
| 2        | נפתח חלון הורדת קובץ / שמירת PDF לפי הגדרות הדפדפן      | המשתמש רואה את החשבונית או מאשר הורדה                  |

### (ב) ניתוח המימוש בקוד (Back-End)

| מס' צעד | לוגיקה טכנית                                                                                            | מיקום בקוד                            | מבנה ותוכן קוד רלוונטי                                                |
|---------|--------------------------------------------------------------------------------------------------------|----------------------------------------|-------------------------------------------------------------------------|
| 1       | בהתאם לסוג התשלום/הטבלה מופעל אחד מהקבצים `download_invoice.php`, `download_invoice_sub.php`, `download_invoice_gc.php` | קבצי `download_invoice*.php`           | בכולם קיים `require "auth.php"` ואז שליפת הפרמטרים (`orid`, `pid` וכו'). |
| 2       | וידוא גישה (`$_CURRENT_USER->has($siteID)`)                                                           | בתוך אותו קובץ                        | `if (!$_CURRENT_USER->has($purchase['siteID'])) throw new Exception(...)` |
| 3       | מאתרים בשדה ה־`invoice`/`resultData` מהו מספר החשבונית שהונפק, או מפנים ל-`YaadPay::$INVOICE_URL`      | `download_invoice.php` (וכו’)          | משתנה `$invoice`, או `$payData['invoice']` ונעשה redirect או הורדת PDF   |
| 4       | מחזירים כותרות מתאימות (header) ל-HTTP כך שהדפדפן מוריד את הקובץ או עובר ל־URL חיצוני                  | בקובץ ה-PHP הרלוונטי                   | `header('Content-disposition: attachment; filename="invoice-....pdf"');` |

---

## תרחיש 4: הפקת דו"ח עסקאות כללי (`print_deal_report.php`)

### (א) ניתוח משתמש הקצה (Front-End)
**תיאור כללי:**  
המשתמש מעוניין בדוח מרוכז, נכנס לכתובת `print_deal_report.php` (בד"כ בלחיצה מעמוד הנהלה), רואה סיכומי הכנסות ומספר פעולות, ואז יכול להדפיס או להוריד PDF.

**טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                               | תוצאה מצופה                                             |
|----------|----------------------------------------------|---------------------------------------------------------|
| 1        | המשתמש לוחץ על כפתור "דו"ח עסקאות" בעמוד מנהל   | נפתח עמוד `print_deal_report.php` עם טופס/תוצאות דוח    |
| 2        | המשתמש מאשר טווח תאריכים או סוגי תשלום מסוימים | נטענים טבלאות סיכומי תשלום (סה"כ לכל סוג), סה"כ פעולות  |
| 3        | המשתמש לוחץ על "הדפסה"                         | הדפדפן מציג חלונית הדפסה, ומופק דף HTML מתאים           |
| 4        | (אופציונלי) הורדת PDF                         | לרוב מצריך לחיצה/כפתור המייצר את ה-PDF ושומר/מוריד אותו |

### (ב) ניתוח המימוש בקוד (Back-End)

| מס' צעד | לוגיקה טכנית                                                                                    | מיקום בקוד                 | מבנה ותוכן קוד רלוונטי                                |
|---------|------------------------------------------------------------------------------------------------|----------------------------|--------------------------------------------------------|
| 1       | מקבל פרמטרים (למשל `from`, `to`, `payType`), טוען אותם משורת ה-URL                             | `print_deal_report.php`    | `$_GET['from']`, `$_GET['to']` וכו'                    |
| 2       | מריץ שאילתה דומה ל־`yaadTrans` (כולל UNION) אך סוכמת GROUP BY payType                          | `print_deal_report.php`    | `$totalQue = "SELECT \`payType\`, SUM(\`sum\`) ..."`    |
| 3       | מרכז את התוצאות בטבלה ושומר לסטרינג `$report`                                                  | `print_deal_report.php`    | משתמש ב־ob_start() / ob_get_clean() להכנת HTML        |
| 4       | קורא ל־`TCPDF` דרך פונקציה `genContractPDF(...)` לייצר PDF                                     | `print_deal_report.php`    | החלק האחרון בקובץ שמציג לינק / כפתור להדפסה / להורדה   |

---

## תרחיש 5: הפקת דו"ח הכנסות מיוחד (`print_deal_report_special.php`)

### (א) ניתוח משתמש הקצה (Front-End)
**תיאור כללי:**  
דוח דומה לדו"ח עסקאות כללי אך משמש מצבים מסוימים (למשל, כרטיסים שיש להתחשב בתאריך טיפול ולא רק בתאריך תשלום).

**טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                                      | תוצאה מצופה                                          |
|----------|-------------------------------------------------------|------------------------------------------------------|
| 1        | המשתמש נכנס/לוחץ על "דו"ח הכנסות" (מעין גרסה מיוחדת)  | נפתח עמוד `print_deal_report_special.php`           |
| 2        | גולש בוחר/רואה את טווח התאריכים וסוגי התשלום          | מופיעה טבלה מפורטת (הכנסות) + אפשרות הדפסה/הורדת PDF |
| 3        | לוחץ על "הדפסה"                                       | מופק דף HTML המוכן להדפסה                            |

### (ב) ניתוח המימוש בקוד (Back-End)

| מס' צעד | לוגיקה טכנית                                                                                                          | מיקום בקוד                          | מבנה ותוכן קוד רלוונטי                                                     |
|---------|----------------------------------------------------------------------------------------------------------------------|-------------------------------------|-----------------------------------------------------------------------------|
| 1       | בדומה ל־`print_deal_report.php`, אך יש לוגיקה נוספת עבור כרטיסים מסוימים (“byTreatDate”)                              | `print_deal_report_special.php`     | `if ($pt == 'coupon' ...)` וכו'                                            |
| 2       | איסוף נתונים עם התייחסות לשדות נוספים (למשל תאריך הטיפול `timeFrom` ב־orders משניים)                                | `print_deal_report_special.php`     | שימוש ב־UNION ושדות נוספים בפילטר                                          |
| 3       | הפקת HTML + קריאה ל־`TCPDF` לייצור PDF                                                                               | שם הקובץ עצמו                       | מבנה דומה לחתימת הפונקציה ב־`print_deal_report.php`.                       |

---

# 6. מסמך שימוש (מדריך למשתמש)

להלן מדריך קצר לשימוש במערכת/דפי הניהול המתוארים, בגוף שני:

1. **כניסה לעמוד `yaadTrans.php`**
   - פתח/י את הדפדפן והקלד/י את כתובת העמוד `yaadTrans.php`.
   - בחר/י את טווח התאריכים המתאים בעזרת שדות "מתאריך" ו"עד תאריך" (או השתמש/י בקיצורי "היום", "השבוע", "החודש").
   - סמן/י אמצעי תשלום (אם רצוי) והקלד/י טקסט חופשי לחיפוש.
   - לחץ/י על "חפש" – יוצגו התוצאות לפי הסינון. בעבור כל תשלום, ניתן לבצע ביטול/זיכוי או להוריד חשבונית.

2. **צפייה בגיפט קארד (Gift Card) ומימושו**
   - בעמוד התשלומים, אתר/י שורה המסמנת תשלום של Gift Card או כפתור "ראה גיפט קארד".
   - לחץ/י עליו, וייפתח פופ-אפ המציג את פרטי השובר (יתרה, מימושים קודמים וכו').
   - לביצוע מימוש חלקי או מלא – אם קיים כפתור מתאים, לחץ/י עליו ואשר/י את הסכום. המערכת תעדכן את היתרה.

3. **הורדת חשבונית**
   - בכל שורת תשלום, אם ישנה אפשרות "חשבונית", לחץ/י עליה.
   - הדפדפן יציע להוריד או לפתוח את קובץ ה־PDF. שמור/י אותו והשתמש/י לצורך הנה"ח.

4. **הפקת דוחות**
   - לצפייה בדוח עסקאות כללי, עבור/י לכתובת `print_deal_report.php` או לחץ/י על "דו"ח עסקאות" בתפריט (אם קיים).
   - לאחר בחירת טווח התאריכים, יוצג לך ריכוז סכומי העסקאות לפי סוג תשלום, ותוכל/י להדפיסם או לשמור בפורמט PDF.
   - לדוח הכנסות מיוחד (למשל לפי תאריך טיפול), השתמש/י ב־`print_deal_report_special.php`.

---

# 7. סיכום

מסמך זה סוקר את כל הקבצים שנמצאו בפועל ואת התרחישים העיקריים העולים מהם: חיפוש תשלומים, הצגת שוברים (גיפט קארדים), הורדת חשבוניות, והפקת דוחות.  
הקבצים שלא נבדקו צוינו בנפרד, והם אינם מופיעים ברשימה המקורית שסופקה. מעבר לכך, לא זוהו קבצים חסרים או שלא נמצאו.  
כל אחד מהקבצים הנסרקים ממלא תפקיד ברור במערכת: הצגת עסקאות, ביצוע פעולות תשלום/ביטול, או עיבוד ותצוגת דוחות. ניתן להמשיך ולהרחיב/לשפר פונקציונליות בהתאם לצורך.

**אין קבצים נוספים לטפל בהם**, שכן נאמר במפורש שלא נדרשת התייחסות מעבר לקבצים השייכים לתיקיית `user` (ועוד כמה קבצים בספריית `cms` / `api` המסופקים במלואם).

