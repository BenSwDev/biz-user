# 1. הקדמה
המסמך שלפניך מרכז ניתוח מלא של חמישה קבצים שנמצאו בפועל (ajax_spaPlus.php, ajax_spaFrom.php, ajax_spaFromTherapist.php, ajax_spaSMS.php, pre_print.php). הניתוח מבוסס אך ורק על המידע המופיע בקבצים עצמם, ללא הוספת פרטים או הנחות שאינם מופיעים במקור. תפקיד הקבצים הוא ניהול תהליכי הזמנה, טיפולים ושהות בחדרים (כמו חדרי אירוח או חדרי טיפולים), תוך אפשרות לשלוח הודעות (Mail/SMS), לבצע בדיקות זמינות, להוסיף טיפולים, להזין תוספות, להפיק קבצי PDF לחתימה ועוד.

בקבצים השונים ניתן למצוא היגיון עסקי מורכב הכולל:
- יצירה ועדכון הזמנות (CRUD).
- בדיקת זמינות חדרים/יחידות.
- הקצאת משבצות זמן (tfusa).
- שליחה ללקוח (מייל/WhatsApp/SMS).
- ממשק מותאם למנהלים (ADMIN) וממשק מותאם למטפלים (Therapist).
- פונקציות נוספות כמו הסתרת מחירים, שחזור הזמנה שבוטלה, ועוד.

---

## 2. הקבצים שנבדקו
להלן רשימת הקבצים הקיימים בפועל ושנסרקו במלואם, כולל עיקרי הדברים שניתן להסיק בבירור מתוכנם:

1. **ajax_spaPlus.php**  
   - מטפל בבקשות שונות (דרך `$_POST['action']`), כגון:  
     - `hidePrices` (הסתרת מחירי הזמנה),  
     - `info` (שליפת מידע על הזמנה),  
     - `cancel` (ביטול הזמנה ע"י עדכון הסטטוס ל-0 ומחיקת זמני שהות),  
     - `delete` (מחיקה מוחלטת של הזמנה וטבלאות נלוות),  
     - `insertOrder` (הוספה/עדכון הזמנה, בדיקת תפוסה, שליחת מייל, הזנת יחידות וכו'),  
     - `restore` (שחזור הזמנה שבוטלה),  
     - `reviewInvite` (שליחת בקשה לחוות דעת).  
   - בקובץ מופיעות פונקציות עזר דוגמת `addTfusa()`, `checkAvil()`, `deleteUnitsOrder()`, `updateOrder()`.
   - מתבצעות בדיקות הרשאות (`$_CURRENT_USER->has(...)`).
   - נעשה שימוש בקריאות מסד נתונים (דרך `udb::`) ולוג משתמש (`UserActionLog`).

2. **ajax_spaFrom.php**  
   - מציג/בונה טופס הזמנה לצורך ניהול מערכת על ידי ADMIN.  
   - אם המשתמש לא בעל הרשאות ADMIN, נעשית הפניה ל–`ajax_spaFromTherapist.php`.  
   - הקובץ טוען נתוני הזמנה (כולל יחידות, תוספות, טיפולים קיימים), קלט משתמש, דינמיקת HTML/JS (כגון תאריכים, שעות, ארוחות, הנחות), ושומר/שולח נתונים בשילוב עם `ajax_spaPlus.php`.  
   - בין היתר מאפשר שליחת הודעות (WhatsApp/SMS/Email), טיפול במקורות הזמנה (sourceID), העלאת טופס לחתימה וכדומה.

3. **ajax_spaFromTherapist.php**  
   - גרסה אחרת (מצומצמת) של הצגת פרטי הזמנה למשתמש שאינו ADMIN (כגון מטפל / Therapist).  
   - מבצע בדיקת הרשאה בסיסית, מציג טופס שלא כולל את כל אפשרויות הניהול המלאות שיש לאדמין.

4. **ajax_spaSMS.php**  
   - מיועד לשליחת SMS דרך צד השרת.  
   - מקבל `orderID` ו/או פרטי טלפון, ותוכן הודעה (`sms_con`).  
   - לאחר שליחה מוצלחת דרך `Maskyoo::sms`, נרשמת הרשומה בטבלת `orders_sms` (אם מקושר להזמנה), או `sms_manual` (אם נשלח ידנית ללא הזמנה).  

5. **pre_print.php**  
   - יוצר קובץ PDF (באמצעות TCPDF) לצורך הדפסת הסכם (חוזה) לפני חתימה.  
   - בודק אם ההזמנה קיימת והמשתמש מורשה, מפיק PDF זמני, ושולח להורדה לדפדפן.  
   - משתמש בפונקציות עזר (כגון `genContract()`, `genContractPDF()`) שאינן מופיעות בקבצים הנוכחיים.

---

## 3. הקבצים שלא נמצאו
אין קבצים שצוין לגביהם במפורש "הקובץ לא נמצא", ולכן רשימה זו **ריקה**.

---

## 4. הקבצים שלא נבדקו
במהלך קריאת הקוד מתגלים אזכורים לקבצים/ספריות שאינם מופיעים ברשימת הקבצים שנבדקו, אך הקוד מצריך אותם:

1. **TCPDF/tcpdf_config.php**  
2. **TCPDF/tcpdf.php**  
3. **../sendgrid/sendgrid-php.php**  
4. **../phpmailer/class.bizonlineMailer.php** (מופיע בקוד כהערה/קומנטרי, אך עדיין מוזכר).  

מכאן שהם נדרשים (או מוזכרים), אך אינם קיימים ברשימה של הקבצים שנסרקו בפועל ולכן לא נבדקו.

> **הערה:** על פי ההנחיות, יש להתעלם מאזכורי `auth.php`, `functions.php`, `index.php`, `partial/menu.php` וכו', ולכן הם לא מופיעים כאן.

---

## 5. תרחישים כוללים בעמוד

### מטרת הניתוח
לזהות את כל תרחישי השימוש (Use Flow Scenarios) כפי שהם באים לידי ביטוי בקבצים השונים, ולהציגם בשני היבטים עיקריים:
1. **Front-End Perspective (משתמש קצה)** – תיאור מה המשתמש עושה או רואה.
2. **Back-End Perspective (מפתח)** – הסבר טכני של הלוגיקה שמתרחשת "מאחורי הקלעים".

### **1. זיהוי כל תרחישי השימוש**

להלן סיכום התרחישים העיקריים העולים מתוך חמשת הקבצים:

1. **הסתרת מחירים (hidePrices)** – פונקציונליות לשינוי שדה `hidePrices` של הזמנה.  
2. **שליפת מידע על הזמנה (info)** – הצגת פרטי הזמנה כולל קישורי חתימה, WhatsApp ו-SMS.  
3. **ביטול הזמנה (cancel)** – שינוי סטטוס ל-0 ומחיקת נתוני השהות (tfusa).  
4. **מחיקת הזמנה (delete)** – מחיקה מלאה של ההזמנה וכל הקשרים (orderUnits, tfusa).  
5. **הוספה/עדכון הזמנה (insertOrder)** – יצירת הזמנה חדשה או עדכון קיימת, בדיקות זמינות, הוספת יחידות, תוספות, טיפולים וכו'.  
6. **שחזור הזמנה (restore)** – החזרת הזמנה מבוטלת לסטטוס פעיל (1), כולל בדיקת תפוסה.  
7. **שליחת בקשה לחוות דעת (reviewInvite)** – שליחת מייל הזמנה למילוי חוות דעת לאחר השהות.  
8. **הצגת טופס ניהול הזמנה (ajax_spaFrom.php / Therapist)** – הצגה ועריכה של נתוני הזמנה בממשק HTML/JS, בין אם למנהלים או למטפלים.  
9. **שליחת הודעת SMS להזמנה (ajax_spaSMS.php)** – שליחת SMS לאורח והוספת לוג על כך.  
10. **יצירת קובץ PDF להסכם (pre_print.php)** – הפקת חוזה/מסמך לפני חתימה והורדתו כ-PDF.

להלן פירוט נבחר של חלק מן התרחישים המרכזיים, במבנה מבוקש.

---

### **תרחיש 1: הסתרת מחירים (hidePrices)**

#### א. תיאור משתמש הקצה (Front-End Perspective)
- **תיאור כללי:** המשתמש (ADMIN) לוחץ במקום מסוים על "הסתר מחירים" כדי שהזמנה מסוימת לא תציג מידע כספי למשתמשים אחרים.
- **טבלת צעדים:**

| מספר צעד | פעולה מצד המשתמש                 | תוצאה מצופה                                        |
|----------|--------------------------------|----------------------------------------------------|
| 1        | מפעיל/מבטל "הסתר מחירים" בהזמנה | נשלחת בקשת AJAX לשרת עם `action="hidePrices"`.     |
| 2        | —                              | בממשק מוצגת הצלחה/שגיאה, והמחירים מוסתרים/גלויים.  |

#### ב. תיאור המימוש בקוד (Back-End Perspective)
- **תיאור כללי:** בקובץ ajax_spaPlus.php, ב-swich על `$_POST['action']`, מזוהה `"hidePrices"`.
- **טבלת צעדי תרחיש טכני:**

| #   | לוגיקה טכנית                                                | מיקום בקוד                          | מבנה ותוכן הקוד                                       |
|-----|------------------------------------------------------------|-------------------------------------|--------------------------------------------------------|
| 1   | בדיקת `$_POST['action'] == "hidePrices"`                   | `switch($_POST['action'])`          | `case "hidePrices": ... break;`                       |
| 2   | שליפת `orderID` ו-`hidePrices` (`true`/`false`)            | תחילת ה-`case "hidePrices"`         | `$orderID = intval($_POST['orderID']); ...`           |
| 3   | בדיקת הרשאות מול `$_CURRENT_USER->has($order['siteID'])`   | בתוך ה-case hidePrices              | אם אין הרשאה -> Exception                              |
| 4   | עדכון `hidePrices` בטבלת `orders` (1/0)                    | `udb::query("UPDATE `orders` ...")` | `UPDATE orders SET hidePrices= ... WHERE orderID=...`  |
| 5   | שמירת לוג (`user_log->save(...)`)                          | בסיום                                | `hide_price...`                                        |
| 6   | החזרת תוצאה JSON                                           | סיום case hidePrices                | `$result['status'] = 1;`                               |

---

### **תרחיש 2: שליפת מידע על הזמנה (info)**

#### א. תיאור משתמש הקצה (Front-End)
- **תיאור כללי:** משתמש בוחר "צפה/ערוך בהזמנה" ומצפה לקבל פירוט מלא (תאריכים, פרטי לקוח, קישורי חתימה וכו').
- **טבלת צעדים:**

| מספר צעד | פעולה מצד המשתמש              | תוצאה מצופה                                                     |
|----------|-------------------------------|-----------------------------------------------------------------|
| 1        | לוחץ על כפתור / שולח בקשה "הצג מידע" | נשלחת בקשת AJAX עם `action="info"`, `orderID`.                  |
| 2        | —                             | מתקבלים בקוד הפרונט-אנד נתוני ההזמנה ומוצגים על המסך לעריכה/צפייה. |

#### ב. תיאור המימוש בקוד (Back-End)
- **תיאור כללי:** ajax_spaPlus.php מתאם שליפת נתוני הזמנה, בדיקת הרשאה, והחזרת אובייקט JSON.
- **טבלת צעדי תרחיש טכני:**

| #   | לוגיקה טכנית                                                      | מיקום בקוד        | מבנה ותוכן הקוד                                           |
|-----|------------------------------------------------------------------|-------------------|------------------------------------------------------------|
| 1   | `case "info": ... break;`                                        | בתוך ה-switch     |                                                            |
| 2   | שליפת `$orderID` וידוא שהוא תקין                                 | תחילת case info   | `if (!$orderID) throw new Exception("No order ID");`       |
| 3   | בדיקת הרשאה מול `$_CURRENT_USER->has($order['siteID'])`          | לאחר שליפת ההזמנה | אם לא מורשה -> Exception                                   |
| 4   | שליפת מידע מ־`orders`, `sites`, `orderUnits`                     | `udb::single_row` | `SELECT sites.siteName, orders.*, orderUnits.unitID FROM...`|
| 5   | בניית קישורים (WhatsApp, SMS, mailto) לפי פרטי לקוח             | בתוך ה-case       | `$order["whatsapp"] = ..., $order["sms"] = ..., $order["mailto"] = ...` |
| 6   | החזרת `$result["order"]`                                         | סוף case          |                                                            |

---

### **תרחיש 3: ביטול הזמנה (cancel)**

#### א. תיאור משתמש הקצה (Front-End)
- **תיאור כללי:** המשתמש לוחץ "בטל הזמנה" מתוך הממשק המנהלי, והיא יוצאת ממצב פעיל.
- **טבלת צעדים:**

| #   | פעולה מצד המשתמש   | תוצאה מצופה                                   |
|-----|--------------------|-----------------------------------------------|
| 1   | בוחר "בטל הזמנה"  | המערכת שולחת בקשה `action="cancel"`.          |
| 2   | —                  | מתקבלת חיווי שהסטטוס הוגדר כבטל, והחדר התפנה. |

#### ב. תיאור המימוש בקוד (Back-End)
- **תיאור כללי:** בקובץ ajax_spaPlus.php, `cancel` יוצר סטטוס=0 ומוחק רשומות tfusa.
- **טבלת צעדים טכני:**

| #   | לוגיקה טכנית                                             | מיקום בקוד          | מבנה ותוכן הקוד                                              |
|-----|----------------------------------------------------------|---------------------|---------------------------------------------------------------|
| 1   | `case "cancel": ... break;`                              | בתוך ה-switch       |                                                               |
| 2   | בדיקת הרשאות                                             | `if(!$_CURRENT_USER->has(...)) throw ...` |                                                               |
| 3   | מחיקת רשומות `tfusa`                                     | `udb::query("DELETE FROM tfusa ...")`       |                                                               |
| 4   | `UPDATE orders SET status=0`                              | בשורה הרלוונטית     |                                                               |
| 5   | `user_log->save('order_cancel'...)`                       | סוף התהליך         |                                                               |
| 6   | החזרת `$result['status'] = 1` (הצלחה)                    | סיום case           |                                                               |

---

### **תרחיש 4: מחיקת הזמנה (delete)**

#### א. תיאור משתמש הקצה
- **תיאור כללי:** המשתמש מבקש למחוק לגמרי הזמנה.
- **טבלת צעדים:**

| #   | פעולה מצד המשתמש | תוצאה מצופה                                                        |
|-----|------------------|--------------------------------------------------------------------|
| 1   | לוחץ "מחק הזמנה" | AJAX עם `action="delete"`, ומתקבל אישור על המחיקה המלאה (רשומות נמחקו). |

#### ב. תיאור המימוש בקוד (Back-End)
| #   | לוגיקה טכנית                              | מיקום בקוד         | מבנה ותוכן הקוד                                              |
|-----|------------------------------------------|--------------------|---------------------------------------------------------------|
| 1   | `case "delete": ... break;`              | בתוך ה-switch      |                                                               |
| 2   | בדיקת הרשאות                             | `$_CURRENT_USER->has($order['siteID'])` |                                                               |
| 3   | מחיקה מ-`orders`, `orderUnits`, `tfusa`   | `DELETE FROM ...`  | מוחקים את כלל הנתונים בהזמנה                                 |
| 4   | רישום לוג `order_delete`                 | `user_log->save()` |                                                               |
| 5   | החזרת `$result['status'] = 1`            | סוף case          |                                                               |

---

### **תרחיש 5: הוספה/עדכון הזמנה (insertOrder)**

#### א. תיאור משתמש הקצה
- **תיאור כללי:** המשתמש ממלא טופס חדש או עורך הזמנה קיימת, ולוחץ "שמור". מצפה לבדיקה האם החדר/תאריכים תפוסים.
- **טבלת צעדים:**

| #   | פעולה מצד המשתמש             | תוצאה מצופה                                |
|-----|------------------------------|--------------------------------------------|
| 1   | ממלא טופס פרטי הזמנה        | הזמנה מוכנה לשמירה                        |
| 2   | לוחץ "שמור"                 | AJAX עם `action="insertOrder"`            |
| 3   | —                            | אם החדר תפוס -> שגיאה. אחרת -> נשמר בהצלחה |

#### ב. תיאור המימוש בקוד (Back-End)
| #   | לוגיקה טכנית                                                                             | מיקום בקוד                 | מבנה ותוכן הקוד                                                                   |
|-----|------------------------------------------------------------------------------------------|----------------------------|------------------------------------------------------------------------------------|
| 1   | `case "insertOrder": ... break;`                                                        | ב-switch (`ajax_spaPlus`) |                                                                                    |
| 2   | המרת נתונים (`typemap`) ותאריכי התחלה/סוף                                               | תחילת case                |                                                                                    |
| 3   | בדיקת תפוסה `checkAvil(...)`                                                            | טרם יצירה/עדכון           | אם תפוס -> `throw new Exception("החדר תפוס");`                                     |
| 4   | הזמנה חדשה: `INSERT INTO orders ...` והכנסת יחידות (orderUnits) + יצירת tfusa            | אם `$data['orderID']` חסר  |                                                                                    |
| 5   | הזמנה קיימת: עדכון `orders` ופונקציית `updateOrder(...)` (שמוחקת ומוסיפה מחדש tfusa)   | אם `$data['orderID']` קיים |                                                                                    |
| 6   | שליחת אימייל/סמס (אם נדרש), הוספת תוספות (extras)                                      | בסוף ההוספה/העדכון        |                                                                                    |
| 7   | `user_log->save(...)`                                                                    | בסיום                      |                                                                                    |
| 8   | החזרת `$result['success']` או `$result['error']`                                        | סוף case                  |                                                                                    |

---

### **תרחיש 6: שחזור הזמנה (restore)**

#### א. תיאור משתמש הקצה
- **תיאור כללי:** המשתמש רוצה לשחזר הזמנה שבוטלה. אם החדר פנוי, ההזמנה תחזור לסטטוס פעיל.
- **טבלת צעדים:**

| #   | פעולה מצד המשתמש            | תוצאה מצופה                                 |
|-----|-----------------------------|---------------------------------------------|
| 1   | לוחץ "שחזור הזמנה מבוטלת"  | AJAX עם `action="restore"`.                 |
| 2   | —                           | אם אין תפוסה -> סטטוס חוזר ל-1, אחרת שגיאה. |

#### ב. תיאור המימוש בקוד (Back-End)
| #   | לוגיקה טכנית                                            | מיקום בקוד            | מבנה ותוכן הקוד                                      |
|-----|---------------------------------------------------------|-----------------------|-------------------------------------------------------|
| 1   | `case "restore": ... break;`                            | בתוך ה-switch         |                                                       |
| 2   | שליפת הזמנה, בדיקה שהיא מבוטלת (status=0)              | לפני השחזור           |                                                       |
| 3   | בדיקת הרשאות `$_CURRENT_USER->has($order['siteID'])`    |                       |                                                       |
| 4   | `checkAvil(...)`; אם לא תפוס, כותבים מחדש tfusa         | בלולאה על היחידות     | `addTfusa($orderID, $uid, ...)`                      |
| 5   | `UPDATE orders SET status=1`                            | לאחר הצלחה            |                                                       |
| 6   | רישום לוג `order_restore`                               | בסיום                 |                                                       |

---

### **תרחיש 7: שליחת בקשה לחוות דעת (reviewInvite)**

#### א. תיאור משתמש הקצה
- **תיאור כללי:** לאחר שהות הלקוח, המערכת מאפשרת למנהל לשלוח קישור למילוי חוות דעת במייל.
- **טבלת צעדים:**

| #   | פעולה מצד המשתמש                       | תוצאה מצופה                                               |
|-----|----------------------------------------|-----------------------------------------------------------|
| 1   | לוחץ "reviewInvite" או כפתור דומה      | AJAX עם `action="reviewInvite"`                           |
| 2   | —                                      | נשלח מייל ללקוח למילוי חוות דעת (אם יש אימייל בהזמנה).    |

#### ב. תיאור המימוש בקוד (Back-End)
| #   | לוגיקה טכנית                                            | מיקום בקוד                      | מבנה ותוכן הקוד                                |
|-----|---------------------------------------------------------|---------------------------------|-------------------------------------------------|
| 1   | `case "reviewInvite": ... break;`                       | בתוך `switch($_POST['action'])` |                                                 |
| 2   | בדיקת הרשאות וודא שיש אימייל להזמנה (`$order['customerEmail']`) | בתוך case                      | אם אין -> `throw new Exception(...)`            |
| 3   | `include_once __DIR__ . "/../sendgrid/sendgrid-php.php";` | שליחת המייל בפועל               | `send_review_invite($order);`                   |
| 4   | `$result['success'] = true;`                            | סוף case                        |                                                 |

---

### **תרחיש 8: הצגת טופס (ajax_spaFrom.php / ajax_spaFromTherapist.php)**

- בנקודה זו, **ajax_spaFrom.php** ו-**ajax_spaFromTherapist.php** מייצרים/מציגים טופס לעריכת הזמנה:
  - **אם המשתמש ADMIN** – נטען `ajax_spaFrom.php`.
  - **אם המשתמש מטפל/אחר** – נטען `ajax_spaFromTherapist.php`.
  - בשניהם נטענים נתוני ההזמנה דרך שאילתות `udb::`, ומוצג HTML דינמי להוספת טיפולים, הזנת פרטי לקוח, ועוד.
  - הלוגיקה בסופו של דבר משתמשת ב-`ajax_spaPlus.php` לפעולות CRUD לפי ה-`action`.

---

### **תרחיש 9: שליחת הודעת SMS (ajax_spaSMS.php)**

#### א. תיאור משתמש הקצה
- **תיאור כללי:** מתוך הממשק, המשתמש מקיש תוכן SMS ולוחץ "שלח SMS" ללקוח.
- **טבלת צעדים:**

| #   | פעולה מצד המשתמש             | תוצאה מצופה                                                      |
|-----|------------------------------|------------------------------------------------------------------|
| 1   | מקיש טלפון או מסתמך על orderID  | AJAX אל `ajax_spaSMS.php`, עם `sms_con` (תוכן הודעה).            |
| 2   | —                            | המערכת משיבה "SMS נשלח בהצלחה" או שגיאה במידה ולא ניתן לשלוח.    |

#### ב. תיאור המימוש בקוד (Back-End)
- **תיאור כללי:** קובץ ajax_spaSMS.php מקבל `orderID` או `phone`, ותוכן הודעה. משתמש ב–`Maskyoo::sms(...)`.
- **טבלת צעדים טכני:**

| #   | לוגיקה טכנית                                                             | מיקום בקוד        | מבנה ותוכן הקוד                                                             |
|-----|-------------------------------------------------------------------------|-------------------|------------------------------------------------------------------------------|
| 1   | קריאת `$_POST['orderID']` / `$_POST['phone']`                          | תחילת הקובץ      | `header('Content-Type: application/json'); ...`                             |
| 2   | בדיקות חריגים: "לא נמצאה הזמנה", "לא קיים טלפון לשליחה"                | בלוק try-catch    | `throw new Exception("...")` אם חסר מידע                                    |
| 3   | שליפת `smsName` מ–`sites` לפי siteID                                    | לפני השליחה       | `$smsName = udb::single_value("SELECT `smsName` FROM `sites` ...");`        |
| 4   | קריאה ל–`Maskyoo::sms($text, $phone, $smsName)`                         | שליחת ה-SMS בפועל |                                                                              |
| 5   | במידה וההודעה מקושרת להזמנה, רושם רשומה בטבלת `orders_sms`             | אם `orderID` קיים | `udb::query("INSERT INTO orders_sms(...) VALUES(...)");`                     |
| 6   | החזרת `$result['msg'] = "SMS נשלח בהצלחה!"`                            | סוף הסקריפט       | `echo json_encode($result);`                                                |

---

### **תרחיש 10: יצירת PDF להסכם (pre_print.php)**

#### א. תיאור משתמש הקצה
- **תיאור כללי:** לוחץ כפתור "הדפס הסכם לא חתום", מוריד קובץ PDF לחתימה פיזית.
- **טבלת צעדים:**

| #   | פעולה מצד המשתמש                    | תוצאה מצופה                                 |
|-----|-------------------------------------|---------------------------------------------|
| 1   | לוחץ "הדפס הסכם" (pre_print.php?oid=XX) | נפתח חלון הורדת PDF עם תוכן החוזה.           |
| 2   | —                                   | מופיע חוזה להדפסה ולחתימה פיזית.            |

#### ב. תיאור המימוש בקוד (Back-End)
- **תיאור כללי:** `pre_print.php` טוען את ההזמנה, בודק הרשאה, ומייצר PDF זמני בעזרת TCPDF.
- **טבלת צעדים טכני:**

| #   | לוגיקה טכנית                                           | מיקום בקוד            | מבנה ותוכן הקוד                                      |
|-----|--------------------------------------------------------|-----------------------|-------------------------------------------------------|
| 1   | שליפת `orderID` מ–`$_GET['oid']`                       | תחילת הקובץ          | `intval($_GET['oid'])`                               |
| 2   | בדיקת הרשאה מול `$_CURRENT_USER->sites(true)`          | לאחר שליפת ההזמנה     | אם אין -> 403 Forbidden                              |
| 3   | הפקת חוזה ב־HTML (`genContract(...)`), המרתו ל-PDF      | שימוש ב–`TCPDF`       | `genContractPDF($file, $contract);`                  |
| 4   | שליחת ה־PDF להורדה (Headers מתאימים)                   | סוף הסקריפט           |                                                      |
| 5   | מחיקת הקובץ הזמני                                      | לאחר השליחה          | `unlink($file);`                                     |

---

## 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך צעד-אחר-צעד למשתמש הקצה, המתייחס לכל התרחישים העיקריים:

1. **פתיחת דף ההזמנה**  
   - אם אתה מנהל (ADMIN), הקובץ ajax_spaFrom.php ייפתח אוטומטית; אם אתה מטפל, תראה גרסה מצומצמת (ajax_spaFromTherapist.php).

2. **מילוי ועריכת פרטי הזמנה**  
   - הזן/י פרטים בסיסיים (שם המזמין, טלפונים, אימייל, סיבת הגעה, תאריכים, שעות, ועוד).  
   - סמן/י יחידות (חדרים), טיפולים, ותוספות (Extras) בהתאם לצורך.

3. **שמירת ההזמנה**  
   - ללחוץ על "שמור" (בממשק) – המערכת בודקת אם החדר פנוי; אם תפוס, מופיעה שגיאה "החדר תפוס". אם פנוי, ההזמנה תישמר.

4. **שליחת לינק לאישור וחתימה**  
   - לאחר יצירת הזמנה, ניתן לשגר ללקוח לינק במייל או SMS לאישור/חתימה.  
   - ניתן גם להסתיר מחירים (HidePrices) לפי צורך.

5. **ביטול/מחיקה**  
   - לביטול הזמנה (מבלי למחוק כליל) – לחיצה על "בטל הזמנה".  
   - למחיקה מלאה – לחיצה על "מחק הזמנה".  
   - אפשר לשחזר הזמנה שבוטלה (אם החדר פנוי) בלחיצה על "שחזור הזמנה".

6. **שליחת SMS**  
   - לחלופין ניתן לשלוח הודעת טקסט ישירות מתוך הממשק (הקלדת טקסט ולחיצה על "שלח SMS"), מה שיופיע בלוג השליחות.

7. **PDF לצורך הדפסה**  
   - להפקת חוזה/טופס להדפסה לפני חתימה פיזית – לחיצה על "הדפס הסכם" (pre_print.php).

8. **שליחת בקשה לחוות דעת (Reviews)**  
   - לאחר השהות, ניתן לשלוח ללקוח מייל עם בקשה לחוות דעת (reviewInvite).  

המערכת בנויה כך שמשתמשים בעלי הרשאת ADMIN יראו אפשרויות מורחבות, ומשתמשים בדרגה אחרת (מטפלים/אחרים) יראו גרסת טופס מצומצמת יותר.

---

## 7. סיכום
בקבצים שנבדקו הוצגה מערכת נרחבת לניהול הזמנות, הכוללת לוגיקה של יצירת הזמנה, בדיקות תפוסה, מחיקה/ביטול/שחזור, עריכה והצגה למשתמשים שונים (ADMIN/מטפל), וכן שליחת מיילים והודעות SMS.  
רוב פעילות ה-CRUD מבוצעת ב-`ajax_spaPlus.php`, בעוד `ajax_spaFrom.php` ו-`ajax_spaFromTherapist.php` מספקים את ממשקי הטופס (HTML/JS). `ajax_spaSMS.php` מטפל בשליחת הודעות SMS, ו-`pre_print.php` מפיק חוזה ב-PDF.  
כך מתקבלת מערכת מקיפה לניהול ושירות לקוחות, המאפשרת למנהלים או למטפלים להתנהל מול לקוחות באופן יעיל, כולל אפשרות לחתימה מקוונת, הסתרת מחירים, ועוד.

