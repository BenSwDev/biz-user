# 1. הקדמה
מסמך זה מרכז ניתוח מעמיק של קטעי קוד ומסמכים המשמשים לניהול ותצוגה של מערכת יומן/לוח שנה (Calendar) עבור משמרות ועבודת ספא (טיפולים, חדרים, מטפלים וכו'). הקוד נועד להציג למשתמש ממשק דינמי, כולל תצוגה יומית/שבועית/חודשית, אפשרויות הזנת משמרות והפסקות, הזמנות של טיפולים ספא, עדכון הערות יומיות, טיפול בשיוך מטפלים לחדרים/טיפולים ועוד.  
כל המידע והניתוח בדוח זה מבוססים **אך ורק** על התוכן הממשי שקיים בקבצים שנאספו (רשימה מלאה למטה). לא בוצע שימוש או הוספה של מידע חיצוני כלשהו.

---

# 2. הקבצים שנבדקו

להלן רשימת הקבצים שנמצאו בפועל (ויש בהם תוכן) לפי מה ששיתפת:

1. **pages/absolute_calendar.php**  
   מציג לוח שנה (Calendar) במגוון תצוגות (יום/שבוע/חודש/רשימה), כולל:
    - טיפול בפרמטרים מ־\$_GET (כגון `date`, `viewtype`, `weekly`, `type`/`caltype`, `workers`).
    - הגדרת תצוגות שונות (משמרות, לפי מטפלים, לפי חדרים), לצד פיצולי מידע ליחידות, מטפלים, עובדים.
    - יצירת מערך מועדים (הזמנות, משמרות), והצגה טבלאית בהתאם לטווח התאריכים המחושב.
    - שימוש ב־JavaScript (לדוגמה `assets/js/absolute_tfusa.js` ואחרים) לצורך עיבוד ויזואלי ושימושיות (גרירה, גלילה, סימון שעות, ועוד).
    - שילוב CSS דינמי (`style_ctrl.php`) וקריאות צד שרת לאחזור ולסינון נתונים (כגון `udb::`).

2. **ajax_daily_remarks.php**
    - קובץ PHP המקבל בקשות POST לצורך עדכון/שמירת הערות יומיות (remarks) בטבלה `daily_calendar_remarks`.
    - בודק האם המשתמש מורשה לערוך את המתחם (`siteID`) ומעדכן/מוחק את הרשומה הקודמת לפני שמירה.

3. **assets/css/style_ctrl.php**
    - קובץ PHP שמפיק בפועל תוכן CSS, לכאורה תוך התחשבות בפרמטרים `dir` (כגון RTL/LTR) ו־`fileName`.
    - מבצע חילופי left ↔ right ועוד החלפות סמנטיות בזמן אמת לפי הצורך (LTR מול RTL).

4. **assets/js/absolute_tfusa.js**
    - קוד JavaScript המרכז לוגיקה פרונט־אנד (Front-End) הקשורה לשרטוט משבצות יומן, משמרות והזמנות בממשק.
    - מכיל פונקציות כמו `addOrder`, `addShift_inOrders`, `addLocked` לציור אלמנטים בזמן אמת בלוח, הכוללים חישובי אחוזים ומיקומים (width/right/height/…).
    - מפעיל יכולות גרירת טיפולים, הזזת משמרות (drag & drop), יצירת פופאפ להזמנות/משמרות, ועוד.
    - קורא בין היתר ל־ajax (למשל `ajax_spaSingle.php`, `ajax_lockShift.php`) לעדכון נתונים בצד שרת.

5. **assets/js/absolute_tfusa2.js**
    - הרחבה/משלים ל־`absolute_tfusa.js`.
    - נראה שמטפל בלוגיקות נוספות של הזמנות ספא, כגון פונקציות המופעלות בעת פתיחת טופס "spaOrderForm", בקרות ומניעת התנגשות (busy therapist/חדר תפוס) וכד'.
    - כולל קריאות AJAX להוספה/עריכת טיפולים (למשל `openSpaFrom`, `saveSpaSingle`, `insertShift`, וכד').

6. **ajax_order.php**
    - משמש ליצירת הזמנה מסוג "allDay" או הזמנה מלאה, כולל הכנסת רשומות לטבלת `orders` ו־`orderUnits`, שימוש בפונקציה פנימית `addTfusa`.
    - מבצע בדיקות זמינות (function `checkAvil`) כדי למנוע התנגשות בין הזמנות באותו חדר (`tfusa`).
    - מאמת וסוגר פינות לגבי הרשאות משתמש, מעדכן טבלאות, קורא בין היתר ל־`DatesManager::update_wubook` (נראה חלק ממערכת שאינה מוצגת בקובץ).

7. **ajax_spaSingle.php**
    - קובץ PHP לטיפול מקיף בהזמנות ספא (צד שרת):
        - `moveSpaSingle` – שינוי שעה/מיקום (לדוגמה שינוי מטפל).
        - `saveSpaSingle` – שמירת/עדכון טיפול אחד, כולל חישוב מחיר, בדיקת התנגשות עם טיפולים אחרים או הפסקות.
        - ניהול משימות נוספות כמו מחיקת טיפול (`deleteSpaSingle`), שכפול טיפולים למטפלים שונים (`copyOrder`, `copyGroup`).
        - מפעיל מחלקות נוספות (כגון `TfusaSpa`, `OrderSpaMain`, `OrderCopy`) שבעצמן לא מופיעות כאן (מניחים שהן בקבצים אחרים).

8. **ajax_lockShift.php**
    - מקבל בקשת POST לנעול או לשחרר יום של מטפל (סטטוס של "הפסקה מלאה" באותו יום).
    - בודק אם למטפל כבר יש טיפולים באותו יום, ואם כן – מונע נעילה.
    - אחרת, מוסיף/מוחק רשומה מהטבלה `spaShifts` עם `status=0` כמייצג נעילה.

9. **ajax_shiftFrom.php**
    - נועד לפתיחת "פופ־אפ" (כנראה בצד לקוח) להצגת/עריכת משמרת בודדת ליום אחד.
    - שולף משמרות קיימות של המטפל לתאריך המבוקש, מאפשר להוסיף/לערוך/למחוק (הפסקה, משמרת), ולאחר מכן לשמור.

10. **ajax_shiftPlus.php**
    - מתפעל את שמירת המשמרות (או ההפסקות) של מטפל *לתאריך בודד* (מוחק תחילה ואז מכניס רשומות חדשות).
    - מונע יצירת הפסקה בזמן שיש טיפולים בפועל.
    - שומר בטבלה (`spaShifts` או `workShifts`).

11. **ajax_shiftPlus_week.php**
    - שמירת משמרות/הפסקות למטפל, אך בטווח שבוע שלם.
    - מוחק קודם את הנתונים הקיימים בטווח week (לפי `startweek` ו־`endweek`) ואז מוסיף לפי הנתונים מהפורמט הטבלאי.
    - בודק התנגשות מול טיפולים קיימים.

12. **ajax_shiftFromWeek.php**
    - מנגנון להצגת פופ־אפ עריכת משמרות שבועיות למטפל.
    - טוען מראש את כל המשמרות הקיימות באותו שבוע (לדוגמה מיום ראשון ועד שבת הנוכחית/שבוע רצוי).
    - מאפשר לשכפל משמרות מיום ליום ואף "לדרוס" משמרות בימים הנבחרים.

---

# 3. הקבצים שלא נמצאו
לא אותרו קבצים "חסרים" שסומנו מפורשות כ-"הקובץ לא נמצא".  
כלומר, מהרשימה שסיפקת, **כולם קיימים** ובעלי תוכן.

---

# 4. הקבצים שלא נבדקו
בחלקים שונים של הקוד מופיעות התייחסויות אפשריות לקבצים שלא הופיעו ברשימה, אך **לא** מדובר בקבצים שיש להתייחס אליהם לפי הנחייתך (כגון `auth.php`, `functions.php` וכו' שעליהם הונחינו להתעלם).  
עם זאת, יש קובץ נוסף שהוזכר ולא נכלל ברשימתך:
- **ajax_client.php** (מוזכר בקוד `ajax_spaSingle.php` או בקבצי JS לצורך auto-complete).

מאחר והוא לא מופיע ברשימת הקבצים שנבדקו או שלא נמצאו, נכלל אותו ברשימת "לא נבדקו".

**הערה**: התייחסות לקבצים כמו `auth.php`, `functions.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php` – הוגדרה מפורשות להתעלם מהם (אין צורך לכלול אותם ברשימת "לא נבדקו").

---

# 5. תרחישים כוללים בעמוד

## הוראות לניתוח קוד ובניית תרחישי שימוש (Use Flow Scenarios)

**מטרה מרכזית:** להפיק ניתוח מקצועי ומדויק של הקוד הקיים, תוך זיהוי **תרחישי שימוש** (Use Flows) אפשריים, המתארים גם את חוויית המשתמש (Front-End) וגם את המימוש הטכני (Back-End).

### 5.1 זיהוי תרחישי השימוש
לאור התבוננות בקבצים, ניתן לאפיין מספר תרחישים ראשיים במערכת (דוגמאות עיקריות):

1. **תרחיש הצגת לוח שנה**
    - המשתמש מגיע לעמוד `absolute_calendar.php`.
    - יכול לעבור בין תצוגה יומית/שבועית/חודשית ולסנן לפי משמרות/מטפלים/חדרים.

2. **תרחיש עדכון הערה יומית**
    - המשתמש פותח פופ־אפ להזנת "הערות" ליום מסוים ומאשר שמירה.
    - בצד השרת, נשמרת הרשומה ב־`daily_calendar_remarks`.

3. **תרחיש הוספה/עריכה של משמרת**
    - המשתמש פותח חלון ("פופ־אפ") בו הוא יכול להגדיר משמרת של מטפל (שעות התחלה/סיום, הפסקה וכו').
    - בצד השרת, מתבצעת שמירה או עדכון בטבלת `spaShifts`/`workShifts`.

4. **תרחיש נעילת יום למטפל**
    - המשתמש בוחר "נעל" יום שלם למטפל (למשל בטבלת המשמרות).
    - השרת בודק אם קיימים טיפולים/הזמנות באותו יום. אם אין – מוסיף רשומת "משמרת נעולה" (`status=0`) לחסום הכל.

5. **תרחיש יצירת טיפול ספא (הזמנה בודדת)**
    - המשתמש לוחץ על תא בלוח, בוחר מטפל וחדר, מזין פרטי הטיפול (אורך, סוג, מחיר וכו').
    - נשלחת קריאה ל־`ajax_spaSingle.php` עם הפעולה המתאימה (`saveSpaSingle`, למשל).
    - השרת בודק התנגשות זמנים, שומר בהצלחה, ומחזיר תשובה.

6. **תרחיש העברת (Drag & Drop) טיפול**
    - המשתמש גורר טיפול קיים למיקום חדש בלוח (לשעה אחרת או לחדר/מטפל אחר).
    - הקוד בצד לקוח מפעיל AJAX לשינוי הרשומה (`moveSpaSingle`).
    - השרת מעדכן בבסיס הנתונים את השדות `timeFrom`/`timeUntil` ואולי גם `therapistID`.

7. **תרחיש מחיקת טיפול**
    - המשתמש בוחר להסיר טיפול מהיומן.
    - הקריאה נשלחת ל־`ajax_spaSingle.php` עם action=deleteSpaSingle.
    - הרשומה נמחקת מטבלת `orders`, ובמקביל נמחקים הרישומים הקשורים (`orderUnits`, `tfusa`, וכו').

8. **תרחיש שכפול טיפולים/משמרות**
    - המשתמש יכול לשכפל משמרת יום שלם לימים אחרים, או טיפול למספר מטפלים (עבור group).
    - הצד שרת קולט את כמות ההעתקים המבוקשת, מייצר רשומות חדשות בטבלאות הרלוונטיות.

*כמובן שיש עוד וריאציות ותרחישים, אך אלו מייצגים עיקרי התהליך בקבצים הנסרקים.*

---

### 5.2 מבנה הניתוח של כל תרחיש שימוש
לכל תרחיש נציג:
1. תיאור מנקודת מבט המשתמש (Front-End / User Perspective).
2. תיאור המימוש בקוד (Back-End / Developer Perspective).

---

### 5.3 דוגמה לניתוח משתמש הקצה (Front-End Perspective)
להלן דוגמה מפורטת לתרחיש "הוספת טיפול ספא":

#### תיאור כללי
המשתמש מעוניין ליצור טיפול חדש: בוחר תאריך, שעה, מטפל וחדר, וממלא פרטי הלקוח (טלפון, מין המטופל וכו').

#### טבלת צעדים (משתמש)

| מס' צעד | פעולה מצד המשתמש           | תוצאה מצופה                                |
|---------|---------------------------|--------------------------------------------|
| 1       | לוחץ על תא ריק בלוח/קלנדר | נפתח פופ־אפ "יצירת טיפול" (Spa Order Form) |
| 2       | ממלא פרטי הלקוח (שם, טל') | הטופס מציג שדות בהתאם לשדות שנבחרו         |
| 3       | בוחר סוג טיפול/משך       | הטופס בודק/מסנן טיפולים אפשריים           |
| 4       | בוחר מטפל, חדר, תאריך ושעה | הטופס מציג אזהרות אם יש אי־התאמה          |
| 5       | לוחץ "שמור"              | הפופ־אפ נסגר, מופיעה הזמנה בלוח            |

---

### 5.4 דוגמה לניתוח המימוש בקוד (Back-End Perspective)
נמשיך עם אותו תרחיש:

#### תיאור כללי
בעת לחיצה על כפתור "שמור" בפופ־אפ, הקוד ב-JS שולח AJAX לנתיב `ajax_spaSingle.php` עם הפרמטר `act=saveSpaSingle`. בצד השרת נבדקים:
- הרשאות גישה (אתר/מטפל).
- חפיפת שעות במידת הצורך (`spaShifts`, `orders`).
- הגדרת מחיר הטיפול בהתאם למשך וסוג טיפול.
- עדכון טבלאות (`orders`, `orderUnits`, `tfusa`).

#### טבלת צעדים (מתכנת)

| מס' צעד | לוגיקה טכנית                                                                                 | מיקום בקוד                          | מבנה ותוכן הקוד                                                      |
|---------|---------------------------------------------------------------------------------------------|-------------------------------------|----------------------------------------------------------------------|
| 1       | קריאת AJAX ל־`ajax_spaSingle.php` עם `act=saveSpaSingle`                                    | `assets/js/absolute_tfusa.js` / `2.js` | `saveSpaSingle({treatmentID,...})`                                   |
| 2       | בדיקת הרשאת משתמש ובדיקה שה־`siteID` חוקי                                                   | בתוך `ajax_spaSingle.php`           | `if (!$_CURRENT_USER->has($siteID)) throw new Exception(...)`         |
| 3       | בדיקת חפיפה מול טיפולים אחרים                                                               | `ajax_spaSingle.php`                | `SELECT COUNT(*) FROM orders WHERE ... AND timeOverlaps...`           |
| 4       | עדכון/הוספה בטבלת `orders` + `orderUnits`                                                  | `ajax_spaSingle.php`                | `udb::insert('orders', [...])` + `udb::insert('orderUnits', [...])`   |
| 5       | החזרת `success` לצורך עדכון התצוגה בלקוח                                                   | `ajax_spaSingle.php`                | `echo json_encode(['success'=>'...'])`                                |

> **הערה**: טבלת הצעדים והקוד להמחשה בלבד; הקוד בפועל כולל פונקציות נוספות ומחלקות (למשל `TfusaSpa`, `OrderSpaMain`).

---

# 6. מסמך שימוש (מדריך למשתמש)
*(כתיבה בגוף שני למשתמש הקצה)*

1. **כניסה ללוח השנה**
    - גשו לכתובת/דף `absolute_calendar.php`. תוכלו לבחור תצוגה (יומית/שבועית/חודשית) בעזרת הכפתורים בראש העמוד.

2. **מעבר בין משמרות / מטפלים / חדרים**
    - למעלה תוכלו לראות מתגי "לפי מטפלים / לפי חדרים / משמרות". בחרו בהתאם לצורך.

3. **שינוי תאריך**
    - השתמשו בחיצים (חודש קודם/הבא, יום קודם/הבא וכו') או בשדה התאריך (Datepicker) לבחירה מהירה.

4. **הוספת טיפול ספא**
    - הקליקו במקום פנוי ביום/שעה רצויה.
    - מלאו את פרטי המטופל, בחרו סוג טיפול, מטפל, חדר ושעת התחלה.
    - לחצו "שמור" לסיום. האזור ביומן יתמלא בהזמנה החדשה.

5. **עריכת טיפול קיים**
    - הקליקו על הטיפול הקיים, או גררו אותו למיקום אחר (אם מאופשר Drag & Drop).
    - עדכנו את הפרטים הרלוונטיים (מטפל/שעה) ושמרו.

6. **ניהול משמרות (Shift)**
    - לחצו על "ערוך שבוע" או "ערוך משמרת" ליד שם המטפל.
    - ייפתח חלון עם פירוט שעות המשמרת / ההפסקות.
    - הוסיפו/מחקו טווחי שעות כרצונכם ולחצו "שמור".

7. **הערות יומיות**
    - בלוח הראשי, לחצו על כפתור "הערות" (אם מופיע בצורת אייקון), מלאו את הטקסט ושמרו.
    - ההערה תוצג בבועת סיכום או סמל מיוחד (לפי ההגדרות).

8. **נעילת יום למטפל**
    - לחצו על האייקון "Lock" (אם קיים) ליום מסוים.
    - אם אין טיפולים באותו יום, המערכת תנעל ותסמן שהמטפל לא פנוי כלל.

---

# 7. סיכום
במערכת הקיימת מתבצעות פעולות מרובות סביב ניהול יומן ספא/משמרות: יצירת משמרות, הוספת טיפולים (הזמנות), עדכון הערות יומיות, הצגה ויזואלית גמישה (יום/שבוע/חודש), חסימת מטפלים, ועוד.  
כל התהליכים נשמרים בשרת במסדי נתונים (orders, shifts, וכד'), תוך בקרת הרשאות ותנאי התנגשות (busy/fictive).  
מבחינת משתמש הקצה, השימוש מתרכז בלוח שנה אינטראקטיבי המאפשר יצירה ועריכה של טיפולים ומשמרות באופן נוח.  
התשתית כוללת מספר קריאות AJAX (בקבצי PHP שונים) המנהלות את הלוגיקה העסקית, והקוד JavaScript מציג ומעדכן מצד ה־Front-End.

---

