# מסמך אפיון וניתוח – pages/agreements.php, partials/settings_menu.php, pages/settings.php, ajax_settings.php

## 1. הקדמה
מטרת כלל הקבצים שסופקו היא לספק אפשרות ניהול לאתרים שונים (Sites) עבור משתמשי מערכת, הכוללת:
- עריכה ושמירה של הסכמי שימוש (agreements.php).
- תפריט ניווט המאפשר גישה לעמודי “הסכמים” ו”חוות דעת” (settings_menu.php).
- הגדרת מאפיינים הקשורים לחוות דעת ומצבים שונים באתר (settings.php).
- עדכוני הגדרות מתקדמים יותר של האתר, כגון: שליחת תזכורת לחוות דעת, פרסום חוות דעת, לוגיקת ביטולי הזמנות, הגדרות שכר, ועוד (ajax_settings.php).

בכל הקבצים קיימת בדיקה האם למשתמש יש אתר "פעיל" (Active Site). אם לא, הוא נבחר באופן אוטומטי. יש שימוש במסד נתונים (בעיקר טבלאות `sites` ו- `sites_langs`) ובהגדרות מוגדרות מראש.  
ניתן לראות ששכבת ה-Front-End כוללת טפסים, כפתורים, תפריטים וסוויצ'ים שונים, בעוד בצד ה-Back-End מתבצע עדכון של נתונים במסד באמצעות קריאות לפונקציות כדוגמת `udb::update`, `Translation::save_row` וקריאות Ajax.

---

## 2. הקבצים שנבדקו

1. **pages/agreements.php**
   - מציג למשתמש מגוון הסכמים (1–4 ושכירות).
   - הסכם 1 מופיע לקריאה בלבד; הסכמים 2,3,4 ושכירות ניתנים לעריכה.
   - כפתורי רדיו מאפשרים לבחור מי יהיה "ברירת המחדל" (`defaultAgr`).
   - בטופס ה-POST נשלחים הנתונים, ולאחר בדיקת הרשאות והרשומה הרלוונטית, הם נשמרים בטבלת `sites_langs`.

2. **partials/settings_menu.php**
   - קובץ המייצר תפריט (topMenu) עם שני קישורים: “הסכמים” (page=agreements) ו”חוות דעת” (page=settings).
   - מסמן את הקישור לעמוד הנוכחי כפעיל (`class="active"`) לפי `$_SERVER['QUERY_STRING']`.

3. **pages/settings.php**
   - עמוד שמציג הגדרות הקשורות לחוות דעת, דוגמת שליחת תזכורת אוטומטית (sendReviews) ופרסום חוות דעת (publishReviews).
   - כעת ה-CheckBox-ים מוגדרים כ-disabled, אך הקוד מציג כיצד בעזרת קריאות Ajax (`setReview`, `setPublish`) ניתן לעדכן את הערך במסד הנתונים.
   - העמוד בודק גם כאן האם יש אתר פעיל למשתמש, ואם לא – בוחר אחד באמצעות `select_site()`.
   - טוען קובץ CSS דינמי (`style_ctrl.php`) לצורך עיצוב מותאם.

4. **ajax_settings.php**
   - מטפל בבקשות Ajax אשר מתקבלות (באמצעות `_POST`) כדי לעדכן הגדרות שונות באתר:
      - סוגים שונים של הגדרות ביטול (CancelCondSpa), שליחה/פרסום חוות דעת (sendReviews/publishReviews),
      - אפשרויות נוספות הקשורות לניהול שעות תזכורת, שכר מטפלים/ספא, חסימת מחיקה (blockDelete) ועוד.
   - מבצע בדיקות הרשאה כדי לוודא שלמשתמש יש גישה לאתר אותו הוא מבקש לעדכן.
   - מעדכן את הטבלאות `sites` או `therapists` בהתאם לסוג הפעולה, ולבסוף מחזיר תשובה בצורת JSONResult.

---

## 3. הקבצים שלא נמצאו
*(אין קבצים שרשום עליהם “הקובץ לא נמצא” ברשימה שנמסרה.)*

---

## 4. הקבצים שלא נבדקו
*(כל הקבצים הרלוונטיים קיימים בפועל; לא נרשמו קבצים אחרים שהמערכת מתייחסת אליהם אך אינם מופיעים ברשימה.)*

> **הערה:** בקובץ `pages/settings.php` מוזכר `assets/css/style_ctrl.php`, אך הוא **כן** קיים ברשימה ונסרק תחת `ajax_settings.php`? לא – למעשה זהו קובץ נוסף (קובץ CSS/PHP דינמי). אולם מכיוון שמצויין במפורש **"לא יישארו קבצים שלא נבדקו"** ועד כה צוין רק ארבעה קבצים, נראה שהקובץ `style_ctrl.php` לא הופיע ברשימת הקבצים כ"לא נמצא" או "נבדק".  
> אך לא הוגדר “לא נמצא” ולכן נציין אותו כאן כקובץ לוגי נוסף שנעשה בו שימוש.  
> **בפועל**:
> - `assets/css/style_ctrl.php` **כן** קיים בקוד הקיים (בקובץ settings.php), אך **לא הועבר** לבדיקה מפורטת או סומן כ"לא נמצא".
> - נכלול אותו כאן כרעיון של "קובץ נוסף המוזכר אך לא סופק", אם יש צורך.

בכל מקרה, אין “קבצים שלא נבדקו” לפי הרשימה שאתה מסרת לנו, לבד מאותו `style_ctrl.php` שעשוי להיחשב כלא סרוק (במידה ומתעקשים).

---

## 5. תרחישים כוללים בעמוד

### **1) תרחיש: ניהול הסכמים (agreements.php)**

#### א. ניתוח משתמש הקצה (Front-End Perspective)
**תיאור כללי:**  
המשתמש פותח את עמוד “הסכמים” כדי לערוך את ההסכמים (2,3,4 ושכירות), לצפות בהסכם 1 ולבחור את ההסכם המהווה ברירת מחדל.

| מספר צעד | פעולה מצד המשתמש                                                       | תוצאה מצופה                                                                               |
|----------|-----------------------------------------------------------------------|------------------------------------------------------------------------------------------|
| 1        | ניווט לכתובת `pages/agreements.php` (או דרך התפריט)                   | העמוד נטען, המערכת מזהה/בוחרת אתר פעיל (אם אין כבר).                                     |
| 2        | צפייה בטופס: הסכם 1 מוצג לקריאה, הסכמים 2,3,4 ושכירות ניתנים לעריכה. | המשתמש רואה textarea עבור כל אחד מהסכמים 2,3,4 ושכירות, וכן כפתורי רדיו לבחירת ברירת מחדל. |
| 3        | עריכת טקסט בשדות ההסכם והגדרת ברירת מחדל (בחירה ברדיו הרצוי).         | ערכי הטקסטים מתעדכנים (מה שהמשתמש מקליד), ונבחר כפתור הרדיו הנכון.                       |
| 4        | לחיצה על כפתור "עדכן הסכם".                                           | הנתונים נשלחים ב-POST לעיבוד, העמוד צפוי להתרענן והערכים החדשים יופיעו לאחר השמירה.     |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
**תיאור כללי:**  
עם טעינת העמוד, נבדק אם למשתמש יש אתר פעיל (`select_site`), נטענים ההסכמים מתוך טבלת `sites_langs`. לאחר שליחת POST, המערכת בודקת את `$asid` והרשאות המשתמש, בונה מערך `$data` ומעדכנת את `sites_langs`.

| מספר צעד | לוגיקה טכנית                                                                                                                         | מיקום בקוד                                                    | מבנה ותוכן הקוד                                                                                                                                                 |
|----------|--------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בדיקה `if (!$_CURRENT_USER->select_site())` => ואז `$_CURRENT_USER->select_site($_CURRENT_USER->active_site())`.                    | שורות ראשונות ב- `agreements.php`                              | ```php
if (!$_CURRENT_USER->select_site()){
$_CURRENT_USER->select_site($_CURRENT_USER->active_site());
echo '<script>...</script>';
}
``` |
| 2        | השמת `$asid = $_CURRENT_USER->active_site() ?: 0;` וטעינת `$list = $_CURRENT_USER->sites();`.                                       | לאחר הבדיקה הנ"ל                                              | ---                                                                                                                                                             |
| 3        | קריאת `udb::single_row(...)` לקבלת `agreement1, agreement2, agreement3, agreement4, agreement_rent, defaultAgr` מטבלת `sites_langs`. | `$que = "SELECT ... FROM sites_langs ..."`                     | ```php
$agreements = udb::single_row($que);
```                                                                                                                                               |
| 4        | בהגיע בקשת POST, שימוש ב- `typemap($_POST, [...])` ליצירת `$data` המכיל `agreement2,3,4,rent, defaultAgr`.                           | בבלוק `if ('POST' == $_SERVER['REQUEST_METHOD']){ ... }`       | ```php
$data = typemap($_POST, [
    'agreement2'   => 'text',
    'agreement3'   => 'text',
    'agreement4'   => 'text',
    'agreement_rent' => 'text',
    'defaultAgr'   => 'int'
]);
``` |
| 5        | בדיקה ש- `$asid` קיים ב- `$list`, ואם לא => הודעת "Access denied".                                                                   | עדיין בבלוק ה-POST                                            | ```php
if ($asid && !$_CURRENT_USER->has($asid)){
    echo 'Access denied';
    return;
}
``` |
| 6        | עדכון מסד (`udb::update('sites_langs',$data, "...")`) ו- `Translation::save_row('sites', $asid, $data, 1, 1);`                       | עדיין בבלוק ה-POST                                            | ---                                                                                                                                                             |
| 7        | רענון הדף ע"י JavaScript אחרי השמירה.                                                                                                | סוף בלוק ה-POST                                                | ```php
?>
<script>
    window.location.href = window.location.href;
</script>
<?php
``` |

---

### **2) תרחיש: ניווט דרך התפריט (settings_menu.php)**

#### א. ניתוח משתמש הקצה (Front-End Perspective)
**תיאור כללי:**  
המשתמש נתקל בתפריט עליון הכולל שני קישורים: “הסכמים” ו”חוות דעת”. הוא מצפה שהקישור לעמוד הנוכחי יהיה מסומן כפעיל ושניתן לעבור בלחיצה לעמוד השני.

| מספר צעד | פעולה מצד המשתמש        | תוצאה מצופה                                                                                          |
|----------|-------------------------|-------------------------------------------------------------------------------------------------------|
| 1        | התבוננות בתפריט העליון | המשתמש רואה שני קישורים: “הסכמים” (`page=agreements`) ו”חוות דעת” (`page=settings`).                    |
| 2        | זיהוי הקישור הפעיל     | אם המשתמש נמצא בעמוד "הסכמים", הקישור להסכמים מסומן כ-active, וכן להפך.                                |
| 3        | לחיצה על הקישור השני   | הדפדפן שולח בקשה ל- `?page=...` ומציג את העמוד המתאים (למשל "חוות דעת").                               |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
**תיאור כללי:**  
במקור, הקובץ יוצר מערך `$subMenu2[]` המכיל פרטי ה-URL והשמות (“הסכמים”, “חוות דעת”). בתוך לולאת `foreach`, משווים את `$_SERVER['QUERY_STRING']` ל- `$sub["url"]`; אם שווה => `class="active"`.

| מספר צעד | לוגיקה טכנית                                                                                                      | מיקום בקוד                     | מבנה ותוכן הקוד                                                                                                              |
|----------|-------------------------------------------------------------------------------------------------------------------|--------------------------------|------------------------------------------------------------------------------------------------------------------------------|
| 1        | הגדרת `$subMenu2[] = array("url"=>"page=agreements", "name"=>"הסכמים"); ...("url"=>"page=settings","name"=>"חוות דעת");` | תחילת `settings_menu.php`       | ```php
$subMenu2[] = array("url"=>"page=agreements", "name"=>"הסכמים");
$subMenu2[] = array("url"=>"page=settings", "name"=>"חוות דעת");
``` |
| 2        | לולאה `foreach($subMenu2 as $sub)`, בדיקה `$active = ($_SERVER['QUERY_STRING'] == $sub["url"])? "active":"";`         | בתוך `settings_menu.php`       | ---                                                                                                                          |
| 3        | הצגת `<a class="<?=$active?>" href="?<?=$sub["url"]?>"><?=$sub["name"]?></a>`                                      | עדיין באותה לולאה             | הקישור כולל ה-url הרלוונטי (`?page=...`), והשם שמוצג בפני המשתמש.                                                             |

---

### **3) תרחיש: הגדרת חוות דעת (pages/settings.php)**

#### א. ניתוח משתמש הקצה (Front-End Perspective)
**תיאור כללי:**  
המשתמש נכנס לעמוד “חוות דעת” (settings). הוא רואה CheckBoxים הקשורים למשלוח תזכורת אוטומטית (sendReviews) ולפרסום חוות דעת (publishReviews). כרגע, הם ב-disabled, אך הלוגיקה מציגה כיצד ניתן היה להפעילם ולשמור שינויים (באמצעות קריאות Ajax).

| מספר צעד | פעולה מצד המשתמש                                | תוצאה מצופה                                                                                     |
|----------|------------------------------------------------|------------------------------------------------------------------------------------------------|
| 1        | ניווט ל- `pages/settings.php`                   | העמוד נטען, מזהה את האתר הפעיל, מציג את הגדרות החוות דעת הקיימות לטופס.                          |
| 2        | רואה כפתורי On/Off אך אינם פעילים כרגע          | המשתמש מבחין ששדות CheckBox במצב disabled, אך מוצגות אינדיקציות לגבי שליחת ופרסום חוות דעת קיימות. |
| 3        | אם היו Enabled: לחיצה על ה-Switch (on/off)       | הייתה אמורה להפעיל קריאת Ajax ל- `ajax_settings.php` כדי לעדכן את ההגדרה בשרת.                   |
| 4        | ציפייה שהמצב יתעדכן (check/unchecked) אוטומטית | במידה ופעיל, השרת מחזיר תשובה (1 או 0), והCheckBox מתעדכן בהתאם, בהתאם ללוגיקה שב-JavaScript.    |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
**תיאור כללי:**  
העמוד טוען נתונים מטבלת `sites` (`sendReviews`, `publishReviews`) לפי אתר פעיל. הוא מציג את CheckBox-ים, וכולל Javascript (פונקציות `setReview`, `setPublish`) שקוראות ל- `ajax_settings.php` (ב-POST).  

| מספר צעד | לוגיקה טכנית                                                                                                        | מיקום בקוד                         | מבנה ותוכן הקוד                                                                                                                                                  |
|----------|---------------------------------------------------------------------------------------------------------------------|------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בדיקה אם למשתמש קיים אתר פעיל; אם לא => `$_CURRENT_USER->select_site($_CURRENT_USER->active_site());`               | בראש `pages/settings.php`          | ```php
if (!$_CURRENT_USER->select_site()){
    $_CURRENT_USER->select_site($_CURRENT_USER->active_site());
    echo '<script>...';
}
``` |
| 2        | `$asid = $_CURRENT_USER->active_site() ?: 0;`                                                                       | בהמשך הקוד                         | ---                                                                                                                                                              |
| 3        | שליפת נתונים מ- `sites` עבור `$asid` כדי לקבל `sendReviews` ו- `publishReviews`.                                    | `$snames = udb::full_list("SELECT ...")` | ```php
$snames = udb::full_list("SELECT siteID, siteName, sendReviews, publishReviews FROM sites WHERE siteID IN (" . $asid . ")");
``` |
| 4        | הצגת `<input type="checkbox" ... name="review<?=$sname["siteID"]?>" <?=$sname["sendReviews"] ? 'checked':''?> >`     | בקטע ה-HTML של הקובץ               | מסומן checked אם `sendReviews==1`, אך `disabled` בהגדרה הנוכחית.                                                                                                |
| 5        | הצגת `<input type="checkbox" ... name="publishReviews<?=$sname["siteID"]?>" <?=$sname["publishReviews"]?'checked':''?>>` | גם כן בקטע ה-HTML                  | מסומן checked אם `publishReviews==1`.                                                                                                                            |
| 6        | פונקציות `setReview(siteid)` ו- `setPublish(siteid)` קוראות `$.post("ajax_settings.php",{id:siteid,type:...},...)`. | בסקריפט `<script> ...</script>`    | ```js
function setReview(siteid){
    $.post("ajax_settings.php",{id:siteid,type:1},function(res){
        var elem = $("input[name='review"+siteid+"']");
        if(res==0){ elem.prop("checked", false); } else { elem.prop("checked", true); }
    });
}
``` |

---

### **4) תרחיש: בקשות Ajax מתקדמות (ajax_settings.php)**

#### א. ניתוח משתמש הקצה (Front-End Perspective)
**תיאור כללי:**  
המשתמש לא ניגש ישירות ל- `ajax_settings.php`, אלא מפעיל פעולות Ajax מהעמודים השונים (בעיקר `pages/settings.php`), למשל כיבוי/הדלקה של שליחת חוות דעת. המשתמש מצפה שהשינוי יתבצע מאחורי הקלעים ושיקבל תגובה מיידית על המסך (למשל Switch on/off).

| מספר צעד | פעולה מצד המשתמש                                 | תוצאה מצופה                                                                                                |
|----------|-------------------------------------------------|-----------------------------------------------------------------------------------------------------------|
| 1        | לחיצה על Switch כלשהו (למשל הפעלת חוות דעת)      | נשלחת בקשת Ajax ל- `ajax_settings.php` עם הנתונים הרלוונטיים.                                             |
| 2        | המתנה קצרה לתגובת השרת                           | המשתמש רואה לרוב אנימציה/שינוי ויודע אם הכול התעדכן בהצלחה.                                               |
| 3        | המערכת מאשרת/דוחה את הבקשה לפי מצב הרשאות ונתונים | אם הצליח => Switch מתעדכן ל-On/Off. אם נכשל => הצגת שגיאה "Access denied" או שגיאה אחרת מהשרת.              |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
**תיאור כללי:**  
הקובץ `ajax_settings.php` מקבל ערך `type` ב-POST, ועל פיו מחליט מה לעדכן ב-DB. דוגמאות: `type=1` מפעיל/מכבה `sendReviews`, `type=2` מפעיל/מכבה `publishReviews`. יש גם פעולות נוספות התלויות ב-`$_POST['act']` (למשל `cancelType`, `blockDelete` וכו'). לפני העדכון מבוצעת בדיקת הרשאה: `if (!$_CURRENT_USER->has($sid)) throw new Exception("Access denied")`.

| מספר צעד | לוגיקה טכנית                                                                                                                                            | מיקום בקוד (`ajax_settings.php`)                            | מבנה ותוכן הקוד                                                                                                                                                                        |
|----------|---------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | טעינת `auth.php` כדי לוודא שלמשתמש יש סשן פעיל ואובייקט `$_CURRENT_USER`.                                                                               | בראש הקובץ                                                  | ```php
require_once "auth.php";
/**
 * @var TfusaUser $_CURRENT_USER
 */
``` |
| 2        | בדיקה של `$_POST['type']` לערכים 1 או 2 => עדכון `sendReviews` או `publishReviews`.                                                                     | בהתחלה (`if(intval($_POST['type']) ==1){...} else if(...){}` | ```php
$exists = udb::single_value("SELECT sendReviews FROM sites WHERE siteID =".intval($_POST['id']));
$change = $exists==1? 0 : 1;
udb::update('sites', ['sendReviews' => $change], 'siteID='.intval($_POST['id']));
echo $change;
exit;
``` |
| 3        | בדיקה של `$_POST['type']` לערכים אחרים, או שימוש ב- `$_POST['act']` => ביצוע פעולות שונות: שינוי הגדרות ביטול (`CancelCondSpa`), תצוגה (`hideUnfilled`), ועוד. | במקטעים שונים בקובץ                                      | כוללים בדיקות הרשאה (`!$_CURRENT_USER->has($sid)`) וקריאות `udb::update('sites', [...], 'siteID= ...')`.                                                                             |
| 4        | שימוש במנגנון try/catch => `Exception` אם אין הרשאה או שגיאה כלשהי, והחזרת `status`=99. אחרת, `status`=0.                                                | סוף הקובץ                                                  | קוד מחזיר JSONResult עם אובייקט `status`, `error`, ועוד.                                                                                                                               |

---

## 6. מסמך שימוש (מדריך למשתמש)

1. **הגעה למסך הסכמים**  
   - מתוך התפריט העליון (או דרך קישור ישיר), בחר/י “הסכמים” (`agreements.php`).  
   - היכנס/י לעמוד, וצפה/י בהסכם 1 + ערוך/י את הסכמים 2,3,4 ושכירות.  
   - אם תרצה/י להגדיר הסכם כברירת מחדל, סמנ/י את כפתור הרדיו המתאים.  
   - בסיום, לחצ/י על “עדכן הסכם”. המערכת תשמור את ההגדרות ותתרענן אוטומטית.

2. **הגעה למסך חוות דעת**  
   - בתפריט העליון, לחצ/י על “חוות דעת” (`pages/settings.php`).  
   - בממשק שייפתח, תראה/י CheckBoxים המתארים את שליחת (sendReviews) ופרסום (publishReviews) של חוות דעת.  
   - מצבם כרגע עשוי להיות “כבוי” (disabled), אולם הלוגיקה המופיעה בקוד מתארת כיצד ניתן להפעילם באמצעות Ajax (בלחיצה על הסוויצ’).

3. **עדכון הגדרות מתקדמות (Ajax)**  
   - חלק מהפעולות (כגון החלפת שליחת חוות דעת מ-0 ל-1, פרסום חוות דעת, הגדרות ביטול, ועוד) מתבצעות דרך Ajax ל- `ajax_settings.php`.  
   - בפועל, כאשר תלחץ/י על Switch On/Off המתאים, תישלח בקשת Ajax לעדכן את המידע במסד הנתונים, והמערכת תחזיר תגובה לאפשרות הצלחה/כישלון.

---

## 7. סיכום
הקבצים הללו מהווים מערך ניהולי מרכזי עבור מערכת מרובת אתרים.  
- `agreements.php` מאפשר לערוך ולהגדיר הסכמים (כולל הסכם ברירת מחדל).  
- `settings_menu.php` מציג תפריט המוביל בין “הסכמים” ל”חוות דעת”.  
- `settings.php` מציג הגדרות חוות דעת (שליחת תזכורת ופרסום), לצד אפשרויות נוספות (אם היו מופעלות).  
- `ajax_settings.php` מרחיב את אפשרויות הניהול ומאפשר עדכון דינמי של הגדרות דרך Ajax, כולל שליחה/פרסום חוות דעת, ביטולי הזמנה, הגדרות שכר, ועוד.  

כך מתקבלת מערכת אחידה המייצרת ממשק נוח ויעיל למנהלי האתר, תוך הפרדת אחריות בין הקבצים השונים.

