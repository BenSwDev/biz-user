# 1. הקדמה
מסמך זה מתאר את ההתממשקות לשירות CardCom ב‑BizOnline ישראל, בהתאם לקבצים שנבדקו במלואם. הקבצים עוסקים באפשרות לחייב כרטיסי אשראי, ליצור חשבוניות, ולבצע פעולות נוספות דוגמת החזקת (הקפאת) סכום בכרטיס, החזר (Refund) או ביטול (Cancel), וכן ניהול טוקנים (Tokens). קיימים מספר מחלקות המרחיבות זו את זו או חולקות לוגיקה משותפת, במטרה לספק גמישות במודלי העבודה השונים של אתרי BizOnline. 

בקוד מופיעים בין היתר:
- **פונקציות SOAP ו‑cURL** לשידור בקשות אל ה‑API של CardCom.
- **פעולות הקשורות ליצירת טרנזקציה (Transaction)** לצורך תיעוד הפעולות ב‑DB.
- **תמיכה בהנפקת חשבוניות** (עם או בלי מע"מ), בהתאם להגדרות האתר/הטרמינל.
- **ממשק לתשלום ישיר באמצעות טוקן**, החזרים, הקפאת סכום ושחרורו, שליחת PDF ללקוח ועוד.

הרציונל העיקרי שעולה מקבצי הקוד הוא לאפשר גמישות מרבית בהתממשקות ל‑CardCom, החל מעבודה עם טרמינלים שונים ועד הגדרות התנהגות (כמו הצגת ממשק תשלום ללקוח, הקפצת מסך הזדהות, הפקת חשבוניות, יצירת/מחיקת טוקנים וכו').

---

# 2. הקבצים שנבדקו
1. **cms/classes/class.CardCom.php**  
   - מחלקה `CardCom` היורשת, לכאורה, ממחלקה `Terminal` (שאינה בקבצים שסופקו).  
   - הקובץ כולל הגדרות קבועות (URL של WSDL, API וכדומה), משתנים מוגנים (כגון username, terminal, cancelPwd) ומתודות לביצוע חיובים (send, send_post, send_api), יצירת פרופיל תשלום (initFramePay), חיוב ישיר (directPay), החזר (directRefund), בדיקת כרטיס (initFrameCardTest) ועוד.  
   - מתבסס על `SoapClient` עבור חלק מהקריאות, ועל `cURL` עבור קריאות HTTP/HTTPS אחרות.

2. **cms/classes/class.CardComBiz.php**  
   - מחלקה `CardComBiz` יורשת מ‑`CardCom`.  
   - מרחיבה את מפתחות התשלום האפשריים (`$_customPayTypeMap`) כדי לתמוך בצורות תשלום נוספות (העברה בנקאית, אפליקציית BIT, וכדומה).  
   - בקונסטרקטור שלה, היא טוענת נתונים (באמצעות `udb::single_row`) עבור אתר מסוים (`siteID`) ומגדירה משתנים הקשורים ליכולות החיוב, הפקת חשבוניות, הגדרת מע"מ, מחלקות וכדומה.

3. **cms/classes/class.CardComGeneral.php**  
   - מחלקה `CardComGeneral` שמרחיבה/משתמשת ב‑`CardCom`.  
   - מיועדת לקבל הגדרות שונות מ‑DB (`sites_terminals`) עבור אתר (siteID) ו‑target מסוימים, ולפי זה להפעיל את הלוגיקה של CardCom (מספר מסוף, מפתחות, סיסמה וכו').  
   - מגדירה URLs של הצלחה/כישלון/notify בהתאם ל‑urlBase שמכוון ל‑`api/cardcom/`.

4. **cms/classes/class.CardComOut.php**  
   - מחלקה `CardComOut` היורשת מ‑`CardComBiz`.  
   - מטרתה לטעון נתוני טרמינל ולהגדיר נתיבי הצלחה/כישלון בהתבסס על API ספציפי (למשל `cardcom_result.php`, `cardcom_notify_...php`).  
   - מבצעת בדיקות לקיומם של קבצי התוצאה (successURL) וההתראה (notifyURL).  

5. **api/spaplus/cardcom_notify_sHcEjvz.php**  
   - סקריפט (notify) שאמור לטפל בקריאות חוזרות (Callback) של CardCom, כאשר מתקבלת התראה על השלמת עסקה.  
   - נטען קוד (למשל `functions.php` ו‑`Transaction::getByExId`) כדי לשחזר טרנזקציה, ובמידת הצורך מפעיל את המחלקה `CardComOut` לצורך השלמה או עדכון פרטי ההזמנה במסד הנתונים.  
   - מבצע פעולות נוספות כמו שליחת מייל, עדכון סטטוס ההזמנה, והפקת הודעת SMS באמצעות `Maskyoo::sms`.  

6. **api/spaplus/cardcom_result.php**  
   - סקריפט המוצג לאחר שחוזרים מעמוד התשלום (Redirect).  
   - טוען את ה‑Transaction לפי `lowprofilecode`.  
   - מציג למשתמש הודעת המתנה (או שגיאה אם לא נמצא).  
   - באמצעות AJAX הוא שולח בקשות ל‑`ajax_get_result.php` (שאינו בקבצים) כדי לקבל עדכון על הסטטוס בפועל.  
   - בסיום, קורא `window.parent.postMessage({source: "bizPay", event: "payComplete"}, '*');` להעברת מידע לדף שהטמיע את התשלום ב‑iframe, לדוגמה.

---

# 3. הקבצים שלא נמצאו
*אין קבצים שסומנו במפורש כ"לא נמצאו" ברשימה שלך.*  

---

# 4. הקבצים שלא נבדקו
להלן רשימת קבצים/תלויות המוזכרים בקוד, אך אינם מופיעים ברשימת הקבצים שסופקו ולכן לא נסרקו בפועל:

1. **Terminal** – הבסיס שממנו `class.CardCom` יורשת.  
2. **Transaction** – משמש לניהול הרשומות של הפעולות, יצירה/עדכון.  
3. **udb** – משמש לפעולות DB (כגון `udb::single_row`, `udb::query`, `udb::update`).  
4. **SoapClient** – ספריית PHP מובנית, אך הקוד מסתמך עליה בהרחבה.  
5. **Maskyoo::sms** – קריאה לשירות שליחת הודעות SMS.  
6. **functions.php** – מוזכר ב‑`cardcom_notify_sHcEjvz.php` (include_once).  
7. **sendgrid/sendgrid-php.php**, `send_new_api_order_details()`, `send_order_details()` – מוזכרים/נמצאים בקוד.  
8. **ajax_get_result.php** – הסקריפט שאליו `cardcom_result.php` שולח בקשת AJAX.  

---

# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

## מטרה
לספק ניתוח מלא של הלוגיקה והמימוש הנוגעים להתממשקות עם CardCom: החל משליחת בקשות דרך SOAP/HTTP, דרך יצירת עסקאות והנפקת חשבוניות, ועד קליטת תשובות והתראות והצגתן למשתמש הקצה.

### 5.1 זיהוי כל תרחישי השימוש
1. **יוזמת תשלום/פתיחת עסקה (Frame Pay / Direct Pay / Freeze וכו')**  
2. **החזר תשלום או ביטול עסקה**  
3. **בדיקת כרטיס (CardCheck)**  
4. **קבלת התראה מ-CardCom והשלמת עסקה**  
5. **הצגת תוצאות תשלום למשתמש (Redirect Result)**  
6. **שליחת Printout / יצירת חשבוניות נוספות** (type __cancel, etc.)

---

### 5.2 מבנה הניתוח של כל תרחיש שימוש
1. **תיאור משתמש הקצה** (Front-End / User Perspective)  
2. **תיאור המימוש בקוד** (Back-End / Developer Perspective)

---

### 5.3 ניתוח משתמש הקצה (Front-End Perspective)

#### תרחיש 1: יוזמת תשלום/פתיחת עסקה
**תיאור כללי**  
המשתמש מבקש לבצע תשלום באתר (למשל, מקיש על "שלם"), ויכול לעשות זאת בכמה דרכים: Frame Pay (עמוד תשלום נפרד), Direct Pay (חיוב באמצעות טוקן) או Freeze (הקפאת סכום). המשתמש מצפה שייפתח חלון תשלום או שיופיע ממשק דרכו יזין פרטי כרטיס אשראי.

| מספר צעד | פעולה מצד המשתמש                                | תוצאה מצופה                                                   |
|----------|------------------------------------------------|---------------------------------------------------------------|
| 1        | בוחר להזין פרטי תשלום/ללחוץ על כפתור "תשלום"   | המערכת מעבירה אותו למסך תשלום (Frame Pay) או מחייבת ישירות (Direct Pay) |
| 2        | מזין פרטי כרטיס / מאשר תשלום                   | המערכת שולחת נתונים ל‑CardCom ויוצרת טרנזקציה                |

#### תרחיש 2: החזר תשלום או ביטול עסקה
**תיאור כללי**  
המשתמש או מנהל האתר מעוניין לבצע החזר (Refund) או ביטול עסקה (Cancel) שכבר בוצעה. על פי הצורך, המערכת תחזיר ללקוח את הכסף (Refund) או תבטל את העסקה בטרם החיוב (Cancel).  

| מספר צעד | פעולה מצד המשתמש                  | תוצאה מצופה                                                  |
|----------|----------------------------------|--------------------------------------------------------------|
| 1        | בוחר באפשרות "החזר" או "ביטול"    | המערכת פונה ל‑CardCom ומעדכנת את הסטטוס                      |
| 2        | מקבל אישור/שגיאה בהתאם לתשובת CardCom | המשתמש/מנהל האתר רואה האם הפעולה בוצעה בהצלחה או לא          |

#### תרחיש 3: בדיקת כרטיס (CardCheck)
**תיאור כללי**  
לעיתים יש צורך לבדוק שפרטי הכרטיס תקינים (ולא בהכרח לחייב). המשתמש יזין כרטיס בממשק נפרד, והמערכת תשמור טוקן או תאמת את הכרטיס מול CardCom.

| מספר צעד | פעולה מצד המשתמש                        | תוצאה מצופה                                                         |
|----------|------------------------------------------|---------------------------------------------------------------------|
| 1        | לוחץ על "בדיקת כרטיס" או פעולה דומה      | נפתח מסך שבו המשתמש מזין פרטי כרטיס                                 |
| 2        | מקבל חיווי שהכרטיס תקין (או הודעת שגיאה)  | המערכת שומרת טוקן, או מחליטה האם להמשיך עם החיוב                    |

#### תרחיש 4: קבלת התראה מ-CardCom והשלמת עסקה
**תיאור כללי**  
לאחר שהמשתמש השלים את התשלום, CardCom מחזירה התראה (Notify) א-סינכרונית עם פרטי העסקה הסופיים. המערכת מעבדת את המידע, מעדכנת DB, שולחת מיילים/SMS למנהל האתר או ללקוח, וכו'.

| מספר צעד | פעולה מצד המשתמש                    | תוצאה מצופה                                                    |
|----------|------------------------------------|----------------------------------------------------------------|
| 1        | (לא קיים שימוש יזום בממשק במקרה זה) | CardCom מבצעת קריאת Callback/Notify לכתובת מוגדרת מראש         |
| 2        | מנהל האתר / המשתמש מקבל הודעה       | הסטטוס מתעדכן, הזמנה עוברת למצב "הושלם", מפיקים חשבונית וכו'   |

#### תרחיש 5: הצגת תוצאות תשלום למשתמש (Redirect Result)
**תיאור כללי**  
לאחר שהמשתמש חוזר מ‑CardCom (Redirect), מוצג דף `cardcom_result.php` שמעדכן את המשתמש בהתקדמות/סיום הפעולה.

| מספר צעד | פעולה מצד המשתמש                                 | תוצאה מצופה                                   |
|----------|-------------------------------------------------|-----------------------------------------------|
| 1        | המשתמש חוזר לדף מערכת (Redirect)                | רואה מסך "נא המתן..."                         |
| 2        | המערכת מבצעת AJAX ל‑`ajax_get_result.php`        | מציגה הודעת הצלחה / כישלון בהתאם לסטטוס ב‑DB   |

#### תרחיש 6: שליחת Printout / יצירת חשבוניות נוספות
**תיאור כללי**  
המנהל יכול לשלוח חשבוניות ידניות/נוספות (למשל, על תשלום במזומן או המחאה) או להוציא חשבונית זיכוי (ביטול) דרך פונקציה ייעודית כגון `sendPrintout`.

| מספר צעד | פעולה מצד המשתמש                                         | תוצאה מצופה                                  |
|----------|---------------------------------------------------------|----------------------------------------------|
| 1        | המנהל בוחר "הוצאת חשבונית" ידנית (פונקציית `sendPrintout`) | המערכת מייצרת את החשבונית ושולחת למייל הלקוח |
| 2        | המערכת שומרת את הפלט ב‑DB ומחזירה משוב                 | המנהל רואה אישור/קישור חשבונית              |

---

# 5.4 ניתוח המימוש בקוד (Back-End Perspective)

להלן דוגמאות לזרימות עיקריות מתוך הקוד:

#### תרחיש 1: יוזמת תשלום (initFramePay / directPay וכו')
| מספר צעד | לוגיקה טכנית                                                                      | מיקום בקוד (משוער)                               | מבנה ותוכן הקוד                                                                                                                                                    |
|----------|------------------------------------------------------------------------------------|---------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | יצירת אובייקט `CardCom`/`CardComBiz`/`CardComGeneral`/`CardComOut`               | קבצי המחלקות המתאימות (`__construct()`)           | ```php
$cc = new CardComBiz($siteID, $terminalID, $username, $pwd);
``` |
| 2        | קריאה לפונקציה `initFramePay($data)` או `directPay(...)`                          | class.CardCom.php, למשל בשורות ~146 (initFramePay) | יוצרת אובייקט `Transaction`, מכינה מערך פרמטרים, קוראת ל‑`send('CreateLowProfileDeal', ...)` ו/או `LowProfileChargeToken`. |
| 3        | מחזירה תשובה עם כתובת ה‑URL או תשובת חיוב                                         | המשך הפונקציה                                     | ```php
return ['transID' => $transID, 'url' => $result->url];
``` |

#### תרחיש 2: החזר תשלום או ביטול עסקה
| מספר צעד | לוגיקה טכנית                                                                    | מיקום בקוד (משוער)                                    | מבנה ותוכן הקוד                                                                                                    |
|----------|--------------------------------------------------------------------------------|--------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 1        | קריאה ל‑`payCancel($exID, $clientData, $cancelOnly = true)` או `payRefund(...)` | `class.CardCom.php` ~שורות 706–722                    | ```php
$result = $this->send_post('CancelDeal.aspx', $params, 10);
```                                                                                          |
| 2        | הפונקציה `payRefund` למעשה קוראת ל‑`payCancel` עם `$cancelOnly = false`         | `class.CardCom.php` ~שורה 728                        | ```php
return $this->payCancel($exID, $clientData, false);
```                                                                                           |

#### תרחיש 3: בדיקת כרטיס (initFrameCardTest)
| מספר צעד | לוגיקה טכנית                                                            | מיקום בקוד (משוער)                        | מבנה ותוכן הקוד                                                                                               |
|----------|------------------------------------------------------------------------|--------------------------------------------|---------------------------------------------------------------------------------------------------------------|
| 1        | יצירת טרנזקציה `Transaction::create($this->ownerID, 'frame_card_check', ...)`  | `class.CardCom.php` ~שורה 375             | ```php
$this->transaction = Transaction::create(...);
``` |
| 2        | הגדרת פרמטרים (Operation=CreateTokenOnly/SuspendDealOnly וכדומה)       | המשך הפונקציה `initFrameCardTest()`        | ```php
$params = [
  'Operation' => ...
];
```                         |

#### תרחיש 4: קבלת התראה (Notify)
| מספר צעד | לוגיקה טכנית                                                                        | מיקום בקוד                           | מבנה ותוכן הקוד                                                                                              |
|----------|--------------------------------------------------------------------------------------|---------------------------------------|----------------------------------------------------------------------------------------------------------------|
| 1        | CardCom קוראת ל‑URL המוגדר (למשל `cardcom_notify_sHcEjvz.php`) עם `lowprofilecode`   | `api/spaplus/cardcom_notify_sHcEjvz.php` | ```php
$code = preg_replace('/[^a-z0-9-]+/i', '', $_GET['lowprofilecode']);
```    |
| 2        | איתור ה‑Transaction לפי ה‑code, קריאה ל‑`completeFrameTransaction($_GET)`            | המשך הקובץ notify                     | ```php
$terminal = new CardComOut(...);
$result = $terminal->completeFrameTransaction($_GET);
```       |

#### תרחיש 5: הצגת תוצאות תשלום למשתמש (Redirect Result)
| מספר צעד | לוגיקה טכנית                                                                         | מיקום בקוד                        | מבנה ותוכן הקוד                                                                                                                     |
|----------|---------------------------------------------------------------------------------------|------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------|
| 1        | `cardcom_result.php` טוען את ה‑Transaction לפי `lowprofilecode`                       | `api/spaplus/cardcom_result.php`   | ```php
$transaction = Transaction::getByExId($code);
```                                                                                                                      |
| 2        | מציג הודעה למשתמש (HTML) וממתין לתשובה מ‑AJAX (`ajax_get_result.php`)                 | המשך הסקריפט                      | מפעיל `setInterval` כל 2 שניות, בודק את סטטוס הטרנזקציה, ובסיום מציג הצלחה/כישלון או הודעת fallback אם לא התקבל עדכון.              |

#### תרחיש 6: שליחת Printout / יצירת חשבוניות נוספות
| מספר צעד | לוגיקה טכנית                                                              | מיקום בקוד (משוער)             | מבנה ותוכן הקוד                                                                                      |
|----------|--------------------------------------------------------------------------|---------------------------------|--------------------------------------------------------------------------------------------------------|
| 1        | קריאה ל‑`sendPrintout($type, $sum, $desc, $clientData, $_rel, $docType)` | `class.CardCom.php` ~שורה 755   | ```php
$result = $this->send_post('CreateInvoice.aspx', $params, 20);
``` |
| 2        | בניית פרמטרים וסוג התשלום (cash, check, ccard, או __cancel)              | בתוך הפונקציה                   | מתאים את הפרמטרים לפי `$type` ומבצע POST לכתובת `'CreateInvoice.aspx'`.                              |

---

# 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך קצר כיצד לשלב התממשקות ל‑CardCom בביז אונליין:

1. **ייבוא המחלקות**  
   - ודא שהקבצים `class.CardCom.php`, `class.CardComBiz.php` (או `class.CardComGeneral.php`, `class.CardComOut.php`) זמינים ומוטמעים במערכת.  
   - יש לוודא שהמחלקה `Terminal` (הבסיס) והמחלקה `Transaction` מוטמעות במערכת, וכן שיהיה חיבור תקין ל‑DB באמצעות `udb`.  

2. **הגדרת הטרמינל**  
   - לכל אתר (siteID) ניתן להגדיר מסוף (terminal) ושדות כמו `masof_number`, `masof_key` וכו'.  
   - מחלקות כמו `CardComBiz` ו‑`CardComOut` נשענות על נתונים מה‑DB (טבלאות `sites` או `sites_terminals`) כדי לקבוע פרמטרים כגון מע"מ, אפשרות חיוב (has_cc_charge), והגדרת URL ל‑success/fail/notify.

3. **פתיחת עסקה (Frame Pay לדוגמה)**  
   ```php
   $cc = new CardComBiz($siteID, $terminal, $user, $pwd);
   $info = $cc->initFramePay([
       'sum'         => 100,
       'description' => 'Payment example',
       'customerName'=> 'Yossi Israeli',
       'phone'       => '0501234567',
       'email'       => 'yossi@example.com',
       'orderID'     => 123,
       // ...
   ]);
   // $info['url'] מכיל את הלינק לעמוד התשלום
   // $info['transID'] מכיל את מזהה הטרנזקציה
   ```

4. **חיוב ישיר (Direct Pay)**  
   אם כבר קיים טוקן (כרטיס שמור), ניתן לבצע חיוב ישיר:
   ```php
   $tokenData = [
       'token' => 'XXXXXXXXXXXXXXX',
       'exp'   => '1225',  // MMYY
       // ...
   ];
   $res = $cc->directPay(250, 'Membership Fee', $tokenData);
   // $res['success'] יכיל True/False
   ```

5. **החזר תשלום או ביטול עסקה**  
   - החזר:  
     ```php
     $res = $cc->payRefund($exID, 100, $clientData);
     ```
   - ביטול:  
     ```php
     $res = $cc->payCancel($exID, $clientData, true);
     ```
   אם `$cancelOnly = false` בפונקציית `payCancel`, היא מתפקדת כהחזר (Refund).

6. **בדיקת כרטיס בלבד**  
   ```php
   $res = $cc->initFrameCardTest();
   // מחזיר כתובת url למסך בדיקת כרטיס בלבד
   ```

7. **קליטת התראה (Notify) ועמוד סיכום (Result)**  
   - ב‑`cardcom_notify_XXXX.php`:  
     ```php
     $terminal = new CardComOut(__DIR__, $transaction->siteID);
     $final = $terminal->completeFrameTransaction($_GET);
     // מעדכן DB, שולח התראות, מפיק חשבונית וכדומה
     ```
   - ב‑`cardcom_result.php`:  
     ```php
     $transaction = Transaction::getByExId($code);
     // מציג ללקוח הודעת המתנה ועושה polling לסטטוס בפועל
     ```

8. **הפקת חשבונית ידנית (sendPrintout)**  
   - ניתן לשלוח בקשה ליצירת חשבונית על תשלום שבוצע במזומן, או על ביטול/זיכוי:  
     ```php
     $cc->sendPrintout('cash', 200, 'תשלום מזומן', $clientData, $orderID);
     ```
   בהתאם לטבלה `$_customPayTypeMap`, יותאם סוג התשלום המתאים (check, ccard וכו').

---

# 7. סיכום
במסגרת קבצים אלו הוצגה מעטפת מקיפה לתמיכה בחיוב כרטיסי אשראי דרך CardCom. ניהול מסופים ואתרים שונים נעשה דרך מחלקות ייעודיות (CardComBiz, CardComGeneral, CardComOut), כולן יורשות מ‑`CardCom`. כל מחלקה מוסיפה/מתאימה פרמטרים ספציפיים (חשבונית, מע"מ, ביטול/הקפאה), וכך מספקת פתרון גמיש למגוון תרחישים:

- יוזמת תשלום (Frame/Direct).
- החזרים/ביטולים.
- בדיקת כרטיס ושמירת טוקן.
- הפקת חשבוניות אוטומטית או ידנית.
- עמודי Notify ו‑Result המשלימים את לוגיקת הסליקה.

המסמך לעיל מציג את תרחישי השימוש ברמת המשתמש ובצד הקוד, לצד מדריך קצר להטמעה ולשימוש.

```
(סיום המסמך)
```

---

## 2. רשימה להעתקה של הקבצים

להלן שלוש הרשימות הנדרשות, כאשר בכל רשימה מופיעים רק שמות הקבצים (שורה אחר שורה).

### 2.1 קבצים שנבדקו
```
cms/classes/class.CardCom.php
cms/classes/class.CardComBiz.php
cms/classes/class.CardComGeneral.php
cms/classes/class.CardComOut.php
api/spaplus/cardcom_notify_sHcEjvz.php
api/spaplus/cardcom_result.php
```

### 2.2 קבצים שלא נמצאו
```
```
*(אין קבצים ברשימה זו)*

### 2.3 קבצים שלא נבדקו
```
Terminal
Transaction
udb
functions.php
Maskyoo
SoapClient
sendgrid/sendgrid-php.php
send_new_api_order_details
send_order_details
ajax_get_result.php
```
