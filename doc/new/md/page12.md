# אפיון וניתוח מערכת Calendar

## 1. הקדמה
בקבצים שסופקו ונבדקו (מפורטים בהמשך), ישנה מערכת יומן (Calendar) לניהול והצגת הזמנות (orders) ביחידות שונות (rooms/units). הקבצים מכילים קוד PHP ו-JavaScript המיישם לוגיקה להצגת ההזמנות במגוון תצוגות (רשימה, חודשית, יומית), אפשרות לבחירת יחידות להצגה, והוספת הזמנות חדשות – הן ברמה יומית או עבור יום שלם (allDay). בנוסף, ישנו קובץ CSS המגדיר סגנונות שונים עבור הממשק.

הלוגיקה הכללית:
- **`pages/calendar_ver2.php`** – בונה את המבנה והאלמנטים של עמוד היומן (תאריכים, כפתורי מעבר בין חודשים, רשימת יחידות, ועוד).
- **`assets/js/tfusa2.js`** – אחראי על יצירת האובייקטים המייצגים הזמנות (orders) והצבתם ב-DOM. כולל פונקציות להוספה, בדיקת זמינות וכדומה (בחלקן דורשות קריאת AJAX).
- **`ajax_order.php`** – בצד השרת, מטפל בקריאות AJAX שנשלחות מהצד הלקוח, ובפרט בהוספת הזמנות allDay (או בדיקת התנגשויות).
- **`assets/css/tfusa_ver2.css`** – הגדרות עיצוב (CSS) לתצוגת היומן והאלמנטים השונים בעמוד.

## 2. הקבצים שנבדקו

1. **pages/calendar_ver2.php**
    - כולל קוד PHP הקובע את מבנה עמוד היומן:
        - בדיקת פרמטרים, כגון `$_GET['monthView']` ו-`$_GET['date']`.
        - חישוב טווחי תאריכים (תאריך תחילת החודש / סופו).
        - הצגת רשימת הימים ויחידות בחלוקה לטבלאות.
        - מעבר בין סוגי תצוגות (רשימה / חודש / יום).
        - כפתורים לעבור לחודש הבא או הקודם.
        - חלונית בחירת יחידות (popup) לסינון יחידות להצגה.
        - טעינה של קובץ הסקריפט `assets/js/tfusa2.js`.

2. **assets/js/tfusa2.js**
    - קובץ JavaScript המכיל מספר מחלקות/פונקציות לטיפול בהזמנות ובהצגתן:
        - `addDayOrder`, `addMonthOrder`, `addMonthViewOrder` – אובייקטים הבונים את רכיבי ההזמנה ב-DOM על בסיס התאריך, שעת התחלה, שעת סיום, סטטוס (approved), ועוד.
        - מנגנון AJAX אל `ajax_order.php` (למשל `$.post('ajax_order.php', data, ...)`) לצורך שמירת הזמנות ובדיקת תפוסה.
        - האזנה לאירועי גלילה ומגע (touchmove) לצורך טיפול בתצוגת הטבלה.
        - לוגיקה לחישוב אחוז הרוחב או המיקום המתאים של ההזמנה בתצוגה, בהתאם לשעות התחלה/סיום.

3. **ajax_order.php**
    - קובץ PHP המטפל בבקשות AJAX (POST).
    - כאשר מתקבלת בקשה להוספת הזמנה מסוג `allDay`, מתבצע:
        - שליפת שעות checkIn/checkOut מאתר מסוים (siteID) ובדיקת הרשאות המשתמש (באמצעות `$_CURRENT_USER->has($siteID)` – לא מופיע בהרחבה כאן, רק מוזכר).
        - הוספה למסד הנתונים (`orders`, `orderUnits`, `tfusa`) והחזרת תשובה JSON בהתאם למצב (הוספה מוצלחת, ביטול הזמנה קיימת, או התנגשות).
        - פונקציית עזר `addTfusa` – מוסיפה רשומות בחתכים של 15 דקות לטבלת `tfusa`.
        - פונקציית עזר `checkAvil` – בודקת האם היחידה תפוסה בטווח המבוקש.

4. **assets/css/tfusa_ver2.css**
    - מכיל הגדרות עיצוב, בין היתר:
        - עיצוב לכפתורי מעבר בין חודשים, רשימת החודשים (select), וסידור תצוגה לטבלה.
        - עיצוב מותאם למצב ‘flipped’ (שבו הטבלה מוצגת בצורה רוחבית).
        - עיצוב למצבים שונים (רשימה / חודש / יום), כולל הגדרות רוחב וגובה, צבעים וכדומה.

## 3. הקבצים שלא נמצאו
אין קבצים שמופיעים ברשימה אך סומנו כ"לא נמצאו".

## 4. הקבצים שלא נבדקו
להלן קובץ אחד שמוזכר בקוד אך לא הופיע ברשימה כקובץ שנמסר בפועל:
1. **calendar2_ver2** – מוזכר בלינק `href="index.php?page=calendar2_ver2&date=..."` מתוך `pages/calendar_ver2.php`.

*(קבצים אחרים כמו `index.php`, `auth.php`, `functions.php` וכו’ – התבקשנו להתעלם מהם אם אינם ברשימה).*

---

## 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

### 5.1. זיהוי כל תרחישי השימוש
בהתבסס על תוכן הקבצים, ניתנים דוגמאות לתרחישים עיקריים:
1. **תרחיש A** – מעבר בין תצוגות היומן (רשימה / חודש / יום).
2. **תרחיש B** – בחירת יחידה (room) להצגה מתוך הרשימה הקופצת.
3. **תרחיש C** – הצגת ההזמנות ביומן (והתנהגותן בממשק).
4. **תרחיש D** – הוספת הזמנה חדשה (day / טווח שעות).
5. **תרחיש E** – הוספת הזמנה AllDay (באמצעות `ajax_order.php`).

#### הערה
ברמת הקוד, ייתכן שתרחישים D ו-E דומים מבחינת הממשק, אך בקוד יש לוגיקה נפרדת לטיפול ב-allDay (עם הגדרת שעות בדיקות תפוסה).

---

### 5.2. מבנה הניתוח של כל תרחיש שימוש

#### **תרחיש A**: מעבר בין תצוגות (רשימה / חודש / יום)

##### 1. תיאור משתמש הקצה (Front-End)
| מספר צעד | פעולה מצד המשתמש                                               | תוצאה מצופה                                                                                |
|----------|----------------------------------------------------------------|--------------------------------------------------------------------------------------------|
| 1        | פתיחת העמוד `calendar_ver2.php`.                               | העמוד מציג כברירת מחדל את התצוגה המתאימה לערך `monthView` (למשל “רשימה”).                  |
| 2        | בחירה בתפריט הנפתח (Select `id="monthview"`) של התצוגה הרצויה. | העמוד מבצע הפניה מחדש (reload) עם הפרמטר `monthView` מעודכן, ומוצגת תצוגת היומן בהתאם.     |
| 3        | לחיצה על כפתור “חודש קודם” או “חודש הבא”.                       | היומן נטען מחדש בהתאם לתאריך החדש (חודש קודם/חודש הבא).                                   |

##### 2. תיאור המימוש בקוד (Back-End)
| מספר צעד | לוגיקה טכנית                                                                                                                                 | מיקום בקוד             | מבנה ותוכן קוד רלוונטי                                                                                                                              |
|----------|---------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בדיקה של `$_GET['monthView']` לבחירת מבנה התצוגה (רשימה / חודש / יום).                                                                     | `calendar_ver2.php`    | `if($monthView){ ... } else { ... }`                                                                                                                |
| 2        | שדות `<select id="monthview" onchange="newload()">` מפעילים פונקציה JS `newload()`, המשנה את כתובת ה־URL כולל הפרמטרים.                     | `calendar_ver2.php` (HTML+JS) | ```js\nfunction newload(){\n  var page = ...;\n  window.location='index.php?page='+ page + '&monthView='+ $('#monthview').val() +'&date=...';\n}\n``` |
| 3        | לאחר רענון, התאריכים (טווח ימים וכו’) מחושבים מחדש (`$firstDay`, `$lastDay`), ונטענות ההזמנות בהתאם לשאילתה SELECT מול DB.                 | `calendar_ver2.php`    | `$que = "SELECT ... timeFrom <= '".$lastDay." 23:59:59' AND timeUntil >= '".$firstDay." 00:00:00' ...";`                                            |

---

#### **תרחיש B**: בחירת יחידה להצגה (Room Filter)

##### 1. תיאור משתמש הקצה (Front-End)
| מספר צעד | פעולה מצד המשתמש                                 | תוצאה מצופה                                           |
|----------|--------------------------------------------------|-------------------------------------------------------|
| 1        | לחיצה על האלמנט עם `id="showSelect"` (“כל היחידות”). | חלונית (popup) נפתחת ובה רשימה של יחידות/חדרים.       |
| 2        | בחירת יחידה או “כל היחידות”.                     | החלונית נסגרת, והיומן מסתנן להצגת היחידה/יחידות המתאימות.|

##### 2. תיאור המימוש בקוד (Back-End)
| מספר צעד | לוגיקה טכנית                                                                                                                                  | מיקום בקוד          | מבנה ותוכן קוד רלוונטי                                                                                                                     |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------|----------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בלחיצה על `#showSelect`, מופעל `$('#unitSelect').fadeIn('fast')`.                                                                            | `calendar_ver2.php` (JS) | `<div id="showSelect" onclick="$('#unitSelect').fadeIn('fast')">...</div>`                                                                 |
| 2        | בפונקציה `showunits(type,units,ttl)`, מוסתרים/מוצגים אלמנטים `.row` לפי ה־unitID (למשל `.row[data-uid="x"]`).                               | `calendar_ver2.php`  | ```js\nfunction showunits(type,units,ttl){\n  if(type=="all"){ $('.row').show(); }else{ ... }\n  $('#showSelect').html(ttl);\n}\n```      |
| 3        | הטקסט על הכפתור (id="showSelect") מתעדכן (שם היחידה או “כל היחידות”), וה־popup נסגר (`$('#unitSelect').hide();`).                             | `calendar_ver2.php`  | `$('#showSelect').html(ttl); $('#unitSelect').hide();`                                                                                     |

---

#### **תרחיש C**: הצגת ההזמנות ביומן

##### 1. תיאור משתמש הקצה (Front-End)
| מספר צעד | פעולה מצד המשתמש                                                                 | תוצאה מצופה                                                                                   |
|----------|----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------|
| 1        | כניסה לעמוד היומן (עם date / monthView מסוים).                                   | היומן מציג בלוקים/רכיבים לכל הזמנה רלוונטית (בתאריכים וביחידות המתאימים).                     |
| 2        | גלילה אופקית/אנכית בטבלה.                                                        | המשתמש רואה את הבלוקים במיקומים תואמי שעות/תאריכים (אם זו תצוגה ברשימה/חודש/יום).            |
| 3        | מעבר עכבר (או לחיצה) על ההזמנה.                                                  | עשוי להציג פרטי הזמנה (שם, טלפון, מחיר, ואינדיקציה אם מאושר).                                 |

##### 2. תיאור המימוש בקוד (Back-End)
| מספר צעד | לוגיקה טכנית                                                                                                                                                      | מיקום בקוד              | מבנה ותוכן קוד רלוונטי                                                                                                                                |
|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | בקובץ PHP מבוצע `SELECT * FROM orders ...` מול DB, וכל תוצאת הזמנה מוזרקת בקוד JS (למשל `new addMonthViewOrder({...}).init()`).                                   | `calendar_ver2.php`     | ```php\necho "orderFormMonth = (new addMonthViewOrder({\n  orderID:{$month['orderID']}, ...\n})).init();";\n```                                       |
| 2        | מחלקות JS כמו `addMonthOrder` / `addMonthViewOrder` מחשבות מיקום ורוחב (באחוזים) לפי שעות התחלה/סוף, ומייצרות `<div class="order ...">`.                          | `tfusa2.js`             | ```js\nthis._width() = ( (diff-hours) / 24) * 100;\nthis._hour() = ( (startTime-hours) / 24 ) * 100;\n```                                             |
| 3        | ה־`<div>` נטען לרכיב המתאים ב-DOM (למשל `$('.row[data-uid="'+self.roomID+'"][data-date="'+self.orderDate+'"]').append(dataui);`).                                | `tfusa2.js`             | ```js\n$('.row[data-uid="'+self.roomID+'"][data-date="'+self.orderDate+'"]').append(dataui);\n```                                                    |

---

#### **תרחיש D**: הוספת הזמנה חדשה (day / טווח שעות)

##### 1. תיאור משתמש הקצה (Front-End)
| מספר צעד | פעולה מצד המשתמש                                         | תוצאה מצופה                                                                 |
|----------|----------------------------------------------------------|-----------------------------------------------------------------------------|
| 1        | המשתמש ממלא טופס להזמנת חדר, עם תאריך התחלה וסיום ושעות. | בלחיצה על “שמירה / אשר”, ההזמנה נשלחת לשרת ונשמרת במסד.                     |
| 2        | לאחר אישור, ההזמנה מוצגת ביומן בהתאם לתאריך ושעות שהוגדרו. | הבלוק החדש מופיע באופן מידי על לוח היומן (בהתאם לסוג התצוגה שנבחר).         |

##### 2. תיאור המימוש בקוד (Back-End)
| מספר צעד | לוגיקה טכנית                                                                                        | מיקום בקוד   | מבנה ותוכן קוד רלוונטי                                                                                   |
|----------|-----------------------------------------------------------------------------------------------------|--------------|------------------------------------------------------------------------------------------------------------|
| 1        | קריאת `$.post('ajax_order.php', data, ...)` עם הפרטים (unitID, from, until...).                    | `tfusa2.js`  | ```js\nvar data = {unitID: this.roomID, from: ..., until: ...};\n$.post('ajax_order.php', data, ...);\n``` |
| 2        | בקובץ `ajax_order.php`, מתבצעת הוספה לטבלאות (orders, orderUnits, tfusa) אם אין התנגשות זמינות.  | `ajax_order.php` | `udb::insert('orders', [...]) ; udb::insert('orderUnits', [...]); addTfusa($orderID, $unitID, $timeFrom, $timeUntil);` |
| 3        | ב-JS, לאחר החזרת תשובה מוצלחת, נקראת `this.addUI()` שמוסיפה DOM-Element של ההזמנה ומרעננת התצוגה.  | `tfusa2.js`  | ```js\nif(result){ self.orderID = res.orderID; self.addUI(); }\n```                                       |

---

#### **תרחיש E**: הוספת הזמנה AllDay

##### 1. תיאור משתמש הקצה (Front-End)
| מספר צעד | פעולה מצד המשתמש                                   | תוצאה מצופה                                                                                     |
|----------|----------------------------------------------------|-------------------------------------------------------------------------------------------------|
| 1        | המשתמש בוחר “הזמנה לכל היום” בטופס (או כפתור ייעודי)| ההזמנה נשמרת כ-allDay בשרת, תוך התייחסות אוטומטית ל־checkInHour / checkOutHour (לפי האתר/היחידה).|
| 2        | לאחר השמירה, ההזמנה מופיעה ביומן כתפוסה לאורך כל היום. | היומן מציג הסטטוס “busy” או יוצר בלוק המכסה את היום כולו.                                        |

##### 2. תיאור המימוש בקוד (Back-End)
| מספר צעד | לוגיקה טכנית                                                                                                        | מיקום בקוד       | מבנה ותוכן קוד רלוונטי                                                                                                 |
|----------|---------------------------------------------------------------------------------------------------------------------|------------------|------------------------------------------------------------------------------------------------------------------------|
| 1        | בקבלת פרמטר `allDay=1`, הקוד ב־`ajax_order.php` מאתר את `checkInHour` ו־`checkOutHour` עבור ה־siteID וה־unitID.     | `ajax_order.php` | ```php\n$que = "SELECT sites.checkInHour, sites.checkOutHour,... WHERE `rooms_units`.`unitID`=...";\n$hourFrom = ...;\n``` |
| 2        | מבוצעת בדיקת תפוסה (checkAvil), ואם פנוי – נוצרות רשומות בטבלאות orders, orderUnits, tfusa.                       | `ajax_order.php` | `addTfusa($orderID, $unitID, $timeFrom, $timeUntil);`                                                                 |
| 3        | אם נמצאה תפוסה קיימת (allDay קודמת), במקרים מסוימים ההזמנה הקודמת נמחקת או מוחזרת תשובה שהחדר תפוס (`status=3`).  | `ajax_order.php` | `if($checkOcc['allDay']){ ... } else { $result['status']=3; }`                                                        |

---

## 6. מסמך שימוש (מדריך למשתמש)
1. **מעבר בין תצוגות**
    - בחלק העליון של העמוד, תראו תפריט נפתח בשם "תצוגת רשימה / תצוגה חודשית / תצוגה יומית".
    - בחרו את האפשרות הרצויה לשנות את אופן הצגת היומן.
    - לצורך מעבר בין חודשים, השתמשו בכפתורים “חודש קודם” או “חודש הבא”.

2. **סינון לפי יחידות**
    - לחצו על “כל היחידות” (או הטקסט הנוכחי) לפתיחת חלונית בחירת יחידות.
    - בחרו “כל היחידות” או יחידה ספציפית.
    - החלונית תיסגר אוטומטית, והיומן יסנן את התצוגה ליחידות שנבחרו בלבד.

3. **הצגת הזמנות**
    - בכל יום או תא ביומן תראו בלוק (div) עבור הזמנה קיימת.
    - תוכלו לראות מידע כמו שם המזמין, טלפון, מחיר וסטטוס (מאושר/לא מאושר).

4. **הוספת הזמנה חדשה (טווח שעות מוגדר)**
    - אם קיים טופס הוספת הזמנה: הזינו בו את פרטי ההזמנה (תאריך, שעת התחלה, שעת סיום, פרטי הלקוח).
    - לחצו “שמירה”.
    - לאחר אישור, ההזמנה תופיע מיידית ביומן – במיקום התואם לטווח התאריכים/השעות שהגדרתם.

5. **הוספת הזמנה “לכל היום” (AllDay)**
    - סימון או בחירת אפשרות “לכל היום”.
    - המערכת תזהה את שעות checkIn/checkOut ותוסיף את ההזמנה כך שתיתפס היחידה למשך כל היום (בצד השרת).

---

## 7. סיכום
המערכת מציגה יומן הזמנות גמיש המאפשר מעבר בין כמה תצוגות (רשימה, חודש, יום), בחירת יחידות (rooms), והצגת הזמנות על פני ציר הזמן. ישנו מנגנון הוספה של הזמנות, הכולל הן טווח שעות רגיל והן הזמנה לכל היום (allDay). הקבצים שסופקו מדגימים כיצד הצד הלקוח (JavaScript) והצד השרת (PHP) משתלבים יחד, כאשר `ajax_order.php` מטפל בבקשות להוספה ובדיקת תפוסה. קובץ ה-CSS מוסיף שכבות עיצוב לממשק.  
במסגרת הפיתוח ניתן להרחיב פונקציונליות (למשל, עריכת הזמנה לאחר יצירתה, מחיקה וכדומה) או להתאים את הממשק לצרכים נוספים, אך במתכונתו הנוכחית – המערכת מספקת מענה לניהול והצגת הזמנות בצורה יעילה וידידותית.

