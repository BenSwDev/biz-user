
# 1. הקדמה
מסמך זה מרכז את הניתוח המלא של שני הקבצים שנמצאו ונסרקו בפועל, העוסקים בניהול והתקשרות עם ממשק ה-API של WuBook (שירות חיצוני לניהול זמינות והזמנות של חדרים). שני הקבצים מכילים מחלקה בשם `WuBookManager`, אך כל אחת מהן ממומשת בצורה שונה ועושה שימוש בספריות שונות.  
המסמך מבוסס אך ורק על המידע הקיים בפועל בקבצים שנבדקו, ללא הוספת מידע ממקורות חיצוניים.

---

# 2. הקבצים שנבדקו
1. **cms/classes/class.WuBookManager.php**  
   - תוכן עיקרי:
     - הגדרת קבועים `VILLA_ID` ו-`ROOM_ID`.
     - שימוש בספריית `PhpXmlRpc` (באמצעות `include_once(__DIR__ . '/PhpXmlRpc/Autoloader.php');`).
     - מחלקה `WuBookManager` אשר מתחברת לכתובת API: `https://wired.wubook.net/xrws/`, באמצעות טוקן `wr_807d6039-6eb6-4387-a0d7-3c56d6b083fb`.
     - פונקציה `fetch_rooms()` המבצעת קריאה ל-API `fetch_rooms` ומדפיסה את התוצאה המפוענחת.
     - פונקציה `update_avail($data)` המסדרת נתוני זמינות לפי תאריכים ומבצעת קריאה ל-API `update_avail`, ולאחר מכן מדפיסה את התגובה המפוענחת.

2. **wubook/vendor/idan/wubookwrapper/src/WuBookManager.php**  
   - תוכן עיקרי:
     - הגדרת קבוע `ENDPOINT` לכתובת API: `https://wired.wubook.net/xrws/`.
     - שימוש בספריות `fXmlRpc` ו-`chillerlan\SimpleCache` (כולל מחלקות `NativeParser`, `NativeSerializer`, `FileCache` ועוד).
     - מחלקה `WuBookManager` (במרחב השמות `WubookWrapper`) המממשת גישה מודולרית ל-API של WuBook, באמצעות:
       - מתודות `auth()`, `availability()`, `reservations()` המחזירות אובייקטים ייעודיים לניהול התחברות, זמינות והזמנות (ע"י הפניות ל-`WubookWrapper\Api\WuBookAuth`, `WubookWrapper\Api\WuBookAvailability`, `WubookWrapper\Api\WuBookReservations`).
     - שימוש במערך `config` לצורך ניהול פרטי התחברות (username, password, provider_key, lcode, ועוד).
     - ניהול Cache מקומי (באמצעות `FileCache`) לצורך אחסון/שמירת טוקנים.

---

# 3. הקבצים שלא נמצאו
לא התקבל מידע על קבצים נוספים שהוגדר לגביהם במפורש “הקובץ לא נמצא”.  
לפיכך, רשימה זו ריקה.

---

# 4. הקבצים שלא נבדקו
במהלך בחינת תוכן שני הקבצים, נמצאו התייחסויות/ייבוא (import/use/include) לספריות או קבצים חיצוניים, שאינם מופיעים ברשימת הקבצים שלנו. אי-לכך, לא נבדקו בפועל:
- `cms/classes/PhpXmlRpc/Autoloader.php`
- `WubookWrapper\Api\WuBookAuth`
- `WubookWrapper\Api\WuBookAvailability`
- `WubookWrapper\Api\WuBookReservations`
- `WubookWrapper\Exceptions\WuBookException`
- ועוד קבצים פנימיים לספריות `fXmlRpc` ו-`chillerlan\SimpleCache`

(יש לשים לב שהוראה מפורשת הייתה לא לציין ברשימה זו קבצים כמו `index.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php`, `auth.php`, `functions.php`, גם אם היו אזכורים עליהם — אך בפועל לא נמצאו אזכורים כאלו בטקסט שבקבצים הנסרקים.)

---

# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

להלן תרחישי השימוש העולים מהקוד הקיים. כל תרחיש יוצג בשני חלקים:  
**(א)** חוויית משתמש הקצה (Front-End) – על אף שהקוד הוא מצד השרת, נתאר כיצד **בעל האתר או המפתח** עשוי להפעיל את הפעולות לצורך ממשק חיצוני.  
**(ב)** המימוש בקוד (Back-End) – הצצה לפונקציות המרכזיות, הקריאות ל-API והאופן שבו הנתונים מעובדים.

---

## 5.1 זיהוי כל תרחישי השימוש
1. **fetch_rooms**  
   קריאת API להחזרת רשימת חדרים (בקובץ `cms/classes/class.WuBookManager.php`).

2. **update_avail**  
   עדכון זמינות לחדרים בתאריכים מסוימים (בקובץ `cms/classes/class.WuBookManager.php`).

3. **auth**  
   מחזיר אובייקט התחברות למערכת WuBook (בקובץ `wubook/vendor/idan/wubookwrapper/src/WuBookManager.php`).

4. **availability**  
   מחזיר אובייקט לניהול זמינות (באותו קובץ, `wubook/vendor/idan/wubookwrapper/src/WuBookManager.php`).

5. **reservations**  
   מחזיר אובייקט לניהול הזמנות (באותו קובץ, `wubook/vendor/idan/wubookwrapper/src/WuBookManager.php`).

---

## 5.2 מבנה הניתוח של כל תרחיש שימוש

### 5.2.1 תרחיש: fetch_rooms

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי:**  
  מנהל המערכת (או סקריפט אוטומטי) מפעיל פעולה שתפקידה לאחזר רשימת חדרים מ-WuBook לצורכי הצגה או עיבוד פנימי.
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                  | תוצאה מצופה                                              |
|----------|-----------------------------------|----------------------------------------------------------|
| 1        | מפעיל פונקציית `fetch_rooms`      | המערכת יוצרת קריאה ל-API של WuBook ומקבלת רשימת חדרים   |
| 2        | ממתין להשלמת הפעולה               | מוצגת/מודפסת רשימה המוחזרת מה-API (למשל בפלט ה-PHP)     |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי:**  
  בפונקציה `fetch_rooms()` נבנה אובייקט `Request` באמצעות ספריית `PhpXmlRpc`, מועברים פרמטרים (טוקן + `VILLA_ID`), ולאחר מכן מתבצעת שליחת בקשה (`$this->client->send($req)`). התשובה מפוענחת ומודפסת.
- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                                                                                     | מיקום בקוד                                               | מבנה ותוכן הקוד                                                                                                   |
|----------|------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| 1        | יצירת מערך פרמטרים (token, VILLA_ID) והמרתו ל-XML RPC באמצעות `PhpXmlRpc\Encoder`                                                               | `fetch_rooms()` בשורות הראשונות                          | `$myStruct = (new Encoder())->encode([...])`                                                                      |
| 2        | בניית אובייקט `Request` עם שם הפעולה `fetch_rooms` ופרמטרים                                                                                     | `fetch_rooms()`                                          | `$req = new PhpXmlRpc\Request('fetch_rooms', $myStruct);`                                                         |
| 3        | שליחת הבקשה ל-API דרך `$this->client->send($req)`                                                                                              | `fetch_rooms()`                                          | `$result = $this->client->send($req);`                                                                            |
| 4        | פענוח התוצאה באמצעות `Encoder()->decode($result->value())` והצגתה (print_r)                                                                     | `fetch_rooms()`                                          | `$decoded = (new Encoder())->decode($result->value()); print_r($decoded);`                                        |

---

### 5.2.2 תרחיש: update_avail

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי:**  
  מנהל המערכת מעדכן זמינות לחדר (למשל מספר ימים פנויים) בתאריכים מסוימים, כדי שיתעדכן בו-זמנית במערכת WuBook.
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                        | תוצאה מצופה                                                                     |
|----------|-----------------------------------------|---------------------------------------------------------------------------------|
| 1        | מזין או מעביר מערך נתונים (תאריכים -> זמינות) | המערכת תקבל את המידע ותבנה בקשה מתאימה ל-API של WuBook                           |
| 2        | מפעיל פונקציית `update_avail($data)`    | זמינות הימים מעודכנת ב-WuBook, והפלט מודפס על המסך (או נשלח להמשך עיבוד)         |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי:**  
  בפונקציה `update_avail($data)` מסדרים את המערך `$data` לפי סדר תאריכים, מכינים מבנה נתונים חדש, ומזינים אותו לקריאה בשם `update_avail`. מקפידים לבחור בתאריך המוקדם ביותר כמפתח התחלתי.
- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                                                                     | מיקום בקוד                                | מבנה ותוכן הקוד                                                                                          |
|----------|---------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|----------------------------------------------------------------------------------------------------------|
| 1        | מיון המערך `$data` לפי מפתח התאריכים (ksort)                                                                                   | `update_avail()` בראש הפונקציה            | `ksort($data, SORT_STRING);`                                                                             |
| 2        | בניית מערך `$avails` שבו כל תאריך מיוצג כ-`['avail' => intval($avail)]`                                                          | `update_avail()`                           | `foreach($data as $date => $avail) { $avails[] = ['avail' => intval($avail)]; }`                          |
| 3        | לקיחת התאריך הקטן ביותר (min(array_keys($data))) ושמירתו כנקודת התחלה                                                            | `update_avail()`                           | `$date = min(array_keys($data));`                                                                        |
| 4        | יצירת `Request` ל-`update_avail` ב-XML RPC, כולל `API_TOKEN`, `VILLA_ID`, תאריך התחלה ומערך ימי זמינות לחדר מזהה ROOM_ID         | `update_avail()`                           | `$myStruct = (new Encoder())->encode([...])` <br/> `$req = new Request('update_avail', $myStruct);`       |
| 5        | שליחת הבקשה (`$this->client->send($req)`) ופענוח התשובה (`Encoder()->decode(...)`) והצגתה                                       | `update_avail()`                           | `$decoded = (new Encoder())->decode($result->value()); print_r($decoded);`                                |

---

### 5.2.3 תרחיש: auth

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי:**  
  המפתח יוצר אובייקט `WuBookManager` (במרחב השמות `WubookWrapper`) ומבקש לבצע הליך התחברות (לדוגמה, לטובת קבלת טוקן או גישה להמשך פעולות).
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                               | תוצאה מצופה                                               |
|----------|------------------------------------------------|-----------------------------------------------------------|
| 1        | קורא למתודה `auth()` על אובייקט WuBookManager   | נוצר אובייקט `WuBookAuth` חדש, המבצע תהליך התחברות (לפי הצורך)  |
| 2        | מקבל אובייקט התחברות לחזרה                     | המפתח יכול להשתמש באובייקט לצרכי פעולות Auth בהמשך        |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי:**  
  פונקציית `auth()` מחזירה אובייקט מסוג `WuBookAuth`. ביצירת האובייקט מפעילים את ה-`Client` של `fXmlRpc` ומעבירים לו קונפיגורציה, וכן מנגנון Cache.
- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                                                 | מיקום בקוד                          | מבנה ותוכן הקוד                                                                 |
|----------|-------------------------------------------------------------------------------------------------------------|--------------------------------------|---------------------------------------------------------------------------------|
| 1        | יצירת אובייקט `Client` של `fXmlRpc` עם `ENDPOINT`                                                           | `auth()` בתוך `WuBookManager`        | `$client = new Client(self::ENDPOINT, null, new NativeParser(), new NativeSerializer());` |
| 2        | אתחול אובייקט `WuBookAuth` עם פרטי `config`, Cache ו-Client                                                 | `auth()`                              | `return new WuBookAuth($this->config, $this->cache, $client);`                 |

---

### 5.2.4 תרחיש: availability

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי:**  
  לאחר התחברות, המפתח עשוי לבקש לטפל בפעולות זמינות (למשל, בדיקת זמינות, עדכון זמינות, וכדומה), ולכן קורא למתודה `availability()`.
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                                  | תוצאה מצופה                                                                          |
|----------|---------------------------------------------------|--------------------------------------------------------------------------------------|
| 1        | קורא למתודה `availability($token)` באובייקט WuBookManager | מחזיר אובייקט המספק יכולות ניהול זמינות (`WuBookAvailability`)                       |
| 2        | משתמש באובייקט שהוחזר לביצוע פעולות זמינות נוספות | תלויות בשאר הפונקציות במחלקה (למשל, `fetch_rooms`, עדכונים וכו', אך בקונטקסט ה-API)  |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי:**  
  פונקציית `availability($token)` יוצרת אובייקט `Client` של `fXmlRpc` ומחזירה מופע של `WuBookAvailability`, המוכן לפעולות API (כגון עדכוני זמינות או שאילתות).
- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                              | מיקום בקוד                                      | מבנה ותוכן הקוד                                                                                                 |
|----------|------------------------------------------------------------------------------------------|--------------------------------------------------|-----------------------------------------------------------------------------------------------------------------|
| 1        | יצירת אובייקט `Client` חדש עם `ENDPOINT`                                                 | `availability()`                                 | `$client = new Client(self::ENDPOINT, null, new NativeParser(), new NativeSerializer());`                       |
| 2        | אתחול אובייקט `WuBookAvailability` עם פרטי `config`, Cache, Client והטוקן שהתקבל כפרמטר   | `availability()`                                 | `return new WuBookAvailability($this->config, $this->cache, $client, $token);`                                  |

---

### 5.2.5 תרחיש: reservations

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי:**  
  בדומה לפעולות זמינות, לעיתים יש צורך בגישה להזמנות (Reservations). לשם כך המפתח עשוי לקרוא לפונקציית `reservations($token)`.
- **טבלת צעדי התרחיש מצד המשתמש:**

| מספר צעד | פעולה מצד המשתמש                                       | תוצאה מצופה                                                                       |
|----------|--------------------------------------------------------|-----------------------------------------------------------------------------------|
| 1        | מפעיל `reservations($token)` על אובייקט WuBookManager   | מתקבל אובייקט לטיפול בהזמנות, `WuBookReservations`                               |
| 2        | משתמש באובייקט לצורך ביצוע פעולות הקשורות להזמנות      | תלוי בפונקציות המוגדרות במחלקה (שאינן מופיעות בקובץ שנסרק במלואו)                 |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי:**  
  פונקציית `reservations($token)` יוצרת אובייקט `Client` חדש ומחזירה מופע של `WuBookReservations`, לניהול פעולות הקשורות להזמנות (כגון יצירת הזמנה או קריאת הזמנות).
- **טבלת צעדי התרחיש מצד המתכנת:**

| מספר צעד | לוגיקה טכנית                                                                             | מיקום בקוד                                       | מבנה ותוכן הקוד                                                                                                  |
|----------|-----------------------------------------------------------------------------------------|---------------------------------------------------|------------------------------------------------------------------------------------------------------------------|
| 1        | יצירת אובייקט `Client` חדש עם `ENDPOINT`                                                | `reservations()`                                  | `$client = new Client(self::ENDPOINT, null, new NativeParser(), new NativeSerializer());`                        |
| 2        | אתחול אובייקט `WuBookReservations` עם פרטי `config`, Cache, Client והטוקן שהתקבל כפרמטר  | `reservations()`                                  | `return new WuBookReservations($this->config, $this->cache, $client, $token);`                                   |

---

# 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך קצר למשתמש (או למפתח) כיצד להשתמש בפונקציות/מתודות שהוגדרו בקבצים הנסרקים:

1. **התחברות למערכת (auth)**  
   - צרו מופע של המחלקה `WuBookManager` (בנתיב `wubook/vendor/idan/wubookwrapper/src/WuBookManager.php`), והעבירו לפרמטר הבנאי (`$config`) את כל פרטי ההתחברות הנדרשים (username, password וכו’).  
   - לאחר מכן, קראו למתודה `auth()`. היא תחזיר אובייקט המייצג את ההתחברות. שמרו אותו להמשך פעולות.

2. **פעולות זמינות (availability)**  
   - לאחר שמתקבל טוקן התחברות (או במקביל), ניתן לקרוא למתודה `availability($token)`. כך מקבלים אובייקט המאפשר לבצע פעולות הקשורות בזמינות (בדיקות, עדכונים, קריאת חדרים, וכדומה).

3. **פעולות הזמנות (reservations)**  
   - בדומה ל-availability, ניתן לקרוא למתודה `reservations($token)`, המעניקה גישה לכלי ניהול הזמנות ב-WuBook.

4. **קריאת רשימת חדרים (fetch_rooms)**  
   - בקובץ `cms/classes/class.WuBookManager.php`, קיימת מתודה `fetch_rooms()`.  
   - הפעלתה תבצע מיד קריאת API של WuBook ותחזיר (ותדפיס) את רשימת החדרים.

5. **עדכון זמינות (update_avail)**  
   - בקובץ `cms/classes/class.WuBookManager.php`, ניתן לקרוא למתודה `update_avail($data)`, כאשר `$data` הוא מערך של תאריך -> כמות זמינות.  
   - המתודה תעדכן ישירות ב-API של WuBook ותדפיס את תגובת השרת.

---

# 7. סיכום
בשני הקבצים שנבדקו ישנה התמודדות עם אותו שירות WuBook, אך בגישות שונות:
- בקובץ `cms/classes/class.WuBookManager.php` – גישה ישירה בעזרת ספריית `PhpXmlRpc`, תוך שימוש פונקציונלי ספציפי (`fetch_rooms`, `update_avail`).
- בקובץ `wubook/vendor/idan/wubookwrapper/src/WuBookManager.php` – גישה מודולרית ומתקדמת יותר בעזרת `fXmlRpc` וספריות Cache, עם חלוקה ל-API שונים (Auth, Availability, Reservations).

התרחישים המוצגים לעיל מדגימים כיצד מנהל/מפתח האתר יכול לנצל את המחלקות לצרכי התחברות, בדיקת/עדכון זמינות, וכן ניהול הזמנות.  
כל המידע והרציונל מבוססים במדויק על תוכנם של שני הקבצים שנסרקו, ללא הוספת נתונים חיצוניים.

```

---

## 2. רשימה להעתקה של הקבצים (שורה אחר שורה)

### 2.1 קבצים שנבדקו
```
cms/classes/class.WuBookManager.php
wubook/vendor/idan/wubookwrapper/src/WuBookManager.php
```

### 2.2 קבצים שלא נמצאו
```
```
*(ריק)*

### 2.3 קבצים שלא נבדקו
```
cms/classes/PhpXmlRpc/Autoloader.php
WubookWrapper\Api\WuBookAuth
WubookWrapper\Api\WuBookAvailability
WubookWrapper\Api\WuBookReservations
WubookWrapper\Exceptions\WuBookException
```
