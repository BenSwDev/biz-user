# 1. הקדמה
המערכת מורכבת מעמוד סטטיסטיקות מרכזי (`stats.php`) ושלושה קבצי “חלקי עמוד” (partials) המשמשים להצגת נתונים מפורטים לפי סוג הפעולה (וואטסאפ, מסקיו ולידים). העמוד הראשי מבצע שאילתות לבסיס הנתונים ומציג תוצאות בטבלת סיכום. כאשר המשתמש בוחר סוג פעולה מסוים (ע”י פרמטר `type` בכתובת), נטען אחד מקבצי החלקים (`whatsappstart.php`, `maskyoocall.php`, `contacts.php`) ומוצגת בו טבלה מפורטת עם פרטי הפניות/שיחות/לידים הרלוונטיים.

כל הקבצים מסתמכים על מחלקת `udb` (שאינה מסופקת כאן) לצורך הרצת שאילתות וקריאת נתונים מבסיס הנתונים. בקוד מופיעים מסננים ופרמטרים שונים (כגון טווחי תאריכים, דומיין, מחרוזת חיפוש), וכן פעולות עזר (כמו `formatPhoneNumber`, `htmlDate`) המאפשרות עיבוד ערכים והצגתם.

---

# 2. הקבצים שנבדקו
1. **pages/stats.php**
    - קובץ ראשי המציג את טופס החיפוש (סינון לפי תאריכים, דומיין, סוג פעולה) וטבלת סיכום של הנתונים הנשלפים מבסיס הנתונים.
    - קורא את הפרמטר `$_GET['type']` ובהתאם טוען קובץ חלקי (partial) להצגת רשימה מפורטת.
    - מכיל פונקציות עזר כגון `htmlDate` ו-`formatPhoneNumber`, ומתבסס על מחלקת `udb` לצורך שאילתות.
    - מבצע פילטרים שונים לפי תאריכים (כולל טיפול בתאריך התחלה, תאריך סיום, או שניהם), מזהה דומיין, ומילות חיפוש.

2. **partials/stats/whatsappstart.php**
    - קובץ חלקי (partial) המציג רשימה מפורטת של פניות וואטסאפ (מתוך הטבלה `contact_whatsapp`), כולל עמודות: מאת, טלפון, תאריך פניה, תאריך מבוקש ומספר אורחים.
    - מייצר טבלה עם מזהה (מיספור פנימי), ומסתמך על משתנים שהוגדרו ב־`stats.php` (למשל `$wherew` ו־`$adding`) כדי להרכיב את שאילתת הנתונים.
    - מכיל שדה חיפוש (JavaScript) לסינון מקומי של השורות.

3. **partials/stats/maskyoocall.php**
    - מציג טבלת שיחות מסקיו (מתוך הטבלה `maskyooCalls`), כולל עמודות: מאת (מספר מתקשר), אל (מספר יעד), זמן התחלה, זמן סיום, משך שיחה, וסטטוס שיחה.
    - כולל מיפוי ערכים (`$disposition`) כדי להציג את הסטטוס הנכון בעברית (למשל “נענה”, “לא נענה” וכו’).
    - מחשב את משך השיחה ע”י הפרש זמנים בין `start_call` ל־`end_call`.

4. **partials/stats/contacts.php**
    - קובץ חלקי להצגת לידים (טבלת `contactForm`), עם עמודות: מאת, טלפון, תאריך פניה, מייל, הודעה.
    - מייצר טבלה דומה, מסתמך על שאילתה הבנויה בקובץ הראשי (`stats.php`) לצורך הגבלת התוצאות (פילטרים בתאריכים ודומיין).
    - כולל גם כן שדה חיפוש (JavaScript) לסינון פנים-טבלאי.

---

# 3. הקבצים שלא נמצאו
לא קיימים קבצים שלא נמצאו. כל הקבצים שהוזכרו ברשימה אכן קיימים.

---

# 4. הקבצים שלא נבדקו
לא קיימים קבצים נוספים שהקוד או המסמכים מתייחסים אליהם ולא הופיעו ברשימה. כל הקבצים שהוזכרו קיימים ונסרקו בפועל.

---

# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

להלן כל תרחישי השימוש שניתן לזהות בקוד:

## 5.1 זיהוי כל תרחישי השימוש
1. **תרחיש ראשי – כניסה לעמוד סטטיסטיקות ללא בחירת סוג פעולה**
    - העמוד `stats.php` מציג טופס סינון + טבלת סיכום ראשית.
    - לא מופיעים נתוני פירוט מ־partials (כי `$_GET['type']` ריק או שווה ל־0).

2. **תרחיש סינון והצגת פירוט "התחלת שיחת וואטסאפ" (whatsappstart)**
    - המשתמש ממלא טופס סינון כלשהו ובוחר את סוג הפעולה "whatsappstart".
    - התוצאות מתקבלות בטבלה הראשית, ובנוסף נטען הקובץ `partials/stats/whatsappstart.php`.

3. **תרחיש סינון והצגת פירוט "שיחות מסקיו" (maskyoocall)**
    - המשתמש בוחר `type=maskyoocall`.
    - העמוד `stats.php` טוען את `partials/stats/maskyoocall.php` ומציג פירוט קריאות/שיחות.

4. **תרחיש סינון והצגת פירוט "לידים יצירת קשר" (contacts)**
    - המשתמש בוחר `type=contacts`.
    - העמוד `stats.php` טוען את `partials/stats/contacts.php` להצגת פירוט לידים/טופס יצירת קשר.

---

## 5.2 מבנה הניתוח של כל תרחיש שימוש

### 5.2.1 תרחיש 1 – כניסה לעמוד הסטטיסטיקות ללא בחירת סוג פעולה

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי**  
  המשתמש נכנס לעמוד `stats.php` ללא הגדרת `type` (או שהערך הוא `0`). הוא רואה טופס חיפוש (עם אפשרות לסינון לפי תאריכים, דומיין ועוד), ואז טבלה המראה כמות פעולות בכל אתר (וואטסאפ, מסקיו, יצירת קשר) אך ללא פירוט נוסף.

- **טבלת צעדי התרחיש מצד המשתמש**

| מספר צעד | פעולה מצד המשתמש                                   | תוצאה מצופה                                      |
|----------|----------------------------------------------------|--------------------------------------------------|
| 1        | ניגש לכתובת המפעילה את `stats.php` ללא פרמטרים     | הטופס והטבלה הראשית מופיעים.                     |
| 2        | מתבונן בטבלה                                      | רואה נתונים כלליים על האתרים (ללא רשימת פירוט). |
| 3        | (אופציונלי) ממלא שדות חיפוש ולוחץ "חפש"           | הטבלה הראשית מסתננת לפי הבחירות שביצע.          |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי**  
  הקוד מזהה ש-`$_GET['type']` לא קיים/ריק, ולכן אינו טוען קובץ partial. הוא מבצע שאילתות כדי למלא את הטבלה הראשית לפי תנאים שנלקחו מפרמטרים נוספים (אם סופקו).

- **טבלת צעדי התרחיש מצד המתכנת**

| מספר צעד | לוגיקה טכנית                                                                                                                                                     | מיקום בקוד                   | מבנה ותוכן הקוד                                                           |
|----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|----------------------------------------------------------------------------|
| 1        | בודק את ערכי `$_GET` (`createDate`, `createDateTo`, `domainID`, וכו’) לצורך בניית המשפטים `$where`, `$wheret`, `$wherec`, `$wherew`, `$wherem`.                  | ראש הקובץ `stats.php`        | `if($_GET['createDate']) { ... } else { ... }` וכו’.                       |
| 2        | מפעיל שאילתות לבסיס הנתונים עבור הטבלה הראשית (למשל `SELECT distinct(...) FROM sites_domains ...`).                                                               | אמצע הקובץ `stats.php`       | `udb::full_list(...)` מחזיר מערך נתונים ואיתו יוצרים שורות לטבלה.         |
| 3        | בודק אם `$_GET['type']` קיים. כיוון שאין ערך (או `0`), לא מבצע `require` של קובץ partial.                                                                         | ממש לפני `if($_GET['type'])` | `if($_GET['type']) { require ... }`.                                       |
| 4        | מציג טבלת סיכום ב־HTML (כולל הלולאה על `$sites`).                                                                                                                | סיום הקובץ `stats.php`       | מכיל `<table class="stats-table">...</table>`.                             |

---

### 5.2.2 תרחיש 2 – סינון והצגת פירוט “התחלת שיחת וואטסאפ”

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי**  
  המשתמש בוחר ב”סוג המידע” את "התחלת שיחת וואטסאפ" (ערך `whatsappstart`), ממלא תאריכים (אופציונלי) ולוחץ "חפש". בעמוד נטענת טבלה ראשית + טבלה מפורטת של פניות וואטסאפ.

- **טבלת צעדי התרחיש מצד המשתמש**

| מספר צעד | פעולה מצד המשתמש                                                            | תוצאה מצופה                                                                                     |
|----------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------|
| 1        | נכנס ל־`stats.php`, בוחר סוג המידע “התחלת שיחת וואטסאפ” (whatsappstart)     | השדה `type=whatsappstart` ממולא בטופס.                                                          |
| 2        | ממלא טווח תאריכים ודומיין (אופציונלי), ולוחץ על "חפש"                       | הטבלה הראשית מסתננת ומציגה נתונים רלוונטיים; בנוסף נטענת טבלת פירוט הפניות מ־`whatsappstart.php` |
| 3        | גולל מטה ורואה את רשימת הפניות, כולל שם הפונה, טלפון, תאריך פניה ותאריך מבוקש | יכול לחפש בטבלה הפנימית באמצעות שדה החיפוש המקומי שמופיע מעל הטבלה.                             |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי**  
  כאשר `$_GET['type'] == 'whatsappstart'`, בסוף העמוד `stats.php` מבוצע `require __DIR__ . '/../partials/stats/whatsappstart.php';`. קובץ ה־partial שולף את הנתונים מטבלת `contact_whatsapp` ומציג אותם.

- **טבלת צעדי התרחיש מצד המתכנת**

| מספר צעד | לוגיקה טכנית                                                                                                                                      | מיקום בקוד                            | מבנה ותוכן הקוד                                                         |
|----------|---------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|----------------------------------------------------------------------------|
| 1        | בונה תנאי סינון `$wherew` לפי תאריכים ודומיין (אם מוגדר).                                                                                        | בראש `stats.php`                      | `if($_GET['createDate']) { ... } else { ... }`.                            |
| 2        | מזהה `$_GET['type'] == 'whatsappstart'` ומבצע `require "whatsappstart.php"`.                                                                      | בסוף `stats.php` (אחרי יצירת הטבלה)  | `require __DIR__ . '/../partials/stats/whatsappstart.php';`                |
| 3        | בתוך `whatsappstart.php`, מבוצעת שאילתת `SELECT * FROM contact_whatsapp WHERE ... ORDER BY id DESC`.                                            | בקובץ `whatsappstart.php`             | `$conWhatsapp = udb::full_list("SELECT * FROM contact_whatsapp WHERE...");` |
| 4        | מציג טבלת HTML עם עמודות #, מאת, טלפון, תאריך פניה, תאריך מבוקש, מספר אורחים.                                                                     | `whatsappstart.php`                   | `<table><thead> ... </thead><tbody> ... </tbody></table>`                   |
| 5        | מפעיל מנגנון חיפוש (JavaScript) שמבוסס על `onkeyup="search_table();"` עבור הטבלה המקומית.                                                         | `whatsappstart.php`                   | `<input type="text" placeholder="חיפוש בטבלה" ... onkeyup="search_table();" />` |

---

### 5.2.3 תרחיש 3 – סינון והצגת פירוט “שיחות מסקיו”

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי**  
  המשתמש בוחר `type=maskyoocall`, ממלא פרטי סינון רלוונטיים ולוחץ "חפש". מעבר לטבלה הראשית, יופיעו פרטי השיחות שנשלפו.

- **טבלת צעדי התרחיש מצד המשתמש**

| מספר צעד | פעולה מצד המשתמש                                              | תוצאה מצופה                                                       |
|----------|---------------------------------------------------------------|-------------------------------------------------------------------|
| 1        | ניגש לעמוד `stats.php` ובוחר “שיחות מסקיו” (maskyoocall)     | `type=maskyoocall` נשלח בפרמטר GET                                |
| 2        | ממלא תאריכים ולוחץ “חפש”                                     | הטבלה הראשית מסתננת, ובתחתית תוצג טבלה חדשה משיחות מסקיו.        |
| 3        | רואה עמודות כגון מאת, אל, זמני התחלה/סיום, משך, וסטטוס שיחה  | יכול לעיין בפרטי כל שיחה (משך, סטטוס “נענה” וכו’).               |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי**  
  `$_GET['type'] == 'maskyoocall'` מפעיל `require __DIR__ . '/../partials/stats/maskyoocall.php';`. בקובץ זה נעשית שאילתת `SELECT * FROM maskyooCalls` ומוצגים הנתונים בטבלה.

- **טבלת צעדי התרחיש מצד המתכנת**

| מספר צעד | לוגיקה טכנית                                                                                                                               | מיקום בקוד                              | מבנה ותוכן הקוד                                                       |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|------------------------------------------------------------------------|
| 1        | סינון `$wherem` עבור טווחי תאריכים/דומיין (אם נשלחו)                                                                                      | בראש `stats.php`                        | `if($_GET['createDate']) { ... } else { ... }` וכו’.                     |
| 2        | טוען `maskyoocall.php` אם `$_GET['type'] == 'maskyoocall'`.                                                                                | בסוף `stats.php`                        | `require __DIR__ . '/../partials/stats/maskyoocall.php';`               |
| 3        | בקובץ `maskyoocall.php`, מבוצעת שאילתת `SELECT * FROM maskyooCalls WHERE ... ORDER BY start_call DESC`.                                   | בתוך `maskyoocall.php`                  | `$maskyoo = udb::full_list($maskyooSql);`                                |
| 4        | מחשב משך שיחה ע”י הפרש בין `end_call` ל־`start_call` (באמצעות `DateTime`).                                                                  | `maskyoocall.php`                       | `$call_duration = $diff->i . ":" . $diff->s;`                            |
| 5        | מציג טבלת HTML עם עמודות #, מאת, אל, שעת התחלה, שעת סיום, משך, סטטוס.                                                                      | `maskyoocall.php`                       | `<table><thead>...</thead><tbody>...</tbody></table>`                    |
| 6        | הסטטוס (`call_status`) ממופה למחרוזת עברית (למשל `ANSWER`→`נענה`), ע”י מערך `$disposition`.                                                | `maskyoocall.php`                       | `$disposition['ANSWER'] = 'נענה';` וכו’.                                 |

---

### 5.2.4 תרחיש 4 – סינון והצגת פירוט “לידים יצירת קשר” (contacts)

#### א. ניתוח משתמש הקצה (Front-End Perspective)
- **תיאור כללי**  
  המשתמש בוחר `type=contacts`, ממלא טווחי תאריכים או דומיין, ולוחץ “חפש”. התקבלו תוצאות מסוננות בטבלה הראשית, וכן טבלת לידים עם עמודות "מאת, טלפון, תאריך פניה, מייל, הודעה".

- **טבלת צעדי התרחיש מצד המשתמש**

| מספר צעד | פעולה מצד המשתמש                                                      | תוצאה מצופה                                                     |
|----------|-----------------------------------------------------------------------|-----------------------------------------------------------------|
| 1        | בוחר “לידים יצירת קשר” (`contacts`) בטופס הסינון                      | `type=contacts` נשלח בפרמטר GET                                |
| 2        | מזין תאריכים ולוחץ על "חפש"                                          | הטבלה הראשית מסתננת, ובנוסף מוצגת טבלה מפורטת מהרשומות בטופס.  |
| 3        | רואה עמודות: מאת, טלפון, תאריך פניה, מייל, הודעה                      | יכול לסקור כל ליד שהגיע ולהשתמש בשדה חיפוש פנימי לטבלה.        |

#### ב. ניתוח המימוש בקוד (Back-End Perspective)
- **תיאור כללי**  
  `$_GET['type'] == 'contacts'` גורם לטעינת `partials/stats/contacts.php`, אשר שולף את הנתונים מטבלת `contactForm` ומציג אותם.

- **טבלת צעדי התרחיש מצד המתכנת**

| מספר צעד | לוגיקה טכנית                                                                                                                                  | מיקום בקוד                        | מבנה ותוכן הקוד                                                       |
|----------|-----------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|------------------------------------------------------------------------|
| 1        | סינון `$wherec` לפי פרמטרים (תאריכים, דומיין וכו’).                                                                                          | בראש `stats.php`                  | `if($_GET['createDate']) { ... } else { ... }`.                        |
| 2        | מזהה `$_GET['type'] == 'contacts'`, טוען `require __DIR__ . '/../partials/stats/contacts.php';`.                                             | בסוף `stats.php`                  | `require __DIR__ . '/../partials/stats/contacts.php';`                 |
| 3        | בקובץ `contacts.php` מבוצעת שאילתת `SELECT * FROM contactForm WHERE ... ORDER BY id DESC` לקבלת הלידים הרלוונטיים.                        | `contacts.php`                    | `$conForm = udb::full_list("SELECT * FROM contactForm WHERE ... ");`   |
| 4        | מציג טבלת HTML עם עמודות: #, מאת, טלפון, תאריך פניה, מייל, הודעה.                                                                            | `contacts.php`                    | `<table><thead>...</thead><tbody>...</tbody></table>`                  |
| 5        | כולל אפשרות חיפוש מקומית (JavaScript) לפי מחרוזת, בדומה לקבצים האחרים.                                                                        | `contacts.php`                    | `<input type="text" onkeyup="search_table();" ... >`                   |

---

# 6. מסמך שימוש (מדריך למשתמש)
1. **כניסה לדף הסטטיסטיקות**  
   היכנס לכתובת של `stats.php` (ללא פרמטרים או עם פרמטרים ריקים). תוצג טבלת סיכום הכוללת מספר פניות/שיחות לפי סוגי הפעולות הרלוונטיות.

2. **סינון לפי תאריכים ודומיין (אופציונלי)**  
   בשדות “תאריך מ” ו”תאריך עד” תוכל לבחור טווח תאריכים באמצעות בחירה מתפריט תאריכון. ניתן להגדיר גם דומיין (אם השדה לא מוסתר) לצורך סינון ממוקד יותר.

3. **בחירת סוג פעולה להצגת פירוט**
    - אם תרצה לפרט ספציפית על “התחלת שיחת וואטסאפ”, בחר בערך “whatsappstart”.
    - עבור “שיחות מסקיו”, בחר “maskyoocall”.
    - ללידים שנשלחו דרך טופס “צור קשר”, בחר “contacts”.

4. **לחיצה על “חפש”**
    - המערכת תרענן את טבלת הסיכום.
    - אם נבחר “סוג פעולה” כלשהו, תופיע למטה טבלה מפורטת נוספת (וואטסאפ / מסקיו / פניות צור קשר).

5. **חיפוש פנימי בתוך הטבלה המפורטת**  
   בכל אחת מהטבלאות המפורטות תוכל להקליד מילה/מספר כדי לסנן את השורות בהתאם.

6. **ניקוי טופס**  
   כדי לאפס את הטופס ולהסיר סינונים, לחץ על “נקה” (מקשר לכתובת עם הפרמטר `?page=stats` ללא ערכים נוספים).

---

# 7. סיכום
קבצי המערכת מפוצלים לעמוד ראשי (`stats.php`) המציג טבלת סיכום עבור אתרים/פניות, ולקבצי partial (וואטסאפ, מסקיו, פניות), שנוספים בתחתית העמוד כאשר המשתמש בוחר סוג פעולה מסוים. מבנה זה מאפשר התמצאות מהירה בנתונים (בטבלה המרכזית) וקבלת פירוט נוסף בהתאם לצורך. במדריך הצגנו את תרחישי השימוש המרכזיים, החל מהצגת כלל הנתונים ללא סינון ועד לפירוט ממוקד של כל אחד משלושת סוגי הפעולות הנתמכים.


