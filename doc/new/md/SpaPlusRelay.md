
# 1. הקדמה

המסמך הנוכחי מרכז ניתוח מקיף של קובץ אחד, **cms/classes/class.SpaPlusRelay.php**, שנסרק במלואו. הקובץ מכיל מחלקה בשם `SpaPlusRelay` האחראית על אינטגרציה עם שירות חיצוני (Spaplus) באמצעות קריאות HTTP (באמצעות cURL). מהמסמך עולה כי קיימת תלות בקובץ או מחלקה נפרדת (כנראה `udb`) המשמשת לביצוע שאילתות למסד הנתונים, אך קובץ זה לא הופיע ברשימת הקבצים שנסרקו בפועל. בנוסף, נראה כי הקריאה הבסיסית של המחלקה מתרחשת אל קובץ/כתובת `pricesupdate.php?act=prices` אשר לא סופק בקבצים הסרוקים (ככל הנראה מדובר בקובץ חיצוני בשרת המרוחק של spaplus.co.il או בקובץ שאינו קיים ברשימת הקבצים המקומית).

### עיקרי הרקע והמידע מהקובץ
- המחלקה `SpaPlusRelay` מכילה פונקציות עזר לשליחה (send) של מידע ל-Spaplus בפורמטים שונים (`raw`, `form`, `query`, `json`) ומטפלת בנתוני cURL המתאימים.
- המחלקה משתמשת במפתח (`spKey`) ובכתובת בסיס (`spURL`) לשם ביצוע הקריאות.
- למחלקה מתודה להגדרת מזהה אתר (siteID) ומתודה לשליחת מחירונים (sendPrices).
- קיימת גישה למחלקה או פונקציות סטטיות בשם `udb::single_list` ו-`udb::single_value` לצורך שליפת נתונים ממסד הנתונים.
- הקובץ כולל טיפול בשגיאות (Exception) במקרה של חוסר הצלחה בשליחה או בהגדרת `siteID` לא תקין.

---

# 2. הקבצים שנבדקו

1. **cms/classes/class.SpaPlusRelay.php**  
   - **מה ניתן ללמוד על הקובץ?**  
     - מגדיר את המחלקה `SpaPlusRelay`.
     - אחראי לשליחה ועיבוד נתונים מול שירות חיצוני (Spaplus) באמצעות cURL.
     - כולל משתנים מוגנים (`$bizID`, `$spID`) ופרמטרים להגדרת כתובת (`$spURL`) ומפתח (`$spKey`).
     - כולל פונקציות עזר כמו:  
       - `__construct($siteID = 0)` – אתחול עם אפשרות לקבוע `siteID`.  
       - `setSite($siteID)` – קובע את מזהה האתר בפועל, ומוציא את מזהה Spaplus ID (spID) מתוך מסד הנתונים.  
       - `sendPrices($data_only = false)` – קורא מהמסד מחירונים רלוונטיים ושולח אותם בפורמט JSON ל-Spaplus.  
       - פונקציות סטטיות `getSpaplusID($siteID)` – שולפות `spaplusID` ממסד הנתונים.

---

# 3. הקבצים שלא נמצאו

לא זוהו קבצים נוספים שדווחו ברשימה כ"לא נמצאו".  
(אין ברשותנו מידע על קבצים נוספים שנכללו ברשימת המקור וקיבלו הערה "הקובץ לא נמצא".)

---

# 4. הקבצים שלא נבדקו

להלן קבצים המוזכרים או נרמזים בקובץ שנבדק, אך אינם מופיעים ברשימת הקבצים שנבדקו בפועל או ברשימת הקבצים שלא נמצאו:

1. **קובץ או מחלקה בשם `udb`**  
   - בקובץ `class.SpaPlusRelay.php` יש שימוש ב-`udb::single_list` ו-`udb::single_value`. סביר להניח שמדובר בקובץ (או במחלקה) אחראי לפעולות מול מסד הנתונים.

2. **`pricesupdate.php` (או מסלול אחר לכתובת `pricesupdate.php?act=prices`)**  
   - בקוד מתבצעת קריאה לכתובת `pricesupdate.php?act=prices` (דרך `$this->send`), אך קובץ זה אינו מופיע ברשימת הקבצים.

---

# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

הקוד הקיים בקובץ `class.SpaPlusRelay.php` מאפשר מספר תרחישי שימוש (Use Flows), המשלבים בין נקודת המבט של המשתמש (Front-End) לבין הלוגיקה הפנימית (Back-End). להלן תרחישי השימוש האפשריים:

## תרחיש 1: אתחול והגדרת אתר (Constructor + setSite)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
מפתח או תהליך מערכת אחר מעוניין להתחבר לשירות Spaplus בעזרת המחלקה `SpaPlusRelay`. המשתמש (המתכנת) יוצר אובייקט חדש של `SpaPlusRelay` ומזין את המזהה (`siteID`) של האתר בו הוא מעוניין לטפל.

**טבלת צעדים (מצד המשתמש):**

| **מס' צעד** | **פעולה מצד המשתמש**                   | **תוצאה מצופה**                                                  |
|-------------|----------------------------------------|------------------------------------------------------------------|
| 1           | יוצר אובייקט חדש: `new SpaPlusRelay($siteID)` | המחלקה מאותחלת עם ערכים התחלתיים (`bizID=0`, `spID=0`), ואם נשלח `siteID` בשורה אחת הוא ייקבע ברגע הקריאה. |
| 2           | במידת הצורך, קורא לפונקציה `$obj->setSite($siteID)` באופן מפורש | מזהה האתר (`bizID`) וכן `spID` (מזהה לפי מסד הנתונים) נשמרים במחלקה ומוכנים לשימוש בהמשך. |

### 2. תיאור המימוש בקוד (Back-End Perspective)

**תיאור כללי:**  
- עם יצירת אובייקט `SpaPlusRelay`, אם התקבל `$siteID`, המתודה `setSite()` תופעל ותבצע שאילתה ל-`udb::single_value` כדי לאתר את `spaplusID`.  
- המתודה `setSite()` תזרוק `Exception` אם אין מזהה Spaplus לאתר הנוכחי.

**טבלת צעדים (מצד המתכנת):**

| **מס' צעד** | **לוגיקה טכנית**                                                                                                                                                                       | **מיקום בקוד**                           | **מבנה ותוכן הקוד**                                                                              |
|-------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|---------------------------------------------------------------------------------------------------|
| 1           | קריאה ל־`__construct($siteID=0)`. במידה ו־`$siteID` גדול מ־0, הקריאה תפנה ל־`setSite($siteID)`.                                                                                       | `__construct()` בשורות הפתיחה של הקובץ   | ```php
public function __construct($siteID = 0){
  // הגדרת bizID, spID, ולבסוף setSite()
}
``` |
| 2           | `setSite($siteID)` מבצעת קריאה סטטית אל `udb::single_value("SELECT spaplusID FROM sites WHERE siteID = ...")`. הערך המוחזר הוא `spID`. אם לא קיים, נזרק Exception.                    | בתוך `setSite()`                        | ```php
$outer = self::getSpaplusID($siteID);
if (!$outer) throw new Exception("No spaplus ID...");
``` |
| 3           | אם הכל תקין, משתני המחלקה `$bizID` ו-`$spID` מאותחלים בהתאם.                                                                                                                          | בהמשך בפונקציה `setSite()`              | ```php
$this->bizID = intval($siteID);
$this->spID = intval($outer);
return $this;
``` |

---

## תרחיש 2: שליחת מחירונים (sendPrices)
### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
לאחר הגדרת ה־`siteID`, ניתן לשלוף ולהעביר מחירונים אל Spaplus. התרחיש כולל בדיקה האם המחירים קיימים במסד הנתונים ושליחתם לכתובת היעד החיצונית.

**טבלת צעדים (מצד המשתמש):**

| **מס' צעד** | **פעולה מצד המשתמש**                                               | **תוצאה מצופה**                                                                                                        |
|-------------|--------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------|
| 1           | קורא לפונקציה `$obj->sendPrices()`                                 | במידה ו־`siteID` ו־`spID` הוגדרו, הטבלה `treatmentsPricesSites` נבדקת ומופק רשימת מחירונים רלוונטיים (אם יש).         |
| 2           | במידה ולא נמצאו כלל מחירונים, הפונקציה תחזיר מידע טקסטואלי (אם `$data_only` = `true`), או תמשיך בכל מקרה לשלוח את הרשימה (אם קיימת). | המשתמש מקבל תגובה אם לא נמצאו מחירים, או שהמערכת שולחת JSON מלא ל־Spaplus ומחזירה תשובת שרת ספא + לוג בדיקה. |

### 2. תיאור המימוש בקוד (Back-End Perspective)

**תיאור כללי:**  
- `sendPrices()` בודק האם קיימים ערכים חיוביים (`price1`, `price2`, `price3`) עבור הטיפולים השונים.  
- במידה ויש מחירים, הפונקציה עורכת אותם בפורמט JSON ושולחת בקשת POST אל `pricesupdate.php?act=prices` ב־Spaplus.  
- אם שליחה נכשלה ב־cURL, מושלך Exception.

**טבלת צעדים (מצד המתכנת):**

| **מס' צעד** | **לוגיקה טכנית**                                                                                                                                                           | **מיקום בקוד**                       | **מבנה ותוכן הקוד**                                                                                                                                           |
|-------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1           | בודק ש־`$this->bizID` ו־`$this->spID` אינם אפס. אם אחד מהם שווה ל-0, נזרק Exception.                                                                                       | תחילת `sendPrices()`                 | ```php
if (!$this->bizID || !$this->spID)
  throw new Exception("Site ID is not set...");
``` |
| 2           | שליפת רשימת המחירונים בעזרת `udb::single_list(...)` מטבלת `treatmentsPricesSites` (צירוף עם `treatments`). נשמרים רק שורות בהן אחד מהמחירים (`price1`, `price2`, `price3`) גדול מ-0. | בהמשך `sendPrices()`                 | ```php
$prices = udb::single_list("SELECT ... FROM treatmentsPricesSites ... WHERE (p.price1 > 0 OR ...)");
``` |
| 3           | אם לא נמצאו תוצאות והפרמטר `$data_only` שווה `true`, מחזירים טקסט `"No prices found"`.                                                                                   | באותו חלק של `sendPrices()`          | ```php
if (!$prices && $data_only)
  return 'No prices found';
``` |
| 4           | אחרת, מבוצע `array_filter` על כל שורת נתונים, ולאחר מכן קריאה לפונקציה `send()` עם פורמט JSON וכתובת `pricesupdate.php?act=prices`.                                      | סוף `sendPrices()`                   | ```php
return $this->send(['siteID' => $this->spID, 'prices' => $prices], 'json', 'pricesupdate.php?act=prices');
``` |
| 5           | בפונקציה `send($data, $format, $target)`, מופעל cURL המוגדר עם POST, שליחת `$msg` והוספת מפתח ספציפי (`$this->spKey`) לפרמטרי הכתובת.                                   | בפונקציה `send()` בתוך הקובץ         | ```php
$link = curl_init($url . '?key=' . $this->spKey);
...
curl_exec($link);
``` |

---

# 6. מסמך שימוש (מדריך למשתמש)

במדריך זה, המשתמש (בדרך כלל מתכנת או מפתח אינטגרציה) ילמד כיצד לעבוד עם המחלקה `SpaPlusRelay`:

1. **ייבוא המחלקה**: יש לוודא שהקובץ `class.SpaPlusRelay.php` נכלל בקוד שלכם באמצעות `include`/`require`.
2. **אתחול המחלקה**:  
   ```php
   $relay = new SpaPlusRelay(); 
   ```
   - ניתן להעביר `siteID` ישירות בבנאי, לדוגמה:  
     ```php
     $relay = new SpaPlusRelay(123);
     ```
3. **קביעת האתר**: במידה ולא הוגדר בבנאי, ניתן לקרוא:  
   ```php
   $relay->setSite(123);
   ```
   - אם אין `spaplusID` תקין עבור `siteID` = 123, תיזרק שגיאה.
4. **שליחת מחירונים**:  
   ```php
   $response = $relay->sendPrices();
   ```
   - הפרמטר `data_only` (בברירת מחדל `false`) מאפשר להחזיר טקסט `"No prices found"` במידה ואין מחירים ולא לשלוח דבר בפועל.
   - במידה והפרמטר נשאר `false`, גם אם אין מחירים, עדיין תהיה חזרה עם תוצאת השליחה (או שגיאה ב-Exception).
5. **טיפול בשגיאות**: השימוש במחלקה כרוך בנסיונות cURL. אם השרת המרוחק מחזיר קוד שאינו 200, תיזרק שגיאת `Exception`. מומלץ לעטוף את הקריאה ב־try/catch:
   ```php
   try {
       $relay->sendPrices();
   } catch (Exception $e) {
       // טיפול בשגיאה
       echo $e->getMessage();
   }
   ```

---

# 7. סיכום

בקובץ `cms/classes/class.SpaPlusRelay.php` הוגדר ממשק המתקשר עם שירות Spaplus לצורך שליחה ועיבוד של נתונים (כגון מחירונים). ראינו כיצד באמצעות מתודות שונות (`__construct`, `setSite`, `sendPrices`, ועוד) ניתן לנהל את תהליך האתחול, הטעינה ושליחת המידע. הקובץ נשען על מחלקה/פונקציות DB חיצונית בשם `udb`, וכן מבצע שליחה בפורמט JSON לכתובת `pricesupdate.php?act=prices`.  
חשוב לשים לב שתהליך השילוב ידרוש קובץ/מחלקה חיצונית (`udb`) שאינו כלול בסריקה זו, וככל הנראה גם מידע נוסף או קובץ מקביל (`pricesupdate.php`) בצד השרת המרוחק (או המקומי) לצורך קליטת הנתונים.
```

---

## 2. רשימה להעתקה של הקבצים (שורה אחר שורה)

להלן שלוש הרשימות כנדרש:

1. **קבצים שנבדקו**  
```
cms/classes/class.SpaPlusRelay.php
```

2. **קבצים שלא נמצאו**  
*(כרגע לא זוהו קבצים שהוגדרו "לא נמצאו")*  
```
```
*(רשימה ריקה)*

3. **קבצים שלא נבדקו**  
```
udb
pricesupdate.php
```  
```
