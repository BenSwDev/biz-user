
# 1. הקדמה
בקבצים שנסרקו (מפורטים להלן), ניתן לזהות מערכת המאפשרת תהליך התחברות (Login) לשני סוגי משתמשים עיקריים:

1. **משתמש רגיל (User)** – כניסה באמצעות `user/login.php` וקריאה ל-`js_login.php`.
2. **משתמש מטפל (Member/Therapist)** – כניסה באמצעות `user/login_member.php` וקריאה ל-`js_login_member.php`.

הקוד מפעיל מנגנוני אימות באמצעות בדיקת שם משתמש וסיסמה מול מסד נתונים, יוצר אובייקטי Session, ובמידת הצורך מעביר את המשתמש/מטפל לעמוד המתאים. הגדרת המחלקה `TfusaBaseUser` (ממוקמת ב-`cms/classes/class.TfusaBaseUser.php`) מעניקה מבנה בסיסי למשתמשי המערכת, כגון מזהה ייחודי, הרשאות, רשימת אתרים (Sites) ועוד.

**הרציונל** העולה מהקבצים הוא לספק מערכת גמישה לניהול כמה סוגי כניסות: משתמשי מערכת כלליים מזהים את עצמם בנתיב `/user/login.php`, בעוד שמטפלים (Therapists) משתמשים בנתיב `/member/`. בכל אחד מהמקרים, הקוד בודק את התוקף של שם המשתמש והסיסמה, ועל פי התוצאה מעדכן את ה-Session ומחזיר תשובה מתאימה (JSON) או מפנה לעמוד הבא.


# 2. הקבצים שנבדקו

1. **user/js_login.php**  
   - קריאה מצד JavaScript לצורך אימות שם המשתמש והסיסמה (עבור כניסת משתמש רגיל).  
   - נטען מתוך `user/login.php` באמצעות Ajax (`$.post('js_login.php', ...)`).  
   - מקבל `$_POST['user']` ו-`$_POST['pass']`, בודק אותם מול טבלת `biz_users`, ואם הסיסמה מתאימה נוצרת סשן ומוחזר JSON עם `success = true` וקישור המשך.

2. **user/js_login_member.php**  
   - קריאה מצד JavaScript לצורך אימות שם המשתמש והסיסמה (עבור כניסת מטפל/therapist).  
   - נטען מתוך `user/login_member.php` באמצעות Ajax (`$.post('js_login_member.php', ...)`).  
   - מקבל `$_POST['user']` ו-`$_POST['pass']`, בודק אותם מול טבלת `therapists`, ואם הסיסמה נכונה (באמצעות `MemberUser::passVerify`), נוצרת סשן מתאימה ומוחזר JSON עם `success = true` וקישור המשך.

3. **user/login.php**  
   - עמוד הכניסה למשתמשים רגילים.  
   - בודק אם הנתיב הוא `/member/` – במקרה כזה מייבא את `login_member.php` ומפסיק את יתר הפעולות.  
   - מכיל טופס HTML בסיסי: שדות שם משתמש וסיסמה, וכפתור "התחבר".  
   - עושה שימוש בקבצי CSS ו-JS חיצוניים (jQuery, sweetalert2, style.css וכו').  
   - מפעיל לוגיקה של “זכור אותי” דרך `localStorage.tfusa_username`/`tfusa_password` לצורך מילוי אוטומטי.

4. **user/login_member.php**  
   - עמוד הכניסה המותאם למטפלים (Therapists).  
   - דומה במבנהו ל-`login.php`, אך בפועל פונה ל-`js_login_member.php` במקום ל-`js_login.php`.  
   - מציג טופס עם כיתוב “כניסת מטפלים” ועוד.  
   - מפעיל לוגיקה דומה של שמירת שם משתמש וסיסמה ב-`localStorage`.

5. **cms/classes/class.TfusaBaseUser.php**  
   - מחלקת בסיס עבור משתמשי המערכת.  
   - שומרת מידע על מזהה המשתמש, רשימת האתרים שאליהם יש לו גישה, הרשאות (permission), ועוד.  
   - מטפלת בכל הנושא של active_site, בדיקת הרשאות (can / is), הוספת אתרים, חישוב ערכי סשן, ועוד.  
   - כוללת שיטות סטטיות לניהול סיסמאות (`passHash` ו-`passVerify`).

6. **partials/header.php**  
   - קובץ HTML+PHP קטן המייצר אזור Header באתר (כולל תמיכה ב-WhatsApp, תמונת לוגו, תפריטים בסיסיים וכו’).  
   - מכיל DIV-ים שונים, קוד להצגת תפריטים שמגיעים מתוך טבלת `menu` במסד הנתונים.

7. **manifest.json**  
   - קובץ הגדרות PWA (Progressive Web App) או הגדרות אפליקציה לדפדפן.  
   - מכיל את שם היישום, אייקונים שונים, הגדרת צבעי רקע, צבע ערכת נושא, וכתובת התחלה (`start_url`).  


# 3. הקבצים שלא נמצאו
לא צוינו קבצים עם סטטוס "לא נמצא". כלומר, אין ברשימה קבצים שסומנו במפורש כ-“הקובץ לא נמצא”.


# 4. הקבצים שלא נבדקו
במהלך הסריקה, זוהו התייחסויות למספר גורמים/מחלקות/משאבים אשר אינם מופיעים ברשימת הקבצים שהועברו (וגם אינם בקבוצת הקבצים שהתבקשנו להתעלם מהם). לכן, הם מסווגים כקבצים/משאבים שלא נבדקו:

1. **קובץ/מחלקה המגדיר את `MemberUser`** – נדרשת מחלקה בשם `MemberUser` (נראה שמרחיבה או דומה ל-TfusaBaseUser). יש קריאה לפונקציה `MemberUser::passVerify`.  
2. **קובץ/מחלקה המגדיר את `JsonResult`** – נראית מחלקה שמחזירה אובייקט JSON לצרכי תגובה (`new JsonResult([...])`).  
3. **קובץ/מחלקה המגדיר את `udb`** – בכל מקום רואים שימושים בסגנון `udb::escape_string(...)`, `udb::single_row(...)` וכו’. לא סופק קובץ כזה.  
4. **נכסי עיצוב/JS נוספים (שאינם ברשימת ההתעלמות)**:  
   - `assets/css/style.css`  
   - `assets/css/sweetalert2.min.css`  
   - `assets/js/jquery-2.2.4.min.js`  
   - `assets/js/sweetalert2.min.js`  
   - `assets/img/login.jpg`  
   - `index/style.css`  
   - `index/logo.png`  
   - `index/phoneLogo1.png`  
   - `index/footer_logo.png`  


> **הערה חשובה**: על פי ההנחיה, אין צורך להתייחס כ”לא נבדקו” לקבצים המופיעים במפורש ברשימת ההתעלמות (כגון `functions.php`, `index.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php`, `auth.php`). לכן, למרות שהקוד מתייחס ל-`functions.php`, לא נכלול אותו בקטגוריה זו.


# 5. תרחישים כוללים בעמוד (Use Flow Scenarios)

להלן פירוט **תרחישי שימוש** עיקריים, כפי שעולים מן הקבצים:

---

## תרחיש 1: התחברות משתמש רגיל (User Login)

### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
משתמש נכנס לעמוד הכניסה הראשי (`/user/login.php`), מזין שם משתמש וסיסמה, ולוחץ על "התחבר". המערכת בודקת אוטומטית האם יש שמירת שם משתמש/סיסמה ב-`localStorage`; במידה וכן, מתבצעת התחברות אוטומטית. אחרת, נשלח Ajax ל-`js_login.php`.

**טבלת צעדי התרחיש מצד המשתמש:**

| **מספר צעד** | **פעולה מצד המשתמש**                      | **תוצאה מצופה**                                                        |
|--------------|-------------------------------------------|------------------------------------------------------------------------|
| 1            | מגיע לעמוד `/user/login.php`             | רואה עמוד התחברות (שני שדות טקסט, כפתור "התחבר")                       |
| 2            | מזין שם משתמש וסיסמה בטופס                | מחכה שהמערכת תקבל את הנתונים (אין עדיין שליחת טופס)                    |
| 3            | לוחץ על כפתור "התחבר"                     | מופעלת פונקציית JavaScript, נשלח `$.post` ל-`js_login.php` עם המידע    |
| 4            | מקבל חיווי הצלחה/שגיאה (מודעת swal וכו’)   | במקרה הצלחה – מעביר/מנתב לכתובת שחוזרת ב-`result['link']`. במקרה כישלון – מופיע התרעת שגיאה |

---

### 2. תיאור המימוש בקוד (Back-End Perspective)

**תיאור כללי:**  
בצד השרת, `js_login.php` מקבל את הנתונים (POST) וניגש לטבלת `biz_users`. אם הסיסמה תואמת (נבדקת עם `password_verify`), נוצרת סשן מסוג `TfusaUser`, ומוחזר אובייקט JSON המודיע על הצלחה. אחרת, מוחזר אובייקט JSON עם `error`.

**טבלת צעדי התרחיש מצד המתכנת:**

| **מספר צעד** | **לוגיקה טכנית**                                                                                                                                                                                                                                     | **מיקום בקוד**              | **מבנה ותוכן הקוד**                                                                                                                      |
|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| 1            | קליטת POST של `user` ו-`pass`; בדיקת ריקוּת                                                                                                                   | `user/js_login.php`         | `if(isset($_POST['login'])) { ... }`<br/> `typemap($_POST['user'],'string')`                                                           |
| 2            | שליפת הרשומה מ-`biz_users` על סמך `username` פעיל                                                                                                                                                                                                   | `user/js_login.php`         | `$que = "SELECT ... FROM biz_users WHERE username = '...' AND active=1"; $user = udb::single_row($que);`                                |
| 3            | השוואת הסיסמה שהוזנה מול העמודה `password` (באמצעות `password_verify`)                                                                                                                                                                              | `user/js_login.php`         | `if($user && password_verify($password,$user['password'])) { ... }`                                                                     |
| 4            | בדיקת צירוף אתרים (Sites) למשתמש; יצירת אובייקט `TfusaUser` ואחסונו ב-Session                                                                                                                                                                       | `user/js_login.php`         | `$sess = new TfusaUser(...); $_SESSION['tfusa']['user'][$sess->access_token] = $sess;`                                                  |
| 5            | החזרת JSON עם `success = true` וכתובת הפניה  (`/user/.../`) אם הכל תקין, או `error` במקרה של כישלון                                                                                                                                                 | `user/js_login.php`         | `$result['success'] = true; $result['link'] = '/user/'.$sess->access_token.'/'; echo json_encode($result);`                             |

---

## תרחיש 2: התחברות מטפל/Therapist (Member Login)

### 1. תיאור משתמש הקצה (Front-End Perspective)

**תיאור כללי:**  
מטפל (Therapist) נכנס לכתובת `/member/` או ישירות לעמוד `user/login_member.php`, מזין שם משתמש וסיסמה, ולוחץ על "התחבר". מתרחשת בדיקה דומה המותאמת לטבלת `therapists`.

**טבלת צעדי התרחיש מצד המשתמש:**

| **מספר צעד** | **פעולה מצד המשתמש**                                | **תוצאה מצופה**                                                                   |
|--------------|-----------------------------------------------------|-----------------------------------------------------------------------------------|
| 1            | מגיע לעמוד `/user/login_member.php` או `/member/`   | רואה עמוד התחברות למטפלים (שני שדות טקסט, כפתור "התחבר", כותרת “כניסת מטפלים”)    |
| 2            | מזין שם משתמש וסיסמה בטופס                          | מחכה שהמערכת תקבל את הנתונים                                                      |
| 3            | לוחץ על כפתור "התחבר"                               | מופעלת פונקציית JavaScript, נשלח `$.post` ל-`js_login_member.php` עם המידע        |
| 4            | מקבל חיווי הצלחה/שגיאה (מודעת swal)                 | במקרה הצלחה – מופנה אוטומטית לכתובת שמוחזרת ב-JSON (לרוב `/member/...`)            |

---

### 2. תיאור המימוש בקוד (Back-End Perspective)

**תיאור כללי:**  
בצד השרת, `js_login_member.php` מקבל את הנתונים ובודק מול טבלת `therapists`. אם ההשוואה (באמצעות `MemberUser::passVerify`) מצליחה, נוצר אובייקט `MemberUser` (שלא מופיע כקובץ סרוק, אך מוזכר), נשמר ב-Session תחת `$_SESSION['tfusa']['member']`, ומוחזר JSON של הצלחה.

**טבלת צעדי התרחיש מצד המתכנת:**

| **מספר צעד** | **לוגיקה טכנית**                                                                                                | **מיקום בקוד**                 | **מבנה ותוכן הקוד**                                                                                                       |
|--------------|-----------------------------------------------------------------------------------------------------------------|--------------------------------|----------------------------------------------------------------------------------------------------------------------------|
| 1            | קליטת POST של `user` ו-`pass`; בדיקת ריקוּת                                                                     | `user/js_login_member.php`     | `if(isset($_POST['login'])) { ... }`<br/> `typemap($_POST['user'],'string')`                                               |
| 2            | חיפוש הרשומה המתאימה ב-`therapists` (רק אם `active=1` ו-`deleted=0` וכו')                                       | `user/js_login_member.php`     | `$que = "SELECT therapistID, siteID, password, siteName FROM therapists ... AND active=1 ..."; $user = udb::single_row();` |
| 3            | השוואת הסיסמה באמצעות `MemberUser::passVerify`                                                                  | `user/js_login_member.php`     | `if($user && MemberUser::passVerify($password,$user['password'])) { ... }`                                                 |
| 4            | יצירת אובייקט `MemberUser`, השמתו ב-Session תחת `tfusa']['member']`                                             | `user/js_login_member.php`     | `$sess = new MemberUser(...); $_SESSION['tfusa']['member'] = [$sess->access_token => $sess];`                             |
| 5            | החזרת JSON עם `success = true` וכתובת הפניה (`/member/...`) במקרה הצלחה או `error` במקרה כישלון                | `user/js_login_member.php`     | `$result['success'] = true; $result['link'] = '/member/'.$sess->access_token.'/'; echo json_encode($result);`             |

---

# 6. מסמך שימוש (מדריך למשתמש)

להלן מדריך קצר למשתמש הקצה, באופן הדרגתי וברור:

1. **גלישה לכתובת**  
   - עבור משתמש רגיל: היכנסו לדפדפן והקלידו `https://example.com/user/login.php` (הכתובת עשויה להשתנות בהתאם לסביבה).  
   - עבור מטפל: היכנסו ל-`https://example.com/user/login_member.php` או לחלופין `https://example.com/member/`.

2. **הזנת פרטי התחברות**  
   - בעמוד הכניסה תמצאו שני שדות: שם משתמש (Username) וסיסמה (Password). הזינו את הפרטים שהתקבלו מכם בעת הרישום.

3. **אישור ולחיצה על "התחבר"**  
   - לחצו על כפתור "התחבר".  
   - אם המערכת מזהה פרטים שמורים (Saved credentials) בדפדפן, ייתכן שתתבצע התחברות אוטומטית ללא צורך בהקלדה חוזרת.

4. **קבלת משוב**  
   - במקרה של הצלחה: תועברו לעמוד הניהול/אזור האישי המתאים.  
   - במקרה של שגיאה: תופיע הודעת אזהרה (SweetAlert או אחרת) עם סיבת השגיאה.

5. **יציאה מהמערכת (Logout)**  
   - ברוב המקרים ניתן ללחוץ על "התנתק" (Logout) מתוך התפריט העליון או התפריט הצדדי (תלוי בעיצוב). פעולה זו תסגור את ה-Session ותדרוש התחברות מחדש בכניסה הבאה.

6. **תמיכה ושחזור סיסמה**  
   - אם שכחתם סיסמה, או במידה ואינכם מצליחים להתחבר, ניתן לפנות לתמיכה באמצעות הקישורים בעמוד (למשל, "לא מצליח להתחבר") או לחייג למספרי הטלפון המוצגים.  

שימו לב כי ייתכן שחלק מהפונקציות (כמו "שחכתי סיסמה") עדיין אינן פעילות או מפנות לעמוד אחר במערכת.


# 7. סיכום
מסמך זה הציג ניתוח מלא של קבצי המערכת שנסרקו במלואם, לרבות שני תרחישי התחברות עיקריים (משתמש רגיל ומטפל). לצד פירוט התרחישים, נוספה טבלת צעדים טכנית (Back-End) וטבלת צעדים מנקודת מבט המשתמש (Front-End). כמו כן, זוהו הקבצים החסרים שלא נבדקו ואפשרו הבנת תמונת המערכת המלאה. באופן כללי, נראה שהמערכת בנויה כך שתומכת במספר סוגי משתמשים שונים, עושה שימוש ב-Session וקריאות Ajax, ונותנת מענה לאתרי ספא, צימר, טיפול ואירוח.


---

## 2. רשימה להעתקה של הקבצים (שורה אחר שורה)

להלן שלוש הרשימות המבוקשות:  
1. קבצים שנבדקו  
2. קבצים שלא נמצאו  
3. קבצים שלא נבדקו  

> **שים לב**: בכל רשימה מופיעים אך ורק שמות הקבצים, שורה אחר שורה, ללא תוספת מידע.

---

### 1) קבצים שנבדקו

```
user/js_login.php
user/js_login_member.php
user/login.php
user/login_member.php
cms/classes/class.TfusaBaseUser.php
partials/header.php
manifest.json
```

### 2) קבצים שלא נמצאו

```
```
*(אין קבצים בקטגוריה זו)*

### 3) קבצים שלא נבדקו

```
MemberUser
JsonResult
udb
assets/css/style.css
assets/css/sweetalert2.min.css
assets/js/jquery-2.2.4.min.js
assets/js/sweetalert2.min.js
assets/img/login.jpg
index/style.css
index/logo.png
index/phoneLogo1.png
index/footer_logo.png
```
