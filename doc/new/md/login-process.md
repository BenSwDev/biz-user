
# 1. הקדמה
בקבצים שנסרקו יש התממשקות למערכת התחברות של משתמשים ומטפלים (Therapists). מטרת הקוד היא לאפשר כניסה דרך דפי Front-End (טפסי התחברות), ובצד ה-Back-End להפעיל תהליכי אימות מול בסיס הנתונים, יצירת סשן מתאים והפניית המשתמש/המטפל לאזור המתאים.  
במסגרת הקוד קיימים שני מסלולי התחברות עיקריים:  
1. **כניסת משתמש רגיל** – מבוצע דרך הקבצים `login.php` ו-`js_login.php`.  
2. **כניסת מטפל** – מבוצע דרך הקבצים `login_member.php` ו-`js_login_member.php`.  

הקוד נסמך, בין היתר, על מחלקות ופעולות חיצוניות (כגון `TfusaBaseUser`, `MemberUser`, פונקציות DB, וכו’), וכן על אלמנטים ב-Front-End (קבצי CSS, JavaScript, Manifest, וכדומה). חלק מקבצים אלו אינם נמצאים ברשימת הקבצים הנסרקים בפועל.

---

# 2. הקבצים שנבדקו
להלן הקבצים אשר **קיימים** בפועל ושיש בהם תוכן, לפי הרשימה שסופקה ונסרקה:

1. **user/js_login.php**  
   - מטפל בבקשת AJAX (מתודה POST) של התחברות משתמש רגיל.  
   - כולל בדיקות תקינות (שם משתמש, סיסמה), שליפת מידע משתמש מבסיס הנתונים, בדיקת סיסמה באמצעות `password_verify`, יצירת אובייקט סשן (`TfusaUser`) והפניית המשתמש לנתיב המתאים.  
   - משתמש במחלקה `JsonResult` לייצוא תשובה במבנה JSON.

2. **user/js_login_member.php**  
   - מטפל בבקשת AJAX (מתודה POST) של התחברות מטפל (Therapist).  
   - מבצע בדיקות שם משתמש/סיסמה, שליפת פרטי המטפל מבסיס הנתונים, בדיקת סיסמה באמצעות `MemberUser::passVerify`, יצירת אובייקט סשן (`MemberUser`) והפניה לנתיב המתאים.  
   - משתמש אף הוא ב-`JsonResult` במבנה JSON לחיווי הצלחה/שגיאה.

3. **user/login.php**  
   - מסך התחברות למשתמש הרגיל (Front-End).  
   - מכיל טופס התחברות (HTML), הכולל אינפוטים לשם משתמש וסיסמה.  
   - בעת שליחה (`submit`), מבצע קריאה ל-`js_login.php` (באמצעות jQuery POST) כדי לבצע את הלוגיקה ב-Back-End.  
   - כולל גם מנגנון זיהוי מהיר (אם הפרטים שמורים ב-localStorage).

4. **user/login_member.php**  
   - מסך התחברות למטפלים (Front-End).  
   - דומה באופיו לקובץ `login.php`, אך פונה ב-POST אל `js_login_member.php`.  
   - מכיל טופס התחברות עם אינפוטים לשם משתמש וסיסמה, ושומר/טוען את הפרטים מ-`localStorage`.

---

# 3. הקבצים שלא נמצאו
לא אותרו קבצים שהוגדרו מראש כקיימים אך בפועל סומנו כ"לא נמצאו". כלומר, אין ברשימה שום קובץ שסומן במפורש כ"לא נמצא".

---

# 4. הקבצים שלא נבדקו
בקוד קיימים הפניות או אזכורים לקבצים שונים שלא הופיעו ברשימת הקבצים שסופקה, ולכן לא נסרקו בפועל. אלו הקבצים שזוהו:

1. `../cms/classes/class.TfusaBaseUser.php`  
2. `../partials/header.php`  
3. `assets/css/style.css`  
4. `assets/css/sweetalert2.min.css`  
5. `assets/js/jquery-2.2.4.min.js`  
6. `assets/js/sweetalert2.min.js`  
7. `favicon.ico` (בספרייה הראשית / ברמת שורש האתר)  
8. `assets/img/login.jpg`  
9. `assets/img/lock.png`  
10. `assets/img/error.png`  
11. `manifest.json` (בהתאם לכתובת `/[path_base]/manifest.json`; יכול להיות `user/manifest.json` או `member/manifest.json`)

> **הערה חשובה:** לפי ההנחיות, **אין צורך** להוסיף לרשימה זו קבצים כמו `functions.php`, `index.php`, `partial/menu.php`, `partial/submenu.php`, `partial/menu_member.php`, או `auth.php`, גם אם הם מופיעים בהפניות בקוד, משום שנאמר במפורש להתעלם מהם.

---

# 5. תרחישים כוללים בעמוד

## הוראות לניתוח קוד ובניית תרחישי שימוש (Use Flow Scenarios)

### 1. זיהוי כל תרחישי השימוש
בקוד הנסרק זוהו שני תרחישים עיקריים:
1. תרחיש התחברות משתמש רגיל (User Login Flow).
2. תרחיש התחברות מטפל (Therapist Login Flow).

---

### תרחיש 1: התחברות משתמש רגיל

#### 1. תיאור משתמש הקצה (Front-End / User Perspective)
- **תיאור כללי:** המשתמש נכנס לדף `user/login.php`, רואה טופס התחברות עם שני שדות (שם משתמש, סיסמה) וכפתור "התחבר". לאחר שהוא מזין את פרטיו ולוחץ על הכפתור, הוא מצפה או להיכנס למערכת (אם הפרטים תקינים) או לקבל שגיאה רלוונטית (אם הפרטים שגויים).

| מספר צעד | פעולה מצד המשתמש          | תוצאה מצופה                                                   |
|----------|---------------------------|----------------------------------------------------------------|
| 1        | פתיחת העמוד `login.php`  | מוצג מסך התחברות עם שדות להזנת שם משתמש וסיסמה.               |
| 2        | הקלדת שם משתמש וסיסמה    | הנתונים מוזנים לשדות המתאימים ומופיעים בממשק הטופס.           |
| 3        | לחיצה על כפתור "התחבר"   | נשלחת בקשת AJAX אל `js_login.php`; המערכת מחכה לתשובת אימות. |
| 4        | (לאחר תשובה)             | אם ההתחברות הצליחה – מעבר לכתובת שהוחזרה; אחרת – הודעת שגיאה. |

---

#### 2. תיאור המימוש בקוד (Back-End / Developer Perspective)
- **תיאור כללי:**  
  בקובץ `user/login.php` נעשה שימוש ב-jQuery כדי לשלוח POST אל `js_login.php`.  
  בקובץ `user/js_login.php` נעשות בדיקות של המידע בבסיס הנתונים (טבלת `biz_users`), אימות הסיסמה באמצעות `password_verify`, בדיקה שיש אתרי גישה למשתמש, יצירת אובייקט משתמש מסוג `TfusaUser` ושמירה במערך סשן. אם הכל תקין, מחזירים תשובה JSON עם `success = true` וקישור להמשך.

| מספר צעד | לוגיקה טכנית                                                                                                                                           | מיקום בקוד               | מבנה ותוכן הקוד                                                                                                                                                        |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | קריאת ה-POST מהטופס (`$_POST['user']`, `$_POST['pass']`).                                                                                             | `user/js_login.php`      | בדיקה `if(isset($_POST['login'])) { ... }`.                                                                                                                            |
| 2        | בדיקת ערכים ריקים או לא חוקיים עבור שם משתמש וסיסמה.                                                                                                  | `user/js_login.php`      | `if (!$username) $result['error'] = 'Empty or illegal e-mail'; else if (!$password) $result['error'] = 'Empty password';`                                              |
| 3        | שליפת רשומת המשתמש (`SELECT * FROM biz_users ...`) ובדיקת הסיסמה באמצעות `password_verify($password, $user['password'])`.                             | `user/js_login.php`      | `$user = udb::single_row($que); ... if($user && password_verify(...)) {...}`                                                                                           |
| 4        | שליפת רשימת האתרים שהמשתמש יכול לגשת אליהם (`sites_users`) והפקת אובייקט סשן `TfusaUser`.                                                             | `user/js_login.php`      | `$sites = udb::single_column(...); $sess = new TfusaUser(...); $_SESSION['tfusa']['user'][$sess->access_token] = $sess;`                                               |
| 5        | החזרת תשובת JSON להצלחה או שגיאה (`$result['success'] = true/false`).                                                                                 | `user/js_login.php`      | `echo json_encode($result);`                                                                                                                                          |
| 6        | ב-Front-End, אם `success = true`, מפנים את המשתמש לנתיב `res.link`; אחרת מציגים הודעת שגיאה (מופיעה בחלון swal).                                      | `user/login.php` (JS)    | `$.post('js_login.php', data, function(res){ if (res.success) window.location.href = res.link; else swal('שגיאה!', res.error, 'error'); }, 'json');`                  |

---

### תרחיש 2: התחברות מטפל (Therapist Login Flow)

#### 1. תיאור משתמש הקצה (Front-End / User Perspective)
- **תיאור כללי:** המטפל פותח את הדף `user/login_member.php`, רואה כותרת "כניסת מטפלים", מזין שם משתמש וסיסמה, ולוחץ "התחבר". אם הפרטים נכונים, הוא מגיע לאזור ניהול/יומן מותאם למטפלים; אם לא, תופיע שגיאה.

| מספר צעד | פעולה מצד המטפל                      | תוצאה מצופה                                                   |
|----------|-------------------------------------|----------------------------------------------------------------|
| 1        | פתיחת העמוד `login_member.php`      | מוצג מסך התחברות מותאם למטפלים, שדות לשם משתמש וסיסמה.        |
| 2        | הזנת שם משתמש וסיסמה                | הנתונים מופיעים בשדות הטופס (front-end).                       |
| 3        | לחיצה על כפתור "התחבר"              | נשלחת קריאת AJAX אל `js_login_member.php`; ממתינים לאימות.     |
| 4        | (לאחר תשובה)                        | אם ההתחברות הצליחה – מעבר לכתובת שהוחזרה; אחרת – הודעת שגיאה. |

---

#### 2. תיאור המימוש בקוד (Back-End / Developer Perspective)
- **תיאור כללי:**  
  בקובץ `user/login_member.php` יש שליחת POST אל `js_login_member.php`.  
  בקובץ `user/js_login_member.php` נעשית שאילתה לטבלת `therapists`, בדיקת `deleted = 0`, בדיקת `active = 1`, הגבלת תאריכי התחלת עבודה (`workStart`) וסיום (`workEnd`), וכמובן אימות הסיסמה באמצעות `MemberUser::passVerify`.

| מספר צעד | לוגיקה טכנית                                                                                                                                                | מיקום בקוד                   | מבנה ותוכן הקוד                                                                                                                                                             |
|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1        | קליטת פרמטרים `user` ו-`pass` מתוך `$_POST`.                                                                                                               | `user/js_login_member.php`   | `if(isset($_POST['login'])) { ... }`                                                                                                                                         |
| 2        | בדיקות ריקוּת (empty) או ערך לא חוקי עבור המשתמש/סיסמה.                                                                                                     | `user/js_login_member.php`   | `if (!$username) $result['error'] = 'Empty or illegal e-mail'; else if (!$password) $result['error'] = 'Empty password';`                                                    |
| 3        | שאילתה לטבלת `therapists` לבדיקת התאמת שם המשתמש, מצב הפעיל (active), עובד לא מחוק (deleted=0), ותאריכי התחלת/סיום עבודה.                                | `user/js_login_member.php`   | `$que = "SELECT \`therapistID\`, \`siteID\`, ... FROM \`therapists\` WHERE ... AND \`active\` = 1 ..."; $user = udb::single_row($que);`                                      |
| 4        | בדיקת סיסמה ע"י `MemberUser::passVerify($password, $user['password'])`.                                                                                     | `user/js_login_member.php`   | `if($user && MemberUser::passVerify($password, $user['password'])) { ... } else { $result['error'] = 'Wrong e-mail or password'; }`                                          |
| 5        | יצירת אובייקט סשן `MemberUser` (מקבל therapistID, siteName, הרשאות, ועוד) ושמירתו במערך `$_SESSION['tfusa']['member']`.                                    | `user/js_login_member.php`   | `$sess = new MemberUser(...); $_SESSION['tfusa']['member'] = [$sess->access_token => $sess];`                                                                                 |
| 6        | החזרת תשובה במבנה JSON (הצלחה או שגיאה).                                                                                                                   | `user/js_login_member.php`   | `$result['success'] = true; $result['link'] = '/member/' . $sess->access_token . '/'; echo json_encode($result);`                                                           |
| 7        | ב-Front-End, אם `success = true`, מפנים את המשתמש לכתובת `res.link`; אחרת מציגים הודעת שגיאה.                                                               | `user/login_member.php` (JS) | `$.post('js_login_member.php', data, function(res){ if (res.success) window.location.href = res.link; else swal('שגיאה!', res.error, 'error'); }, 'json');`                 |

---

# 6. מסמך שימוש (מדריך למשתמש)
להלן מדריך קצר למשתמש הקצה, כיצד להשתמש בדפים השונים:

1. **כניסת משתמש רגיל**  
   - פתחו את הקישור/כתובת של `user/login.php`.  
   - בהופעת המסך, הזינו את שם המשתמש והסיסמה בשדות המתאימים.  
   - לחצו על כפתור "התחבר".  
   - במידה והפרטים תקינים, תופנו אוטומטית לאזור האישי המותאם למשתמש שלכם.  
   - אם מופיעה הודעת שגיאה, בדקו את הפרטים ונסו שנית או פנו לתמיכה.

2. **כניסת מטפל**  
   - פתחו את הקישור/כתובת של `user/login_member.php`.  
   - הזינו את שם המשתמש והסיסמה שהוקצו לכם.  
   - לחצו על "התחבר".  
   - לאחר אימות מוצלח, תועברו אל עמוד הניהול/יומן הרלוונטי למטפל.  
   - אם מופיעה הודעת שגיאה, יש לבדוק מול התמיכה או מנהל המערכת בנוגע להרשאות והפרטים שהוזנו.

---

# 7. סיכום
מסמך זה מציג את ארבעת הקבצים העיקריים הקיימים בתחום ההתחברות למערכת, ומסביר את תרחישי השימוש והזרימות הטכניות (Front-End ו-Back-End). המערכת מספקת מנגנון התחברות למשתמשים רגילים ולמטפלים, תוך בדיקות אבטחה בסיסיות (אימות סיסמה, סטטוס פעיל/לא מחוק, תאריכי עבודה וכו’).  
כל פעולה טכנית נתמכת על-ידי קובצי PHP משלימים, מחלקות עזר, וקבצי סשן, במטרה לספק חוויית משתמש פשוטה לצד מימוש טכני ברור.  
```

---

## 2. רשימה להעתקה של הקבצים (שורה אחר שורה)

להלן שלוש הרשימות, בפורמט המבוקש:

### 1. קבצים שנבדקו
```
user/js_login.php
user/js_login_member.php
user/login.php
user/login_member.php
```

### 2. קבצים שלא נמצאו
*(אין קבצים בקטגוריה זו)*

*(השאר ריק)*

### 3. קבצים שלא נבדקו
```
../cms/classes/class.TfusaBaseUser.php
../partials/header.php
assets/css/style.css
assets/css/sweetalert2.min.css
assets/js/jquery-2.2.4.min.js
assets/js/sweetalert2.min.js
favicon.ico
assets/img/login.jpg
assets/img/lock.png
assets/img/error.png
manifest.json
```
